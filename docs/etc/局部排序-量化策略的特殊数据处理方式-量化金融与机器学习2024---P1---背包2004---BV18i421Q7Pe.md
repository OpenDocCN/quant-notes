# 局部排序-量化策略的特殊数据处理方式-量化金融与机器学习2024 - P1 - 背包2004 - BV18i421Q7Pe

呃，这个部分呢讲一个一种特征处理的方法，或者说我认为其实是属于什么呢，是属于金融领域里面一种比较特殊的标准化，我我觉得是一可以这么看一种特殊的标准化啊，靠我们去试着把它完成它，看看它是不是能够。

我也不知道不确定能不能改善效果，但是理论上道理上来说，这种对特征的处理，是比较适用于我们的这样的金融领域的，就是我们之前不是用标准化来做特殊处理吗，但是其实在至少在股票市场。

很多时候用排名来替代具体的量，可能会有更好的效果呃，什么意思呢，比如说你看啊，刚才我们的呃目标向量是要预测什么呢，我们是想预测那个股票的收益是不是，但是大家发现我们的这个应用逻辑没有你。

你你觉得我们有必要预测股票的收益吗，其实没有这个必要，为什么呢，你想想我们每次用这个东西的时候，我们都是预测了股票的收益之后，选择收益最大的那几只，是不是能理解吗，所以说我们其实是只要知道在这一天。

通过这一天的数据，我们不知道未来30天之后哪些股票收益最大，是不是就行了，我们并不在乎这个收益是多少，我们只在乎哪些股票收益最大，大家能理解这个逻辑吗，所以说很多时候我们并不太行。

并不需要去预测那么详细的一个收益，这个时候其实把对应的东西弄成排名可能更好，而且还有一点大家能看到没，刚才讲的是呃，目标向量对于因子来说其实也是一样，如果这个因子比较重要，我们在乎这个因子具体是多少。

哪个值吗，我们不在乎，我们只在乎这个因子，这个股票的这个因子，它相比其他股票处在什么地位，能理解吗，也就是说这个股票的这个因子，在整个市场上的位置，比这个因子本身的值是更重要的，能理解这个逻辑吗。

所以说当我们涉及到股票市场的一些东西，的一些特征的处理的时候，有些时候做排名比做理论上啊，比做标准化可能会更有效，而且这个排名大家注意点，不是全量数据的排名，大家能理解吗。



![](img/a17bac1222aa3d333c323521fe239c44_1.png)

是什么排名呢，是什么，什么样的排名是有效的。

![](img/a17bac1222aa3d333c323521fe239c44_3.png)

它得是在你你从事交易的那一天，那一天，这个股票这个因子，在那一天在那个市场上的一个排名，懂吗，他并不是说哎呀整个5年，我把整个5年所有股票的因子做成一个序列，然后对它进行排名，这个这个就不合适了啊。

因为我们是呃投资行为，通常都是都是一个比较和选择行为，我们之所以要排名，就是要选好的，而我们某一天的时候，我们面对的其实就是这么几只，这么这么1000多只股票是吧，我们的这个这个数据里面。

我们并不需要和历史排名来进行比较，我们只需要当前的所有股票这个因子的排名，所以说这个排名不是全局的排名，是局部的排名啊，局部的排名或者说更更加呃更加直接一点，就是那一天的你要投资的那一天。

这个股票的排名，这个股票在所有所有投资标的，所有股票的的这个这个里面所处的那个位置，好吧呃这是这是这一点，不管是音质也好，还是目标向量也好啊，通过排版，通过来通过把具体的因子值。

或者说具体的目标的值转换成排名，有可能是一个更好的一个处理方式，特征处理方式好，我们来做一下，呃在我们这里有什么呢。



![](img/a17bac1222aa3d333c323521fe239c44_5.png)

我们要做什么呢，我们要把把我们认为的那些比较重要的。

![](img/a17bac1222aa3d333c323521fe239c44_7.png)

一些东西要转换成排名。

![](img/a17bac1222aa3d333c323521fe239c44_9.png)

我我我去找一找我们的之前的代码拷贝一下，copy一下啊。

![](img/a17bac1222aa3d333c323521fe239c44_11.png)

这里是不是这是我们之前啊。

![](img/a17bac1222aa3d333c323521fe239c44_13.png)

之前引入那几个新的特征的啊，新的特征的，我们先把它copy到这里来。

![](img/a17bac1222aa3d333c323521fe239c44_15.png)

然后然后来个排名额，我们首先呢我们要什么呢，我们要做收益的排名，要做收益的排名呃，然后呢我们的收益在哪里呢，收益在在这个位置看到没有，这是我们的收益，而是30天后的收益嘛，要做收益的排名。

嗯我们先先拿一个拿一个东西出来。

![](img/a17bac1222aa3d333c323521fe239c44_17.png)

我们这个不要运行啊，这个运行过的，我们先搞什么呢，先搞收益的排名，我们搞一个新的特征，做他的排名。

![](img/a17bac1222aa3d333c323521fe239c44_19.png)

然后呢我们肯定是要做他的排名的。

![](img/a17bac1222aa3d333c323521fe239c44_21.png)

但是刚刚才大家讲，刚才跟大家讲了这个逻辑啊，和我们在做这个percent。

![](img/a17bac1222aa3d333c323521fe239c44_23.png)

在这做这个收益，每个股票收益率是一样的，我们也得group by，因为我们不是做全局排名，我们是做每一个分组排名，而之前我们在做收益的时候，我们是要对股对股票代码进行分组，但是这个时候我们不一样。

我们这个时候我们不需要对股票代码进行分组，我们要对哪个分组啊，同学们知道吗啊，对日期啊懂吗，因为我们现在要看这一天，这个股票在整个市场的排名，要这一天啊，所以说我们现在呢要要获取啊，日期的分组。

要把每一个日期的所有股票分成一组，分成一组之后呢，干嘛呢获取它的，收益，分成一组之后拿到对应的那个预期收益啊收益，然后呢在，然后呢在等true这个也挺重要的，为什么呢，大家想想啊，每一天的股票。

每一天的股票的数量有可能是不一样的，能理解吗，因为有些股票会停盘，它就不存在，我们的，这在，在不就不在我们的这个这一天的股票里面了啊，有些股票还没上市啊，所以说你如果今天是900只股票。

明天是1000只股票，那么你这个排名总数是会变的，能理解吗，这就不合适了啊，所以说我们要干嘛呢，我们不是说算他的排名第几，要算他的比例，能理解吗，这样的话，我们始始终计算这个股票在所有的股票里面。

处在多少的比例的位置，能理解吗，这个就是一个统一的东西啊，就是统一的东西，所以说percent啊，这个东西必须等于true，这一点也挺重要的啊，也挺重要的，好了，我们我们运行一下这个，然后我们看一下啊。



![](img/a17bac1222aa3d333c323521fe239c44_25.png)

就拿到了这个东西啊。

![](img/a17bac1222aa3d333c323521fe239c44_27.png)

当然我们这里还有空值这个，不管待会会那个的啊，就这是排名的比例，因此的我们除了因这个东西要做这个事情呢，我们还有很多要做这个事情，要要有什么呢。



![](img/a17bac1222aa3d333c323521fe239c44_29.png)

我们得有我们有两个东西啊，我们一个是什么，一个是我们的呃，市盈是不是市盈率。

![](img/a17bac1222aa3d333c323521fe239c44_31.png)

市盈率我们也得做一个排名啊。

![](img/a17bac1222aa3d333c323521fe239c44_33.png)

做一个排名。

![](img/a17bac1222aa3d333c323521fe239c44_35.png)

原始的就是这个了，把它拿过来，还有一个是什么呢，是我们的市值。

![](img/a17bac1222aa3d333c323521fe239c44_37.png)

市值后面也拿过来。

![](img/a17bac1222aa3d333c323521fe239c44_39.png)

![](img/a17bac1222aa3d333c323521fe239c44_40.png)

OK这个我们做好了，这三个我们做好了。

![](img/a17bac1222aa3d333c323521fe239c44_42.png)

做好了之后，我们把它给运行一下啊。

![](img/a17bac1222aa3d333c323521fe239c44_44.png)

运行一下，这样的话我们其实就拿这些东西来做来做，做我们的训练了。

![](img/a17bac1222aa3d333c323521fe239c44_46.png)

训练的话我们代码就直接拿上面的吧。

![](img/a17bac1222aa3d333c323521fe239c44_48.png)

是不是，呃这个时候呢我们拿就不拿这两个了。

![](img/a17bac1222aa3d333c323521fe239c44_50.png)

应该是拿什么呢，一个是试银，然后呢拿市值，然后拿什么呢，这是我们的目标向量，拿这个。

![](img/a17bac1222aa3d333c323521fe239c44_52.png)

是吧，那就改好了，然后呢我们的特征矩阵就拿前面两个就行了，这流程是一样的啊，只是其中一些东西换掉，还有目标向量的话，就拿后面那个，是不是，然后再做训练啊，再做训练。



![](img/a17bac1222aa3d333c323521fe239c44_54.png)

啊其实我们可以不用分割了啊，分割没问题啊，分割也行啊，来做训练，就是注意一下。

![](img/a17bac1222aa3d333c323521fe239c44_56.png)

这里依然是四回归啊，用50%的数据，其实全量数据也行啊，因为只有两个特征，怎么着都比较简单，你看是不是这个R这个系数稍微增加了一点点。



![](img/a17bac1222aa3d333c323521fe239c44_58.png)

我看看上面系数多少。

![](img/a17bac1222aa3d333c323521fe239c44_60.png)

下面是1。1。1，是不是这个啊，这个R方决定系数增加了一点点。

![](img/a17bac1222aa3d333c323521fe239c44_62.png)

我看这个有没有好一点点，0。24怎么还多了，但这个是那个这个不一样，这个是我们已经已经哦，这是排名是吧，相对排名啊，我不管你就这样啊。



![](img/a17bac1222aa3d333c323521fe239c44_64.png)

这这不再是收益了啊，所以说跟上面的就不一样了，意义是不一样的。

![](img/a17bac1222aa3d333c323521fe239c44_66.png)

上面这个意义是不一样的啊，这个意义显然是指的收益的13%。

![](img/a17bac1222aa3d333c323521fe239c44_68.png)

但是这个这个应该是属于相对排名了哈。

![](img/a17bac1222aa3d333c323521fe239c44_70.png)

有20%的一个差异啊，不管我们这个模型弄出来了。

![](img/a17bac1222aa3d333c323521fe239c44_72.png)

模型弄出来的话。

![](img/a17bac1222aa3d333c323521fe239c44_74.png)

这个其实是一样的啊，那我还是拿下来吧。

![](img/a17bac1222aa3d333c323521fe239c44_76.png)

把这个拿下来，这个都不用改，是不是要票改一下。

![](img/a17bac1222aa3d333c323521fe239c44_78.png)

要改一下，要改一下。

![](img/a17bac1222aa3d333c323521fe239c44_80.png)

要改什么呢，因为我们的特征变了啊，我们的特征变了，我们得得拿这两个特征。

![](img/a17bac1222aa3d333c323521fe239c44_82.png)

拿什么来拿这三个特征，其实拿这两个就够了啊，目标向量我们不需要了。

![](img/a17bac1222aa3d333c323521fe239c44_84.png)

特征变了。

![](img/a17bac1222aa3d333c323521fe239c44_86.png)

是不是其他的不用改模型，还是还是那个预测它的值就行了啊，预测值我们肯定是选最大的嘛是吧，肯定是选最大的。



![](img/a17bac1222aa3d333c323521fe239c44_88.png)

其他都不用改，不用改。

![](img/a17bac1222aa3d333c323521fe239c44_90.png)

好来看看能不能赚钱，同志们，激动人心的时刻又来了啊。

![](img/a17bac1222aa3d333c323521fe239c44_92.png)

我们总是想赚钱，但是总是总是没法赚钱啊。

![](img/a17bac1222aa3d333c323521fe239c44_94.png)

就这个吧。

![](img/a17bac1222aa3d333c323521fe239c44_96.png)

![](img/a17bac1222aa3d333c323521fe239c44_97.png)

稍微多赚了一点点，是不是是不是稍微多赚了一点点啊，之前是0101啊，这次好像这次这个稳妥的稳稳的这个赚了赚了。



![](img/a17bac1222aa3d333c323521fe239c44_99.png)

赚了10%，百分之什么10%啊，是不是还可以啊。

![](img/a17bac1222aa3d333c323521fe239c44_101.png)

是不是还可以，他其实他其实这里这是为啥呀，这是被怎么被坑的，看这是怎么被坑的，然后这里又起来了是吧，这里应该是有一波，就是之前的规规则有一波变化，然后然后再起来的。



![](img/a17bac1222aa3d333c323521fe239c44_103.png)

但不管怎么说，好像比之前稍微好一点，是不是稍微好一点啊。

![](img/a17bac1222aa3d333c323521fe239c44_105.png)

好吧，那同学们也实现一下这个事情啊。

![](img/a17bac1222aa3d333c323521fe239c44_107.png)

![](img/a17bac1222aa3d333c323521fe239c44_108.png)