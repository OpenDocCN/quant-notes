# 简单的均线策略-backtrader的通用量化框架-量化金融与机器学习2024 - P1 - 背包2004 - BV1sF4m1P7gW

继续来上课啊。

![](img/15a29eeaa698616297b9ab779f80234c_1.png)

呃，在我们具体用这个策略之前啊，就说虽然我们之前简单过用过这个策略，但是在我们具体用这个策略之前，老师还是要强调几个点啊，之前忘记强调的啊。



![](img/15a29eeaa698616297b9ab779f80234c_3.png)

之前忘记强调的一个是什么呢，呃就是这个这个替换，如果你的电脑内存不太多的话，就用这个吧，用这个的好处，就是呃我们导入的股票可能大概少了1000多个，但是就占的内存会小一点。

上课的时候我们就用这个少一点的，就不要不用全量的股票了，行不行，就这个意思啊，这个是全量的啊，这是全量，全量的话大概占大概一到两个G的内存吧，呃这个会稍微少一点啊，稍微稍微少一点。

老是把它设置成2500，是因为比亚迪是在二五几，我最好能够把比亚迪给弄进去，这样的话我能够能够呃这个，用比亚迪的股票来来做一下例子啊，做一下例子好吧，这是这个地方这个地方全亮的也行啊。

就是我们可以可以通过这种方式来，让我们的这个股票池稍微少一点，这样的话电脑可能呃没那么卡啊，没那么卡。



![](img/15a29eeaa698616297b9ab779f80234c_5.png)

除此之外的话还有这个这个这个更关键啊，这个更关键，建议同学们先暂时用这一条东西啊，如果你们的那个你们的代码里面，如果是用的下面这一条的话，老师建议先切换这一条啊，切换成这一条啊，啊为什么用这一条呢。

这其实是一个容错机制啊，其实是一个容错机制啊，他它的目的来源于什么呢，来源于backstreet，它要求它的股票池里面的每一个股票，在每一个交易日都不能滞空，不能有空子，所以说呢就意味着因为有些股票在。

但有些交易日它是你停盘的，所以说是本质上是没有价格这个信息的，但是呢break trade要求，所有股票在所有的交易日都必须得有数据，所以说呢这意味着我们需要什么呢，我们需要啊，当他有空值的时候。

要对它进行一些填补啊，用前面的后面的价格做一些填补啊，这其实用前后的价格做做个，对它进行多一个填补啊，优先是填用它之后的价格来来填啊，之后的价格来填，如果填，如果后面已经没有任何价格的话。

就用前面的价格填，大概是这么个，大概是这么一个方法来进行呃空值的一个填取，这个钱取的话会导致一个问题，就是在很在有些场景上会不够严谨，这是为什么老师会用下面这个填补啊，下面这个填补意味着。

如果呃下面这个填补意味着什么呢，意味着我们在生成我们的策略的时候，已经就考虑了停盘等一些因素，就是你我们的策略自动的，会避免在停盘日购买对应的股票，那么我们把这个股票的这个价格设置成一。

这样的很奇怪的值，也不会影响最后的结果啊，但是如果我们的策略，一开始没有考虑这些问题的话，建议同学们把它设置成这样子啊，但是我们不考虑这一点，我们就设置成这样子，这样的话。

它会自动的去用前后的价格去对空值进行填补，至少不至于我们的策略出现大的错误，但是确实会带来一些不严格的地方，这个这个事情我们今后今后再说，现在我们先用简单的方式来私信他，好吧，这是这是这一点啊。



![](img/15a29eeaa698616297b9ab779f80234c_7.png)

这是这一点，还有还有一点呢，老师要强调一点，就是就是什么呢。

![](img/15a29eeaa698616297b9ab779f80234c_9.png)

就是呃backstreet的一个交易机制，这个我们未来还会谈谈到它，但是现在我们强调一下，break确实是这样的，你看在这里面我们会判断是否在对应的天，然后发生交易，但实际上他在这一天不会发生交易。

他会干嘛呢。

![](img/15a29eeaa698616297b9ab779f80234c_11.png)

他会在下一天啊，就是比如说我们你看啊。

![](img/15a29eeaa698616297b9ab779f80234c_13.png)

你看我们给了一个呃交易的一个日期，是9月22号，要交易这两只股票，但是实际上这个交易是发生在9月20号，22号下面的一个交易日啊，有可能是9月21号，当然交易日嘛，那如果星期天会会会再再再过两天。

就是他真实的交易，实际上是发生在9月22号，下面的一个交易日，应该是在下面那个交易日的，用，用下面那个交易日的开盘价来购买这支股票啊，来购买这只股票，所以啊这个特点大家要要记得啊，要记得这个特点之后啊。

我们昨天我们之前的那个问题。

![](img/15a29eeaa698616297b9ab779f80234c_15.png)

可能就会可以弥补一下好，这三点大家稍微了解一下，了解好了之后呢。

![](img/15a29eeaa698616297b9ab779f80234c_17.png)

我们来做啊，第一个第一个事情就是我们的均线突破啊，就我们再做一次，再做一次呃，金券突破呢交易策略非常简单，是股价高于30日均线进行购买，然后低于30日均线呢，就就就就把它给抛掉啊，非常简单的一个策略啊。

呃我们这里选的是平安银行。

![](img/15a29eeaa698616297b9ab779f80234c_19.png)

比亚迪行，平安银行都行啊，我们我们可以往上举个例子讲讲。

![](img/15a29eeaa698616297b9ab779f80234c_21.png)

这是什么意思啊，这是个什么意思啊，所谓的，啊所谓的均线就是高于的话，就是在比如说你看在这条均线的上面，就是要高于在均线的下面就要低于，所以当他当这个价格啊，当这个价格高于那个均线的时候，我们就会买。

低于的话就会卖，但是这里面有个问题啊，什么意思呢，呃当它一旦高于均线的时候，它会在很长一段时间都会在均线之上，能理解吗，但这个时候我们不要一直触发这个触发的交易，我们一般来说高于均线。

把所有的股票卖掉就OK了，能理解吗，然后等到什么呢，等到它在低于均线的时候，然后再再再再抛掉就行了啊，它会它低于，一旦他低于均线的时候，很有可能是一直会在均线下面，在这之后就不要再做操作了啊。

所以这一点啊是我们需要考虑的，就不要去重复的去去购买它。

![](img/15a29eeaa698616297b9ab779f80234c_23.png)

因此的话我们在做策略的时候呢，那我们来做一下。

![](img/15a29eeaa698616297b9ab779f80234c_25.png)

我们来做一下，我们就用平安银行吧。

![](img/15a29eeaa698616297b9ab779f80234c_27.png)

我们这个是不是没有没有运行啊。

![](img/15a29eeaa698616297b9ab779f80234c_29.png)

看一下啊，这个。

![](img/15a29eeaa698616297b9ab779f80234c_31.png)

啊这是有的。

![](img/15a29eeaa698616297b9ab779f80234c_33.png)

我们获取的是大于那个二五的。

![](img/15a29eeaa698616297b9ab779f80234c_35.png)

应该是用平安银行不行啊，平安银行它是小于小于这个词啊。

![](img/15a29eeaa698616297b9ab779f80234c_37.png)

就是我们获取的啊，我没有把全部的股票获取，我们获取的是这个部分。

![](img/15a29eeaa698616297b9ab779f80234c_39.png)

那我们还是用比亚迪吧啊还是用比亚迪，比亚迪应该在它之上的啊。

![](img/15a29eeaa698616297b9ab779f80234c_41.png)

在他之上的。

![](img/15a29eeaa698616297b9ab779f80234c_43.png)

是吧，这个是有的啊，平安银行它可能它它应该是他的呃，那个股票代码在在2500以下。

![](img/15a29eeaa698616297b9ab779f80234c_45.png)

所以说我们当时没拿到啊，我们这里就做比亚迪，然后呢他是要30日均线。

![](img/15a29eeaa698616297b9ab779f80234c_47.png)

30日均线，所以说我们可以先拿到什么呢。

![](img/15a29eeaa698616297b9ab779f80234c_49.png)

先拿到，比亚迪的啊。

![](img/15a29eeaa698616297b9ab779f80234c_51.png)

比亚迪的收盘价，是不是他说这个名字就不改了啊，先拿到比亚迪的收盘价，然后呢我们做比亚迪的30日均线，30日均线的话就就用我们的那个，对应该是这个，是吧，然后我们把它给到给到一个词，一个词。

啊这就是它的30日均线。

![](img/15a29eeaa698616297b9ab779f80234c_53.png)

30日均线啊，我们可以把这两个东西给图给做出来啊，图给做出来。

![](img/15a29eeaa698616297b9ab779f80234c_55.png)

我们把图定义一下，让它更加更加宽一些。

![](img/15a29eeaa698616297b9ab779f80234c_57.png)

![](img/15a29eeaa698616297b9ab779f80234c_58.png)

嘶太宽了，怎么这样。

![](img/15a29eeaa698616297b9ab779f80234c_60.png)

![](img/15a29eeaa698616297b9ab779f80234c_61.png)

就这样吧，这样正好在最中间，是不是。

![](img/15a29eeaa698616297b9ab779f80234c_63.png)

然后再把这个做一下。

![](img/15a29eeaa698616297b9ab779f80234c_65.png)

![](img/15a29eeaa698616297b9ab779f80234c_66.png)

是啊，这就是大概他的均线下面黄色的是均线，然后这个是股票价格，股票的收盘价，然后他他所谓的就是当股票的价格，在这个均线上面的时候会买，但跌下去的话就会卖出啊，就会卖出呃。

所以说我们这里呢需要判断它是否在上面。

![](img/15a29eeaa698616297b9ab779f80234c_68.png)

是否在上面，而且不仅要判断它是否在上面。

![](img/15a29eeaa698616297b9ab779f80234c_70.png)

而且我们可以把这个做个循环。

![](img/15a29eeaa698616297b9ab779f80234c_72.png)

![](img/15a29eeaa698616297b9ab779f80234c_73.png)

![](img/15a29eeaa698616297b9ab779f80234c_74.png)

![](img/15a29eeaa698616297b9ab779f80234c_75.png)

![](img/15a29eeaa698616297b9ab779f80234c_76.png)

我们用均线的这个索引吧。

![](img/15a29eeaa698616297b9ab779f80234c_78.png)

因为呃都行啊，他两个索引一样的。

![](img/15a29eeaa698616297b9ab779f80234c_80.png)

但是呢我们肯定不能一开始就用，因为均线的话他前面是有空值的啊。

![](img/15a29eeaa698616297b9ab779f80234c_82.png)

他是30日，均线的话，我们从30，31号开始吧，30作为他的那个。

![](img/15a29eeaa698616297b9ab779f80234c_84.png)

啊这是可以的，然后，呃另外一点的话，我们判断当天的啊，判断当天的情况，然后呢，当天把这个信号给到black trade，black trade应该它自动的会在就我们刚才讲的。

它实际上自动的会在下一个交易日啊，来进行购买，所以说这里我们并不需要我们自己去给下，一个交易日一个时间，我们只需要在这个这一天来进行判断，是否行就可以了啊，是否满足我们的条件啊，Break trade。

它会自动的会在下一个交易日来进行购买。

![](img/15a29eeaa698616297b9ab779f80234c_86.png)

进行购买，并且呢我们要完成这些事情，是需要把这些啊。

![](img/15a29eeaa698616297b9ab779f80234c_88.png)

把这些弄过来的，这些弄过来。

![](img/15a29eeaa698616297b9ab779f80234c_90.png)

![](img/15a29eeaa698616297b9ab779f80234c_91.png)

把这些都弄过来。

![](img/15a29eeaa698616297b9ab779f80234c_93.png)

![](img/15a29eeaa698616297b9ab779f80234c_94.png)

这时候我们呃用我们的这个打包好了，这个程序，我们现在要完成这个策略，只需要我告诉这个策略，我们应该在哪一天呃有信号啊，哪一天哪个股票有这个信号就行了啊，所以说呢我们需要什么呢，我们需要在这里。

我们需要在这里来定义我们的交易的，请策略策略，但是这个我们给它是个空的，是不是呃。

![](img/15a29eeaa698616297b9ab779f80234c_96.png)

这个其实我们就不需要了，因为我们已经是平安呢。

![](img/15a29eeaa698616297b9ab779f80234c_98.png)

是不是已经是平安了。

![](img/15a29eeaa698616297b9ab779f80234c_100.png)

已经是这个比亚迪，而且他的股票代码是这个是吧。

![](img/15a29eeaa698616297b9ab779f80234c_102.png)

我们直接手动给就行了，因为我们就只有一只股票啊。

![](img/15a29eeaa698616297b9ab779f80234c_104.png)

只有只有一只股票，所以我们在自己手中啊，这这一次的啊，就是这个我们就手动给就行了啊，手动给就行了，然后呢我们在。



![](img/15a29eeaa698616297b9ab779f80234c_106.png)

判断判断。

![](img/15a29eeaa698616297b9ab779f80234c_108.png)

股票的价格，大于，30日均线的时候，我们就触发一个，触发一个呃，买入的信号。

![](img/15a29eeaa698616297b9ab779f80234c_110.png)

啊这个这个列表显然就是这个啊，没有别的啊，没有别的，然后呢，当他，小于它的时候，我们就触发一个卖出的信号，是吧，啊触发一个卖出的信号啊，但是我们可以看一下结果，我们看一下，看一下这个情况啊。



![](img/15a29eeaa698616297b9ab779f80234c_112.png)

我们可以看一下，你看啊，他因为什么呢，因为它会长期的都会在某个线的上面。

![](img/15a29eeaa698616297b9ab779f80234c_114.png)

我们就可以看到啊，他会你看他这两天都在。

![](img/15a29eeaa698616297b9ab779f80234c_116.png)

然后他你看他一旦一直在的话，你看他89789十十一。

![](img/15a29eeaa698616297b9ab779f80234c_118.png)

他一直会会会发出卖买入的信号，但实际上我们现在并没有分批买入，我们实际上一开始进入就买入了，后面实际上是不需要再进行购买的啊，所以说这个这是我们之前做的不够完善的地方，所以说我们不应该这样子啊。

我们不应该啊。

![](img/15a29eeaa698616297b9ab779f80234c_120.png)

只做这样的判断，我们还得加个信号啊，还得加个信号，让他等于等于零等于零啊，就是没有，如果，这样的话我们既判断他这样子，然后呢，And，不过它等于零，然后我们就就发出这样一个信号，并且呢把把它啊。

把把它让它等于一，然后呢，当当这个啊哎，等于一当它等于一的时候，然后我们就等于意味着什么呢，意味着我们是买过的啊，是有仓位的，这个时候我们呃发出一个卖出信号，卖出完了之后呢，我们重新把这个信号变成零。

这样的话就不会像刚才那样啊，重复的来做了啊。

![](img/15a29eeaa698616297b9ab779f80234c_122.png)

重复的来做了，好我们可以看一下，看一下这个结果，你看这样的话就不会出现大段的这个啊。

![](img/15a29eeaa698616297b9ab779f80234c_124.png)

一直一直在发出这个买入，买出的信号的一个情况啊。

![](img/15a29eeaa698616297b9ab779f80234c_126.png)

它都是会在啊，刚刚出现的时候来发出一个信号啊。

![](img/15a29eeaa698616297b9ab779f80234c_128.png)

发出一个信号，这样的话就会好一些。

![](img/15a29eeaa698616297b9ab779f80234c_130.png)

就会好一些，好吧，这个这个我们弄好了，弄好了之后呢。

![](img/15a29eeaa698616297b9ab779f80234c_132.png)

我们运行一下这个我们看一下结果。

![](img/15a29eeaa698616297b9ab779f80234c_134.png)

这个啊是这样的啊。

![](img/15a29eeaa698616297b9ab779f80234c_136.png)

我们得得干嘛呢，得，得这样子啊，点那个那个那个要把它转换成什么呢。

![](img/15a29eeaa698616297b9ab779f80234c_138.png)

是这样的啊，跟同学讲一下，我们那个里面是要用什么呢，要用他的啊，要用要用它的一个字符串的形式，要用它的字符串形式啊，这样也可以啊，还有一种符号也行，我们不管，我们就用这个吧，先用字符串的形式啊。



![](img/15a29eeaa698616297b9ab779f80234c_140.png)

对这样这样这种形式才行啊。

![](img/15a29eeaa698616297b9ab779f80234c_142.png)

![](img/15a29eeaa698616297b9ab779f80234c_143.png)

![](img/15a29eeaa698616297b9ab779f80234c_144.png)

大概就这样啊，就这样，然后我们可以什么呢。

![](img/15a29eeaa698616297b9ab779f80234c_146.png)

我们可以做一下图，我们看一下这个给到的是reload。

![](img/15a29eeaa698616297b9ab779f80234c_148.png)

然后点。

![](img/15a29eeaa698616297b9ab779f80234c_150.png)

啊啊就是这样的一个情况。

![](img/15a29eeaa698616297b9ab779f80234c_152.png)

这样的一个情况，他会在一些他认为需要的一些点来买入买出。

![](img/15a29eeaa698616297b9ab779f80234c_154.png)

就这个平安银行啊。

![](img/15a29eeaa698616297b9ab779f80234c_156.png)

我们看一下平安银行本来怎么样啊。

![](img/15a29eeaa698616297b9ab779f80234c_158.png)

要是比亚迪奥，我买的是比亚迪是吧。

![](img/15a29eeaa698616297b9ab779f80234c_160.png)

比亚迪本来就很好，但是他这么一番操作下来还不好了。

![](img/15a29eeaa698616297b9ab779f80234c_162.png)

就是。

![](img/15a29eeaa698616297b9ab779f80234c_164.png)

这个策略很一般啊，至少在比亚迪这里来看。

![](img/15a29eeaa698616297b9ab779f80234c_166.png)

因为比亚迪本来他就翻了很多，涨了很多啊，就涨了很多，涨了涨了一两倍吧。

![](img/15a29eeaa698616297b9ab779f80234c_168.png)

在这个时间段啊，在这个时间段，在我们设置的这个时间段。

![](img/15a29eeaa698616297b9ab779f80234c_170.png)

2020年到23年。

![](img/15a29eeaa698616297b9ab779f80234c_172.png)

他本来就有很大的上涨，所以说这个策略本身并没有带来什么正面价值。

![](img/15a29eeaa698616297b9ab779f80234c_174.png)

就是一个策略的实现好吧，同学们把这个事情搞一搞啊。

![](img/15a29eeaa698616297b9ab779f80234c_176.png)