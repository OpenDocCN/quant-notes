# 人生苦短，我学量化！比刷剧还爽的python金融分析与量化交易实战课程！——时间序列分析／机器学习算法／股票交易／回归算法／聚类算法 - P48：48.完成策略交易展示结果P49(P48) - 请不要关注我- - BV1Bz421y7Tu

![](img/d723162e815e3b51400a4839a466322b_0.png)

接下来咱们来继续完成我们的REBECON函数啊，第一步我们现在选出来了，当前呃我要去的就是当前我们排名的一个股票，然后呢，接下来啊咱们不是把这个股票拿到手了，那接下来我们是不是得看一下哎呦。

现在我这个排名可能做了一些变化吧。

![](img/d723162e815e3b51400a4839a466322b_2.png)

那我们现在要再写个函数，就是呃，我们手里有的和现在新的一个排名当中诶，有什么样的一个差异，一会儿呢咱们是不是要基于这个差异来实际的，咱们要去选一些股票，或者说实际的我们要去购买一些股票了，好了。

咱们来把这个函数完成，这个函数，其实说白了就是呃去看一下，当前你手里有的股票有哪些，然后呢我们做一个差异好，我们先写第一个就是现在咱们手里有的，咱先把手里有的股票给拿过来。



![](img/d723162e815e3b51400a4839a466322b_4.png)

把这个context得给我传进去好了，在这个函数当中啊，咱们想一想做什么。

![](img/d723162e815e3b51400a4839a466322b_6.png)

首先第一步哎，我说现在这个当中，我是不是看一下我这个position是等于多少啊。

![](img/d723162e815e3b51400a4839a466322b_8.png)

PSTON好了，拿到我们context当中找吧。

![](img/d723162e815e3b51400a4839a466322b_10.png)

context里边咱找一下咱们的用户信息里边哦，这些个指标在这个指标当中，我们是不是把第一个position拿过来啊，跟咱之前的方法是一样的好了。



![](img/d723162e815e3b51400a4839a466322b_12.png)

然后我说现在我写个名字吧，在这个holding当中，火影当中，现在他是一个加S吧，现在它是一个list。



![](img/d723162e815e3b51400a4839a466322b_14.png)

然后呢一会我说把这个list做一个填充，然后做一个判断吧，for咱们的一个position呃，在这一块for the position in这些当中好了，看一看咱们现在这些持有的吧。

如果说哎我持有的数量只要怎么样，它大于零，是不是就行了好了，把我这个拿过来啊，然后看一下，如果看一下这里，我说先找到吧，找到把这个传进去看看什么，看一看咱们拥有的一个质量得多少吧。

Q u n t i t y，然后去判断一下，如果说大于零二，那是不是说咱们先持有，持有的时候给他加进来就行了哦，这块这块应该是个判断，如果说它是大于零的，大于零的情况下，咱就是持有的持有的。

然后在这里我说做一个判断操作，我拍的操作把咱当前的这个股票给他传进来，是不是就可以了好了，现在把咱们股票拿到手之后，那我说最后我是turn一下吧，return就是咱们当前你持有这些东西啊。



![](img/d723162e815e3b51400a4839a466322b_16.png)

就完事了好了，咱们来练习啊，现在我得到了就是新的一轮stars，是排名周的结果，然后呢，接下来我说现在把我这个holdings先拿到手，他等于去get一下啊，这就完事了，get一下。



![](img/d723162e815e3b51400a4839a466322b_18.png)

咱当然结果，然后把这个context再传进去，那现在我说要算什么，哎我说了我得去算一下我要买什么了，那我写一个to b吧，我要接下来去买的，买的就是当前什么哎，你手里有的这些东西。

跟你现在新的一名之间肯定有差异吧，重复的你就不用去管了，你要管他什么差异的吧，所以说啊在这个DOS当中，我们要在这个DOS当中，我们去算减掉谁呢，减掉咱现在手里有的，这不就是我现在要去买的吗。

然后不光我要去买，然后我可能还要去卖去脉，什么意思，现在这个holding当中不在哪了，不在style当中了，那holding里边不在st当中的，是不是用这个holding减去一个DOS当中啊。



![](img/d723162e815e3b51400a4839a466322b_20.png)

好了，我们把一个买的和卖的都指定完了，那先卖吧，应该是先卖后买好了，然后我一个因在咱们现在要去卖的当中。



![](img/d723162e815e3b51400a4839a466322b_22.png)

然后再去执行这样一个卖操作就行了吧，然后一个order order target value or order target。



![](img/d723162e815e3b51400a4839a466322b_24.png)

然后全卖掉，那就是给它变成零，Stock，给它复制过来，然后全卖掉，占有的量变成0%就完事了。

![](img/d723162e815e3b51400a4839a466322b_26.png)

这就是一个mt操作，然后呢接下来呢直接买啊，这个可以先判断一下，如果说啊咱们现在没有买的，直接return运行，如果这个东西to bed浪值。



![](img/d723162e815e3b51400a4839a466322b_28.png)

如果它等于等于零，一只股票都没有去买，那return回去相当于咱做完了就完事了，然后如果说咱要有买的，要我买的时候再去看一看呃，我现在手里有多少钱，然后呢咱平均去买是不行了，比如说给大家算一下吧。

咱可以咱现在指定个指标，就是在这个context当中啊，你所有的信息都能调出来，你的一些用户的信息，在这里把咱们信息当中我看一下啊，找一个value值，咱们来我把这个直接复制过来吧。

这里边它叫做一个value值哦，应该是他的一个全称，然后点一下它的全称，然后杠一个value就行了好了，看下咱们现在呃有多少的一个资产，然后呢有多少资产之后，然后我们要指定。

对于我当前这个资产要判断什么，判断一下呃，当前我买股票的时候，我买一个股，然后再买多少吧好了，然后咱一共是有这么多股票，图片当中一共是有这么股票，那他俩比一下，那就是实际一个股票当中。

我们应该去买多少吧，好了，这块我指定一个参数叫做一个平均的，那一会咱就平均去买啊，Average，然后一个Y90就行了，接下来呢我们还是执行这个函数，只不过说哦还是把这个复制过来吧。

还是要去遍历一下遍地，在我们接下来这块不是to sell了，就是一个to b的，在我们要去买的这些个股票当中哦，这就不是一个percent了，我们之前不是算了，你要买多少吗，那就是一个value。

然后top当中在指定出来了，然后每一个买多少，哎咱也指定出来是不是就行了，这样我们就指定了咱们去买的一个操作吧，那好了，现在就是基本上，我们已经把所有操作咱都列完了吧。



![](img/d723162e815e3b51400a4839a466322b_30.png)

嗯回顾一下吧，看一看我们还没有什么落到一开始在context当中，哎我说我指定股票池子或者下载当中，然后这里呢哎有一个那rank，就是我们上一期咱们的一个排名嗯，咱们现在暂时还没用上这个结果是吧。

一会儿咱看看会不会用啊，不会用，给它注释掉吧，然后说每月咱要做一个调仓操作。

![](img/d723162e815e3b51400a4839a466322b_32.png)

然后每月呢在做这个调仓操作过程当中，我说我先去算算几个值，哎先算买什么和卖什么，不是就现在我算一个新的排名的值。



![](img/d723162e815e3b51400a4839a466322b_34.png)

然后呢再算我手里有什么，然后接下来我说基于他们的一个差异，然后去买还是去卖。

![](img/d723162e815e3b51400a4839a466322b_36.png)

这些操作都没什么问题，然后呢主要还是啊就是我们这个get source当中，咱去查这些指标，然后把这些做一些筛选是吧行了，基本上没什么问题啊。



![](img/d723162e815e3b51400a4839a466322b_38.png)

咱写完了，这样再运行一下，看一看有没有什么问题，我估计可能会报错。

![](img/d723162e815e3b51400a4839a466322b_40.png)

遇到报错没关系，咱们来改一改，不过现在这pass没用上的，咱就全都给他pass掉。

![](img/d723162e815e3b51400a4839a466322b_42.png)

然后看下结果吧，这样可能会报错，来看一看看书，结果写完这个报错了，他说现在这块有一个无效字符，找一找。



![](img/d723162e815e3b51400a4839a466322b_44.png)

他说每股收1P，那看一下在咱们当前的给他还是放右边。

![](img/d723162e815e3b51400a4839a466322b_46.png)

每股收益EPS，这来找一找，在当前这块，他说有一个特殊字符a fundamentals点，然后去查找哦，这个写错了是什么，写成了一个中文逗号是吧。



![](img/d723162e815e3b51400a4839a466322b_48.png)

好再执行一下哦，顺便算了。

![](img/d723162e815e3b51400a4839a466322b_50.png)

先给他扣掉吧，我发现几个毛病，这块他也是一个重要注意，然后这一块，然后这里这块又少写了一个逗号，我们再再加上这一块，他也少写了逗号，也加上这里也是一样的，咱有点小毛病，给他稍微改一改好了。

这块都有些逗号，然后再往下看看，这都是在执行吧，看看有没有什么问题，他只想让我顺便先过一下，简单找一找有没有什么太大问题，然后这里看起来都没什么问题，行看结果吧，看报不报错吧，看报错咱们来改哦。

他说不支持类型，然后list我看在哪啊，在这个to b当中啊。

![](img/d723162e815e3b51400a4839a466322b_52.png)

等于这样一个减法来看一下，我们现在还设计了一个图片。

![](img/d723162e815e3b51400a4839a466322b_54.png)

我说现在我要去买什么，等于我的一个STOS减去我当前的一个holding，这块不行，那我们得做这样一件事，我也给它做成一个set集合，这样吧，咱把它全部处理成一个set集合这一块，我说也处理剩菜即可。

处理成菜，没问题吧，好了这样咱来看一下，应该就能执行我们的一个差异的一个操作了，这个关掉看一看。

![](img/d723162e815e3b51400a4839a466322b_56.png)

哎呀咱这块还有个东西忘设了，就是咱们的一个时间呃，时间先不管了，就是从2016年1月4号吧，到2016年1月10号，这无所谓了，反正就是这些时间吧。



![](img/d723162e815e3b51400a4839a466322b_58.png)

咱不改了，然后一会儿我再改个时间。