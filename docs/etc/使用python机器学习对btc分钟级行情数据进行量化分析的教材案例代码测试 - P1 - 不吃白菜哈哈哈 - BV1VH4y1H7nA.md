# 使用python机器学习对btc分钟级行情数据进行量化分析的教材案例代码测试 - P1 - 不吃白菜哈哈哈 - BV1VH4y1H7nA

好我们今天看到这个机器学习的金融分析案例，来自于这个印度小哥，他写了一本书，就是这本书，这本书啊，机器学习与金融数据分析，那么在这本书中间呢，他把整本书的代码放在了这个项目中间，就是FIMML。

这是他的GITHUB的主页，我们点进去以后呢，可以在这个扣子中间下载它的全部的代码，如果你需要在本地跑的话，可以下载整本书每一章的代码，那么我们主要关心的是他的6。3，也就是这本书的199页。

中文版199页，它有一个比特币的把分类模型交易策略，那么可以看到它的代码都在这里了，全部都在这里了，我们主要想做的事情，就是说我们了解一下，就是他作为一个作者，他是如何使用机器学习来预测啊。

这种投资标的走势的，因为如果比特币可以预测的话，那么各种各样金融产品都可以用它可以预测，那么我们看看它的框架是什么样的，具体的技术细节可以再说，但是呢他这个问有一个问题，就是他这个程序。

因为大家可以看他的这个币价，还是在2000多美元的时候，所以呢这是很多年前的一个编程序，所以当你在本地跑这个程序的时候呢，你会遇到的第一个麻烦就是这些库你读不进去，读不进去。

所以我们今天就从头开始讲一讲，就是如何在aka中间新建一个空，大建一个全新的空档，把各种各样的包子装上去以后，来把这个库读进去，这里读进去以后呢，后面基本上照着它改改就可以跑起来了。

看看能不能把这个视频跑出来看，所以大家先禁止改造空难以后。

![](img/268e93c81d55b0784a03bae340d12c3e_1.png)

它有个prompt，这个中间有个prompt，那么这个base环境呢是我们平时的环境，我们新建一个，负N然后给它起个名字叫test05，指定一下Python版本，那么这个版本我看看是多少啊。



![](img/268e93c81d55b0784a03bae340d12c3e_3.png)

你们这些版本号都是我自己测试过可以用的。

![](img/268e93c81d55b0784a03bae340d12c3e_5.png)

你们就按照我这个本来就可以了，那么等于3。11。5，选yes，你要听他的账号，对不对，你把他卖掉，我不借钱，我拿到厂房，看下来走到走不上好，那么我这个版本这个空杆就建好了，建好了以后呢，我们激活它。

好前面的base变成了test，零五以后我们进入这个空调的环境。

![](img/268e93c81d55b0784a03bae340d12c3e_7.png)

那么这个环境中间是什么都没有装的，所以我们先按照这个包来一个键，就是首先把空大升级一下，升级到29。0，23。90。0这个版本。



![](img/268e93c81d55b0784a03bae340d12c3e_9.png)

目前并且社的那个地方特产有没有看到，那一定是，三弟不在说他的，我说森林房子。

![](img/268e93c81d55b0784a03bae340d12c3e_11.png)

升级完了以后呢，我们来把这个GITLAB装一下。

![](img/268e93c81d55b0784a03bae340d12c3e_13.png)

他现在这样挺热闹，这个JUPITLAB就是JUBEAT，notebook的升级版本的软件，其实它跟notebook用法是一样的，好像还没打，我来了，我就把你赢了，你也不能出来就好了。

话到时候来到越南那几年，其实话我一点不及抗拒你给打，好那么这样的话我就在这个新的空档中间，test05空中间呢就把我们的lab装好了，那么你就可以启动它，用这个GPA空格lab命令启动它。



![](img/268e93c81d55b0784a03bae340d12c3e_15.png)

比如说我们用浏览器打开。

![](img/268e93c81d55b0784a03bae340d12c3e_17.png)

那么我们就进入了这个Python的环境，然后呢我们把这个作者的这个，程序上传一下，然后呢数据的话就不要用作者的数据，因为作者的数据中间缺失值。



![](img/268e93c81d55b0784a03bae340d12c3e_19.png)

我们自己会有一个就是每分钟的比特币的数据。

![](img/268e93c81d55b0784a03bae340d12c3e_21.png)

也上传一下，这里是一个上传进度，好传完了以后呢，我们打开这个程序，好在这个时候呢，我们已经在Python的环境中看到这个程序了，就坐着这个程序了，那么我的建议不要直接上面跑，我们新建一个。

然后分段一段段跑过来，一段段的往这里跑，那么你先跑这一段，就是把机器学习这块放开，就先放第一段，看看能不能过，我们来运行一下，按住shift按回车，你会发现不能过，就连这个蓝牌都没有装。

说明他这个新的空调环境下面什么包都没有装，所以呢我们接下来把这些包都装掉，那么这里呢就会有这样子的，就是大家就用我这个install蓝牌pandas，和这个画图的包以及机器学习包，这四个包都要装。



![](img/268e93c81d55b0784a03bae340d12c3e_23.png)

那么这个时候怎么办呢，因为我这个窗口已经启动了这个安娜空大了，所以我再开一个窗口。

![](img/268e93c81d55b0784a03bae340d12c3e_25.png)

再开个窗口，那么你开的时候，他这个时候的大环境在base环境下，所以我还要再激活，我们刚刚新建的这个test05，这里切换了test05。



![](img/268e93c81d55b0784a03bae340d12c3e_27.png)

然后一个个的装，首先把南派装点。

![](img/268e93c81d55b0784a03bae340d12c3e_29.png)

现在这个样子，凤凰那边，12357关注，我顶多你接着说，我不说不说，不快就没，现在就让你知道你的胸口，嗯你想让它退掉了，你们需要的是什么东西，好难盘，装完了以后呢，我们再来装后面的。

再把这个pandas也装掉，就都指定这个版本就跟我一样就好了，这样可以确保这个城市的跑通，因为它是在独立的空档中间，所以它也不会影响别的环境，就只会在这个空档中间，它是按照这个环境来安装的。

那你们两个吃吃两个果实，好peas装完了以后呢。

![](img/268e93c81d55b0784a03bae340d12c3e_31.png)

我们再来装这个绘图。

![](img/268e93c81d55b0784a03bae340d12c3e_33.png)

和另外一个包，大家注意都在零五中间装独立的隔离出来，环境中装，暴雨的话全部，为家人做黑烟烟，听过歌唱时间，我是真怕把人你美得太难受。



![](img/268e93c81d55b0784a03bae340d12c3e_35.png)

好那么这里也装完了以后呢，这三个包子装完以后。

![](img/268e93c81d55b0784a03bae340d12c3e_37.png)

那么我们这个程序的第一行就能跑了，第一格中间就可以跑了，按住shift按回车，它就可以跑过去，我们看这个新号变成数字就OK了，代表它跑通了，如果他还是新的话，代表他还在跑，跑就变成数字，就代表他跑完了。

我们再来跑第二个，第二个就这一段，这一段大的呢它是有个机器学习库，所以你这样跑的话，那肯定也是跑不过去的，他会说缺这个模块，所以我们要继续在prompt里面装什么呢，装个机器学习模块，大概是装1。2。

2。

![](img/268e93c81d55b0784a03bae340d12c3e_39.png)

这么早啊，我刚才都出圈了，嘿嘿，哦你看看我穿上了，但现在差不多时间差不多的呀，差不多，就这么玩的都快挨打。



![](img/268e93c81d55b0784a03bae340d12c3e_41.png)

好那么这个机器学习我开始装完了以后，我们再来跑跑，看这个，我们再来跑这个按住shift回车，你就发现他跑过去了，没有报错，没有报错，然后跑第三段就是这一段，这挺偏的。

这一段呢你可能就会无论如何都跑不过去，因为它涉及到了这个中间有这个KERS，它被整合到TFLOW包里面去了，就是一个深度学习的包，但深度学习这个包呢它迭代了很多版本，所以它版本很混乱，你如果直接跑的话。

跑不过去的，所以呢我们先要做的事情就是把这两个装掉，那么这两个呢用空调装，可能网络会连不上，版本也不太对，所以我们就用PIP装pip装，首先装tensor，我们装到2。16。1，这是一个比较新的版本。



![](img/268e93c81d55b0784a03bae340d12c3e_43.png)

这个包很大，不是按17，17是高位好吧，不是干饭啦，现在多少多少，我只能买房子，为了帮小姐，听说明天啥的，还有一个地方是活着的，装好了吗，你不要，那么那边还不，我说阿姨您好，一个角度看，032车架。

帅哥哈喽，大家好好哭了，明白了，刚刚自选了，嗯嗯这边看看这边好看，走了走了走走谁呀，小庄好好过人，喝点啥，他可以开始打，A75条，27，还有你说过来的时候，他还在这就准备走，小红条茶，你喝的什么。

我喝了杯咖啡，喝了杯咖啡哦，你喜欢喝什么茶吗，我我我无所谓，我没开那个，这个因为它是一个很大的包，所以安装起来比较慢，有300多兆，可能这里就会等待一下，那么这个包的作用主要是在后期。

他会使用这个包中间的一个机器学习模型，来对行情做预测，我想看你笑那一下的那一，退守的爱情来，剩下回忆了回去的，我不行吗，1500吗，王子们现在有一个有一个活的人，他们自己写的只会说一般是，他今天上来。

就是那个，它下载完成以后装的这个过程也比较慢，所以大家稍微等一下，对应该是因为他带摩托车的，还可以替代不带摩托的，其实如果说他定一个目标的时候，可以不穿，我也可以解决这个问题。

但是你们家里面没有什么太好，就是不太好，不知道你们上次中国，然后不用再报道了，这个应该到底是没办法去配合。



![](img/268e93c81d55b0784a03bae340d12c3e_45.png)

好这样的话TFO就装完了，TPO装完了以后呢，然后还有最后一个包，就是有一个这个SCIKOS把它装掉。



![](img/268e93c81d55b0784a03bae340d12c3e_47.png)

那么基本上包就差不多了，这个装包的过程比较慢，但是有这样的过程的话，大家就可以知道，从一个比如说全新的空档，中间把这些东西都装上去。



![](img/268e93c81d55b0784a03bae340d12c3e_49.png)

大概是怎么样一个流程，这个包应该比较小，其实我们去年不是订了一批吗，看人家这个电车是什么，比如说他们物业，还有的农业经理长了很长了，但是你在那里扛了很多了，他到最后他就会给你提出来好。

这样的话就全装完了，全装完以后呢，那么大家看一下，你在你跑这步的时候，你可能还是跑不过去，青春前行的无水分多大，想陪你看穿了，我们这个时候所有的包都装完了，你会发现你还跑不过去，为什么呢。

是因为他写这个程序的时候呢，这个KOS这个东西还不在TFLOW里面，同时在后期呢他被整合到TFLOW中间去了，所以他这段代码需要改变，那么你问一下呃，人工智能或者自己谷歌搜索一下都可以。

所以他会建议你把这段代码改掉，改成什么呢，我这里call给大家的就是这一段，这一段和原作者是不一样的，那我们把它改成这个样子，这个体格下面啊，你们就抄我的就可以了，把这段改成这样好。

这样的话你看它变成数字就跑过去了，那么这三段都跑过去以后呢，后面就简单了，我们来看这个程序啊，当他这一包都读进去了以后呢，他就开始读这个数据集，那么它是用读的，这个就是他这个他自己这个sample。

但他这个sample的很早是201718年的数据，而且有很多缺失值，所以我们现在就用我们自己的这个数据，那我们这个数据是2021年5月1号，到2024年3月12号的，每一分钟的比特币的行情数据集。

那么我们怎么读这个数据集呢，我程序也拷给大家了，你们可以用我这段程序对对对对，整个那几个，当时甲方不是说先做两个嘛对吧，然后我们把这个东西全部包给他，加上我们就是整个一个算下来一个项目的成本。

他假装很大，因为他一年收入了，他本来就是一个响应业主的这种事情，你们要开关一下啊，他们觉得现在国际店是个很值这么多钱，靠我这张导数据的程序，那么这个中间有一个地方需要改。

这里的话呢定义每一列的名字和类型，这里呢是定义每一列的这个最后定下来的列名，那么但是这个地方要改，就这个地方呢，因为它是代表了他这个文件的路径，那么这个路径每个电脑都不一样，所以我们看看这个路径在哪。

路径在哪啊，我们找找到这个文件，现在就差着了，现在比如说是在这在这啊，所以我呢对于我来说，我是在E盘的，百度的百度网盘这个路径下面，所以呢，我们就这样粘过来，但是你会发现他这个斜杠啊是反的。

所以你也要变成反，因为在右边的右撇，右撇的斜方对Python是个特殊符号，所以我把它改成左撇的，是个斜杠好，然后我们来运行，我老是买的时候才1万一个，1万2的，这么贵的吗，这个数据集比较大。

大概有150万行，所以你看这里如果通过的话，那就读进来，读进来的话，你可以让它显示一下，比如说我display一下这个DATASET，这个名字就叫data set，就大家在读的时候，你给它命名为了。

所以这个数据的名字叫可以啊，所以我们能看到这里有1234，5677列和151万行，第一列的是时间戳，后面是开盘最高，最低收盘和按比特币计价的这个成交量，和按美元计价的成交量大概是这样。

每一分钟的数据都已经有了，那么到这里为止以后呢，那么我们再来复现它，这个数据程序就变得很简单了，因为数据读进来了，这里其实不用，我们就从三开始啊，比如说这里它是你就直接粘过来运行就好了。

他看看这个数据的形状，就可以照它运行151万行七列对吧，然后呢，这里呢它是显示一下这个数据的最后几行，但这里呢他，它会显示最后的五行显示给你看一下，就都照抄就可以了，照抄就可以了啊，然后。

这个地方呢是对这个数据进行描述性统计，就是每一个变量他的这个平均值标准差，然后各个分位点的值大概是多少，然后这里呢是查看这个数据集有没有缺失值，那么我们这个数据因为很干净，是没有缺失值的。

是我们自己整理好的好吧，那么他这里有个填充填充缺失值呢，因为我们没有缺失值，所以不用填充了，然后他把这个第一列的时间也直接删掉，因为他对预测行情没有帮助，他把它删掉，那么这样的话我这个数据就只有六列了。

只有六列了，好吧好，从4。2开始呢，他就开始建目标变量和特征变量了，那么这个这个地方呢它是建了一个目标变量，就是他的目标变量不是涨跌，就他这个建模这个作者做的有点奇怪啊。

它是定义了一个短期平均线和一个长期平均线，如果短期平均线在长期平均线之上的话呢，他认为是一买入，如果他在他以下的话，那就零卖出，所以呢他这个signal作为，类似于我们线性回归方程的Y这一项，Y这一项。

他这里定义了Y，定了定了娃以后呢，后面呢这里呢特征工程它就开始定义X，那么这里呢我们具体不解释了，你们可以把这个代码一段一段的，贴到人工智能里面，问他什么意思，比如说这是一个加权的一个呃平均线啊。

叫什么叫均线，均线就是他会对近期的价格给予更大的权重，而不像普通的均线这样的，大家可以等权重的，包括什么ROCRM动量啊，ISI啊，都是一些股票常用的指标啊，然后我们整个粘过来就好了。

他只是再生成一些特征，变X就是我们线性回归的时候，Y等于KX中间一系列的X运行一下，然后看看他这个心会不会变成数字，变成数字就跑过去了，好他们的数字就成跑成功了，那么这里呢继续还在生成，特种兵X，好。

那么大家可以看到这个时候呢，我们这个数据表中间，除了我们原先的一些列以外呢，后面就生成了很多，特征变量都只有signal，是我们的目标变量Y，别的都是XX两点左右最低的好，那么Y和X都建立完了以后呢。

这里只是用来显示的，我就不用跑啊，然后呢，他这里把不参与建模的一些变量都删掉了，DP掉了，让这个数据集变得更简单，然后这里呢是把有缺失值的行给去掉，就是有些行，因为我们在计算移动平均的时候。

它会有些行缺失值，所以我们把它去掉啊，确保每每每每一行都是有数据的，他说的暂时不用看啊，好那么到这里为止呢，我们就整个数据处理完了，处理完了以后呢，就做些可视化，比如说这个地方呢可能我们需要改一下。

就因为这个，集中集中是没有的，所以我们就画一下close，看看它的走势就可以了，好我们能看到这个比特币在2021年5月，到2024年3月三月呢经历了两轮，就是下跌到上涨，再下跌到上涨啊。

那么这样的话它的数据采样率比较充分，就有两轮熊市，两轮牛市比较充分，然后呢，这里呢是对各个特征变量做了一个直方图，就看一下分布时间关系啊，我们就把它跑通就可以了，第一次不要对他要求太高。

我们先看看程序里面的跑通，后续再来修改它，不好意思，好那么他这把特殊变量都跑出来了，跑出来了，跑出来了以后呢，这里是看目标变量的分布，就是这个Y到底有多少个，买入信号多少个卖出信号。

那么他可以看看他两个是比较比较平均的，比较平均的啊，好这里是计算相关系数矩阵，因为如果是共线性的变量的话呢，在建模的时候，我们可能不会把它都放进去，所以来这里先做一个相关数据。

真的后期后期用来筛选特征变量，先放在这里，先不要动不要动好，到第五步我们就开始建模的时候呢，他这里是从中间抽样了10万的数据，其实呢这个做法有点值得商榷，因为我们看啊，就是如果你这样建模的话。



![](img/268e93c81d55b0784a03bae340d12c3e_51.png)

你只抽样，你你在建模的时候，你可能只在建了这一块，就最近的10万条，因为它一共有150万条，你只抽了1/15的数据呢，正好这段时间都在上涨，所以建模是有问题的，所以其实应该改成150万公务员名下。

但是考虑到时间关系，就是150万的话，后面跑起来比较慢，所以我们演示的时候，就还是按照他原来的样子啊，我们还是按照他的样子抽，后续大家真的用的时候可以自己改，然后呢这里呢是设置了一下。

就是我的随机数以及它的一些模型评估的标准，他把这四个方法清掉了，所以他只用这个保护轮精确度的标准啊，你们可以自己修改自己的需要，然后这里开始就是他建了多个模型，他尝试的比如说逻辑回归啊，KNCART啊。

神经网络啊对吧，会有一些梯度梯度上升啊，随机森林啊，它会有各种各样的模型，他现在都放在这里，好放了以后呢，列表放好以后呢，然后呢这一步就是跑模型了，但是你这步呢跑起来很慢的，但是如果你直接粘的话。

你会发现他少一个参数，你跑不过去的，在哪里呢，就在这个地方，我记得是他漏了一个SHFNTR，应该漏了这样一个东西，就是这个参数它漏了，所以你加了这个以后，他就开始跑了，跑了以后呢，那么它就会。

大家稍微等一下啊，他就会因为这步是比较慢的，因为它要真正的开始训练模型了嘛，他就会把每一个模型的结果输出，就是这里呢是准确度，那么这里呢是标准差，所以你可以这样理解，就准确度越高，标准差越小。

那么这个模型就代表越好，这个过程会比较慢，那么后面呢我就不演示下去了，大家只要一步步的跑就可以了，你看他这样一个出来了，就是LR就逻辑回归的话，可能是0。89，这个标准还比较小。

当然他这个他这个模型我觉得是有点问题的，因为他预测的东西目标变得有点奇怪，他不是预测未来，比如说15分钟，30分钟的涨跌，所以我们只看他一个框架，就整个框架是怎么下来的，然后来修改它们啊。

并不要完全按照他来做啊，所以第一次来我们追求的目标不要太高，就先把它整个模型模型跑通，看看别人是怎么个流程，那么具体真的自己要操作的时候，自己再参考它来改就可以了，那么这里的比较慢，我后面就不演示了。

所以大家后面的话就接下来跟他一样，就一直一步一步的跑下去，可以应该就没有什么问题，我大概解释一下啊，这里就做了模型的准确率的各个的一个分布啊，就各个模型下面是各个模型对应的。

它的精确度和它的波动性波动性，那么这里呢就是它已经定下来了，他发现了这个中间RF这个模型，随机森林这个模型比较好，所以他决定用随机森林这个模型，所以在这里呢他这里做了一个什么呢，就做了一个网格搜索。

因为随机森林模型的时候呢，他需要设参数，就是有一个estimate和一个最大深度，那么这两个值多少，你不知道，所以他这里做了一个网格搜索，他的十和80，所以呢它最终完成的模型的时候。

他就使用随机森林模型，然后把这两个参数设好，设好以后做了个预测，做了预测一下，这里做了一个混淆矩阵，我就是来看它的准确度啊，对比一下，最后呢这里做了一个变量变量重要性，变量重要性。

就是到底哪个变量对这个Y的预测权重最高，然后最后做了个回测，back test啊，他他这个回撤也很奇怪，就是他因为他预测的这个取样区间，就一直上涨了，因为最后一轮牛市嘛，所以他就一直是上涨。

而且呢它是以呃短期均线在长期线之上，它是一个实际的这样的一个表现呢，就买入在之下的话，那就空仓这样做了一个，然后呢预测的话呢，也是就是我预测的结果是买入，那么就买入预测的结果是零就空仓。

那么这两个呢你会发现这两个线都差不多对吧，最后呢他做了个回测，所以呢他这个东西我个人觉得嗯，作为一个初步的使用机器学习模型，来分析价格走势的框架而言的话，还是比较有参考意义的。

但是如果只是像他这样做的话，用来实战的话，还是可能不太够，我们需要后续的修改。

![](img/268e93c81d55b0784a03bae340d12c3e_53.png)

所以这个视频呢大家就这样理解啊，我们只要理解它中间整体的框架，是大概涉及到哪些步骤，以及能够把整个模型先跑通，因为这个如果跑通了以后呢，后续我们再来改它的话呢，就不会遇到。

比如说我们在一开始装库的这些问题。

![](img/268e93c81d55b0784a03bae340d12c3e_55.png)

因为我们的库都已经装掉了，包括后面会涉及到一些啊错误的问题，我们也都已经有一些心得了，那么再做下一步就会比较简单啊，大概是这样一个过程。



![](img/268e93c81d55b0784a03bae340d12c3e_57.png)

那么就这样。