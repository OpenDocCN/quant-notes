# 【比刷剧还爽！】这太完整了！量化交易和python金融分析实战课程，全程干货无废话 入门到精通一步到位！（数据挖掘分析／大数据／可视化／投资／金融／股票／算法） - P35：37. 37.37.因子数据预处理(Av1302064773,P37) - AI算法-溜溜 - BV1iC411n7XN

![](img/d7912d66164b6879b363cb899b624bf1_0.png)

要进来呃，指标查询码了之后，那是不是说我们得做这个啊预处理操作了。

![](img/d7912d66164b6879b363cb899b624bf1_2.png)

预处理操作在这个预处理操作当中啊，咱是不是就是之前给大家说了。

![](img/d7912d66164b6879b363cb899b624bf1_4.png)

咱们三步走，第一步要去疾驰。

![](img/d7912d66164b6879b363cb899b624bf1_6.png)

第二步标准化，第三步中性化啊，好了再来写吧，第一步我们要做一个呃去极值去其时啊。

![](img/d7912d66164b6879b363cb899b624bf1_8.png)

方法挺多，咱们简单点就用这个三西格玛。

![](img/d7912d66164b6879b363cb899b624bf1_10.png)

这个比较好用，然后呢第二步第二步啊，我说我要做一个什么，做一个标准化。

![](img/d7912d66164b6879b363cb899b624bf1_12.png)

就是一个DDER啊，做一次一个standard的操作。

![](img/d7912d66164b6879b363cb899b624bf1_14.png)

然后呢第三步第三步啊，咱们说要做一个中性化的一个操作。

![](img/d7912d66164b6879b363cb899b624bf1_16.png)

咱们来写一下，完成我们当前的一个中性化的操作行了。

![](img/d7912d66164b6879b363cb899b624bf1_18.png)

就这三步就可以了啊，这这样吧，咱们先把三个函数我们写完。

![](img/d7912d66164b6879b363cb899b624bf1_20.png)

然后呢写完三个函数之后，咱们再来去，在这里直接去掉啊，相当于离群值。

![](img/d7912d66164b6879b363cb899b624bf1_22.png)

你要自己写函数，然后标准化自己写，然后中心化也得自己写，比较麻烦。

![](img/d7912d66164b6879b363cb899b624bf1_24.png)

先写第一个，第一个就是一个聚集值啊，再来写一下FTER。

![](img/d7912d66164b6879b363cb899b624bf1_26.png)

这是什么呢，filter一个三啊，GIGA就行了，在这里啊。

![](img/d7912d66164b6879b363cb899b624bf1_28.png)

咱们来想一想我传入是什么，那是不是传入一个指标啊，然后呢咱之前说了。

![](img/d7912d66164b6879b363cb899b624bf1_30.png)

是不是有个三四个码N等于什么，N等于三吧，好了，接下来咱们来写第一步。

![](img/d7912d66164b6879b363cb899b624bf1_32.png)

在三四法当中，你是不是得说我算出来均值和标准差了一下。

![](img/d7912d66164b6879b363cb899b624bf1_34.png)

还差在这里，我们的一个均值比较简单啊。

![](img/d7912d66164b6879b363cb899b624bf1_36.png)

跟咱们之前写的都是一模一样的，在这里就是一个点幂。

![](img/d7912d66164b6879b363cb899b624bf1_38.png)

然后STD就是它的一个点TD就行了。

![](img/d7912d66164b6879b363cb899b624bf1_40.png)

那么接下来就是一个max，还有这样一个一个命啊，咱们都分别指定一下我的一个上限。

![](img/d7912d66164b6879b363cb899b624bf1_42.png)

还有一个下签range，这也是一个range。

![](img/d7912d66164b6879b363cb899b624bf1_44.png)

等于什么，就等于唉我当前的一个均值，然后加上或者减去多少倍的一个哎。

![](img/d7912d66164b6879b363cb899b624bf1_46.png)

就是加上一个N倍。

![](img/d7912d66164b6879b363cb899b624bf1_48.png)

这里就是30个嘛，三乘上我当前的一个STD是就行了，然后这一块下面都是一样的，只不过说它就是一个减号，咱就完事了，这样就完成了第一个啊，像这还没完成，还得给turn一个值return，在这个安排当中。

我得把这些值不是真正的去掉，而是把它做一个规范啊。

![](img/d7912d66164b6879b363cb899b624bf1_50.png)

在这里series s给它传进去，然后我们两个参数的两个界限在指定好。

![](img/d7912d66164b6879b363cb899b624bf1_52.png)

这就行，第一个界线，然后还有我们的第二个界限好了。

![](img/d7912d66164b6879b363cb899b624bf1_54.png)

这是一个我们的来写一下吧，这里这步操作啊。

![](img/d7912d66164b6879b363cb899b624bf1_56.png)

我们的一个呃去离群点吧，或者是去啊极值吧。

![](img/d7912d66164b6879b363cb899b624bf1_58.png)

去极值操作好了，接下来我们再来写还有什么。

![](img/d7912d66164b6879b363cb899b624bf1_60.png)

接下来就是我们第二个第二个当中呃，要去做这样一个标准化。

![](img/d7912d66164b6879b363cb899b624bf1_62.png)

我们来写标准化操作好了，写一下，我们重新创建一个函数。

![](img/d7912d66164b6879b363cb899b624bf1_64.png)

在这个函数当中啊，咱们来写标准化操作，其实听写体验是挺简单的。

![](img/d7912d66164b6879b363cb899b624bf1_66.png)

劝我们干什么，其实方法都是一样的，都是需要咱们去计算出来，Stander t a n d。

![](img/d7912d66164b6879b363cb899b624bf1_68.png)

都是需要我们去计算出来一些指标吧。

![](img/d7912d66164b6879b363cb899b624bf1_70.png)

好了，然后咱们一个呃thunder就叫三角得了了。

![](img/d7912d66164b6879b363cb899b624bf1_72.png)

在这里我们来持续一下标准化操作当中啊，咱们要做这样一件事。

![](img/d7912d66164b6879b363cb899b624bf1_74.png)

首先还是这两个值，这池支付都可以直接复制过来了，这直接复制过来。

![](img/d7912d66164b6879b363cb899b624bf1_76.png)

然后我的一个参数也是直接复制过来，然后这块他直接return一个结果。

![](img/d7912d66164b6879b363cb899b624bf1_78.png)

return一下咱第一个series，然后减去一个灭，然后哦在这这哎再比上这样一个标准差异型。

![](img/d7912d66164b6879b363cb899b624bf1_80.png)

再比上一个STD就完事了，这是个标准化操作吧，好了咱们也下一个。

![](img/d7912d66164b6879b363cb899b624bf1_82.png)

下一个，咱之前是不是没写过叫中性化操作。

![](img/d7912d66164b6879b363cb899b624bf1_84.png)

中心化是这样，我们在中心化当中啊，之前说了，我们要干什么，是不是我说要去做一个回归方程啊。

![](img/d7912d66164b6879b363cb899b624bf1_86.png)

在这个回归方程当中。

![](img/d7912d66164b6879b363cb899b624bf1_88.png)

我们都要干什么，是不是第一步哎，我滴妈这个回归方程给他怎么样，给他求解出来吧。

![](img/d7912d66164b6879b363cb899b624bf1_90.png)

求解完出来之后呢，把做一个NURAL得了，求解完出来，求解出来之后，我说咱们要用一个真实值减预测值，减完之后，相当于诶。



![](img/d7912d66164b6879b363cb899b624bf1_92.png)

我这个因子，它自身应该自身的一个价值是等于多少吧，但是咱们来想一想，这里有需要几个参数啊，哎这里咱们需要几个参数。



![](img/d7912d66164b6879b363cb899b624bf1_94.png)

咱们之前是不是说了，我看一下这个市净率诶，跟我市值之间的关系啊，那其实对于我们的一个市净率来说。

![](img/d7912d66164b6879b363cb899b624bf1_96.png)

它是啥，它是我们这个因子吧，就是我们这个factor。

![](img/d7912d66164b6879b363cb899b624bf1_98.png)

然后呢我们要要拿这个factor跟谁做对比啊，是不是跟刚才拿出来这个指标啊。

![](img/d7912d66164b6879b363cb899b624bf1_100.png)

我直接复制过来了，直接复制过来。

![](img/d7912d66164b6879b363cb899b624bf1_102.png)

拿我们的市净率跟我们这个市值做一些事了，好了，把它拿过来。

![](img/d7912d66164b6879b363cb899b624bf1_104.png)

在这里呢咱们说一下，就是谁是X谁是YY是谁啊，其实这里不用写Y啊。

![](img/d7912d66164b6879b363cb899b624bf1_106.png)

咱们直接用这个参数型，但是让大家看的更明显一点啊，再给大家强调一遍，Y是谁啊。

![](img/d7912d66164b6879b363cb899b624bf1_108.png)

是不是看我的一个市值哎，对这个factor影响有多大，那谁是YY就是我的一个音。

![](img/d7912d66164b6879b363cb899b624bf1_110.png)

就是咱们这个因子吧，好了，Y是因子X呢。

![](img/d7912d66164b6879b363cb899b624bf1_112.png)

X哎是我当前的一个市值吧，这没问题吧。

![](img/d7912d66164b6879b363cb899b624bf1_114.png)

好了，接下来咱们之前是不是导进来一个models哦，这块咱们来指定一下。

![](img/d7912d66164b6879b363cb899b624bf1_116.png)

这块我得把他的API再导进来一下呃，import评价在这个models当中。

![](img/d7912d66164b6879b363cb899b624bf1_118.png)

然后呃点API。

![](img/d7912d66164b6879b363cb899b624bf1_120.png)

然后一个SMSM码，这里我们要用最小二乘法来做一个求解。

![](img/d7912d66164b6879b363cb899b624bf1_122.png)

所以说我得把这个state models拿到手，在这个step model当中。

![](img/d7912d66164b6879b363cb899b624bf1_124.png)

在这个model当中咱们缺点什么，线性回归方程吧，说白了啊，往简单说，我们要做一个最小二乘法vs，在这个OS当中啊，我们要传递两个参数。



![](img/d7912d66164b6879b363cb899b624bf1_126.png)

第一个就是一个Y值，第二个就是一个X值，咱们先写Y，然后他有要求就是得是一个flow类型。

![](img/d7912d66164b6879b363cb899b624bf1_128.png)

最好给他转成一个flow类型，tap下f type成咱们的一个flow类型。

![](img/d7912d66164b6879b363cb899b624bf1_130.png)

然后这是一个Y。

![](img/d7912d66164b6879b363cb899b624bf1_132.png)

然后接下来是xx也是一样的，传进来我们的一个标签。

![](img/d7912d66164b6879b363cb899b624bf1_134.png)

还有我们的一个数据，这就行了，然后呢他会把这个模型给我返回来。

![](img/d7912d66164b6879b363cb899b624bf1_136.png)

我写一个result吧，这就是我的模型，在我的模型当中啊，你说其实我想要的是谁啊。

![](img/d7912d66164b6879b363cb899b624bf1_138.png)

我想要return什么，是不是，我要return我的一个真实值。

![](img/d7912d66164b6879b363cb899b624bf1_140.png)

和我的一个预测值之间的一个差异啊，好了，在这个this model当中啊。

![](img/d7912d66164b6879b363cb899b624bf1_142.png)

咱有个简单方法，你直接return什么，result当中，它有一个方法呃。

![](img/d7912d66164b6879b363cb899b624bf1_144.png)

叫做我们的一个残差来找一下哦。

![](img/d7912d66164b6879b363cb899b624bf1_146.png)

这个叫做我们的参差，但是不是这个把DL去掉，这样咱们先返回什么。

![](img/d7912d66164b6879b363cb899b624bf1_148.png)

就是你去除掉了啊，在这个线性微分方程当中，你把这个W加B给去掉了。

![](img/d7912d66164b6879b363cb899b624bf1_150.png)

相当于把咱们市值影响啊，它的一个因素去掉了。

![](img/d7912d66164b6879b363cb899b624bf1_152.png)

那这个fighter相当于是比较纯的了，咱现在就完成了一个纯的操作。

![](img/d7912d66164b6879b363cb899b624bf1_154.png)

方法是比较简单啊，啊咱们用这个state models。

![](img/d7912d66164b6879b363cb899b624bf1_156.png)

它这个属性啊，直接帮我们自动的算一个差异值了，大家感兴趣，你可以自己上一件API当中看一下啊。

![](img/d7912d66164b6879b363cb899b624bf1_158.png)

![](img/d7912d66164b6879b363cb899b624bf1_159.png)