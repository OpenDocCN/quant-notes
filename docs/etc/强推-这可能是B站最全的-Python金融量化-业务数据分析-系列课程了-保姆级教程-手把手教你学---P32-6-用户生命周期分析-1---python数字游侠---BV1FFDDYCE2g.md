# 强推！这可能是B站最全的【Python金融量化+业务数据分析】系列课程了，保姆级教程，手把手教你学 - P32：6.用户生命周期分析~1 - python数字游侠 - BV1FFDDYCE2g

第五部分的话，主要是对咱们用户的生命周期进行的一个分析，那么在这块，咱们主要是针对我们的用户的消费，的一个记录呢，对其进行一个活跃度的划分对吧，我们说可以把它分成这个活用户，回头客，用户。

连续用户等等等等吧，那么这块怎么去划分呢，首先我们逐步来做啊，首先第一个我们先要统计我们每一个用户，每个月的一个消费次数啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_1.png)

那么这块咱们怎么去统计每个用户，每个月的消费次数呢。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_3.png)

啊那么在这的话咱们还是继续啊，练习一下咱们的一个透视表吧，DFDR啊，这个p vot table，那首先这块的话，我们index是我们这个分类的一个条件吧，分类条件的话一定是咱们的一个用户跟id。

因为咱们要统计每一个用户，每个月的一个消费次数吧对吧，那这我们只用来统计它的一个消费次数啊，那么这个value我们只让它显示我们的时间可以吧，order杠DT对吧，将我们的一个什么a j j funk。

给它设定成什么呢，不统计个数啊，默认AJFK是求均值啊，我们能对时间求均值吗。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_5.png)

不能吧，是不是只能对我们的时间求统计个数啊，对不对，好在这咱们去执行走，那这所返回的是什么呢。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_7.png)

是不是在我们的这个order杠DT时间当中，是不是消费了一次啊，2号用户消费两次，3号用户是不是消费六次啊，那咱们有没有算出用户在哪个时间或哪个月，消费了，没有吧，咱们在这视频上想统计。

每个用户每个月的消费次数啊，比如说三个用户一共消费60万，那六次分别是分布在哪个月当中的，不知道吧，怎么办，在这用一下我们的这个columns，columns怎么说，是不是对我们的这个values。

再进行一个细致的分组啊对吧，那在十进当中能不能再根据六份分组啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_9.png)

走看一下，在时间当中又对月份进行了一个分组。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_11.png)

那还是看一下，我们说3号用户一共消费六次吧，这六次分别是不是在这个这个1月份，这是几月份，3月份吧，这是不是我们的4月份啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_13.png)

啊这在我们的这个97年的10月份，是不是还消费两次啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_15.png)

对不对，在我们的98年5月份是不是又消了一次啊，在这咱们就求出了我们的每一个用户，每个月所消费的一个次数吧，不根据我们的月份进行了一个展示啊对吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_17.png)

这个none，就是说我们用户是不是在这个月份，是没有消费啊，是n none。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_19.png)

不好看，是不是怎么办，我们第二需求，是不是将我们的这个NN全部给他，这个换成这个零就比较好看了，怎么办呢，是不是点F哪一次FU呢，是不是将我们的空值进行填充啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_21.png)

将所有的空指定填充成零，行不行走，使用的啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_23.png)

那属于叫什么，可以了吧对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_25.png)

刚才我们分数的名字写错了啊，那这样的话我们看一下，那理应就表示用户在当前月份没有消费吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_27.png)

一就表示消费一次，二表示在当前月份是消费两次啊，对不对好。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_29.png)

那这块的话，咱们就求出了每一个用户，在每个月的一个消费次数吧对吧，把这个表能保存一下，我们叫每一个用户在每个月的一个消费的次数。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_31.png)

OK吧，那么这样的一个data frame是不是就有了，这不就有了吧，好接下来我们再看啊，那如果想统计我们这个什么呢，这个用户的一个回路的话。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_33.png)

我们看他的一个消费次数怎么用的，我们只需要重点去关注，我们用户到底是否消费了吧，消费几次没关系，比如说我有一个用户连续三个月，每个月都消额消费了一次是吧，或者一个用户呢一个月消费了三次。

那哪个可以看出他的回忆录呢，意味着我们用户如果在不同月份，连续消费的次数越多，它活跃度越高啊对吧，灰度并不是针对于，并不是侧重于它的一个消费的金钱，或消费一个产品的数量吧，而是说他有没有消费，是不是。

所以说咱们的第二步，就是说统计每个用户每个月是否消费了，消费我就记为一，没有消费就记为零就可以了，OK吧那看一下啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_35.png)

在这啊哎，在这我们显示一下他啊，这有点卡啊，我们看一下，点head就是在这个表当中。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_37.png)

我们会发现用户到底消费了几次，是不是有明确的记录啊对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_39.png)

现在就是说我不管他消费几次，我只需要关注它是否消费的啊，比如说你看这个用户二，是不是在这个1月份消费两次啊是吧，我们说只要他消费，我就记为一，没消费即为零，是不是就可以了对吧，我不管他消费几次。

所以说在这我们需要统计每个用户，每个月是否消费，消费记录为一，否则记录为零吧，消费几次几次我就不记录了吧是吧，就是需要把这张表当中所有零还给分成零吧，所有非零的值是不是负为一就行了。

一就表示他消费了是吧，消费几次，我不管吧，那怎么做，不需要对这个data frame的每一个元素，进行一个判断啊，怎么判断，如果调一个点儿啊，ply map的一个方法。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_41.png)

那么这个PLAYMAP主要是干嘛使的呀，这我写了啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_43.png)

apply map是对我们date frame当中的每一个元素，进行操作的。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_45.png)

而我们的apply，是不是对我们data frame当中的行或列进行操作的，对不对好。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_47.png)

那这样的话我们对每个元素进行怎么操作呢，进行一个啊，我们用匿名函数写一个操作的一个法则吧，可以吧，好比如说if，如果我们的X要是大于等于大于等于这个一啊，我们就让它返回1else，返回一个零。

可以吧对吧，这个表达式能看懂吧，拉姆的表达式就意味着，我们这个X是不是，我们date frame当中的每一个元素啊，每个元素我要判断，如果每个元素大于等于一，那么我返回的是一，对不对，如果反之。

就说小于100就返回零呗，对不对好，那这块的话我们就把它存到这个表当中，OK吧我们来看一下这个表走。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_49.png)

那现在这个表当中就没有二了吧，是不是只有零和一啊，一就表示用户消费了，零就表示用户是不是在当月没有消费啊，对不对，你会发现你看4号用户是不是在这两个月之内，是不是连续消费两次啊对吧。

然后你看这个五行用户是不是在这几个月当中，是不是连续消费四次啊对吧，根据他是否连续消费啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_51.png)

我们就能够判定他的一个什么呢，判定他的一个回度啊，那么这个灰度怎么判定呢。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_53.png)

好我们来这去看一下啊，看一下，比如说这块我们看一下这个活用户，就是说如果连续月份购买的用户，在这些月份当中为活用户啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_55.png)

你比如说啊，比如说在这看一下，我们说这个什么呢，这个这个5号用户吧，5号用户是不是在这三四个月之内，是不是连续消费了，那么5号用户在这四个月之内，他们都被称之为这个连续用户。

就说5号用户是不是在这个月是连续用户，活用户吧，就在这个月也是混用户，在这个月也是回应户，在这个月也是会运户，而这个月就不是了吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_57.png)

这个月他没有消费，就不再是活用户了，是不是OK吧啊，那还有什么呢，还有我们的回头跟回，就是共购买之后，间隔N个月再次购买的第一个月。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_59.png)

称之为回头客用户，你比如说啊，比如说你看这个这个8号用户。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_61.png)

看一下8号会是不是前两个月连续购买了对吧，然后的话是不是中间间隔了几个月没有购买啊，在间隔几个月没有购买，又连续购买的第一个月份，是不是在一个月份，那8号位户被称之为回头用户啊对吧。

就是8号用户只有在什么，只有在这个6月份当中。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_63.png)

是不是称之为回头客用户，在5月5月份吧，它又不是回头用户了吧对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_65.png)

那在这咱们就能够知道怎么去分析，怎么去对它的回路进行划分吧，我们这会划分成官网用户，前两个月没买，第三个月才第一次买，则该用户在前两个月没有买的月份，被称之为官网用户啊，非回用户信用户，连续用户。

回头客用户。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_67.png)

各位自己去看一下，OK吧，那这块就说用来判定我们的每一行数据，就说看一号用户。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_69.png)

那根据这一行我就看它零一分布的一个规律，我就能够知道他在每个月到底是属于哪个用户。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_71.png)

吧对吧，那这个算法怎么去写呢，这块我们有固定的算法啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_73.png)

固定算法在这我们就写一下，这个就是我们所谓的一个固定算法。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_75.png)

OK吧，叫做active gstates，这传入是data data，指的是我们这张表当中的。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_77.png)

每一个用户所对应的每一行数据，这行数据，我们要是你看这一行，一共是不是有18个数据啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_79.png)

18个值吧，18个零一吧，我们要对这18个零一进行一个什么。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_81.png)

进行连续分布的一个什么呢，分布的一个规律的一个探索，对不对啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_83.png)

那么这块的话，你可以自行的去看一下它，零一到底是怎么排列的，看一下那零一排列的不同。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_85.png)

会导致用户在不同月份所对应的活跃度不同吧，对吧，那这个算法你看懂也行，看不懂直接照抄就OK了，他是一个固定算法对吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_87.png)

固定算法啊，只需要把它是作用在看，是在这直接用调用使用我们的这个DF，是不是调用我们的play啊，apply就是说直接将我们的什么呀，将我们的这个每一行，将我们的这个data frame当中。

每一行是不是作用到这个函数当中啊，对不对，那最终啊最终给我返回的结果啊，给我返回的结果就有什么，看最终返回是space。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_89.png)

space是什么呀，states是一个列表，列表，里边放的是每一个用户。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_91.png)

在每个月所对应的活跃度，OK吧，那么执行之后看下结果走。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_93.png)

我们只看前五行啊，只看前五行还的运算吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_95.png)

因为数据比较多，是不是它会对我们的每一行，每一行当中的0101的一个分布规律，将每一行当中的零和一给它变成我们的什么呢。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_97.png)

变成我们的这个这个官方用户的非回应户了，新用户的回应户的等等这些字符串吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_99.png)

听见了吗，现在我们就拿到了这样的一个结果吧，听到了吗，那这样的结果啊，看这个结果，当你看这个user id是不是一样，你看这返回的是不是个series啊对吧，你看这个series3，你看这个11号用户。

你看后边就是一号用户，在第一个月是新用户吧，第二个月是官网用户，第三个月是不是也是官网用户是吧，看二你再看我们的这个5号用户吧，5号用户第一个月是新用户，第二个月是不是连续购买，是额活用户啊。

第三个月没有买，是不是我们的这个光用户是吧，没有买之后是不是又买了，是不是回头客用户啊，再连续买是不是活用户啊，对不对啊，挥霍啊，那这块我们就得到了这样的一个。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_101.png)

这个是我们得到了这样的一个series对吧，serious啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_103.png)

那么这个SERI咱们得到之后的话，我们就知道每一个用户所对应的一个回度了吧，对吧，你看那这块的话，你看我们的每一个series s对应的值，一共有18个值吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_105.png)

18个值对应的是我们上边的什么呀，上边的每个月份的是吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_107.png)

是不是每个时间每个月份呢对吧，你也可以把这个serious，再填充到我们的这个data frame当中。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_109.png)

是不是也可以啊对吧，填充回血也会呗。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_111.png)

也OK是不是也OK啊，好这样的话我们的活跃度就已经可以拿到了吧，就可以拿到了啊，然后的话咱们在这去填充一下试试吧，填充一下试试啊，毕竟在这看serious不方便，是不是不方便啊，我们就可以再填充一下。

那这块填充的话，我们怎么填充呢，在这的话我们就直接像我们的这个什么呢。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_113.png)

用一下我们的这个表。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_115.png)

这个表是吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_117.png)

你看这个表当中它的行列索引，看这个列。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_119.png)

这个行索引是跟我们的series，和这个这个索引是一样的呀对吧，只不过你看这块我们的这个什么呢，这块我们的这个series当中的这个值，这个值对应的应该是我们前边的这个。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_121.png)

这个表当中的每个月份吧对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_123.png)

那这块你填充的话，就是说这么填充啊，就是说看一下我们这就显示前五行吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_125.png)

![](img/06f7773e6a35c17749cfddf4fcd07cc2_126.png)

那是前五行啊，看一下，那意味着你看一下我们这对比一下啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_128.png)

对比一下，那在这的话你看这个处啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_130.png)

一号用户你看一号用户的话，那么这个NEO对应的不就是我们的这个值吗。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_132.png)

对不对，就说一号用户是不是在这个月份。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_134.png)

是我们的这个什么的这个新用户啊，后边都是零，是不是就是我们的官网用户啊是吧，这样的话以此类推，咱们就可以得到这样一个结论，是不是得到这样的结论啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_136.png)

好那这块的话咱们怎么给它进行一个填充呢。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_138.png)

那我们来看一下这块的话，我们怎么把这个series当中的值对吧，给他以data frame的形式显示一下吧对吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_140.png)

刚才我们说这个series当中的id啊，这个这个索引跟它的值，各表示的含义是什么了吧对吧，那这块我们怎么把它换成一个data frame呢，就是说将这些个什么这些个灰度对吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_142.png)

然后给它填充到我们的前边的，这些个0101当中吧对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_144.png)

那这块咱们怎么去做呢，可以这么去玩啊，这么去玩，首先我们可以把这个series啊，它的一个values拿到，是不是拿他的这个值啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_146.png)

因为你要知道这个series的索引，是不是跟我们前边的这个表。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_148.png)

它的user id是一样的对吧，那这块拿到呃values之后呢，我们就拿到他的所有的元素，那这个元素返回的是一个error数组吧，你在这点儿凸给它转成一个list的，转成一个列表，转成列表之后的话。

这个列表是不是可以作为一个data frame，的一个数据源呢对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_150.png)

那这块的话我们创建一个创建一个data frame啊，好这个data frame的话我们起个名叫它吧，这个data from就等于data frame，然后的话我们的数据源，数据源的话。

就等于它是不是像我们series的这个值拿到，转成一个列表，因为列表可以充当咱们的这个数据源是吧，好充当数据源啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_152.png)

数据有了之后的话，现在我们看一下这个新的data frame，它的一个元素啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_154.png)

就变成了我们的这个这个什么呢，每个用户他的一个回度了吧，那行列索引得换一下呀对吧，这个data frame它的一个行索引CONSO。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_156.png)

是不是应该就是我们的这个表，它的user id啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_158.png)

这个id不就是我们这个表的行索引吗，列索引是不是时间好，把这个表当中的行列索引拿过来，第2index好，columns就等于这个表当中的什么呢，columns吧是吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_160.png)

好在这的话我们执行一下，那现在我们就将series当中的元素给它。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_162.png)

汇总到了一个新的data frame当中吧对吧，这个data form所显示的就是说，你看一号用户是不是在月份是新用户，2月份后边都是光用户啊对吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_164.png)

以此类推啊，以此类推，现在那么这个回度的划分，我们这块是不是就拿到了对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_166.png)

就拿到了啊，叫做这个表，对不对，拿到了拿到之后呢，下一步干啥呢，下一步我们下一步我们需要对回度进行计数吧，那就是说我们要知道啊。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_168.png)

知道，那么我们的这个商家在1月份，他的这些用户到底有哪些是活用户，哪些是连续用户，哪些是回头客吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_170.png)

把这些用户做一个计数吧对吧，这块怎么计数呢，这块做计数的话，咱们就可以调用这样的一个方法看一下啊，应用这样的方法是在干什么呢。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_172.png)

我们来看一下啊，在这的话首先这个是我们得到的这个表格呀，Data frame apply，Apply，是不是对我们的这个我们的这个data frame的行列，进行一个操作啊。

那这块的话我们操作是行还是列呢，操作的是不是列啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_174.png)

我们是为什么操作列，是因为我们要统计每个月对吧，每个月这些不同回度用户的一个个数吧对吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_176.png)

那这块我们的xis不写，默认是零零，就是操作列吧对吧，那这块我们需要apply传入一个运算法则，运算法则用了一个匿名函数吧对吧，匿名函数，这个匿名函数我们在这调的是一个value杠。

cos是一个这个这个pd啊，这个pd当中给我们封装好的这个函数吧，它是不是用来统计个数的，是统计我们的这个这个data frame当中，每一列所对应元素的个数啊对吧，如果没有的话，是不是填充点啊对吧走。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_178.png)

那现在我们就会得到啊，看一下在我们的这个月份对吧，1月份月份的话，这个这个活用户是零对吧，然后新用户是这么多个回头客零逛用户零，然后呢这个这个非活跃是不是这么多个呀对吧，这么多个啊。

那最终的话我们想计数的话，这么看不方便啊对吧不方便，那怎么看方便呢，我们在这呢给它进行一个转置转职，就说行变成列列变成行呗。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_180.png)

走转职完了之后，我们会发现哎在这个什么呢，在这个2月份，那我们的这个什么的回应户就变多了吧对吧，这个是新用户的数量，这个是回头客用户的数量等等等等吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_182.png)

那现在这个表有了之后，这个表里边放的就是我们的每一个月，所统计出来，我们私用户进行活跃度划分之后，人数的一个统计吧。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_184.png)

OK吧，那这个就是我们的最后的一个需求，在这我们就对我们的用户的生命周期。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_186.png)

进行了一个分析，OK吧，那至此的话，我们这终极冲刺项目这五部分就已经结束了啊。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_188.png)

那么重点是我们的第四跟第五部分的实现吧。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_190.png)

因为第四和第五部分，我们都用了两个固有的算法，对不对，这两个固有的算法你能看懂的话。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_192.png)

尽量去看，看不懂的话就直接去用吧对吧，直接用。

![](img/06f7773e6a35c17749cfddf4fcd07cc2_194.png)

所以说最终咱们通过了原始数据当中的这四列，对吧，对我们的这个需求进行了一系列的实现啊，那么这个大家课下，一定要仔细的去进行一个练习，OK吧好。



![](img/06f7773e6a35c17749cfddf4fcd07cc2_196.png)