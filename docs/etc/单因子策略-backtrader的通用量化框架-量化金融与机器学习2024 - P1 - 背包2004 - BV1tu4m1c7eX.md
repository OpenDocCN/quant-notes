# 单因子策略-backtrader的通用量化框架-量化金融与机器学习2024 - P1 - 背包2004 - BV1tu4m1c7eX

我们这节课。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_1.png)

讲。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_3.png)

看一下啊啊这个这节课我们学习啊因子策略。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_5.png)

因子策略。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_7.png)

因子策略是呃一种非常有效的交易策略啊，很有效，为什么说它很有效呢，就是通常能赚钱啊，通常能赚钱，所以因子策略其实是用的很广啊，它不像我们之前学习的那些信号和事件，就事件和信号通常是那种啊那种散户的那种。

股民天天看那个看盘，然后喜欢用的东西啊，但实际上至少从量化层面很难找到一个有效的，一个稳定收益的方式，但是量化层面用因子来做策略的话，是很容易能找到，因为也不能算很容易吧，我也不知道。

因为我也我毕竟没有示范过，但是老师通过回测的话，是挺容易能够找到一些呃，能够有正收益的一些策略的啊，就因此策略，呃啥是因子策略呢，其实就是你找一个特征啊，我们在机器学习里面叫特征。

或者找一个什么一个一个一个量，以这个量为基础来对股票进行筛选，进行选股啊，然后对你选好的股票进行买买入，然后再持有，然后按照一定的规则啊进行这个买入买出，最后就通常会有一些收益啊，而且因子策略的话。

它的呃选股方式和我们之前的阿富N分析，其实是有异曲同工之妙的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_9.png)

因为以前我们的阿尔法分那个阿尔法分析。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_11.png)

up frank的收益分析啊，其实就用到了一个很简单的思路。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_13.png)

大家应该还记得，就是拿了因子之后呢，N按因子的大小对股票进行排序。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_15.png)

然后呢会把股票分成分成若干个小组。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_17.png)

![](img/bfa930d99328eb2d80dc47b2e5212fc7_18.png)

按照他的顺序处在它不同排序的那个，分成若干个小组，然后看每个小组持有一段时间之后的一个，收益情况啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_20.png)

这是我们AFTERANCE里面的收益。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_22.png)

收益分析里面的一个分析方法，而这种方法到了我们的因子策略里面。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_24.png)

其实是一样的啊，其实是这样的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_26.png)

就是什么呢，我们选一个因子啊，比如说这样一个因子，或者或者是这样一个因子，然后以这个因子呃排序选这个因子，头部尾部或者某一个部分按这个顺序，某一部分的股票把他选好，选好买入，然后持有。

然后到了一定的时候，再然后判断是不是还在这里面，不带的话就抛一部分，然后再买进一部分，保持始终持有这个排序的那个部分的股票，然后看最后的收益，这就是因子策略，因子策略的一个通用的一个思想啊。

通用的一个策略，通过排序来做的，相信大家也能也能理解吧，也能理解吧，然后呢我们来实现我们最简单的一个因子策略。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_28.png)

单因子单音子的一个一个策略，我们先把前面的东西来呃。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_30.png)

运行一下啊，运行一下，我们还是选少一点的股票啊，这个大概有1000多只股吧，就选1000多只股。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_32.png)

好运行一下，好咱们把把这些简单的运行通好。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_34.png)

我们这个通用策略啊，先运行通看一看。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_36.png)

好看一看好好了啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_38.png)

这是我们的基准基准数据，我们待会再用吧，那我们现在写我们的单因子策略吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_40.png)

单因子策略刚才讲了，单因子策略就是爱因子对股票进行排序，然后获取排序的某个部分股票来进行购买啊，所以说我们我们来做一做这个事情。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_42.png)

现在呢我们可能选市值啊，我们市值在哪里呢，市值在这里啊，总是指这个这个好啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_44.png)

这个因子我们先暂时用这个因子啊，用这个因子，呃因为在做这个之前，我们首先想我们的买入卖出持有的周期是多少，呃我们这里大概想是怎么做呢，呃我们大概会以30天作为的作为周期。

就每30天我们观察一下我们的那个排序啊，是不是发生变化了，如果发生变化，我们就把呃除了排序的那些股票给卖出，然后把新进排序的那些股票再买入，大家能懂这个意思吗，就是以30天做周期，30天做周期。

因此的话我们要做这个事情呢，我们先干嘛呢，先先把我们的时间给弄到啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_46.png)

时间时间是啥呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_48.png)

时间这个先要时间啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_50.png)

需要时间，时间是这个时间是这个的话，我们获取它的什么呢，先要a sort values排序，从小到大，然后再获取它单独的那个，因为获取它单独的。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_52.png)

好把每个时间都拿到啊，每个时间都拿到，然后给到一个吧，给到一个，看来看index我们就简单先搞个这个啊。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_54.png)

先搞个这个，搞了这个之后呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_56.png)

我们呃以30天为我们的那个这个周期的话呢，我们先得干嘛呢，我们先得，0~0到多少人领到这个，总共的总共有多少个时间标签嘛。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_58.png)

然后呢我们的跨度是什么呢，跨度是30，大家能理解吗。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_60.png)

能理解。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_62.png)

啊等一下啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_64.png)

是吧，我们每过30个交易日啊，不是30天，每过30个交易日，我们来进行一次股票购买，这是大概这个意义啊，这个意思，就是这里我们保存的是所有的交易日，然后我们在这个循环里面。

每空30个交易日来做一次操作啊，做一次操作啊，每当我们要操作的时候呢，我们是要干嘛呢，我们肯定是要选择啊。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_66.png)

我们肯定是要选择啊，当天当天的股票肯定是要选择当天的股票。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_68.png)

所以说呢我们得，得选择什么呢，得选择，这个股票点date等于等于等于等于我们的这个，是吧，我们肯定是要选择当天的股票来进行排序的啊，所以说我们先选出当天的股票，选出当天的股票之后呢，然后。

要排序对什么排序呢，对我们的我们选的那个因子选哪个总数值。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_70.png)

那我们就我们就用总市值吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_72.png)

对他进行排序，是不是。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_74.png)

对它进行排序之后，我们要选取排序的钱。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_76.png)

前若干个这个若干个，我们搞个东西来定义一下吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_78.png)

假设五前五个是不是，选他的前五个，选他的前五个之后呢，我们把这个拿拿到外面来好不好，这样的话大家运行的时候能看一看，能看一看。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_80.png)

![](img/bfa930d99328eb2d80dc47b2e5212fc7_81.png)

所以你看这这样，我们是不是好，这个还没运行啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_83.png)

还没运行呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_85.png)

啊你看到了这里的话，我们就是选了这个股票排序的前五个。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_87.png)

他应该是从小到大排序，所以说我们选了总市值最小的前五个。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_89.png)

然后呢拿他的什么呢，拿着前五个的股票代码。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_91.png)

![](img/bfa930d99328eb2d80dc47b2e5212fc7_92.png)

啊拿这些我们的股票代码，然后干嘛呢，然后把它变成列表。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_94.png)

变成列表，能理解吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_96.png)

所以说这个我们每一步都要做一下，这样的话通过这种方式让我通过这个，我们就意味着我们干嘛呢，我们获取到了我们的啊股票列表。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_98.png)

但是获取到了我们的股东股票列表。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_100.png)

也就是这一天，我们在我们的那个排序下面的股票列表。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_102.png)

是这个啊，这个列表意味着什么呢，意味着我们是要啊，是要把它给放到我们的购买里面的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_104.png)

购买购买里面去的，而我们的购买是个什么形式呢，我们我们可以上到上面看看啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_106.png)

你看我们的购买是这样的一个形式。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_108.png)

我们把这都拿下来吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_110.png)

把这个拿下来啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_112.png)

然后。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_114.png)

把上面的拿下来。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_116.png)

我们我们是需要我们需要什么呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_118.png)

我。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_120.png)

我们需要这三个东西，我们要需要重新定义这三个东西。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_122.png)

![](img/bfa930d99328eb2d80dc47b2e5212fc7_123.png)

啊我们把它设成空的啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_125.png)

设成空的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_127.png)

设成空的，然后在这里面通过循环来，逐渐把我们要买的东西放进去啊进去，但是呢股票的列表，这是总列表，我们不能负责那个不能成list，应该让它变成什么呢，变成集合，大家还记得吗，你们应该以前学过集合吧。

把它赋成集合，为什么要赋成集合呢，啊是因为我们需要。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_129.png)

让他每次把新的把新的，每次把新新要买入的股票，把它加入到股啊股票的总列表里面去啊，因为总列表是用来干嘛的呢，总列表是用用来把这些相关的会发生交易的，股票的数据，要导到我们那个black trade的。

那个交易程序的这个大脑里面去啊，所以啊我们得得需要一个总列表啊，总列表有了这个总列表的话。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_131.png)

我们还需要构造构造我们什么呢，构造我们的而每天当天的一个交易额，交易列表，当天的交易列表。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_133.png)

当天的交易列表的话，首先是以时间作为那个的，而这里的时间是啥呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_135.png)

这里的时间是是这个是吧，我们可以看一下这个时间啊，大概是这个形式，但是我们的时间是要求是一个字符串啊，所以呢需要干嘛呢，需要点date，然后呢转换一下，好需要这样一个字符串。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_137.png)

有了这样一个字符串呢，我们把我们的今天，这是要购买的东西给放进去，是吧好我们当天的交易列表完成了，然后呢，当天的一个卖书列表，我们怎么办啊，我们需要完成我们当天的卖出列表，卖出列表的时间肯定还是一样的。

但是呢下面就不一样了，下面是需要什么呢，需要我们之前的一个持仓列表的，之前的一个持仓去去干嘛呢，去去掉啊，去掉接下来的，啊接下来的持仓里面所没有的东西要去掉，接下来的磁场里面所没有的东西。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_139.png)

这个东西要怎么办呢，我们还是使用我们的集合，我们在这里定义一个新的一个集合，然后呢每次用这个集合，用这个集合减去什么呢，减去上面这个减去我们新的新的列表列表，这是这是上一部的我们已经持有的这些股票啊。

减去什么呢，减去这一步啊，这一步我们需要买入的股票，这个是一个取什么呢，这应该是取一个差距啊，大家这是这是集这个减不是减法的减，它是集合的一个取那个去差几啊，就是它会选取什么呢。

选取呃这个集合和这个集合两者不相交的部分，但是这个不相交的部分不是必须得属于他，属于他的，和这个集合不相交的部分，也就是我们的卖出几何啊，卖出几何，以这样的方式形成我们的脉冲集合，形成我们的脉冲集合。

这样好了之后呢，我们意味着我们要干嘛呢，我们每次要把这个position要保存下来，就是我们这一步这一步的新股票，就是我们下一步的旧股票啊，所以说我们不要把这一步的新股票给，付给他啊，这样下一次的话。

他就会用最前一步的那个新股票去减，下一步的新股票了啊，我看看好像就就行了，我把上面这个拿也拿下来吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_141.png)

上面这个也拿下来吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_143.png)

应该就是这一点点代码。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_145.png)

我看看啊啊一次是可以运行的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_147.png)

我们把它给弄掉，好像也也能运行，我看看其他这些东西正不正常。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_149.png)

啊看起来是正常的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_151.png)

好，好了之后的话。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_153.png)

我们运行一下，看看能赚多少钱，能赚多少钱。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_155.png)

它会消需要一定时间，因为毕竟这个时间跨越5年，这意味着他其实啊这个列表里面。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_157.png)

![](img/bfa930d99328eb2d80dc47b2e5212fc7_158.png)

你看我们的初始金额是100万是吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_160.png)

我们不到上面去了啊，我们最终的话是120万，5年赚了20%，这只能说是跟银行差不多啊，5年20%应该跟银行差不多吧。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_162.png)

比银行稍微好点，可能就就跟放支付宝。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_164.png)

比如支付宝稍微好点啊，这是通过什么呢。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_166.png)

这是通过啊，我们还可以把他的那个呃那个线稿画出来。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_168.png)

就是和这个沪深300的一个对比线，我们把它画出来啊。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_170.png)

把它画出来，你看啊，这个应该就是我们这个的我们拿下来吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_172.png)

这个应该就是我们的沪深300对比线放到这里。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_174.png)

这个上面这个是蓝色的。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_176.png)

是沪深300的线，那我下面这个是我们的这个线啊，其实就怎么样啊，就这样，他所谓的这个20%的一个营收，还只是随机出现的哈，但很多时候他还亏了呢，啊你看这里是同一起点吗，啊金黄色是我们的啊，是我们的。



![](img/bfa930d99328eb2d80dc47b2e5212fc7_178.png)

好吧，这是我们的一个单因子策略，根据老师刚才讲的思路来实现，同学们来做一做好吧。

![](img/bfa930d99328eb2d80dc47b2e5212fc7_180.png)