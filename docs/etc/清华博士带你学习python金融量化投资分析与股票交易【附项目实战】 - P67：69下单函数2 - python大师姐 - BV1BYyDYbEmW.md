# 清华博士带你学习python金融量化投资分析与股票交易【附项目实战】 - P67：69下单函数2 - python大师姐 - BV1BYyDYbEmW

OK同学们，那我们接下来写这个下单部分的后半段啊。

![](img/eec9e1af585aa0cfb9f318473f46313a_1.png)

我们底层有了，接下来把它封装成四个大函数，第一个简单啊，order两个参数，第一个参数security，第二参数amount和我们的这个局款保持一致啊，那因为我们要用相当于是用这个东西嘛，对吧。

嗯用这个东西用这个东西，第一个参数就是TELEZA对吧，等于是用那个我们那个今天的信息嘛是吧，我们把这个today data等于等于什么呢，等于get类data。

然后security就是这个security，其实我后来想了一下，我没有必要把一个series传进去，他现在好像只要了开盘价，但是以防万一，我们先这么传吧，万一以后可能是开盘价什么。

或者是改成收盘价之类的，嗯好然后调用这个order什么呢，这个today data就是这个东西，然后第二个参数security和mt呃，第二个参数security，三个参数。

第三个参数amount都一样啊，这个就是买这只股票。

![](img/eec9e1af585aa0cfb9f318473f46313a_3.png)

买这么多股，所以这个很好写对吧嗯好。

![](img/eec9e1af585aa0cfb9f318473f46313a_5.png)

第二个是什么呢，order ta value啊，写target吧，Order target，第一个参数security，第二个参数amount，这个amount是买到多少股。



![](img/eec9e1af585aa0cfb9f318473f46313a_7.png)

所以注意一点，这个amount一定不能是负的啊，这个amount可以是负的，这个among呢表示负的时候表示是卖出，但是这个amount你不能卖到负的呀，你可以卖到零，你卖到零是全部卖出啊。

但是你不能写负的对吧，所以我们这加上一个amount，如果它小于零，那比如说我们这打印一下这个啊，数量，不能，为为负，这个时候我们就给调整成零就可以了，是吧，嗯啊调整成零还是什么，调整成零吧。

这个无所谓，你可以说哎这就是零嘛，你也可以说让他这个什么，让他这个不调整了，我就直接给你返回一个错误，你什么都不知小点行啊。



![](img/eec9e1af585aa0cfb9f318473f46313a_9.png)

然后我们这儿就比如说amount等于零好，正常情况下这个还是拿到，这个特today data啊。

![](img/eec9e1af585aa0cfb9f318473f46313a_11.png)

拿到这支股票今天的价格，然后这个时候我们要哎因为是买到多少股。

![](img/eec9e1af585aa0cfb9f318473f46313a_13.png)

所以这个有点不一样了，我们要先算我们现在有多少股啊，现在有多少股啊，这我们就hold amount等于等于什么呢，context点positions。

security对吧嗯这是不是就是我现在有的这个股数啊，这还有又又差点犯一个问题是啥，他有可能不在里边对吧，那所以这个东西点get，两分，然后这是我现在有的数量，然后根据这个数量，我是不是算一个差值。



![](img/eec9e1af585aa0cfb9f318473f46313a_15.png)

嗯对吧，差值是什么呢，是amount减减去我现在有的啊。

![](img/eec9e1af585aa0cfb9f318473f46313a_17.png)

看啊，如果说我现在有200股，我这写的是买到300股，这个是不是100股，是我买100步对吧，没有问题对吧，如果说hold amount是多少，是啊，是300股，我要买到200股。

这个地方是不是-100，所以正好是卖出100股对吧对吧，所以这个delta ammont，我就直接可以给它传到这里边啊，这个东西一样security，然后传delta among us就可以。

好注意一点，我们这个框架现在还不是很完善，有什么不是很完善的呢，差一个差什么差，T加一之前给大家说过了，所谓T加一就是什么呢，今天买的股票今天不能卖，但是我这并没有限制一，我买完了之后。

他立刻就是我的positions只有一个值，就是股票，然后值就是什么，我的值就是现在有的数量，我没有考虑是今天有的还是明天有的，就是有了就直接有了，也没有考虑他就是说今天买能不能买。

在我现在写的这个框架里，其实是能卖的，所以这如果大家还想做改进，这是真的可以，就是做的主题加一做也不麻烦，你就这个position的值写两个，一个是之前就是一个叫做closeable amount。

就是像我们那个区块上的closable amount，和total amount分开就可以了啊，这个今天买进来的你就加到total amount里，但是不加到close包里，然后过了一天就今天过了。

他的close b就变成total了，等于合作，就就是也不难，大家就是有时间的话，可以在我这个基础上再改一下好，那我们接着说啊，第三个，这样不要return嗯，这什么无所谓。



![](img/eec9e1af585aa0cfb9f318473f46313a_19.png)

因为这个order现在没有返回值，它没有返回值，所以就都写，Order value，嗯value好，这个东西是买多少钱的股票，所以如果我们要掉它之前，我们是不是啊，首先第一步肯定都一样了。

这个获取今天的数据。

![](img/eec9e1af585aa0cfb9f318473f46313a_21.png)

今天的价格啊，那我们要传要调这个东西的话，这是不是要传数量，但是我们现在是不知道钱对不对，所以我把钱给它变成数量是不是就可以了啊，怎么变成数量呢，amount等于value除以今天的价格是不是就可以了。

价格是多少呢，today data的，对不对，这个东西是不是就是我的数量，那当然这个数量啊，对忘了，变成取整数啊，取整数哎，当然这个数量我们说这个是有可能。



![](img/eec9e1af585aa0cfb9f318473f46313a_23.png)

不是100的倍数，但是不要担心啊，这个数量到时候我们在原来那个加下划线的。

![](img/eec9e1af585aa0cfb9f318473f46313a_25.png)

order里才会去调整，对不对，所以就不用管它了。

![](img/eec9e1af585aa0cfb9f318473f46313a_27.png)

把这个数量直接传过去就可以了啊，那就是order，Today data security amount，哎是不是就OK了啊，这是这个下单啊。



![](img/eec9e1af585aa0cfb9f318473f46313a_29.png)

哎是不是下单这个order value，那还有一个下单函数叫做order target value。

![](img/eec9e1af585aa0cfb9f318473f46313a_31.png)

这个函数是什么呢，相当于结合了order target和order value，嗯啊首先这个value是买到多少钱的，这个钱跟这个amount一样，也不能是负的对，所以这要判断一下，把上面那段粘过来。

你不能粘，这是amount，这是value哦，名儿不一样，这名儿不一样。

![](img/eec9e1af585aa0cfb9f318473f46313a_33.png)

那粘过来还要改好，这个就是按这，我这打这个价值不能一调整为零。

![](img/eec9e1af585aa0cfb9f318473f46313a_35.png)

好啊，这是value。

![](img/eec9e1af585aa0cfb9f318473f46313a_37.png)

调整成零好if，完了之后，接下来还是说我这个的价格，我这个是价格，对不对嗯，我要找一个这个价格，是我现在就是我这个股票要买到多少钱，那我可以算我现在有多少钱对吧，有的股不是不是有多少钱，是有的股有股票。

这个股票值多少钱，明白吗，那我现在有的价值，等于context点positions security啊，又差点出了问题，现在写一下，它就得要犯一下嘀咕好，数量对不对，这是数量乘以什么价格，价格是啥。

价格是特，Today thea。

![](img/eec9e1af585aa0cfb9f318473f46313a_39.png)

![](img/eec9e1af585aa0cfb9f318473f46313a_40.png)

什么open close吗，怎么会是close呢，我之前写的哎。

![](img/eec9e1af585aa0cfb9f318473f46313a_42.png)

我之前居然写的close，我不说我拿开盘价当做那个代表吗。

![](img/eec9e1af585aa0cfb9f318473f46313a_44.png)

所以不是close，是open open啊，之前可能手手残，嗯啊这哦好，这是我们的什么，这是我们的这个当前有的股票数，乘上当前的价格是当前，而是而是当前的这个股票值的总价值，那我接下来要算什么。

算我现在差的价值是多少，就是跟这个类似，算一个delta delta y6等于什么呢，等于Y6，因为这是个OUNT减hold amount嘛，所以这是Y6减去hold value嗯。

这是我现在就是说我还要买，或者还要卖多少价值的东西，对吧嗯，那其实到这一步怎么样呢，我们可以直接调order value。



![](img/eec9e1af585aa0cfb9f318473f46313a_46.png)

因为我们的这个这个delta value不就是这个东西吗。

![](img/eec9e1af585aa0cfb9f318473f46313a_48.png)

所以我们直接security value就可以了啊。

![](img/eec9e1af585aa0cfb9f318473f46313a_50.png)

对sorry，Delta value，这个东西就表示什么呢，我现在这是我有这这是我要到达到的价值，这是现在有的价值，差点一减是差的价值，那差价值就是要买或者卖这块价值，就把它传到这来。

那就OK嗯好我们来测试一下。

![](img/eec9e1af585aa0cfb9f318473f46313a_52.png)

比如说我想买就只有这一只股票了。

![](img/eec9e1af585aa0cfb9f318473f46313a_54.png)

哎其实我们还有一个这个600519文件，到时候我们来买它买试一下啊，那是茅台。

![](img/eec9e1af585aa0cfb9f318473f46313a_56.png)

应该是买100股，哎，我再试一下。

![](img/eec9e1af585aa0cfb9f318473f46313a_58.png)

买别的这个600519买别order了，order value吧，买多少钱的呢，买3万块钱的好。

![](img/eec9e1af585aa0cfb9f318473f46313a_60.png)

这个时候买完了之后，我们打印一下我们的这个，context点positions，诶你看这个是什么呢。

![](img/eec9e1af585aa0cfb9f318473f46313a_62.png)

第一行没有出问题，第二这个是什么，这是第二行，3万的时候啊，茅台因为太贵了，所以只能3万块钱才买150，那个时候那个时候现在3万块钱150，现在7万块钱买150，买一手好。

我们可以看到这个时候打印的这个position，就是有两个长度是二对吧，嗯这是100，这也是100对吧啊，所以这个应该还是这俩没有啥问题，那我们试试其他俩，Order target，到什么呢。

到啊五百三十五百二十order，Order，Target value，多一我觉得把这俩倒了，这个500也买不起啊，买到3万也行，就随便看一下吧，反正也没多少钱，就他茅台只能买100锅对吧啊，这是500。

我也大概就是基本上还OK对吧，这是我们写的这四个下单的函数好。

![](img/eec9e1af585aa0cfb9f318473f46313a_64.png)

那么现在这个获取地址数据的也有了。

![](img/eec9e1af585aa0cfb9f318473f46313a_66.png)

下单的也有了，接下来就是什么呢，整个这个啊回测的一个框架，就是我要模拟每天跑一次啊，对不对，怎么模拟它，对不对，那接下来就要写这个东西，就是怎么样让它每天跑一次，然后算出来我们的收益，我们还得画图啊。

我们弄最后结运行的结果是那个图对吧，这是要把那个收益的图像化，那是我们要计算每天的收益，我们要每个交易日模拟执行一次好。



![](img/eec9e1af585aa0cfb9f318473f46313a_68.png)