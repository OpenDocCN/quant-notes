# 股价预测模型的评价与可视化Darts｜深度学习算法｜时间序列预测-量化金融与机器学习2024 - P1 - 背包2004 - BV15M4m167i5

好吧我们继续上节课的啊，这个内容啊，来学习我们这个这个基于这个包的一个，时间序列预测啊，时间序列预测上节课的话，我们应该是跟大家用这个包，走通了一个非常简单的流程啊，这个流程就是什么呢。

就是我们获取到数据，这个数据的格式是个pandas as的数据，然后呢取其中的一个股票的这个股价的序列，最关键在于这个这个流程里面，最关键的一点在于什么呢，最关键的一点在于构建这个时间序列啊。

通过pandas的这个数据结构，通过数据框来构建这个时间序列，构建时间序列名有两点是需要同学们注意的，第一点呢，你的那个时间那一列呀，搞出来的时间这一列啊，它的类型必须是data time或者是时间戳。

其实也行啊，就是你得让它的类型是data time这个类型，同时还有一个要求，这个也很重要，就是你的这个时间序列中间不能有空缺，什么不能有空缺呢，你的这个时间必须是个连续的啊，必须是连续的。

比如说你一号2号三号四号五号六号，7号八号被连续，这个是在我们做股价预测的时候是特别注意的，因为为什么呢，我们股价预测的时候，实际上时间是不连续的，因为我们总是会有假日处于这个非交易的状态。

在我们的这个数据集里面，一旦如果这一天是放假，或者这一天股票没有交易的话，它就是会空缺的啊，会空缺的，所以要把它比较好的转成时间序列的，前提就在于什么呢，要在于要使得这个序列的索引不能有空缺啊。

不能有空缺，必须保证时间上是连续的，正是为此才会有这么一段代码啊，才会有这么大这么一段代码，实际上一旦你产生好了，你时间序列，接下来的额模型的这个应用就是一个标准流程。

在这一点上他和SKSKLINE是类似的啊，而且他基本上呃依照了SKSKINLINE里面的一些啊，一些方法啊，首先是什么呢，是呃，序列的一个标准化也叫标准化吧，其实这个标准化数学点。

他也是把整个序列做标准化啊，至少他的文档里面啊，他的例子里面都是这么干的，但实际上因为因为网上有很多很多很多同学说，这个要分开做标准化，就是预测集和训练集要分开，至少在他的很多的例子里面。

他是没有分开的，而且这里的标准化是个非常简单的标准化，他是怎么了，就别看它函数这么复杂，它好像应该就是怎么了，把所有序列的值除以它的最大值懂吗，就除了个最大值，你看本来我们这个这个是一个股票的价格嘛。

是吧，它现在变成了一个0~1之间的值，那怎么变成0~1的，就是除，就是所有的序列都除了他这里面的一个最大值，等于说就是除了一个常数啊，除了一个常数，而且它整个模型都是去在这个。

在这样一个0~1的一个值之间来做的啊，他就是对整个序列除了一个常数，这个常数是这个序列里面的最大值啊，就是这么干的啊。



![](img/1614a27eeab6a4f18e5814cdbdd91628_1.png)

把它弄好了之后，接下来的标准流程就是分割，然后实例化模型，然后做训练，然后就可以了啊，就可以了，这个相信如果我们之前学过SKLINE，其实是一样的啊，其实是一样的，这也是这个工具的精髓啊。

就是如果我们不使用这个工具，我们要用一些比较复杂的深度学习的方法，其实要做很多事情啊，其实要做很多事情特征处理哈，这是一一些分割，是要做很多事情的，但是这个工具的好处呢。

就是它把很多复杂的事情封装好了啊，我们能够以类似于c gland的一个标准流程，来完成这些比较复杂的一个时间序列预测算法，行吧，这是之前一个回顾啊，因为是上个星期的课嘛，咳接下来呢我们做一个事情。

就是当我们有了这个模型啊，啧我们来把这个模型评价一下，或者说做一个可视化，上上上节课应该是用过，但是我们这节课稍微讲讲，我们现在呃这里只用一个最简单的评价方法，算什么呢，算平均绝对百分比误差啊。

这个应该很好理解的，就是什么呢，就是预测值和真实值之间的差值，然后做的一个平均，当然这个差值是绝对差值哈，他会取绝对值的啊，做了个平均，然后看这个平均的差值额，他的百分比是多少啊，百分比是多少。

额我们看看啊，我们模型其实这里，我们把它运行一下吧，好运行一下吧，这应该有了哈，应该有了。

![](img/1614a27eeab6a4f18e5814cdbdd91628_3.png)

但是我还我我得运行一下啊，得运行应该还都没运行呢，运行一下啊，好啊，我们这里就把这个模型运行完了，运行完了之后呢，呃其实上节课我们就做出来了条图啊，啊就是这个模型额怎么来评价它呢。

或者怎么来可视化它的结果呢，就当我们有了这个模型之后啊，我们就用它来预测啊，预测怎么预测呢。

![](img/1614a27eeab6a4f18e5814cdbdd91628_5.png)

首先你得把他预测的起点的数据，因为我们是是用这个训练集做的一个训练。

![](img/1614a27eeab6a4f18e5814cdbdd91628_7.png)

所以说我们的预测显然是在这个训练集之后啊，在这个训练期之后预测它之后的一个数据，而这个时代表的就是我们预预测这个训练集，我们预测，这个训练集之后的之后的几个时间的数据，我们这里选的是十。



![](img/1614a27eeab6a4f18e5814cdbdd91628_9.png)

为什么选的是十呢，是因为他这里是这样的啊，我们这里的话是用了呃24个数据，就是最近的24个数据，预测未来的12个数据啊，所以你真要正经的啊，正经的做预测的话，你的这个N小于12啊，其实是比较必要的。

当然其实N是可以大于12的啊，N是可以大于12的。

![](img/1614a27eeab6a4f18e5814cdbdd91628_11.png)

比如说我们换成50，额你看看到没有，换成50，他是显然是可以做，但是呢他这个做的话就是什么呢，它就是一种自回归了，什么意思呢，我们前面十前面12个数据啊，他显然是用真实数据做的预测，因为我们这里是用啊。

后面24预测前面12嘛，但是一旦超过12之后，他就不再用真实数据，它就会用什么呢，会用你这里之前的预测值来填补真实数据啊，进行一种自自回归的预测，大家能理解吗，所以这个时候它它就只是按照趋势往前走了。

所以他显然就就会就会这样子偏离下去啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_13.png)

就很容易会偏离下去。

![](img/1614a27eeab6a4f18e5814cdbdd91628_15.png)

所以正寝的话用12可能会是最最正经的。

![](img/1614a27eeab6a4f18e5814cdbdd91628_17.png)

因为他正好他就只能预测到12啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_19.png)

只能预测到12额，不仅是能够把他的图做出来，而且呢我们可以用这个函数啊，用什么函数呢，啊这里也是一样哈，我们可以用什么函数，用这个函数，我们就直接在下面弄吧，弄这个函数，哦在下面弄一下吧。

我们把他的预测值放到这里，然后呢真实值是这个测试集放到这里。

![](img/1614a27eeab6a4f18e5814cdbdd91628_21.png)

然后我们用这个函数运行一下。

![](img/1614a27eeab6a4f18e5814cdbdd91628_23.png)

他得到的这个结果是什么呢，这就是10%，也就是说他的平均绝对误差，是10%的样子啊，至少什么呢，至少在这12个预测数据里面是10%，但是如果你真把它弄长，那肯定就越来越大了哈，因为他后面都是次回归了。

后面都是智慧，就用用预测数据来做预测，它就它就大了啊，它就大了，你看我们用50的话，可以看一下他是不是就变大了啊，所以12是相对来说比较真实的一个情况啊，比较真实的情况好，这是我们最简单的一个评价啊。

最简单的评价，当然这里的话他是应该是把所有的，把所有的测试数据都预测了一个遍，那有好有100多个了啊，有100多个了，然后然后然后把所有的真实值和预测值，来做的一个做的一个东西啊。



![](img/1614a27eeab6a4f18e5814cdbdd91628_25.png)

我们可以看看啊，可以看看他肯定是有很大的偏离的。

![](img/1614a27eeab6a4f18e5814cdbdd91628_27.png)

看没哈，偏离偏移这么大哈啊，他因为他只有这最前面这一段，是用真实数据做的，后面都是用的他的预测数据做的次回归啊，做了次回归，关键是他在这里还居然还那个了啊，居然还往下走了，他这个往下走的一个趋势。

很可能是你是学习的这边的啊，很可能是学习的这这种情况啊，这种情况啊其实还是有一定的学习能力。

![](img/1614a27eeab6a4f18e5814cdbdd91628_29.png)

它不是完全按趋势往上走啊，好吧，这是通过，这个方式来啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_31.png)

来看他的什么呢，看他的平均绝对误差啊，这应该也是这里面最常用的啊，这个里面最常用的一个呃指标啊，一个指标除了这个以外呢，我们下面还有几个东西，一个是这个，这个是不是大家看起来就非常好了啊。



![](img/1614a27eeab6a4f18e5814cdbdd91628_33.png)

我们看一下我们的模型应该是多少，呃啊是这个啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_35.png)

下面这个看起来应该就是非常好了，是不是运行一下。

![](img/1614a27eeab6a4f18e5814cdbdd91628_37.png)

是吧，看起来是不是好很多啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_39.png)

是不是好很多啧，这个相比上面他用的是这个函数啊，用的是这个函数，这个函数它的一个特点是什么呢。

![](img/1614a27eeab6a4f18e5814cdbdd91628_41.png)

它不是用呃刚才讲了上面这个啊，这个它是到了超出了一定范围的话，它是用呃预测出来的数据数据做的自制预测。



![](img/1614a27eeab6a4f18e5814cdbdd91628_43.png)

自回归哈，而这里不是啊，这里始终会用真实数据来做接下来的预测啊，怎么来用真实数据来做接下来的预测呢，首先你看他这里，把所有的真实数据都拿进去了啊，拿进去了，然后他这里定义了什么呢。

定义了你要预测的未来预测几个值，我们的那个模型是能够预测未来的12个值的。

![](img/1614a27eeab6a4f18e5814cdbdd91628_45.png)

是不是啊，这里定义的啊，是用呃模型，是用24过去的24个数据，来预测未来的12个啊，是我们模模型是这么干的，但是这里的话啊，我们在做它的这个这个图的时候，我们定义它总是用未来的24个预测。

前面后面三个就行了，肯定是他依然也能预测12个单词，后面的那些就不要了啊，所以他只拿了最近的三个啊，就是每次只预测最近的三个啊，然后再进行滚动，能理解吗，就是每次确保每次都是用真实值来预测。

这未来的这三个啊，这三个词是大概是这么个意思，然后这个start是什么呢，是从整个数据集里面的额，60%的这个位置开始进行啊，开始进行那个呃拟合啊，拟合关键是注意这一点哈，这个东西非常重要。

如果你的模型是比较小的，或者如果你只是像老师一样上课用来教学的，必须要用这个号，这是什么意思呢，啊这个东西是什么意思呢，我给大家呃，怎么跑了，这东西。



![](img/1614a27eeab6a4f18e5814cdbdd91628_47.png)

这个参数很重要啊，这个参数是这样的。

![](img/1614a27eeab6a4f18e5814cdbdd91628_49.png)

我们刚才讲了，这是一个滚动预测，是不是在我们真实的情况下面，比如说你要用这个模型来进行股票的交易啊，那是不是最严格的方式是什么呢，显然是你过一段时间，每当你预测新的数据，新的结果的时候。

你是不是要用这个结果之前的所有数据来训练，新模型，能理解吗，能不能理解，就是你你肯定不就是比如说你9月份要买股票，你肯定不会用1月份之前的数据训练的模型，来来来买股票，肯定是没那么好的，能理解吗。

就是你9月1号要买股票的话，你肯定是用9月1号以前所有的数据做训练集，然后训练一个模型，然后看再再预测9月1号的情况，能不能理解，当你9月15号又要买股票的时候，那你显然是要用9月15号以前所有的数据。

做你的，做你的训练集，然后训练模型，然后去指导你9月15号买的数据，所以说真实的大家要真要用这个东西的时候，通常是要retrain，就是要每每每拿每预测一个值，然后又会重新去训练模型。

然后再再下面再重就重新拿新数据训练模型，这么个意思，所以说当你把这个变成这个，不要这个参数的时候，它默认是会每次都会重新训练模型的啊，啊这对于这对于这个这个模型来说啊，其他的其实无所谓。

就是很简单的那些模型无所谓，对于我们这个模型来说，大家也看到了，他这个一个都要好几分钟了啊，你要每走一步都重新训练个模型，那你那至少得一下午才能搞定哈，一下午才能搞定，所以说啊老师这里设置了这个参数。

跟他讲，我只是用真实值来预测最近的这三个量，但是我不需重新训练模型啊，return这个词要force，否则我们这个这个课这个上不上去啊，上不下去，但是真实的操作的时候，大家千万要多用这个东西啊。

这这个东西啊会更真实啊，会更真实好吧，这里这个参数大家稍微注意一点啊，我们所以这个图就是用我们上面的那个模型，但是呢呃哎但是但是每一步用的是真实数据，都是去做的结果啊，每一步都是用真实数据做的结果。

然后呢这个结果和这个真实值拿出来做了一个，看见没有，拿出来做了一个这个，一个比较就是求求了他的什么呢，平均绝对误差得到的是这个看到没有。



![](img/1614a27eeab6a4f18e5814cdbdd91628_51.png)

6%，我们之前还记得吗。

![](img/1614a27eeab6a4f18e5814cdbdd91628_53.png)

之前是10%吧，显然这个更靠谱啊，显然这个更靠谱啊，当然他每次都是用真实字母，当然会更不靠谱，所以他的这个额这个情况是6%啊。



![](img/1614a27eeab6a4f18e5814cdbdd91628_55.png)

平均绝对误差是6%好吧，这是这两个图的一个区别，区别就在于这里啊，区别就在于这里啊，另外一个下面这个图呢，下面这个图呢是这样的，它是概率，他是做的一个概率模型啊，一个概率模型。

而且他这里用了一个新的简单的模型，是指数平滑这个模型，这是最简单的模型，这不是我们刚才那个深度学习模型，我们刚才的模型叫什么名字啊，那叫什么什么什么啊，我我也具体我忘了啊，刚才那个模型深度学习。

这里用的是一个指数平滑的一个模型啊，呃这个模型默认是可以做，可以产生一个概率模型的啊，默认是可以产生概率模型的，什么是概率模型呢啊概率模型是这样的啊，就它不仅仅提供点的预测，还能提供啊。

还能提供呃可能的未来结果，结果分布呃，结果分布，这些输出分布代表了不同未来值，发生的可能性啊，发生的可能性，允许在不确定下进行更明智的决策，比如说在贯彻是严格得正向，什么什么什么什么啊。

这是这么一个情况，就是呃用那个的话，它默认能产生一个概率模型，实际上我们这个啊额我们这个模型啊，就是这个，这个模型这个模型应该也是能够有概，也是能够产生概率模型的。



![](img/1614a27eeab6a4f18e5814cdbdd91628_57.png)

但是呢我们这里它没产生，是因为有一个参数，我们设置的是那个啊，我们看一下这是一个什么参数呢，大多数模型都会有的一个参数需要设置啊，额哪个参数啊，对这个啊，如果这个参数设置为true。

应该是产生的就是概率模型，但是老师也没试过哈，我只是呃用了他帮助文档里面的一个呃例子，我并没有试这个参数啊，但是理论上从他的帮助文档来看，大多很多支持的模型，他要真的产生概率模型。



![](img/1614a27eeab6a4f18e5814cdbdd91628_59.png)

真的什么呢，真的能够做刚才的那种图啊，刚才的这种图的话，它有赖于的就是刚才的那个参数啊，就能做这个图，这个图意味着就是他其他点的概率，大概是在一个什么情况啊，这个的话。



![](img/1614a27eeab6a4f18e5814cdbdd91628_61.png)

啊是要设置这个参数的好吧，我们这就提一下吧。

![](img/1614a27eeab6a4f18e5814cdbdd91628_63.png)

啊就提一下好吧，这是这三个可视化以及呃它的意义啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_65.png)

大家稍微了解一下，一个是可视化，一个是什么呢，啊，一个是用这个这个东西来对比，预测值和真实值啊。

![](img/1614a27eeab6a4f18e5814cdbdd91628_67.png)