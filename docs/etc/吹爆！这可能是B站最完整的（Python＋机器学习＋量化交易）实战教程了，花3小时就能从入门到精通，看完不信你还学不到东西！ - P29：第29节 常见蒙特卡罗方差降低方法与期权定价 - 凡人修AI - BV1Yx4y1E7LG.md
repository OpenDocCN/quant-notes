# 吹爆！这可能是B站最完整的（Python＋机器学习＋量化交易）实战教程了，花3小时就能从入门到精通，看完不信你还学不到东西！ - P29：第29节 常见蒙特卡罗方差降低方法与期权定价 - 凡人修AI - BV1Yx4y1E7LG

大家好，欢迎收听Python量化金融与机器学习的第15节课，那么第15节课呢，我们介绍衍生品定价的第二部分，主要是基于蒙特卡罗的衍生品定价，及其的误差降低。

也就是我们称为的advanced method for monte caro。

![](img/dac766c98f16c58236d5593a25a02571_1.png)

让我们来看一下这节课的课程大纲，那么首先呢我们会介绍常见的蒙特卡罗，方差降低的方法，以及呢如何将这些advanced method运用到啊期权定价，那我们会结合上一节课提到的。

欧式期权有POPTION和亚式期权，Asian option，以及啊美式期权的定价，那么我们介绍的一些常见的蒙特卡罗方，方差降低的方法呢，主要有第一个是antithetic method。

也就是反向取路径，第二个是control vari，那我们可以称为这个啊方差控制，那么第三个呢是重点采样，Important sampling，那么重点采样呢我们会重点介绍这个方法。

因为它在这个数学上呃，mathematical里呢它比较的难，而且对于在这个信用违约上面呢，我们基本上使用的房贷降低的方法呢，都是重点采样，那么第四个呢是low discrepancy序列。

那么low discrepancy呢，我们主要介绍的是Sol sequence，称为索博尔系列，那么第最后一个呢我们介绍一下moment matching呃，那么我们还会衍生在作为这个课后习题。

我们会让大家implement一个certification的方法，也就是分层方法，那我们在最后的结尾，会简单介绍一下分层方法的原理，那么由大家去实现这个分层抽样的代码。

那么我们第二块主要内容呢就是深入的介绍，什么是重点采样，也就是important sampling，和它背后的这个数学统计基础，我们称为change of major，也就是改变测度来进行积分。

那么第三块呢我们介绍一个很著名的model，就是incremental retract model，那么这个model呢是simulate，这个投行中我们有不同的这个issue。

那么issue的这个信约违约，信用违约风险，那么基于它的风险呢，我们算一个overall，他的expected loss是多少，那我再取loss的VO，也就是我们之前介绍过。

比如95%的报或者99%的报，算出我们比如说今年这个annually，我们的在信用违约上，我们有95%的这个信心，我们的最大的这个违约不会超过某一个capital。

比如说three billion这样的，然后呢我们介绍是这个在implemental recharge model中，我们使用的这个对，不同的issuer之间的相互关系。

我们用的是one factor的高悬copular model，所以我们会介绍一下高斯和包括这个i r c model，跟高深copular model。

这个model我们用最正常的就是SUOMONTECARLO，那么呢我们的方差会比较的低，那么我们如何通过important samply来shift，来进行这个parallel shift。

我们来提高我们的这个算法效率，那么首先呢，我们先看一下这个蒙特卡罗的误差呃，我们上一节与上一节课的内容，我们知道我们在expected，这个门的卡罗的时候呢，我们基本上算的是我们的overall的M。

那我们计算mean的话，mean的这个标准差是我们一整个的这个sigma，也就是我们每一个样本的sigma除以呢，我们样本的这个开根号，所以我们蒙特卡罗的收敛速率呢是根号N。

所以收敛的速度呢是relatively来的慢的，也就是说可能我在simulate一个option pricing，比如european option pricing，那我要simulate嗯。

1000万条的pass，我的相对误差才能降到1%以下，那么在java run这个MONTECARLO的时候呢，如果是1%的误差，那么啊1000条path呃，1000万条pass。

那么我们基本上要run大概5分钟左右的时间，那如何提高我的算法效率，来缩短我这个ram蒙迪卡罗的时间呢，所以我们就提出了我们上面提到的这一系列，放差降低的方法，那么通过这个simulate的降低方差。

我们提高了我们simulation的效率。

![](img/dac766c98f16c58236d5593a25a02571_3.png)

因此呢就提高了我们的计算的速度，那我们先来看这个第一块，也就是反向取路径。

![](img/dac766c98f16c58236d5593a25a02571_5.png)

那那那我们来看一下取反向路径的方法，就是antithetic path，那么他的想法是呢，对于每一个正态的随机数，那我们把它generally out出来之后呢，我们给它取一个my呃。

Negative sun，也是取了一个负号，那我们再计算呢负的W，那么X呢是由这个W就是正态随机数来driven的，来驱动的，所以它是一个这个正态随机数的一个函数，所以呢我们对正态随机数。

对于每一个generate出来的W我们都取一个负号，然后再把它套到这个driven的函数X中，然后我们得到呢XW和X负W，我们得到之后把它的再进行取一个平均，那我们得到一个新的Y。

那么这个Y呢就是被这个anesthetic path method，给这个嗯advanced过的，那我们之后呢我们通过这个数学的方法，我们可以取Y的这个variance，那么通过计算呢。

算出它的VANCE呢是如下这样的表达式，是二分的西格玛平方，那西格玛方呢是原来就是正常的MONTE，color method的这个方差，那么是二分之西格玛方乘以一加上RO，那是XW和X负W的相关系数。

那么由于呢，我们每一步都要对这个W取一个负号，来进行计算，所以我们本来就是两倍的计算的这个呃，所以我们要对这个计算速率本身就乘以二，也就是我们真正的这个提高的效果呢，是西格玛方乘以一加上柔。

也就是相关系数，所以这个时候呢，如果这个variant of y想要有提高，就必须小于二分之西格玛方，那么等价的呢也就是相关系数比零小，也就意味着这个对每，对我们这个X的这个函数来说。

里面的这个正态随机数是正的还是它的负数呢，它们两个之间最好是负相关的情况，所以让我们来看一下这个效果比较。



![](img/dac766c98f16c58236d5593a25a02571_7.png)

当这个WT如果以这个零分割，那么左右两边呢刚刚好，是就是是一个递增或是一个递减，这样的关系的话，说明这个W跟负W的这个相关系数是负的，所以这个时候呢用antitheti path的效果非常好。

那么如果是这样趴手礼服相关，也就是说可能到这个二之后，那么不管这个W当然是这个四啊还是六啊，那这个负W都是零，所以这个时候呢就不存，就是在有的区间内是相关系数是零的，那么这个时候呢效果呢就是一般。

那最差的效果呢就是W跟负W是相等的，那么这个时候你去ANTITHETIPATH，因为W等于负W，所以就没有任何的意义。



![](img/dac766c98f16c58236d5593a25a02571_9.png)

所以这个时候是in efficient的，就是效果比较差，那我们来介绍更多比较advance的方法，因为上面的antithetic是一个比较简单。



![](img/dac766c98f16c58236d5593a25a02571_11.png)

也比较直观的方法，那么当呢我们是存在这个，第二种和第三种情况的话，那么antithetic method的效果会比较的。



![](img/dac766c98f16c58236d5593a25a02571_13.png)

比较的不理想，所以这个时候让我们来讨论一下这个嗯，control vary的这个方法，那么control berry的想法呢其实也很直观，首先呢就是嗯意思是我们的精确的错误，比粗略的正确要来的更好。

那是什么意思呢，让我们来看一下这个左额右边的这个图像，那么右边第一幅图就是我们打靶，那么我们我这个人呢就水平呢其实是就是方差，误差是比较小的，但是我都打在了这个偏环上，就是我所有的点都偏了。

但是非常的精确而集中，那么还有一个人呢，他是以这个十华为中心，那么他这个人发挥的不是很稳定，所以说呢就是比较的散射，那么这个就是accurate，但是呢imprecise。

那么前面的这个是PRECESS呢，但是inaccurate，那么我们呢依旧是希望是达到第一幅图，这样的情况，就是说如果我们estimate出来的一个东西，它的方差比较小。

但是它存在着偏离存在的bias的话，那我们可以把它往我们先预测出这些点，然后把它往中间移，这个比如说sweet step，那这个时候我们就能得到最精确的解了。

所以这个是control vari的一个想法呃，他的想法是呢，如果我要计算一个exotic option，那么exotic option呢我们没有办，我我们嗯estimate它的话我们的方差比较大。

那这个时候我考虑用vanilla option来进行control VR，首先呢我们用同一条这个呃，monticulo simulation的path来price。

asian option和vanilla option，那么我们来计算这个VINA，用别的方法，比如说black shemodern equation，算出来的答案，那减去呢。

我们上面用monticcolor simulation的这个答案，我们算他的这个error，那么算好了error之后呢，我们前面asian option price也就是real price，减呃。

A选一减去A选二呢，会等于这个前面一个系数乘以这个稳定拉的error，那这样的话我们把贝塔乘以这个error，再加回那个asian option pricing。

那我们就可以得到一个比较精确的asian option price。

![](img/dac766c98f16c58236d5593a25a02571_15.png)

具体的这个拟合的数学表达公式是如下所示，那么首先呢我们要estimate这个样式期权的价格，那么呢我们用同样的set of stock path，是用monte caro simulation出来的。

那我们用同一条set pass呢，我们price这个X1P跟V1PX1pl呢，是亚式期权的价格，那么Y呃V1票呢是欧式期权的价格，我们再通过brush on moch的这个定价公式。

我们第一这个是三节课提到过的，那有一个表达式，那我们通过表达式可以直接计算出，欧式期权的价格，那么欧式期权的精确解解去，欧式期权用这个stop path similarly出来是一个误差。

那么呢嗯这个呢相当于是精确的，亚式期权减去这个亚式期权，用一样的这个settle，stop best price出来的，那么这两个之间的误差呢，存在着一个贝塔的一个线性关系，是一个SCALA的一个关系。

所以这个时候我们想缩小这个方差，我们得估计这个贝塔的值到底是多少，那我们可以通过最小化这个Y的variance。



![](img/dac766c98f16c58236d5593a25a02571_17.png)

因为这个就是我们使用monticolor simulation的目的，所以呢我们来计算这个variance of y在数学上，他的这个理论解应该是多少。

那我们其实就是算这个COVERANCEYY1hat，那我们把这个公式进行展开，那我们展开之后呢，我们得到这个VN是等于这个西格玛X平方，减去两对贝塔covers x跟这个V，然后呢贝塔的平方。

西格玛V平方，那我们因为这个唯一的变量就是贝塔，所以我们对贝塔求偏导，这个导数得等于零，我们求它的极值，那我们求出呢真正的这个贝塔一星，也就是最优的贝塔，一星呢是等于啊这个欧式期权跟亚式期权。

用蒙特卡罗模拟出来的这个相关系数，乘以呢，这个X也就是嗯亚式期权的这个呃标准差，还有除以呢这个欧式期权的标准差，所以呢我们把这个贝塔一心再带回原式，我们可以算出最小的这个方差，就是西格玛X平方乘以一。

减去ROX1撇和YV1漂，那么我们这边需要注意的几个点，第一个点是呢，就是如果我这个欧式期权跟亚式期权，它们之间的相关系数越高，那么我这个control variance的这个方法呢。

对方差的减少呢就越好就越显著，那么第二个呢是就是我们的这个X1票，跟V1票都是欧式期权跟亚成期权，用蒙特卡洛模拟，我们通过模拟这个股价，underlying asset是这个几何布朗运动来得到的。

那我们需要注意的一点是，我们estimate这个stop pass只S每一次每一呃，我们estimate出来之后，把同样的stop pass给这个欧式期权跟亚式期权来price。

也就是他们是用同一条MONTECARLO的这个path来定价的，不能用不同的两条。

![](img/dac766c98f16c58236d5593a25a02571_19.png)

那我们介简单介绍这个亚式集权的定价公式，那么亚式集权在其他方面上跟欧式全都一样，它唯一的区别是这个pay off也是收益率，那么欧式巨型的收益率呢是中中值，X大T减去K然后取这个正号。

就是取这个跟零之间的这个最大值，那么亚式期权呢是一整个这个时间点上的，所有的这个股价，取了一个平均是平均股价减去这个strike price，然后取这个正号，也就是他们比零大的时候。

就是它们如果比零小的时候就是零，所以这个是亚式期权跟这个欧式期权之间的，这个pay off的区别，那在别的方面，包括maturity啊，VENTITY啊，包括stock的underline。

它是这个几何布朗运动啊，这些等等等等的这个assumption，也就是猜想呢都是一样的。

![](img/dac766c98f16c58236d5593a25a02571_21.png)

那么我们这边呢主要用的是欧式期权来control，原因是因为我们欧式期权，除了可以用这个蒙特卡罗来press以外，我们还有我们已知的这个bless sure of modern的公式，可以直接定价。



![](img/dac766c98f16c58236d5593a25a02571_23.png)

所以呢我们才能够得到这边的这个V，要不然没有这个V。

![](img/dac766c98f16c58236d5593a25a02571_25.png)

只有V1飘的话，我们没有办法做出这个control vari，所以control variant作为control的那个因子，基本上都是欧式期权，那么我们需要来改善的可以是亚式期权。

可以是barrel option，也可以是这个美式期权，那我们来简单看一下一个这个Python的例子，那么呢我们用european option来做这个control，那么对于这个嗯欧式气旋跟亚式齐全。

我们是一样的，这个strike和maturity。

![](img/dac766c98f16c58236d5593a25a02571_27.png)

那么我们这个strike是100，然后这一开始的值也是100，然后VITATE是0。25，我们出的题呢是一年，然后我们这个无风险利率是0。02，然后我们每一步的这个时间步呢。



![](img/dac766c98f16c58236d5593a25a02571_29.png)

是这个一个月为一个时间步骤来look back，那我们通过这个Python的这个代码的实现呢，我们会发现我们这个欧式期权跟亚式期权，pass之间的相关系数非常高，是0。85，也就意味着。

其实我们这个方差的这个呃，改善应该是非非常显著的，那我们可以通过我们这个公式，我们可以算出speed up的这个limit是多少，是接近于四的，那么actual呢是通过simulation。

我们来通过上下的比值来发现的。

![](img/dac766c98f16c58236d5593a25a02571_31.png)

因为我们CSPEUP的这个limit呢，就是这边其实就是一-11减去roll方。

![](img/dac766c98f16c58236d5593a25a02571_33.png)

就是我们这个speed up的这个效率是多少倍的关系，那我们通过这个control moniccolor variation，我们算出我们这个压式集权的价格，和它这个正负这个标准差。

也是我的这个置信区间，然后我们总共sim了10万条stop pass。

![](img/dac766c98f16c58236d5593a25a02571_35.png)

那我们用了这个0。31秒，我们可以看一下我们这个嗯代码。

![](img/dac766c98f16c58236d5593a25a02571_37.png)

就是如果直接算这个A选call的话。

![](img/dac766c98f16c58236d5593a25a02571_39.png)

那么我的这个monte color error是这么大的一个情况。

![](img/dac766c98f16c58236d5593a25a02571_41.png)

那如果我用这个嗯嗯就是用control variant的方法。

![](img/dac766c98f16c58236d5593a25a02571_43.png)

那么在这边呢我们就是实现我们这个control variant。

![](img/dac766c98f16c58236d5593a25a02571_45.png)

包括这个你呃计算这个coefficient，我们算贝塔，算完贝塔以后呢。

![](img/dac766c98f16c58236d5593a25a02571_47.png)

这边就是我们control variant的表达式，那我们算好control variant的表达式之后呢。



![](img/dac766c98f16c58236d5593a25a02571_49.png)

我们可以得到我们这个时候的monte color error，是0。017。

![](img/dac766c98f16c58236d5593a25a02571_51.png)

那比上面的这个error呢来的有所改善，然后我们这个speed up的立面也是，我们改善了3。71倍，那为什么我们用这个呃欧式期权跟亚式期权，这个pair我们的效果会比较好呢，那主要的原因呢。



![](img/dac766c98f16c58236d5593a25a02571_53.png)

是因为我们来看这个X1漂跟V1票，我们知道他们的相关系数越高，那么我们改善的效果呢就越好，那么在这边呢，大家的这个就是存在一个可以用肉眼，比较可见的一个线性的一个相关关系。

所以说我们用这个亚式期权的效果会比较好，那我们同理呢可以用美式期权一样来做，Control variance，也就是把亚式期权的位置换成美式期权，也就在上面这边的这个X1票。



![](img/dac766c98f16c58236d5593a25a02571_55.png)

我们用美式期权的价格来替代。

![](img/dac766c98f16c58236d5593a25a02571_57.png)

那么美式期权的这个store simulation的方法呢，用我们上节课提到的这个最小二乘MONTECARO来做，那我们得到最后的这个结果呢是这样子，如下的一个表达式。

我们variance reduction factor，就是我们改善了这个1。4倍，那么理由呢我们可以通过这个分布图来看出来，其实嗯，美式期权呢跟这个欧式期权的这个相关关系。

尤其是当这个strike price比较高的时候，我们可以看出他们这些相关关系，已经非常的呃发散了。

![](img/dac766c98f16c58236d5593a25a02571_59.png)

就是很难捕捉到相关关系，不像这个嗯，亚式期权跟欧式权的相关关系。

![](img/dac766c98f16c58236d5593a25a02571_61.png)

来的一直这么显著，所以说美式期权的效果呢会略差一些。

![](img/dac766c98f16c58236d5593a25a02571_63.png)

那么美升期权的这个代码呢在这边，那么唯一的区别呢就是美式期权的定价，那么美式期权会用到我们的这个上面的，这个MC嗯，嗯就是我们上一节课我们写出来的这个american option。

pricing的这个PRICER，那么需要注意的是，这个s path就是geometry bro motion的这个s pass呢。

跟我们来price european option是要用一样的这个stop pass，所以把这个s pass呢直接带到这边来，那么在estimate european pull的时候呢，也是一样的。



![](img/dac766c98f16c58236d5593a25a02571_65.png)

用同样的这个stop pass，那么这个呢是这个control variance的原理，跟我们在美式期权，跟这个亚式期权的这个嗯使用。



![](img/dac766c98f16c58236d5593a25a02571_67.png)

那我们来回顾一下这个anticii path，其实antithetic path呢它是这个control variant的一个特例，我们可以把这个antithetic这个12的这个呢。

拆成X1PW加上12的X负W减去XW，那我们可以看出，其实这个就已经是一个这个上面，control vari的一个表达式，那么在这边他并没有对我们这个贝塔的口语，非选做最优化，而是直接定死了一个1/2。

所以antithetic呢就是不如control variant来的，generic就来的通用，而且他的这个贝塔因为是一个定死的关系，所以我们呃通常情况下是很难很难达到最优的，这个改善效率的。

所以呢control variance是比ANTISEI来的好，那为什么有时候还会用antithetic呢，因为我们每一步不需要去最优化这个贝塔，不需要去解这个额最优化的公式，我们直接用这个1/2。

所以它是实行起来比较方便的一种方法，就对于antithetic来说，所以我们接下来总结一下control variant，然后我们后面来着重的讲一下，重点采样也是important samply。

那么control variance的呃小结呢，其实我们通过前面的举例已经能看出来它的呃，优点跟他的那个缺点，那么它的优点呢是control vari呢是最好的，这个VARI的降低方法。

因为呢他在算control的时候的这个control因子，贝塔是通过我们的理论值来计算出来的，那么它implement也比较简单方便，而且它还可以用于做delta对冲。

因为delta对冲其实也就是计算我们的那个啊，我们上面提到过的这个贝塔，就是其实也是对冲因子，那他的缺点呢其实也很显著，也就是他对产品的选取非常的敏感。



![](img/dac766c98f16c58236d5593a25a02571_69.png)

比如说我们上面这个美式期权的效果，就不如这个亚洲期权，所以如果我们做的不是这两个，可能是别的期权，那么它跟欧式期权，如果它的相关系数非常低的话，那么用这个control vari呢就几乎没有什么效果。



![](img/dac766c98f16c58236d5593a25a02571_71.png)

所以它对我们选取什么产品来做这个pair呢，是非常的敏感的，那么这呢就是control vue的一个小结。



![](img/dac766c98f16c58236d5593a25a02571_73.png)

那么接下来让我们来看这个important sampling，也就是重点采样，那我们会花比较大的篇幅来着重介绍，这一个啊方法，因为它呢不管是从原理还是从实现上来说，会相对比较困难。

但是他在做这个风险管理。

![](img/dac766c98f16c58236d5593a25a02571_75.png)