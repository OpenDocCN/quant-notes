# 换手率因子与停牌与涨停的问题的解决-blacktrader-量化金融与机器学习2024 - P1 - 背包2004 - BV1At421A7gn

![](img/a050f4f12ababfeb0a021977549a9a15_0.png)

好吧，前面那个部分我们讲到了啊，这个换手率这个因子腰啊。

![](img/a050f4f12ababfeb0a021977549a9a15_2.png)

特别特别变态啊，特别变态，啊这简直就，就是为什么会这样呢，最主要是这样的啊，我们是选的换手率比较小，大家想一想什么情况换手率比较小，就大家都不买那个股票了，什么情况下换手率比较小，一般是涨停的时候。

涨停的时候换手率会比较小，能理解吧，所以说呢我们这个方案是为什么会这样呢，是因为啊我们总是在涨停的时候去买股票，能够吃到人家的涨停，主要是这个原因啊，但是呢按理说理论上一旦股票涨停，你是没法交易的。

但是我们这里这个程序里面没有设置这个机制，我们始终是什么呢，在这一天判断这个股票要买，然后第二天就买入，不管第二天到底是停牌还是还是涨停，还是什么啊，都会去买它，都会去买它，而且呢因为我们在这里啊。



![](img/a050f4f12ababfeb0a021977549a9a15_4.png)

![](img/a050f4f12ababfeb0a021977549a9a15_5.png)

在这里我们做了一个做了一个什么呢，做了一个空值的一个填补，这个填补会导致什么呢，导致他如果是停牌呃，他本来是在那一天是没有任何交易的，没有任何交易，他停牌了，但是因为我们把这个价格填补进来了。

填补进来了，然后呢我们就能够在那里交易了，因为系统他不知道啊，不知道他停牌，这是这个东西最大的原因啊，这是这个东西最大的原因，不信我们可以去掉它，我们就不用它旁边的价格，来来来来，那个呃来填补。

我们用一来填补。

![](img/a050f4f12ababfeb0a021977549a9a15_7.png)

你会发现发生了巨大的变化啊，会我们来运行一下这个球。

![](img/a050f4f12ababfeb0a021977549a9a15_9.png)

就这个时候把价格用一就停牌的价格，不是其他价格。

![](img/a050f4f12ababfeb0a021977549a9a15_11.png)

用一来填补，等一下。

![](img/a050f4f12ababfeb0a021977549a9a15_13.png)

好。

![](img/a050f4f12ababfeb0a021977549a9a15_15.png)

然后变成2000多万了。

![](img/a050f4f12ababfeb0a021977549a9a15_17.png)

2000多万，所以少了点是不是，但是可能还是不够啊。

![](img/a050f4f12ababfeb0a021977549a9a15_19.png)

还不够啊，但是他至少他说明他变了啊。

![](img/a050f4f12ababfeb0a021977549a9a15_21.png)

他变了，他应该是很多时候是踩到了停牌的位置。

![](img/a050f4f12ababfeb0a021977549a9a15_23.png)

所以他会才才会，你看看没有，他在停牌的时候还成交了，看到没，而且是以一块的价格成交的，哈哈以一块的价格成交的。



![](img/a050f4f12ababfeb0a021977549a9a15_25.png)

即便是这样，他还是涨了挺多的啊。

![](img/a050f4f12ababfeb0a021977549a9a15_27.png)

啊这也就是说它不仅是因为买了停牌，而且是还买了很多涨停。

![](img/a050f4f12ababfeb0a021977549a9a15_29.png)

因为涨停的话，我们的数据是有的啊，是不会是一的啊，虽然说停牌，他在这里以一的价格成交，应该是亏钱的啊。



![](img/a050f4f12ababfeb0a021977549a9a15_31.png)

应该是亏钱的好吧，也就是说我们现在大概了解啊。

![](img/a050f4f12ababfeb0a021977549a9a15_33.png)

最主要是因为我们在这里的处理啊。

![](img/a050f4f12ababfeb0a021977549a9a15_35.png)

使使得系统其实并不并不了解他，我们首先我们必须得这样处理，因为black trade要求你每一个真实的交易日，那个股票都得有数据啊，他不能让他没有数据，他必须得这么处理，只是说在这么处理之后呢。

你的策略要要要自己去考虑这一点啊。

![](img/a050f4f12ababfeb0a021977549a9a15_37.png)

不能不考虑啊，不能不考虑，那应该怎么考虑呢。

![](img/a050f4f12ababfeb0a021977549a9a15_39.png)

啊我们来我们先恢复这个东西，然后呢我们到到我们的程序里面来考虑。

![](img/a050f4f12ababfeb0a021977549a9a15_41.png)

程序里面来考虑。

![](img/a050f4f12ababfeb0a021977549a9a15_43.png)

我们把这个程序，拿过来放到下面去。

![](img/a050f4f12ababfeb0a021977549a9a15_45.png)

放到这里来，然后交易代码也发过来。

![](img/a050f4f12ababfeb0a021977549a9a15_47.png)

![](img/a050f4f12ababfeb0a021977549a9a15_48.png)

我们要改这个东西，首先他是在前一天判断，然后在第二天发生购买，我们必须得什么呢，在判断的时候我们就不要放，对于对于第二天，对于第二天，如果那个股票会停牌，或者是那个股票会发生涨停，这样的情况。

我们就不交易，不去不去碰这些，因为涨停我们是买不进的，能理解吧，涨停是没法买的，不能去破坏这个规则。

![](img/a050f4f12ababfeb0a021977549a9a15_50.png)

所以我们得加个条件啊，加个条件你在这里加一下呃。

![](img/a050f4f12ababfeb0a021977549a9a15_52.png)

得加个条件，加个什么呢，我们得得建立一个股票池，他呢，首先这个股票必须在第二天得有，什么叫待第二天得有了，已经是在，他加一，他必须得第二天是这个股票，在第二天是有价格的，不是说你补充它。

它必须得有价格啊，注意一下啊，这里的数据是没有被填补过的啊，我们只是在什么呢。

![](img/a050f4f12ababfeb0a021977549a9a15_54.png)

只是在，只是在导入啊。

![](img/a050f4f12ababfeb0a021977549a9a15_56.png)

只是在导入这个交易策略的时候，对股票价格做了填补，原始的那个数据是没有填补的，所以说我们直接获取第二天的股票。



![](img/a050f4f12ababfeb0a021977549a9a15_58.png)

这些股票只要是获取到了，就说明他第二天是有价格的，并且还加个条件，再加一个条件，加个什么条件呢，给个and，并且什么呢，并且在，并且它的，开盘价，它的开盘价是要等于它的收盘价，停盘我觉得可以用这个定义。

但是这个定义并不严格，是不是因为有些东西，有些股票是不是他开开开盘开盘九块钱，然后它它它中间震荡震荡，然后到时候玩游又是九块钱，这种情况是有的啊，这种情况他没有停盘，但是但是还被我们误判了。

但是这种误判的几率还是比较小的，所以说我们我们就这样吧啊，用这样简单的方式来判断是否停牌，是否停牌，是否涨停，是否涨停，我们用这个方式啊，用这个东西来判断，所以他的开盘要等于收盘。

这样的股票我们把他的什么呢，把他的股票代码获取到。

![](img/a050f4f12ababfeb0a021977549a9a15_60.png)

然后呢再把它搞成列表，再把它搞成列表。

![](img/a050f4f12ababfeb0a021977549a9a15_62.png)

搞成列表之后呢，这样这样我们就有了我们的股票池，我们先运行一下啊，他没问题，有了这个股票池的列表的话，我们在下面就就得在下面就得做一些事情，什么事情呢，我们在前一天选取股票的时候就得加个条件。

什么条件呢，就是这个这个股票啊，股票的，股票代码，必须在点is in，他要带什么呢，要在我们的那个股票池里。



![](img/a050f4f12ababfeb0a021977549a9a15_64.png)

不在第二天的那个股票池里面，我们就不选它，加这样一个约束条件。

![](img/a050f4f12ababfeb0a021977549a9a15_66.png)

还没加上这两个约束条件，我们先运行一下，看行不行，可以把这个break去掉。

![](img/a050f4f12ababfeb0a021977549a9a15_68.png)

![](img/a050f4f12ababfeb0a021977549a9a15_69.png)

然后再看一下换手率的回测结果，注意一下啊，呃这个效应只有换手率是非常明显，如果是市值和市盈率这些这些特征，你取它最小最大的都都其实都问题不大，他只是在一定概率上，会碰到一些停牌或者是涨停的。

但是但是不会影响太大啊，只有换手率影响非常大。

![](img/a050f4f12ababfeb0a021977549a9a15_71.png)

所以换手率必须得考虑这一点。

![](img/a050f4f12ababfeb0a021977549a9a15_73.png)

哎这咋啦。

![](img/a050f4f12ababfeb0a021977549a9a15_75.png)

这这这这这我肯定肯定出了问题啊，同学们啊，是这样，是这样的啊，不能它等于的，就是我既要我们要选择第二天可以交易的股票，那么它是一个不等于啊，啊是一个不等于能理解吧，就是收盘价不能等于开盘价。

我们要选择不能涨停，不涨停的股票吗，能不能理解，同样不等于啊，不能不能用等于啊，不能用等于啊，就是等于的话。



![](img/a050f4f12ababfeb0a021977549a9a15_77.png)

他肯定就涨停了，涨停了就不能买了啊，不能买的，就你看为什么它会变成从之前的五千五千多万。

![](img/a050f4f12ababfeb0a021977549a9a15_79.png)

变成了9000万呢。

![](img/a050f4f12ababfeb0a021977549a9a15_81.png)

就是我们这里还加强了这个这个效果，加强了这个效果，每次都买涨停的，那当然那当然厉害啊，要要要不等于不等于啊。



![](img/a050f4f12ababfeb0a021977549a9a15_83.png)

然后再看一下，看一下效果。

![](img/a050f4f12ababfeb0a021977549a9a15_85.png)

![](img/a050f4f12ababfeb0a021977549a9a15_86.png)

再看一下吧，我感觉这个空调有效果吗，同学们，不是这个控制的太狠了。

![](img/a050f4f12ababfeb0a021977549a9a15_88.png)

![](img/a050f4f12ababfeb0a021977549a9a15_89.png)

你看这是不正常了，是不是总算少赚，那些是不是经过老师的一番折腾啊，我们从这个赚了这个几千万，变成了只赚100多万了啊。



![](img/a050f4f12ababfeb0a021977549a9a15_91.png)

只赚100多万了好吧，这样大概就差不多了，这样大概就差不多了，至于这。

![](img/a050f4f12ababfeb0a021977549a9a15_93.png)

至于这，这这这100多万的收益到底是怎么来的呢，还是还会因为一些问题吗，我也不清楚啊。

![](img/a050f4f12ababfeb0a021977549a9a15_95.png)

我觉得我已经啊已经这个了啊，已经做的差不多了，差不多了好吧。

![](img/a050f4f12ababfeb0a021977549a9a15_97.png)

同学们试一试啊。