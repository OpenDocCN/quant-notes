# MACD线策略-backtrader的通用量化框架-量化金融与机器学习2024 - P1 - 背包2004 - BV18p421X7YB

好吧，我们一起学习一下这个经典的一个呃均线啊，一个经典的均线，很多的那个呃投资的软件，或者说平台都会提供这个东西啊，提供的东西大家都觉得这个东西好像很有用，好像很有用哈，所谓的MACD线啊。

这种线或者这一类线，它其实包括我们之前的那个均线策略啊，它都来源于一个思想，什么思想呢，就是我们想要赚钱，想要投资我们最最最最好的方式是什么呢，是不是要在一个股票刚开始上升的时候，我们买入，是不是。

然后呢在这个股票快要下跌的时候卖出，这是不是我们所有投资者的梦想，就是这样子，快上升之前要买入，快下跌我要抛出啊，这是一个非常朴素的一个思想啊，这样有了这个思想，我们是不是就会问一个问题。

那什么情况下它是属于快上升的情况下，它是属于就就快要快要快要快要那个了，快要快要跌落了，所以这个时候就存在于你需要怎么去定义了啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_1.png)

怎么去定义了，你看我们上面的最简单的一个均线策略。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_3.png)

它定义的很简单，就是说哎呃你这个股票的价格啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_5.png)

这怎么这么远，股票的价格高于30，我认为它就可能是要快上升，可能要要来一波起飞了，我们就买入，然后呢他低于30日均线的时候，哎他很可能还会跌，它就平仓啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_7.png)

就这么一个思想啊，这是我们之前的均线突破。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_9.png)

而这个MACD线其实也一样，思想跟那个是完全一样的。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_11.png)

只不过是大家之前其实看到了啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_13.png)

如果简单的啊，如果简单的用这个股价和均线，其实是有一些问题的，其实最大的问题大家其实能看到吗，就是这有很多的地方啊，啊很多的地方它实际上是有些纠缠的，看见没有，你看它它它会存在很大的反复。

反复的一个很核心的东西呢，就是你股价本身是有很大的波动性和变化的，你如果用股价和均线的交叉，这就意味着会肯定是会有存在，很多反复交叉的情况，这种其实是并不好的，会增加很大的一个交易成本。

因为我们是有佣金的啊，是有佣金的啊，就会带来非常多的假信号啊，假信号正是因此，我们所以很多人会思考，我们不要用股票和均线的交叉，是不是可以用均线和均线的交叉，这样是不是更好。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_15.png)

而且更进一步啊，而且更进一步，我们的MACD线其实是更进一步的思想啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_17.png)

你看啊他，不仅是看均线和均线的交叉了，他首先他拿拿到一个，他应该是从均线和均线交叉出发的啊，首先他拿到了一个比较快的均线，就是你看12日的一个指数移动平均，然后拿一个比较慢的均线，一个比较慢的均线。

然后呢其实就是在看他的交叉，看它什么呢，看这两个均线的差值能理解吧，看他这两个均线的差值啊，这两个均线的差值呢就会就得到了，这样一个DF线，它是用两条一条快均线和一条慢均线的差值。

得到了他这里一个所谓的离差值啊，离差值得到了这个离差值之后呢，然后再把这个离差值又做一个9日的，一个不一定是9日啊，急着都行啊，又做一个均线啊，又做一个指数啊，移动平均得到了这个离差值的移动平均啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_19.png)

然后呢，再算这两者之间的差值，再看这个这个这两者，再算这两者之间的一个差值，才得到所谓的MACD值，当然这个差值会乘以一个二哈，也就是大家看到最终的MACD值是什么呢，是两条快慢均线的差，然后再取值。

再取移动平均，然后再求的差值就得到了一个MACD值啊，他是求了两个差，求了两个差，好吧，这是他这个这个指标的构建的，一个具体的一个方法，就是这么构建的啊，就这么构建的，大家稍微了解一下哈。

稍微了解一下呃。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_21.png)

然后我们来做一做啊，我们来做一做这个，啊做一做这个线啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_23.png)

做一做这个线啊，我们使用的话就很简单，你看诶我们刚才是平那个那个是给到了平安。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_25.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_26.png)

是不是，啊是平安。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_28.png)

我们把那个比亚迪的数据给到了平安，是不是我们比亚那个这个就没有啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_30.png)

我们取这个，你看我们要做这个线，很简单，直接调这个包，然后呢MACD，然后把我们的那个数据给导进去啊，导进去导进去之后呢，呃定义一下它的什么呢，快快的那个线。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_32.png)

我们这里快线取得六二十，它上面是什么。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_34.png)

上面是12和26，是不是，那我们也取12和26吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_36.png)

先先按照他的说法来做一下，然后呢他的这个实现呢取的是九。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_38.png)

取的是九，啊然后呢把这个东西的结果给到三个字啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_40.png)

为什么是三个值呢，我们刚才看刚才跟大家讲了。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_42.png)

你看啊这一套东西其实首先得到了一个离差值，然后DF还有一个DEA还有一个MACD。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_44.png)

这其实有三个三个词。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_46.png)

这三个词分别对应的什么呢，就是XYZXYZ。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_48.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_49.png)

啥情况，这个不用啊，我们直接拿的是close是吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_51.png)

这样的话我们就有了有了我们的XA，点BRT是吧，我看看啊，为什么他啊，为什么他不做成，为什么不能拖出一个图啊啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_53.png)

得用Y吗。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_55.png)

哦哦可能是上面我我什么地方没有没有关掉。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_57.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_58.png)

这个没有关掉啊，这个也关掉，不关掉，他做不出来啊，就这个这里有个东西啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_60.png)

要关掉它，啊这样应该可以，这是为啥呀，我我用别的方式做一下。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_62.png)

啊啊这折腾了一下好像就可以了啊，这个他black trade，他作图的话是有点有时候有些问题啊，有些问题，然后我们可以做，我们可以把这个图弄弄的大一点啊，对吧，是不是，然后还有一个是Z。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_64.png)

是吧啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_66.png)

就是这这三个三条线的一个图啊，其实也很简单，只要用那个库调一下就能出来啊，调下就能出来，然后呢我们来来看一下它的策略。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_68.png)

然后实现一下就可以了啊，实现一下就他的策略是啥呢。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_70.png)

它是指这快线和慢线都大于零啊，都大于零，快线向上突破慢线再买入，然后下面就是卖出啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_72.png)

那其实也很简单啊，其实也很简单，首先呢我们的。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_74.png)

X是这种东西啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_76.png)

这种东西，然后呢我们点index吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_78.png)

我们基于它来做循环，据他来做循环，然后判断判断到底是满不满足条件。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_80.png)

是否满足条件，所以说我们嗯X提前一点。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_82.png)

因为有些时候他前面一段是是空值啊，前面一段是空值，我们也用刚才是30吧，因为我们是26嘛是吧，所以说我们做个循环，MACD线啊，做个循环，然后呢要做一些判断啊，要做一些判断，什么判断呢。

如果首先它是要两条线都大于零，我们的一开始的四个快线快线呢，它的I是要大于零啊，Y的慢性也得大于零啊，也得大于零，然后呢还有什么还有呃它要向上突破，我们刚才之前讲过，我们其实也讲过这个事情。

所谓的向上突破呢就是他两条线啊交叉啊，所谓的向上突破就是快的那个线啊，快的快的那个线从下往上，从下往上突破这个慢的这个线啊，慢的这根线就这么一个过程，那这个过程是什么呢。

啊通常我们要算这前后两天的一个情况啊，要算一下前后两天的情况才能判断出啊，他是否是向上突破啊，是否是向上突破，这就意味着呢我们需要不仅是对当天的数据，还要看他前一天的数据，这样才能够判断啊。

还要看他前一天的数据，呃而且呢我们我们是要判断他是，一开始是否小于它，然后呢到了这里他是否大于它，是否大于它，但是这个判断我们其实不需要搞了，因为我们有我们的那个Z啊，它其实就是X减Y的乘以二。

所以X到底是大于还是小于Y，主要看的就是Z是否大于零，或者Z是否小于零，能理解对吧，能理解这个吧，所以我们有了这些的话，首先我们得要要两天的数据，才能够做这个事情啊，看前一天的这个Z啊是否啊是否小于零。

然后看最后一天的Z呢是否大于零，这样的话就说就就形成了所谓的向上突破，向上突破，好吧啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_84.png)

有了这些，有了这些，我们很显然啊我们得有一个得有两天的字，所以说还是像之前那样啊，I0等于什么呢，等于X点index29吧是吧，得得弄他前一天的啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_86.png)

所以说，我们看一下都要大于零啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_88.png)

所以我们首先是Z的I，在这一天他在当天他是要大于零的，并且呢Z的I0再再前一点呢，它是要小于零的，好这个条件应该定义好了，条件定义好了，我们需要把它放到我们的balance里面，可以，得等于。

所以说到了这里，所以我们教给我们的什么呢，给我们的STA，是吧，然后呢给到我们的那个那个什么股票。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_90.png)

这股票是啥来着，好像是我们的比亚迪。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_92.png)

是不是就这个吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_94.png)

好这是买入的信号，我们差不多搞定了，当然肯定还有买卖出的信号，卖出的信号，卖出的信号，刚才讲了，他无非就是要小于零嘛。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_96.png)

是吧是吧，我看一下啊，他都小于零。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_98.png)

然后向下突破，其实就就反过来了，诶这个零没有哈，他都要小一，然后呢他一开始是，Z1开始是我看一下它是向上突破，ZZZ后面这是后面任要小于零的，然后呢一开始是要大于零的诶，一开始是要大于零的，是不是。

这样就可以了哈，这样应该就没问题了啊，应该就没问题了，而且这个不存在要用信号，因为它这个交叉不会时时刻都交叉啊，他只带一个点交叉，就不存在，需要像上面那个需要做一个信号来来反转，它好像这样就行了呀。

这样就行了，我们看一下这个买入的这个时机正不正常诶。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_100.png)

这是啥回事啊，就这里还得有个这个东西啊，就是因为我们两天嘛，他他嗯当天到了下一次就变成下一天了，所以说艾琳是要呃那个传递一下。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_102.png)

这样才行啊，传递下这样这样就行了哈，多就加一个这个东西啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_104.png)

加一个这个东西，然后这是这个啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_106.png)

好有了这个的话，其他就是很简单的，就是把代码拷贝过来运行就行了啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_108.png)

把代码拷贝过来运行，我们刚才运行的那个代码在哪里啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_110.png)

啊就这里嘛是吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_112.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_113.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_114.png)

然后还有策略的那个。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_116.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_117.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_118.png)

啊其他的都不用改啊，都不用改是吧。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_120.png)

怎么还能亏钱，这不是有点搞笑吗，我们看一下啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_122.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_123.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_124.png)

好像也没怎么买入。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_126.png)

一个比较有意思，他为什么要全部买入卖出，他这里卖出了。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_128.png)

5月17号。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_130.png)

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_131.png)

好不好，这个没问题，就是这么个情况啊，如果换成18年的话，他是能赚一点钱的啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_133.png)

能赚一点钱，但是实际上这个策略并不好，并不好哈。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_135.png)

如果换成18年的话，就更早的话，他是能赚赚一点钱。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_137.png)

但是相比本身比亚迪的涨幅来说啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_139.png)

这个肯定是比较落后的哈，比较落后的。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_141.png)

好实现就是这么个实现方法啊。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_143.png)

我们稍微最主要是了解一下他这个东西的意义，好未来呢我们可能用用机器学习的方法。

![](img/f643c4b9ce67a6ef7c2bae6c0324e816_145.png)

把它作为一个因子，应该会更好一点啊，更好一点啊，从我们从我们刚才这两个实验其实能够看出，就单纯对某个股票对它的均线啊，根据均线的一个交叉来作为信号来买入买入，其实现在其实已经嗯基本上是不行的啊。



![](img/f643c4b9ce67a6ef7c2bae6c0324e816_147.png)

不行的好吧。