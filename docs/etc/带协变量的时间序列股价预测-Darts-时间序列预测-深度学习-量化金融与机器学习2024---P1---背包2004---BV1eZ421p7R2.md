# 带协变量的时间序列股价预测｜Darts｜时间序列预测｜深度学习-量化金融与机器学习2024 - P1 - 背包2004 - BV1eZ421p7R2

好刚才是讲了多变量，这一次呢我们讲所谓的协变量啊，这两者有什么区别呢，就不管是协变量还是多变量啊，它都有个共同点，就是他有好几个时间序列啊，有好几个时间训练，当然区别在于什么地方呢，就是在多变量里面。

你其他的那些变量它是要参与，他是要一起参与模型的预测的懂吗，就是模型也要负责，对那些其他的一些变量进行预测啊，咳而协变量不一样，协变量呢其实是一一些额外的特征啊，这些就这些特征它也可以引入到。

就是除了时间序列本身，还有其他的一些序列特征，它可以辅助来进行时间序，进行这一条时间序列的预测啊，然后这种东西就称之为协变量啊，协变量其实这很显然，你看我们的那个之前积极学习的股价预测里面。

当然不仅仅是通过股票的数据来做预测，肯定是还要基于什么，基于那个呃市盈率啊，基于其他和市值啊这些这些东西来合起来，对这个股票的价格的趋势做预测，我们时间序机器学习里面拿到怎么改。

而在时间序列里面怎么引入，除了时间序列本身的一些特征呢，通常是通过啊，通常是通过所谓的协变量啊来引入的，当然刚才我们用多变量的方式引入了一些特征，我也不知道哪种好，我觉得可能是这种更好一点啊。

就是一些额外的不重要的，不想去预测的一些特征，我们把它做成协变量，可能是会更好一点啊，可能会更好一点，而所谓的协变呢。



![](img/703fb7c8cc3128114cf3589d654b3c06_1.png)

它其实是分为两种，分为两种，两种写变量，一种是过去的协变量，还有一种是可以未来的协变量，这什么意思呢，这什么意思呢。



![](img/703fb7c8cc3128114cf3589d654b3c06_3.png)

这个图里面可以给大家展示清楚啊，你看假设上面这个蓝色的，是我们要预测的时间序列啊，我们这是我们的过去值，而我们是目标是要预测这个未来的值，是不是未来的时间序列，那么所谓的协变量就有这两类。

这两类的区别就很简单，一种是什么呢，所谓的过去协变量，就是你你你在预测未来的时候，写这个未来是没有这个斜面量，这个值的能理解吗，能不能理解什么意思呢，你看啊，如果我们把市盈率作为股票的协变量。

那我们我我们预预测9月1号之后的股票价格，能理解吗，能理解吗，那这个时候市盈率这个东西，它只出现在特征里面，只出现在之前，不会出现在未来，但是还有一种协变量呢，我们虽然说没预测，但是它未来是有的。

未来是有的，什么样的写变量，未来是有呢，最典型的就是时间哈，时间是未来，什么是时间是未来也有，但待会大家就能看到了，有些东西有些变量未来是有的啊，未来是有的，就是没预测未来，它也也有啊。

也有下面那个例子里面就就很简单。

![](img/703fb7c8cc3128114cf3589d654b3c06_5.png)

你看这个他是在做一个协变量啊，做一个协变量，他做什么样的协变呢，你看股票依然是用用的，我们的股票那个，咳依然是用的，我们那个比亚迪的去年级的股票啊，比亚迪的训练局的股票，这个他是这他用这个东西的话。

应该是会把它当成一个什么呢，当成一个过去的协变量，就是未来它假设不出现，其实这个是可以当成未来写变量的，但是这里他把他当成过去的，但没问题，我们就就用这个，你看这个东西是干啥了。

他是把这个训练集的时间索引的月份抽取出来，做成了一个时间序列，而这个月份呢他把每个月份的月份值除了12。



![](img/703fb7c8cc3128114cf3589d654b3c06_7.png)

除以了12啊，最终这个东西还呃呃，下面这个是另外一个另外一个写变量，它是把这个时间序列呢的年份抽取出来，然后呢用这个年份的值呢减去了2020，为什么要减去2020呢，因为我们的数据是2021。

2022和2023吧，好像是这几个年份减去二零的话，就让这个年份变成了一一和二吧，一和三啊，这样的话把它封装cc到一起，把这两个协变量concrete到一起，凑成了一个我们的这个协变量好。



![](img/703fb7c8cc3128114cf3589d654b3c06_9.png)

然后这里是把这个协变量可视化出来，你看是不是有两条线，一条线是我们的月份，看见没有，这个月份的词其实是很好理解的，你看这不是1月2月，3月4月56789十十一，他是零啊，这应该是一就是12个月。

每个月对应的它的月份的值，当然这里是做了一个除以12，所以说做了他让他投影到0~1之间呢，能理解吗，他做做了这样一个一个这是一年的，然后这是第2年的，看到没有，这是第2年的。

我们的数据应该就是2022~2023，所以是这两年，然后你看这个是年份的协变量，它在这一年他是这个应该是应该对应的，就是什么，就是一吧哈，这一年对应的就是二，当然他是他把他投投过来的嘛。

所以说他是零点几啊，就是每一年对应的一个值，这就是用时间做做出来的两个写变量，大家其实要注意点这两个，写这个这个东西其实很重要的，大家不要以为这个好像这有啥用啊，哈这个很有用哈，这个挺有用的。

其实我们之前的机器学习的特征工程里面，我们只是把这个这一步给漏掉了，其实你在做机器学习的时候，把月份和年份，甚至星期甚至日期，这些东西要把它做成一个呃变量，其实也是能很好的提升你的预测，预测精度的啊。

好吧呃大家理解了没。

![](img/703fb7c8cc3128114cf3589d654b3c06_11.png)

这个协变量就是这么个东西啊，当然这是他这里呃用日期转换出来的协变量啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_13.png)

转换出来的协变量用这个方式好。

![](img/703fb7c8cc3128114cf3589d654b3c06_15.png)

然后有了这个协变量，你看这个协变量其实就是什么。

![](img/703fb7c8cc3128114cf3589d654b3c06_17.png)

就是一个时间序列啊，就是一个时间序列啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_19.png)

看见没，无非是这个时间训练什么呢，它的components是有两个。

![](img/703fb7c8cc3128114cf3589d654b3c06_21.png)

一个是啊月份，一个是年份啊，一个是月份。

![](img/703fb7c8cc3128114cf3589d654b3c06_23.png)

一个是年份，他的index还是我们的date啊，还是我们的date。

![](img/703fb7c8cc3128114cf3589d654b3c06_25.png)

有了这样一个协变量怎么用上去呢，你看这里已经用上去了啊，依然是我们那个模型，然后呢把它给到这个past过去的写变量，把它给到这个词，其他的不变，然后运行就行了哈，然后运行就可以了啊。



![](img/703fb7c8cc3128114cf3589d654b3c06_27.png)

黄运行就可以了。

![](img/703fb7c8cc3128114cf3589d654b3c06_29.png)

又要等好啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_31.png)

这个搞完了，然后你看，只需要加到这里面就能出结果啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_33.png)

就能出结果，当然这个结果同学们在再把他预测出，再用这个predict的时候注意一下啊，就是你如果，额要做预测的话也需要什么呢啊，也需要把协变量要给过来啊，要给过来啊。



![](img/703fb7c8cc3128114cf3589d654b3c06_35.png)

也是要给过来的啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_37.png)

啊这个36应该是太大了哈，我们之前是12。

![](img/703fb7c8cc3128114cf3589d654b3c06_39.png)

所以说12是可以的吧。

![](img/703fb7c8cc3128114cf3589d654b3c06_41.png)

![](img/703fb7c8cc3128114cf3589d654b3c06_42.png)

刚才应该是这个啊，这个要要给训练集的这个东西啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_44.png)

然后和然后和这个配起来啊，就行了。

![](img/703fb7c8cc3128114cf3589d654b3c06_46.png)

好你可以看他的结果其实也差不多啊，没看起来没有特太大的一个变化啊，一个变化，啊是这里啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_48.png)

![](img/703fb7c8cc3128114cf3589d654b3c06_49.png)

是吧，然后我们看一下它，把它延长看看。

![](img/703fb7c8cc3128114cf3589d654b3c06_51.png)

他这个超出范围了啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_53.png)

我们只能够12是最大的，因为他带协变量的话。

![](img/703fb7c8cc3128114cf3589d654b3c06_55.png)

12是最大的，但是呢从这里看到加了这个协变量的话，它的这个这个要小不少了是吧，是要看起来是要好不少。

![](img/703fb7c8cc3128114cf3589d654b3c06_57.png)

就加了这个时间的这个协变量啊，加了时间的协变量看起来是好不少。

![](img/703fb7c8cc3128114cf3589d654b3c06_59.png)

另外的话额具体老师就不做了。

![](img/703fb7c8cc3128114cf3589d654b3c06_61.png)

就如果你不用时间的协变量，还可以用别的什么呢。

![](img/703fb7c8cc3128114cf3589d654b3c06_63.png)

可以用什么呢，可以用我们的那个。

![](img/703fb7c8cc3128114cf3589d654b3c06_65.png)

啊用这个其实也是可以完成预测的。

![](img/703fb7c8cc3128114cf3589d654b3c06_67.png)

好就是时间协变量是一个特殊的协变量啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_69.png)

你如果不用时间写变量，用这个也行的哈，把我们之前的多变量里面的这个东西，当成一个协变量放进去啊，当成一个协变量放进去也是可以的啊。



![](img/703fb7c8cc3128114cf3589d654b3c06_71.png)

如果你既想要要我们的这个这个什么，这是应该是我们的交易量。

![](img/703fb7c8cc3128114cf3589d654b3c06_73.png)

是不是又想要交易量，这个量又想要这个时间呢，你应该把这个交易量用的放在这里，看见没，应该是用这个方式啊，对啊，然后然后把这个东西或者直接放进去啊，或者直接放进去啊，这个老师没有没有没有具体做。

因为没时间了啊，就放进去之后，然后再把这个放进来，就是你要加入多个协变量，你就把所有的变量都CONQU到这里面。



![](img/703fb7c8cc3128114cf3589d654b3c06_75.png)

然后再给到下面就行了啊，给到下面就行了，这是呃这是通常的协变量的引入方法。

![](img/703fb7c8cc3128114cf3589d654b3c06_77.png)

靠的就是这个东西，你可以如果是过去。

![](img/703fb7c8cc3128114cf3589d654b3c06_79.png)

你用过去，如果是未来用未来哈，还有他还提供了提供了一个简更简便的方法啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_81.png)

来生成来生成这个对时间来说来生成协变量。

![](img/703fb7c8cc3128114cf3589d654b3c06_83.png)

![](img/703fb7c8cc3128114cf3589d654b3c06_84.png)

因为时间是可以生成很多不同类型的协变量的。

![](img/703fb7c8cc3128114cf3589d654b3c06_86.png)

具体的同学们看一下啊，你看可以用月份，可以用小时和星期几。

![](img/703fb7c8cc3128114cf3589d654b3c06_88.png)

还可以用它时间不长的绝对位置，以及你要预测的相对位置和年份等等。

![](img/703fb7c8cc3128114cf3589d654b3c06_90.png)

来生成更复杂的基于时间的一个协变量，而这个时候呢你都不用自己做，你像像这种方式来进行定义就行了。

![](img/703fb7c8cc3128114cf3589d654b3c06_92.png)

比如说你看这里举了个例子啊，而且还可以还可以定义它的未来还是过去，你看这里举了一个例子，在这里我们定义把这个月份年份星期，把它定义成一个未来的啊，这个星期好像不应该是day waf星期啊。



![](img/703fb7c8cc3128114cf3589d654b3c06_94.png)

具体的应该是这个应该是这个啊，把这些作为一个未来的协变量放进去，把这个字典定义好了之后呢。

![](img/703fb7c8cc3128114cf3589d654b3c06_96.png)

怎么用呢，你看用用这个参数，用这个参数引入进去懂吗，引入进去，他就能够把把时间自动的做成，符合你这个里面定义要求的协变量。



![](img/703fb7c8cc3128114cf3589d654b3c06_98.png)

然后再运行啊，这个也是能成功的啊，而且效果其实也还可以啊。

![](img/703fb7c8cc3128114cf3589d654b3c06_100.png)

但具体老师时间有限，老师就不做了啊，同学们呃自己尝试一下吧。

![](img/703fb7c8cc3128114cf3589d654b3c06_102.png)

好不好，自己做一下好了。