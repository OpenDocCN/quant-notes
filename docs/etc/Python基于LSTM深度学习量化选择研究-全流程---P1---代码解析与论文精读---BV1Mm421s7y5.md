# Python基于LSTM深度学习量化选择研究-全流程 - P1 - 代码解析与论文精读 - BV1Mm421s7y5

哈喽各位小伙伴们，大家好，之前我们讲解了那个基于机器学习的啊，股票量化选股研究，包括什么随机森林决策树，还有差距，B boost，那今天我们给大家讲一下这个基于深度学习的，尤其是基于循环神经网络。

LSTM的量化选股研究，首先话不多说，我们还是给大家讲解一下代码，就是这个这个过程中，主要是呃用于做学术研究或者作为练习的啊，当然是不能直接用于股市的，咱们只是为了做一个研究用的。



![](img/0508395d102525deb7f0486103f4cfbe_1.png)

首先我们来看一下这个代码。

![](img/0508395d102525deb7f0486103f4cfbe_3.png)

第一部分呢就是忽略警告嗯，因为有的时候我们在使用pandas，pandas的时候，可能因为版本不一致，或者因为其他原因，它会释放出warning，那么我们这个地方就给他把warning给忽略掉。



![](img/0508395d102525deb7f0486103f4cfbe_5.png)

首先第一步导入这个股票。

![](img/0508395d102525deb7f0486103f4cfbe_7.png)

导入这个股票之后，我们来看一下它的股票的一个时间序列。

![](img/0508395d102525deb7f0486103f4cfbe_9.png)

是那个2020年到2022年，3年的时间内的一个股票序列，我们可以打印一下它的股票代码，看看有多少只股票电。



![](img/0508395d102525deb7f0486103f4cfbe_11.png)

好总共是262只股票。

![](img/0508395d102525deb7f0486103f4cfbe_13.png)

首先可以看一下这个时间区间，我们刚才已经讲过了，是2020年1月到2023年，得不到2022年12月三年的时间内。



![](img/0508395d102525deb7f0486103f4cfbe_15.png)

那我在大家都知道啊，如果没有学过LSTM的话，可以去学一下相关的理论和公式。

![](img/0508395d102525deb7f0486103f4cfbe_17.png)

它有一个历史回望窗口，这个和传统的机器学习有很大的不一样点，机器学习呢是使用当前时刻的特征，用于预测下一时刻的label，那LSTM呢是不是使用当前时时刻了，是使用历史一定的窗口数内的数据作为输入。

然后预测下一个时刻的输出，那这个历史回放窗口呢，我们可以选择十就是选择十天。

![](img/0508395d102525deb7f0486103f4cfbe_19.png)

选择十天啊，然后我们可以设置一下这个训练集和验证集。

![](img/0508395d102525deb7f0486103f4cfbe_21.png)

我们以2022年6月之后的作为测试集，2022年6月之前的作为验证集。

![](img/0508395d102525deb7f0486103f4cfbe_23.png)

不是作为训练集好。

![](img/0508395d102525deb7f0486103f4cfbe_25.png)

那这个时候我们就搞出来这个训练，训练集和测试集，我们划分出来了。

![](img/0508395d102525deb7f0486103f4cfbe_27.png)

我们先划分出来，看到没有，这个0001，然后是2020年1月，到2022年5月31日，这么多年了，相当于是两年半的时间作为训练，半年的时间作为回测，这样是传统大家都这么公认的这么做的做法。



![](img/0508395d102525deb7f0486103f4cfbe_29.png)

那这个test就是。

![](img/0508395d102525deb7f0486103f4cfbe_31.png)

6月到12月好。

![](img/0508395d102525deb7f0486103f4cfbe_33.png)

那接下来就是构造这个特征了，构造这个特征呢。

![](img/0508395d102525deb7f0486103f4cfbe_35.png)

我们跟传统的不一样，点在什么地方嗯，我们原来是使用当前时刻的，现在不是使用当前时刻了，是使用当前一段一段时间内的一个数据。



![](img/0508395d102525deb7f0486103f4cfbe_37.png)

我们这里我们主要从这里可以看一下哦，相当于是把特征输入进去，每一个横截面的特征是open high clothes，low volume和mount，然后对每一只对对股票进行一个那个标标准化。

标准化完之后呃，标准化完之后，我们制造一个标签，标签的话就是使用PRE之前的，看到没有，PRE之前的作为训练集，pray之后作为一个测试集，是这样的一个过程嗯，是这样的一个过程，然后那这个PRINA。

相当于是你看这里面有一个循环for i range，然后呃，然后一直有一个从I到I加PRE，这个历史时间窗口内的数据，就是训练集，然后I加PY，然后一直循环，然后一到相当于是第一个呢。

就是I等于零的时候，就是零到pi，零到pi这个地方就是零到pi的数据，作为那个训练集，然后这个PRE呢，这个PRE呢作为他的标签都有它的label，看到没有。

零到pro作为输入pro时刻的作为一个label标签，大概是这样的一个过程嗯。

![](img/0508395d102525deb7f0486103f4cfbe_39.png)

然后呢我们就可以得到这个训练集和验证集，我们可以打印一下它的维度点，Shape，看一下，注意一下多资产股票的LOSTM呢。



![](img/0508395d102525deb7f0486103f4cfbe_41.png)

它的维度一定是这样的，大家看这里哈，就是你构建这个LSTM的话。

![](img/0508395d102525deb7f0486103f4cfbe_43.png)

前面都是一个数据处理的部分，在数据处理这些部分呢，它的维度一定是这个是总的总的时刻，就是所有的股票所有的时刻，然后这个时呢是历史回望窗口数，就是那个PY这个六呢就是特征数。

open high到amount，六个特征，六个特征，十个历史时间窗口嗯，14万多条数据作为它的一个输入的维度。



![](img/0508395d102525deb7f0486103f4cfbe_45.png)

的一个构建，一定是这样的，那个test的维度呢x x y train，SHEP就是14万九千六八百六十四，它是一个一维的数据，这个是三维的数据。



![](img/0508395d102525deb7f0486103f4cfbe_47.png)

这个是一个一维的数据，那接下来就开始进行LSTM的构建了，LSM构建呢就是呃一个这个是一个双向，S t m，这个也是一个双向STM，相当于是大家去看一下什么叫双向，什么叫单向，双向的话是正着记一遍。

倒的倒着也记一遍。

![](img/0508395d102525deb7f0486103f4cfbe_49.png)

就是相当于正反我都记一遍，这就是双向STM64个神经单元素。

![](img/0508395d102525deb7f0486103f4cfbe_51.png)

这个是使用的那个KOKOS有一个好处。

![](img/0508395d102525deb7f0486103f4cfbe_53.png)

它是直接进行堆叠的，model点ADADADA堆叠完之后，他就把这个模型建好了，模型建好之后再设置这个什么优化器啊，设置损失函数啊，嗯然后model点build。

然后这个build呢就是就是输入这个特征。

![](img/0508395d102525deb7f0486103f4cfbe_55.png)

这个点shift点一呢就是相当于是这个十呃。

![](img/0508395d102525deb7f0486103f4cfbe_57.png)

是历史十天的数据，train sh2呢就是这个六，这个NN呢相当于是到底有多少条数据，我是不知道的，但是他的历史回望窗口是十天，然后这个特征是六个，所以这个地方是必须要写的。

后面两个特征必须要这个维度是要写的，而这个地方是不需要写的，model点summary summary。



![](img/0508395d102525deb7f0486103f4cfbe_59.png)

然后就可以打印一下它的这个特，打印一下这个LSTM的一个框架，就是啊这是一层，这是一层top out，这有一层这一层top out，这一般只有一层dance。



![](img/0508395d102525deb7f0486103f4cfbe_61.png)

看到没有，dance叫pot，然后dance相当于两层LSTM两层dance和一层。

![](img/0508395d102525deb7f0486103f4cfbe_63.png)

不是两层，job out和一层dance。

![](img/0508395d102525deb7f0486103f4cfbe_65.png)

这个单词呢就是输出它的这个维度，那在这里呢我们要着重讲一下。

![](img/0508395d102525deb7f0486103f4cfbe_67.png)

我们预测的是价格，为什么不预测的是呢。

![](img/0508395d102525deb7f0486103f4cfbe_69.png)

所以这个loss就是MCMCE损失函数，为什么预测的是价格呢。

![](img/0508395d102525deb7f0486103f4cfbe_71.png)

是由于我们没有做分类，因为在这个时间段哈非常容易出现类别不平衡，什么叫类别不平衡呢，就是如果你处于处于处于一段熊市，大家可以看一下，2020年到2022年这段时间呢，假如跌的特别多。

那那那个零的就是零的标签就多。

![](img/0508395d102525deb7f0486103f4cfbe_73.png)

一的标签就少，那这个时候极其会过拟合，就是训练的时候，大家都会预测为零的标签，导致呃导致它的效果不好。



![](img/0508395d102525deb7f0486103f4cfbe_75.png)

我们把这个分类呢变成了一个回归啊。

![](img/0508395d102525deb7f0486103f4cfbe_77.png)

这用的是MSE损失函数。

![](img/0508395d102525deb7f0486103f4cfbe_79.png)

这样的话就避免它的那个类别不平衡，然后出现供给和的那种情况，相当于是间接避免了做了一个。

![](img/0508395d102525deb7f0486103f4cfbe_81.png)

相当于是做了一个折中吧。

![](img/0508395d102525deb7f0486103f4cfbe_83.png)

折中方案嗯，原来做了个种方案。

![](img/0508395d102525deb7f0486103f4cfbe_85.png)

然后呢我们然后我们呢就就给他进行训练，这里设置的是十个回合，大家也可以根据自己的能力设置成20回合，或者多少回合。



![](img/0508395d102525deb7f0486103f4cfbe_87.png)

这个bench size呢我们设置的是一天，为了加快训练速度。

![](img/0508395d102525deb7f0486103f4cfbe_89.png)

也可以一般设置为64啊，128呀或者32啊。

![](img/0508395d102525deb7f0486103f4cfbe_91.png)

这里面我们设置的比较大，是为了加快训练速度，总共14万多条数据。

![](img/0508395d102525deb7f0486103f4cfbe_93.png)

训练太慢了，所以我们就设置的是1000。

![](img/0508395d102525deb7f0486103f4cfbe_95.png)

然后接下来就模型预测，这个比较简单，carrots就是model predict x test。

![](img/0508395d102525deb7f0486103f4cfbe_97.png)

然后prediction，那那这里我们怎么算它的，根据预测的价格怎么算收益率呢，然后prediction减去就是相当于是，相当于是，这个prediction不是预测到未来的那个价格吗。

然后减去当前的价格，然后再比上当前的价格，那么这个时候就得到了一个LSTM，预测的一个收益的情况，相当于我们也没有间接预测收益率，我们也没有预测涨跌幅，我们预测的是价格，然后根据预测的价格来计算收益率。

这个是预测值，这个是真实值，就是这个预测未来的一天的，就是预测未来一天的那个呃，price减去当前的price除以当前的price。



![](img/0508395d102525deb7f0486103f4cfbe_99.png)

就是预测的那个收益率，然后然后呢我们根据这个，然后呢我们根据这个那个呃。

![](img/0508395d102525deb7f0486103f4cfbe_101.png)

我们就可以看一下算他算的这个，他算的这个MSE，他算的这个MSE，哦哦哦这里要给大家说一下。

![](img/0508395d102525deb7f0486103f4cfbe_103.png)

就是嗯虽然这里进行了标准化。

![](img/0508395d102525deb7f0486103f4cfbe_105.png)

看到没有，这里进行标准化，这个pd这个这个pd和这个loss经完全不一样，就比如说这个pd和这个close，已经完全不是原来那个close了，他们以减，但算出来的收益率还是一致的，比如说我给一个。

就比如说尽管他们两个原来的那个维度，量纲不一样了，但是他们的这个比值还是一样的，相当于是没变。

![](img/0508395d102525deb7f0486103f4cfbe_107.png)

大家都改变一个量纲，那这个比值还是原来那个比值。

![](img/0508395d102525deb7f0486103f4cfbe_109.png)

还是原来那个比值，然后这里呢我们就给他算一下，MICEMICE是这么多，因为我们这个太小了，就我们这个太小了，相当于你标准化完之后，这个东西太小了。



![](img/0508395d102525deb7f0486103f4cfbe_111.png)

难道这个这个MC就比较小，大家也可以不标准化哈。

![](img/0508395d102525deb7f0486103f4cfbe_113.png)

不标准化大家也可以算一算，不标准化，可能他这个量纲不一致，就训练也会出现过拟合。

![](img/0508395d102525deb7f0486103f4cfbe_115.png)

然后我们还是一样。

![](img/0508395d102525deb7f0486103f4cfbe_117.png)

我们根据这个选择的这个我们根据这个收益率，PRTLTM看到没有这个test tepid。

![](img/0508395d102525deb7f0486103f4cfbe_119.png)

这里有，这里有一个，我把这个预测的收益率呢给这个LSTM pd。

![](img/0508395d102525deb7f0486103f4cfbe_121.png)

然后根据这个LSTM，根据预算的收益率进行排序，排序完之后呢，选择K支股票或者选择30只股票，然后计算一个平均值，然后输出，然后这样相当于是我们的策略是，选择预测收益率排名排排排名30名的股票。



![](img/0508395d102525deb7f0486103f4cfbe_123.png)

然后进行一个求平均值，这个就是LSTM的那个收益率。

![](img/0508395d102525deb7f0486103f4cfbe_125.png)

那接下来计算这个沪深单买沪深300还是一样。

![](img/0508395d102525deb7f0486103f4cfbe_127.png)

我们把沪深300导入进来，导入进来之后，我们对它模型进行评估还是一样，我们计算这个呃呃年化收益率，年化波动率，夏普比率锁定的比率，最大回撤偏度峰度还有5%的VR值，这个是负的，相当于是它的最大损失。

这个VR就是最大损失为多少，相当于最大损失是两个点，最大损失1。69个点，在5%的时候，其实这个值是损失多少，其实是损失多少，这里。



![](img/0508395d102525deb7f0486103f4cfbe_129.png)

然后呢我们进行收益计算，收益计算呢，我们计算这个LSTM和沪深300的收益率。

![](img/0508395d102525deb7f0486103f4cfbe_131.png)

在二零在在半年吧，就是2020年6月，2022年6月到2023年1月的时间内，可以看一下它整体是下跌的，整体下跌的，那我们这个策略呢是勉强就是LSTM，这个策略是勉强可以击败这个沪深300策略的。

好今天就讲到这里。

![](img/0508395d102525deb7f0486103f4cfbe_133.png)

大家还想听什么内容，可以在视频正下方留言，大家有什么不会的。

![](img/0508395d102525deb7f0486103f4cfbe_135.png)

或者是说啊想要讨论的，可以直接在微那个视频下面直接丝网啊。

![](img/0508395d102525deb7f0486103f4cfbe_137.png)

我们也可以一起交流好，我还会把这个代码和数据放到视频正下方。

![](img/0508395d102525deb7f0486103f4cfbe_139.png)

大家想要下载的可以直接去下载好，祝大家成果多多，生活愉快，学习顺利，身体健康好。

![](img/0508395d102525deb7f0486103f4cfbe_141.png)