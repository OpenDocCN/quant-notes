# 强推！这可能是B站最全的【Python金融量化+业务数据分析】系列课程了，保姆级教程，手把手教你学 - P31：5.用户消费行为分析~1 - python数字游侠 - BV1FFDDYCE2g

它主要是对我们的这个用户消费的行为进行的一个分析。那在这的话，咱们主要是将我们的新脑用户的一个占比，包括咱们用户的分层进行一个实现。用户的分层就是说将用户呢根据它的一个价值分成不同的层次，对不对啊。

分成不同的层次啊，那这块我们看一下怎么去做。首先看一下这块第一个需求。说首先在这儿我们需要求出用户第一次消费的月份分布和人数的统计，并且把这两个值进行线性图的一个绘制吧，对吧？进行线性图的一个绘制啊。

好，首先咱们来看一下，那用户第一次消费的月份分布跟人数统计该怎么计算呢。首先这块重点是我们用户第一次消费的月份分布吧，对吧？那你想啊我们怎么知道用户第一次消费的月份是什么呢？对吧？

比如说我一共有10个用户，我们要求出这10个用户每一个用户第一次消费的一个月份吧，对吧？那这个月份怎么求呢？我们要知道啊，在这儿你要知道。



![](img/cc82808c798261ee070ef165fde3c97f_1.png)

![](img/cc82808c798261ee070ef165fde3c97f_2.png)

![](img/cc82808c798261ee070ef165fde3c97f_3.png)

这个什么呢？第一次消费的第一次消费的月份啊，月份求的话，就是说教我们那个什么呀？用户进行分组，对吧？每一个用户消费消费什么消费月份的最小值啊，就是什么呢？该用户第一次。消费的月份对不对啊。

用户第一次消费的月份不就是用户消费月份当中最小值嘛，对吧？月份的最小值就是这个用户第一次消费的一个月份吧。这块你能够理解吧，对吧？那这个月份有了之后。

我们要统计一下什么呢统计一下我们的这个月份对应的人数统计吧，对吧？人数统计的话，我们就可以使用我们之前所讲过的mod跟s进行一个实现吧，对吧？好。

实现一下第F点派第一步一定是先对我们的用户进行一个分组吧。对吧用户进行分组啊，然后我们要求的是用户消费的一个什么呢？月份的月份的一个什么呢？最小值，对不对？总利看一下。

那这儿返回的就是我们的看一下一这个用户，他是不是在97年1月份对吧？进行的第一次消费，2号用户也是1月份吧，对吧？然后的话我们看一下是不是有相关的用户是不是第一次消费，是不是3月份啊。

比如说这个用户他是第一次是不是3月份消费的呀。

![](img/cc82808c798261ee070ef165fde3c97f_5.png)

![](img/cc82808c798261ee070ef165fde3c97f_6.png)

![](img/cc82808c798261ee070ef165fde3c97f_7.png)

对吧以此类推啊，在这儿咱们就求出了什么呢？求出了我们的每一个用户，他第一次消费的一个月份分布了吧。我们在这儿除了要统计这个月份分布之外，还有统计人数吧，对吧？统计数就是说我要知道什么呀，我要知道。

比如说1月份到底有多少个用户是第一次消费的吧。对不对？然后2月份是主要用户，是第一次消费的，是不是是这种么行的啊。



![](img/cc82808c798261ee070ef165fde3c97f_9.png)

好，在当前的基础之上，在这干什么呢？做一个点vole杠。counts对吧？wall六杠counts用来统计我们这个se当中每一个元素所出现的一个次数啊。



![](img/cc82808c798261ee070ef165fde3c97f_11.png)

![](img/cc82808c798261ee070ef165fde3c97f_12.png)

对不吧？分次数整理看一下，那现在我们会发现，那我们这个s当中一共啊一共对应的月份有3个月份啊，是不是2月份和97年的1月份和97年的3月份呢，是不是又用3个月啊，对吧？意味着在97年的2月份啊。

一共是有8476个用户是第一次消费，对吧？97年的1月份啊，是有8000呃，7846个用户即时消费吧？以此列推休值啊，那在这的话，咱们在这就统计出了什么？统计出了这个这个人数统计吧，这个是。



![](img/cc82808c798261ee070ef165fde3c97f_14.png)

![](img/cc82808c798261ee070ef165fde3c97f_15.png)

人数的统计啊，而这一块咱们求出是第一次消费月份的分布吧，对吧？那怎样画这个线性图怎么画呢？是不是直接在这儿啊，直接在当前基础上说点一个plot就可以了，对吧？就是说将我们的什么呢？



![](img/cc82808c798261ee070ef165fde3c97f_17.png)

这会儿啊将我们的这个月份将我们月份当成X轴是吧？将人数是不是当成Y轴啊，看有这样的一条折线，对不对？意味你看一下，在这儿啊，从我们的什么呢？这个1月份啊，1月份1月3号，对吧？一直到这个2月7号。

人数是不是上升的呀？对吧随着出期人数下降了。

![](img/cc82808c798261ee070ef165fde3c97f_19.png)

对吧啊。好，再看啊。第二个用户最后一次消费的时间分布和人数统计。这个跟第一个是不一样啊，一样吧，对吧？那就是说我们刚开始求出什么呢？每一个用户消费月份的最小值是用户第一次消费的时间。

那用户最后一次消费的时间不就是用户消费月份的最大值吗？对不对？啊，你要知道用户消费月份的最大值就是用户最后一次消费。



![](img/cc82808c798261ee070ef165fde3c97f_21.png)

![](img/cc82808c798261ee070ef165fde3c97f_22.png)

的月份吧对吧怎么求呢？DF点个 by对不对？by等于还是根据我们的用户做分组吧，对吧？算组之后是不是求月份把月份取出来吧，点 max对吧？那这就求出是每一个用户最后一次消费的月份吧，对吧？

还要做人数统计怎么办？点R volume杠统计出来了吧，对吧？那么意味着在我们的97年啊，97年2月份是由4912个用户是不是最后一次消费啊，对吧？3月份是由4478用户最后一次消费吧，对吧？

你想画我们的性图说点pro就可以了。

![](img/cc82808c798261ee070ef165fde3c97f_24.png)

![](img/cc82808c798261ee070ef165fde3c97f_25.png)

![](img/cc82808c798261ee070ef165fde3c97f_26.png)

![](img/cc82808c798261ee070ef165fde3c97f_27.png)

OK了吧，那从这个图当中，我们能看出怎样的结论呢，看一下，就是说在你看在1月份到3月份之间，你看这个线是不是上升了呀？那么意味着是不是在1月份到3月份，用户的流失率是比较高的呀，对不对？

因为你看用户最后一次消费，就是说用户这一次消费完了之后就不在你这消费了吧，用户是不是流失了，对吧？所以说你看前三个月用户的流失率是比较高的对吧？随之流失率是不是下降了。

然后后边是不是还有逐步的缓逐步的提升啊。

![](img/cc82808c798261ee070ef165fde3c97f_29.png)

对吧可以算出我们用户的一个流失率啊，流失的一个情况。OK吧。好，再往下去看啊，再往下去看啊，在这儿的话我们看一下啊，看一下在这儿需要求出我们新老用户的一个占比吧，对吧？求出新老用户的一个占比啊。

那首先我们在这儿你要知道啊，怎么去计算新老用户呢。

![](img/cc82808c798261ee070ef165fde3c97f_31.png)

![](img/cc82808c798261ee070ef165fde3c97f_32.png)

![](img/cc82808c798261ee070ef165fde3c97f_33.png)

何为新用户，何为老用户，对吧？那这儿咱们就能记住这样的个结论啊，就是说我们消费一次为新用户，消费多次为老用户。



![](img/cc82808c798261ee070ef165fde3c97f_35.png)

![](img/cc82808c798261ee070ef165fde3c97f_36.png)

OK吧。好，咱们这写一下啊，写一下，你要知道。😊，消费一次为信用户。那么消费的多次。为老用户吧，将新用户跟老用户的这个人数统计出来，然后进行一个除法，就可以求出新老用户的一个占比吧，对不对？好。

那么这块的话，咱们怎么知道用户是不是第一次消费呢？对吧？又有一个新的问题，如何。获知用户是否为第一次消费。怎么知道呢？这块啊我们可以可以根据什么呢？用户的消费时间进行。判定啊，那么怎么判定呢？

那你要知道啊。如果。如果用户的第一次消费时间和最后一次消费时间一样则。该用户指。消费了一次为信福。对吧否则为老用户OK吗？能理解吗？对吧？我们将每一个用户他第一次消费的时间跟最后一次消费的时间涨过来。

然后判断这两个时间是否一样。如果一样，说明这个用户第一次消费，也就是最后一次消费吧。它就是我们新用户，否则他就是两个户吧，对吧？来户啊，好，那这块咱们怎么去求呢，对吧？

怎么能够求出用户的第一次消费跟最后一次消费的时间呢，对吧？好，看一下这块我们会使用一个叫做AJG的一个函数啊，AJG的个函数。这时候刚开始呢是用来分组聚合的啊，是用来分组聚合的那首先是DF。



![](img/cc82808c798261ee070ef165fde3c97f_38.png)

![](img/cc82808c798261ee070ef165fde3c97f_39.png)

第二，个肉泡。好，这块的话，首先是还是根据我们的用户做分组啊，对吧？用户做分组分完组之后要求出什么它的一个消费时间吧。order杠DT是不是这是每一个用户它所消费的时间吧，对吧？

点J你看这个点AJ是干嘛呀，是用来做分组聚合的。只不过这个分组聚合，它里边可以传什么呢？可以传多种不同的聚合形式啊，传多种不同的组形式，那这传什么呢？我们传一个me传一个什么的max啥意思？

就是说我在这想要将我们每一个用户他消费时间的最大值跟最小值都求出来吧，O吧？你看AJJ它也是一个运算工具，是不是运算工具，只不过这个运算工具可以帮我们进行多种不同形式的聚合运算吧，对吧？

那这执行完了之后，我会发现得到这样的一个什么得到这样的一个表对吧？那你看一号用户他的第一次消费是97年。



![](img/cc82808c798261ee070ef165fde3c97f_41.png)

![](img/cc82808c798261ee070ef165fde3c97f_42.png)

一号最后一次消费是97年1月1号，是不是意味着一号入户实训用户啊，对吧？3号用户呢第一次消费是97年1月2号，最后一次消费是98年5月8号，那么意味着3号用户就是用户呗。



![](img/cc82808c798261ee070ef165fde3c97f_44.png)

对不对？所以你要知道这块的话，AJJ所表示的含义是什么？AJ是说对分组后的结果进行指定形式聚合吧，对吧？分组之后的结果进行多种指定形式的一个聚合。OK吧，这个是我们AJJ的一个作用吧。



![](img/cc82808c798261ee070ef165fde3c97f_46.png)

![](img/cc82808c798261ee070ef165fde3c97f_47.png)

对吧AJJ啊就是说对分组之后的结果进行多种指定形式聚合。

![](img/cc82808c798261ee070ef165fde3c97f_49.png)

OK吧。好，那这就得到这样一个表吧，对吧？咱们最重要是统计新用户跟老用户的什么的这个人数吧，那这咋统计呢？这块我们怎么统计呢？OK吧，那这样的话咱们就可以这么去玩啊，这么去玩。首先我能不能把这个。

这个表啊这个表在的话，我们去保存一下可以吧？保存一下啊，这个是我们的一个什么的一个。新脑用户是吧，new and old杠。



![](img/cc82808c798261ee070ef165fde3c97f_51.png)

有点搞别。对吧把这个表呢，我们先给它保存一下，保存完了之后，那么接下来干啥呢？我要判定什么呢？判定新老用户的一个什么呢？它的一个这个这个这个这个占比吧，对吧？怎么占比呢？在这儿的话。

我们就将这两列拿出来，一个是me，一个是max吧，对吧？好先me，然后看它等不等于什么呢？new old userDF什么的。



![](img/cc82808c798261ee070ef165fde3c97f_53.png)

![](img/cc82808c798261ee070ef165fde3c97f_54.png)

![](img/cc82808c798261ee070ef165fde3c97f_55.png)

max吧对吧？但如果现在返回的值是处啊，这块啊这块返回的只是处表示的是什么？表示不拼乎啊。新用户啊，然后。



![](img/cc82808c798261ee070ef165fde3c97f_57.png)

bos。表示老用户吧，对吧？dony啊，现在是不是得到这么多出碰bo啊？

![](img/cc82808c798261ee070ef165fde3c97f_59.png)

对不对？得到这么几个初出分 false啊。那接下来干啥呢？接下来我统计一下这个初根 false的个数就可以了，对吧？统计初根 false的个数啊。统计。促和。boss的个数吧，怎统计呢？

在这直接点一个什么点一个vol杠。cos吧，对吧？这加括号啊。

![](img/cc82808c798261ee070ef165fde3c97f_61.png)

我看一下那我们的处一共是有12000多个吧，是11000多个吧，是吧？你要知道处是新用户老用户吧，一除就得到他们那个占比了吧，对吧？这块咱们就得到了一个新老用户的一个占比就求出来了吧。O吧。

根据这样的思路没问题吧。啊，多想想啊，多想想好，那新老用户的占比求出来之后呢，那么接下来咱们再看一下用户的分层啊，用户分层，那用户分层主要是想把用户的分成什么的不同，根据他的一个重要性进行一个分层吧。

对吧？假如说我有100用户，那这100个用户当中哪些是重要价值客户呢？哪些是重要挽留客户呢，哪些是重要发展客户，哪些是我们的一般挽留客户，哪些是一般发展客户呢，对不对啊。

要根据这些不同的层次进行一分层吧。那怎么去做呢？首先咱们一步一步来。首先在这哈我们对用户的重要性分层一定是需要有相关指标的那个指标什么呢？这个指标指就是我们的RFM这三个指标这三个指标分别表示的是啥呢？



![](img/cc82808c798261ee070ef165fde3c97f_63.png)

![](img/cc82808c798261ee070ef165fde3c97f_64.png)

![](img/cc82808c798261ee070ef165fde3c97f_65.png)

我们来看一下啊。首先，这个R表示的是客户最近一次消费的时间间隔。OK吧？F表示是客户购买商品的总数量。M表示是客户交易的金额。OK吧。根据RMF这三个指标来判定用户的一个重要性。OK吧。

来判定用户的一重要性。那首先咱们一步一步去做。首先看第一步，分析得出每个用户总购买量和总消费金额和最近一次消费时间对应的表格。那就是现在我需要有一个新的表格，新的一个d frame版叫做RFM可以吧？

这个RFM啊，它里边所放的是这三类数据。

![](img/cc82808c798261ee070ef165fde3c97f_67.png)

是这三类数据啊，首先有1个RFM是不是要有这样一个表格啊，它是一个dta frame吧。data frame里边的话要有这三个数据，分别是什么？是分别是用户的总购买量，总消费金额和最近一次消费的时间吧。

对吧？那这怎么求呢？那这的话咱们用什么比较合适啊，又分组呢？还是用我们的透视表呢？这块咱们最好用透视表进行实现啊，因为你会发现咱们目前是不是还没用过透视表进行过这个实战啊，那在这咱们用一下啊。

那最后就是我的DFDR。table是不是好，那这块的话我们分类汇总条件是呢？index是谁是我们的user杠 ID啊对不对？我们要对用户进行操作啊，汇总什么汇总每一个用户购买的什么呢？

总商品的数量总消费额跟最后一次消费时间那怎么去玩呢？这我可以A放还是什么？对吧？它是用来指定我们到底是对我们分类的数据进行怎样的形成汇吧。咱们可以一个字典字典里跟什么呢？跟这样一个操作跟这样一啊。

比如说第一个是什么呢？一个就是说我们的一个什么呢？一个总购买量是不是那购买量就是我们购买产品的数量呢？是是order杠对这一列我们要进行一什么呢？进行一个这求和操作吧。对不对？进行一个期货操作。

那总消费金额呢？总消费金额看一下啊，总消首先消费金额是我们的order杠啊mount呀。对吧对他进行一个什么进行一个sm操作吧。对不对？看一下前两个，第一个是我们用户的总购买量啊，到底买了多少吧。

每一个用户是不是到底买了多少啊？对吧看一下，那我们的用户购买产品的数量在这儿对它进行一个sm好呢，还是进行一个com好呢？这一下这回是得用countplay呀。count是用来统计个数的吧，对不对？

用来统计我们的每一个用户到底购买了多少产品，是不是啊，是用count还是用s呢？各位想想。这我想想啊我也想想。用户总购买量就是用就是每一个用户到底买了多少商品，是不是啊？

那么order product这一列表示的是这个用户用户这个购买产品的一个数量吧，对吧？用户购买产品的数量啊，那这块的话我们的用户购买成品数量是得做一个s啊，是吧？做s嘛，不是做com是做s嘛，对吧？

s求和，对不对？count是原来统计次数的吧，求和啊，好，那这块总金额没问题。最后一个最近一次消费的时间，那我怎么知道这个用户最近一次消费的时间是什么？最近一次消费的时间。

是不是这个用户消费的消费记录当中最大的那个时间呢？是吗最大的那个时间吧，对吧？那么那个最大的时间就是我们想要找的吧，最大的时间就是用户最近一次消费的时间，是不是OK吧？好。

那这个就是我们的order杠DT，对不对？它的一个什么呢？叫做麦是一个最大值啊。

![](img/cc82808c798261ee070ef165fde3c97f_69.png)

走看一下，现在我们执行。

![](img/cc82808c798261ee070ef165fde3c97f_71.png)

完了之后，我们来看一下我们这个FM。

![](img/cc82808c798261ee070ef165fde3c97f_73.png)

RFM。看一下这里边放的是啥，这里边放的是我们的每一个用户，他这个什么呢购买产品的总金额，购买产品的数量，还有他的什么最近一次消费时间，对吧？现在这样的一个表格，是不是咱们就计算出来了，对吧？

看这个AG放是不是还能这么去玩啊，对吧？那就说如果你不写，不用AG放的话，那么意味着在这就没法做了吧？



![](img/cc82808c798261ee070ef165fde3c97f_75.png)

对吧是不是得分布去做呀？所以你看A接金放可这里边可以说我们到底是对我们这个原始数据当中的哪些列做怎样形式的汇总操作吧。OK吧，还有这样一种特殊的用途。



![](img/cc82808c798261ee070ef165fde3c97f_77.png)

OK吧好，这个表格咱们就计算出来了啊，就得到了。这个表格有了之后，那么接下来干啥呢？接下来哈我们在这看一下，那现在我们要进行这三个指标的这个计算吧，对吧？这三个指标的计算。

这三个指标的计算分别是我们的什么？第一个是用户最近一次交易的时间间隔，对吧？这个没求出来吧，看F表示客户购买产品的总数量，这个我们求出来了吧，M是什么呃，这个是客户交易的总金额，这不是咱们刚才也求出来。

都是存在了这个RFM这个表里的吧？你要知道F跟M越大，这表示用户消费的总金额越高，购买产品的数量越多呀，是用户越重要啊，对吧？那这个R看一下用户R是表示客户最近一次交易的时间间隔对吧？

那么这个最近一次交易的时间间隔越长越好呢还是越短越好呢？越短越好啊，对吧？越短表示用。😊。

![](img/cc82808c798261ee070ef165fde3c97f_79.png)

购买产品的数量越频繁吧，对吧？看F跟M有了吧，是不是R还没有啊，这R怎么求呢？R，我们单独求一下R吧。好，单独求一下R啊，把这三个能走。



![](img/cc82808c798261ee070ef165fde3c97f_81.png)

![](img/cc82808c798261ee070ef165fde3c97f_82.png)

都先拿下来啊。听到这儿。

![](img/cc82808c798261ee070ef165fde3c97f_84.png)

看一下啊，首先我们来计算一下R啊，计算RR是表示最近一次交易的一个时间间隔。对吧RR叫做RFM，我们给它新建一列叫做R可以吧？叫做RRR就等于。那怎么知道用户最近一次交易的一个时间间隔呢？

那可不可以这样去做？那就是说时间间隔只就是说我们把用户啊用户的一个交易的时间减去什么呢？减去我们原始数据当中最大的那个时间。假设哈这组原始数据我们是一直在更新的，可以吧？

就是我们的这组原始数据一直在更新。那最后一个时间假设是今天可以吧？假设最后一个时间是今天。那么意味着我们让每一个用户的最后一次交易的时间减去今天，不就是他的一个时间间隔吗？比如说3号用户。

他最后一次交易的购买产品的时间是是3月25号吧，OK吧？那么今天是3月26号，那么意味着这个用户他购买啊这个商品的一个间隔，是不是一天啊？



![](img/cc82808c798261ee070ef165fde3c97f_86.png)

![](img/cc82808c798261ee070ef165fde3c97f_87.png)

![](img/cc82808c798261ee070ef165fde3c97f_88.png)

![](img/cc82808c798261ee070ef165fde3c97f_89.png)

![](img/cc82808c798261ee070ef165fde3c97f_90.png)

是意天。OK吗？那在这儿的话就通过这样的操作，咱们就来算一下这个用户的一个什么呢一个时间间隔吧，对吧？那这个R表示用户最近一次交易的时间间隔，最近一次交易的时间间隔，对吧？好，咱们就休一下。

首先啊在这儿的话，我们要找到用户的什么呢？用户的这个最后一次交易的时间吧。

![](img/cc82808c798261ee070ef165fde3c97f_92.png)

对吧然后减去我们所有时间的一个最大值，是不是OK吧？好，首先这个max杠DT。它是谁呢？它是我们的原始数据吧。好，找到这个al杠DT。第二麦OK吧，这是我们的最大时间。假设这个是我们的今天的日期。

可以吧？日期啊，然后再求出什么呢？求出求出每一个用户，求出每。一个用户最后一次交易的时间啊，最后一次交易的时间对吧？跟我们的最今天的日期相减，得到的这个差值不就是咱们用户最近一次交易的时间间隔吗？

对不对？那用户最后一次交易时间怎么求呢？DF点g by是根据用户做分组啊。对吧找出我们的时间吧，时间是谁？时间是我们的这个呃or。杠DT是不是好，找出它的一个点儿max吧。

对吧是不是让这个max依次减去谁，减去我们的max杠GT啊。对不对？那相减完了之后呢，给它括起来。我们起来看一下，那这儿减的话一定是一个负数啊，那前边再加一个什么呢？再加一个负号是负的是吧，对吧？

就把它啊把它作为我们的最后一次时间间隔吧。对吧。OK吧。好，然后的话然后让他复制给R这不就可以了。OK吗？你要是让他点他是不就不用那符号了，对吧？好，符号你加和不加都行吧，对吧？看谁减谁数就可以了。

对吧？假设哈假设这个是谁呢？这个是三号用户，最后一次交易申条是3月15号可以吧？那这个是今天是不是3月17号吧，那么意味着15减17，是不是-2负2在负号是是正啊。

那么意味着这个用户是不是已经有两天没有在我这买东西了，对吧？是最后一次交易的时间间隔吧？

![](img/cc82808c798261ee070ef165fde3c97f_94.png)

对不对？好，执行一下。完了之后呢，在这儿看一下我们的RFM。

![](img/cc82808c798261ee070ef165fde3c97f_96.png)

对吧这里边多一列就是我们的R版，对吧？R啊R是我们的这个什么呢？用户交易的时间间隔吧，对不对？然后这块多了一个dase啊，d，你说想不要啊，d怎么可以不要呢？d不要的话。

就是说在这让它除以一下这个玩意儿就可以了。

![](img/cc82808c798261ee070ef165fde3c97f_98.png)

![](img/cc82808c798261ee070ef165fde3c97f_99.png)

![](img/cc82808c798261ee070ef165fde3c97f_100.png)

嗯。

![](img/cc82808c798261ee070ef165fde3c97f_102.png)

看一下啊。

![](img/cc82808c798261ee070ef165fde3c97f_104.png)

这儿床。在这儿这个是求出我们的这个R来是吧？这个R求出来之后呢，让它呃让它在这儿。除以一下。不是这么说况。



![](img/cc82808c798261ee070ef165fde3c97f_106.png)

还有吗？没有了吧？是不是就没有了，对吧？然后在我们的R这列单独让它除以一下NP点time delay time这个这个这个这个time啊time这个time啊。

然后的话在这就主要是将这个d给去掉O去掉啊，别的没什么含义了O吧在这R是不是有了是吧R有了吧。那我们最终看一下这三个指标，一个是R一个是F一个是M吧R有了。

那这块的话我们就需要把我们这个alder amount跟我们的什么呢？这个alder product是不是给它改成F跟M啊，对吧？好，这给他改一下名字吧，对吧？改下名字啊。

那这块的话怎么去给我们的这个列损改名的。

![](img/cc82808c798261ee070ef165fde3c97f_108.png)

![](img/cc82808c798261ee070ef165fde3c97f_109.png)

对吧首先现在我们将是不是这一列就没用了，到是把这列删除啊，对吧？把这列删掉啊，就是点DROP。好，这个lebels就等于我们删除它，它是不是就没用了？对吧好acs它应该是列吧。

列数一in place等于处造。

![](img/cc82808c798261ee070ef165fde3c97f_111.png)

又删掉了，删掉之后的话，看RFM点儿开的对吧？现在我们需要把什么呢？把这两个分别改成R跟M吧，对吧？这块咋改呢？啊，这块就可以添点一个in带呃点一个colments。



![](img/cc82808c798261ee070ef165fde3c97f_113.png)

这是我们所有的列索眼，对吧？列索引，我重新给它复值赋值什么首先看一下alder跟 amount是谁？是我们的这个消费的总金额啊，消费的总金额指的是我们的M啊，对不对？是M吧，改成M。

第二个就是我们的这个M吧。第三个是R啊。对吧改一下改之后呢，再看一下RFM。

![](img/cc82808c798261ee070ef165fde3c97f_115.png)

改了吧，现在这三个指标是不是都有啊，对吧？FL。FRIM这三个指标都有了吧。那这三个指标有了之后，下一步我们就可以对我们的这三个指标进行什么呢？进行我们的这个分层了吧。分层怎么去做呢？

首先分层的话是有固定的算法的，O吧，看一下这个固定算法是什么啊？在这儿我在这儿封装了一个函数，看见了吗？封装了一个函数啊，O我们知道首先看一下啊。



![](img/cc82808c798261ee070ef165fde3c97f_117.png)

![](img/cc82808c798261ee070ef165fde3c97f_118.png)

![](img/cc82808c798261ee070ef165fde3c97f_119.png)

![](img/cc82808c798261ee070ef165fde3c97f_120.png)

看吧。在这你要知道我们说这个F跟M的值越大越好，对不对？R的值数越小越好啊，是吧？R值越小意味着它交易的间隔越短呗，F越大表示它购买成值数量越多，M越大表示它消费的总额越高，是不是前两个值越大越好。

最后值是不是小越好啊，对不对？那根据这三个指标，咱们就可以基于这样的一函数设定这个函数是写死的O吧，是一个固定算法，这怎么去做的？首先看一下这啊RFM是不是有了，对吧？给它添加一列数叫label啊。

添加一列叫label label怎么来的，label是这么来的啊，看就什么意思啊？首先先看这一步。

![](img/cc82808c798261ee070ef165fde3c97f_122.png)

![](img/cc82808c798261ee070ef165fde3c97f_123.png)

在这步啊，那这块的话，我们就直接呃直接使用我们的RFM就可以了。对吧你看一个date frame直接调一个play，啥意思呢？

date frame直接调play就意味着我们的playly可以充当一个预算工具。这个play的运算工具是对我们的DF当中的某行或某列，是对我们的行后列进行某种形式运算。

那现在我们想要下这个play对我们原数据当中的每一行进行运算。OK吧。所以这块我们的这个acs啊axs的话，我们。



![](img/cc82808c798261ee070ef165fde3c97f_125.png)

这块。现在啊现在目前这块啊，你看这个这个play是没有指定X吧，没有指定是默默认值是零啊，零就对列呗。就首先这个是对我们的什么呢原始数据的每一列做操作吧，做什么操作，看下是不是X减X点面呢？

X点面指的是我们每一列的均值吧，是让我们的M这列的每个值减去M的每呃这个均值啊，F当中的每个值数减去F当中每一列的均值啊。



![](img/cc82808c798261ee070ef165fde3c97f_127.png)

![](img/cc82808c798261ee070ef165fde3c97f_128.png)

![](img/cc82808c798261ee070ef165fde3c97f_129.png)

对不对？一可类可吧？那这样的话，咱们就可以将我们这个。RFM当中的所有的数据是不进行该种形式运算啊，就经行我们的每一列当中的值，是不是减去该列的均值啊，对吧？然后的话再点出来。

你看现在它所反馈的本身就是一个d frame吧。

![](img/cc82808c798261ee070ef165fde3c97f_131.png)

你可以看一下啊，本身就是一个d frame，看见了吗？是这样的一个da frame吧，对吧？然后让这个daateform是在点play，就是说让它作用在这个daateform当中啊，对不对？干啥呢？

在这儿在这儿自定义类函数吧，对吧？作用的是X是一一是我们的行啊，让这个函数作用在原始数据的每一行，是不是？



![](img/cc82808c798261ee070ef165fde3c97f_133.png)

![](img/cc82808c798261ee070ef165fde3c97f_134.png)

![](img/cc82808c798261ee070ef165fde3c97f_135.png)

是自用在是自用在。

![](img/cc82808c798261ee070ef165fde3c97f_137.png)

出了啊。

![](img/cc82808c798261ee070ef165fde3c97f_139.png)

是不是就用在这个d frame的每行啊，是吧？因为你看它就是我们的这个d frame呗，对不对？然后让这个函数作用在这个函数的每一行当怎么怎么作用呢？看一下啊，将我们的一行作为数据是不是传给我的X啊。

X是不是三个值啊，是不是这行数据啊，对不对？然后话你看在这，你看这一行是个ss调map map是不是做运算，对不对？将我们这一行数据干啥呢？判断，如果它要是大于零啊，返回那就是一组数，否则是零字数吧。

那这一行不就是001嘛？😊，是不是这样一个租数啊，最行呢是不是也是001啊？对吧这行是110啊，因为前两个是大于零的，最后一个是小0啊。对不对啊，返回出租舍啊，对吧？好，将这三个租er拼起聘起的话。

就是我们01是不是以三种不同的组形式拼起啊。再看一下我们这个比如说这块是001，那001到底是属于哪个重要层呢？001就属于重要发展客户吧，对吧？那在这的话我们的result返回的就是什么？

就是我们的重要发展客户，对不对？啊，然后在这儿我们执行完了之后，删掉它啊，执行完之后，这块的level就有了吧。最后level有了之后，level就是我们RFM当中的一个系列吧。



![](img/cc82808c798261ee070ef165fde3c97f_141.png)

![](img/cc82808c798261ee070ef165fde3c97f_142.png)

![](img/cc82808c798261ee070ef165fde3c97f_143.png)

看一下是不是这么意思，数据量比较大，会慢一点，是不是？你要知道这块的函数你就可以把它写死了，O吧？它是一个它是一个这个固定的一个算法就可以写死了。O吧。写死之后呢。

你会发现这块多了一个level levelvel里边放的是对我们的每个用户进行了一个重要的一个分层吧。一行用户它是一个一般留客户吧，对吧？你看三方用户是一个重要保持客是不是O吧？

这样的话就对我们的每个用户进行了重要性的一个分层。那这块重点是你要把这个什么呢这个操作看懂吧，对吧？那这个函数的话，其实你是可以看懂的。

你要知道这块的是对我们的d frame当中的行列进行某种形式运算吧。就相当于是我们d frame当中的运算工具吧，而我们说map是的一运算工具，是不是？



![](img/cc82808c798261ee070ef165fde3c97f_145.png)

![](img/cc82808c798261ee070ef165fde3c97f_146.png)

![](img/cc82808c798261ee070ef165fde3c97f_147.png)

![](img/cc82808c798261ee070ef165fde3c97f_148.png)

OK吧？好，这个呢就是我们的这个什么呢？第四部分的一个实现，OK吧。

![](img/cc82808c798261ee070ef165fde3c97f_150.png)