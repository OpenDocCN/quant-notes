# 网格调参与交叉验证-量化金融与机器学习2024 - P1 - 背包2004 - BV1ST421S7pG

好我们讲最后一个啊，这个最后一个部分，所谓的网格调参和交叉验证啊，这也是积极学习里面呃，通常都会必不可少的一个环节，就是你真需要一个比较好的模型的话，你肯定要涉及到调参，也肯定涉及到什么呢。

通过交叉验证来呃，增强你模型的泛化能力，增强模型的泛化能力，就是防止过拟合嘛，通过交叉验证好，我们来看看这个东西到底怎么实现啊。



![](img/dfd2d2e1df9bfea284eca2d958e37705_1.png)

实现也很简单啊，非常简单啊，它是它的实现呢有赖于什么呢，有赖于呃，ska里面提供了这样一个呃这样一个函数，其实我们也能实现所谓的格点调，三不就是调不就是试一下不同的参数吗，我们通过循环就能实现啊。

其实很简单，当然它提供了这样一个函数，可能会稍微方便一点点吧，呃这个这个函数的功能有两个方面，一个就是调参，怎么调参呢，就是尝试不同的参数呃，不同的超参数的模型，然后把它把它训练出来。

然后看这个模型的性能怎么样啊，然后从里面选出一个性能最好的，当然性能怎么样，显然就是看什么来看这个模型的一些评价标准，比如说我们这个回归的话，之前不是用什么用，这个R方决定系数和这个绝对平均。

这个绝对平平均绝对误差是吧，用这个来判断我们的性能，所以他的第一个功能很好理解，就是逮着不同的参数做循环，而我们之前的这些模型我们都没有设置参数，都是用的什么呢，你看我们运行一下这个啊。

我们都是用的默认参数，这是GB gt的这个回归嘛，啊呃用的默认参数，而默认参数我们怎么能获取呢，我们把它实例化了之后，用这个方法就能够获取到。



![](img/dfd2d2e1df9bfea284eca2d958e37705_3.png)

这个模型的默认参数有哪些，你看它默认参数有这些好几个默认参数呢，啊，不同的模型，它的参数的数量和参数的，这个具体的东西是不一样的，我们老师比较喜欢用这个决策树相关的模型，这就是一个决策树相关的啊。

只不过是他把决策树做的做了一些啊，做了一些通过集成学习啊，用集成学习的方法，把决策树做了很多的一些事情，就是决策树相关的，通常都是有这样的一些参数，大家可能没学的话，可能没有那么了解。

但是实际上你看大家了不了解决策树啊，就是树啊，是不是他最终他会是一个一个一个啊，if else这样的一个呃判断数，判断数，然后这个判断数的话，你有很多东西可以可以调什么呢，像这个数到底最大有多深。

还有这个数有多少个，叶子里面包含多少个样本等等，这些参数你都可以去定义它啊，都可以去定义它啊，具体我们就不聊这些啊，就是有一点大家知道，每一个模型都会有很多参数可调，有些参数没那么重要。

有些参数比较重要啊，比较重要，以我们这个模型为例，通常比较重要的是什么参数呢，啊老师可能觉得就这两个参数，一个是学习的速率，还有一个是这个呃机模型的数量好，具体这些代表什么意思，我们就不讲了。

同学们有些同学们应该也学过啊，只是可能不太记得啊，所以说老师在这里呢，就选择了这两个参数来进行调参，所谓的调参也很简单，你看啊，对于这个参数呢，呃它的默认值是多少，我们看一下，默认值是100，看见没有。

默认是有100个基学习器啊，100，然后呢老师做了一个调参，吵什么呢，我就围绕这个啊，我就你看80~100，也就是说80包含起点80，然后八十五九十九十五啊，我们可以看一下嘛，它包含哪些呢。

你看包含这些还不包含100，我们可以把100包含进去吧，101就包含进去了啊，是不是，也就是说我假设他有这么多参数，然后呢假设这个东西呢可以选择这些参数，0。10620。3，它的默认值是多少。

默认值我看一下学习速率的默认值在哪里，默认值就是我们之前在这里看到，默认值是0。1，就是我们之前用的是0。1，这个用的是100，但是现在我们呃调调这几个数好，所谓的条就是他们两两配对，然后放到这里面。

然后再去训练，去训练，就这么回事啊，就这么回事好，这是所谓的格点调参，其实就是几个参数做循环啊，其实很好理解，另外一点还需要理解的是什么呢，所谓的CV也就是所谓的CV，CV是啥是呃，我们百度一下吧。

相关的知识我没有那个啊，没有没有拿过来，我们就看看诶，他这怎么没有讲啊，对一个交叉验证啊，交叉验证交叉验证是怎么来做的呢，啊怎么来做的呢，他做的思路很简单，你看他这里等于五，是不是等于五。

它等于五是什么意思呢，它是这样的啊，待会我们会把我们的特征矩阵就是训练集啊，会拿过去做训练的，但是在这个里面啊，这个体系下面他不会用所有的训练集，而是这么呢，而是把训练集分成了五份，看见没有。

把训练集分成五份用，用剩下的用其中的四份放进去训练，然后用其中的一份做测试，注意一下啊，用其中的一份我们其实之前就要弄的，是不是，这里的话他是把你拿到的，把你给他的训练集分成五份。

剩下的四分80%用来做训练，训练出来的这个结果呢，然后和剩下的20%来嗯，用剩下的20%来算出一个，算出一个指标啊，算出一个指标，因此大家可以想象分成五份，四份做训练，一份做测试，那么这意味着什么。

这意味着每一对向量，每一对参数他需要他可以搞搞几次，可以搞五次，因为我们分成五份之后，是不是有五个不同的测试集可以选，所以有五个不同的分配方案啊，就是你这五份到底是你用哪哪四个做训练集，哪一个做测试题。

这是有五种选择方案的啊，所以说意味着什么呢，意味着每每一个每一对参数，每一组参数都可以都会搞五次啊，都会训练五次，然后他应该是获取这里面额均值还是什么的啊，所以大家可以设想。

你看这里就要训练五次每一对参数，而这里有多少对呢，这里是五六是吧，这是五，这边是335435十五十五对参数，15对参数要每个参数每一对参数要搞五次，15×5，所以他要搞多少次，搞75次，也就是这个。

这个要把这个模型训练75次了啊，训练75次，然后取最好的模式，大概就这个意思，然后我们把它运行一下吧，这个代码就在这里，然后把上面的上就用上面的东西就用这个吧，就用这个拿过来，啊我们不要少点吧。

不然这个要等好久了啊，我们用0。0。4好不好。

![](img/dfd2d2e1df9bfea284eca2d958e37705_5.png)

0。4，然后其他的都没什么，这里还做了一个分割，可以啊，做做分割，这里再做分割没问题啊，然后我们。

![](img/dfd2d2e1df9bfea284eca2d958e37705_7.png)

运行运行一下，这个这里是用的rank是不是。

![](img/dfd2d2e1df9bfea284eca2d958e37705_9.png)

然后呢这X1和Y1，然后在这里运行，注意一下，还有一个参数啊，还有这是什么，这个参数是并行啊，就是它等于一的话，就意味着它会用所有的所有的CPU来做并行运算，我们之前都是都是只用一个CPU啊。

用了这个的话，他会做并行运算啊，这个是什么呢，这个是你需要生产需要去对比哪个量，这个我选的是什么呢。

![](img/dfd2d2e1df9bfea284eca2d958e37705_11.png)

选择的是啊，这个这个什么呢，平均绝对误差就是我刚才的那个啊。

![](img/dfd2d2e1df9bfea284eca2d958e37705_13.png)

平均绝对误差这里有很多可以选，你也可以用R方，以所谓的决定系数来作为它的一个最优的一个，选择标准啊，老师这里呢用的是平均绝对误差啊，用的平均绝对误差，你也可以用其他的啊。



![](img/dfd2d2e1df9bfea284eca2d958e37705_15.png)

用其他的这里都有啊，都有，你可以自己挑，自己挑，好了，那我们运行一下。

![](img/dfd2d2e1df9bfea284eca2d958e37705_17.png)

那就等等啦，好啦好啦。

![](img/dfd2d2e1df9bfea284eca2d958e37705_19.png)

啊我们我们那个啊，我们我们看一下他最好的参数是谁，是0。3和100，速率大一点还好吗，最好的那个0。24其实和上面差不多，是不是上面好像也是0。24，但是正的这是负的，但是我们可以怎么呢。

我们可以自己算一算啊，可以算的，可以把这个东西算一下，可以拿他的模型算一下，拿他最好的模型，这个就是它这里面就是他最好的模型，看一下这个0。16还不错。



![](img/dfd2d2e1df9bfea284eca2d958e37705_21.png)

这好像是我们最好的那个决定系数了，然后我看一下呃。

![](img/dfd2d2e1df9bfea284eca2d958e37705_23.png)

这个，然后也把这个模型拿进去，0。20没差多少，像之前是多少块钱，0。24之前是246672461好一点点，一丁点一丁点调参没啥区别，然后我们看一下这个模型的里面的情况。



![](img/dfd2d2e1df9bfea284eca2d958e37705_25.png)

我们去去这里把它拷贝过来吧。

![](img/dfd2d2e1df9bfea284eca2d958e37705_27.png)

那这里就不需要怎么改，因为它的都是一样的啊，都是一样的，大家可以通过这个拿完整的数据啊，完整的这个每一次运行的那个情况的数据，看见没有，它每一个都都有的，每一组参数的啊的五次运行的结果啊，都有。

这里可以完整的拿，我们就不管了，呃我们看看这要改一个东西，要改这个，因为现在我们的这个模型是在这里的，所以说这里要改一改，改成模型，在这里其他的都一样，其他都一样，那就好啦就好了。



![](img/dfd2d2e1df9bfea284eca2d958e37705_29.png)

之后我们去上面去运行一下吧。

![](img/dfd2d2e1df9bfea284eca2d958e37705_31.png)

运行一下我们的这个，嗯这个在这里运行吧，看一下能不能多赚一点点啊，能否多赚一点，好吧，这哪里是赚是亏了呀，亏了30%的同学们，我的天我的天这怎么办，这为什么会巨亏啊。



![](img/dfd2d2e1df9bfea284eca2d958e37705_33.png)

我是哪里做错了吗，我感觉我没做错啊，我感觉我没做错，同学们试一下吧，这个这里这里应该没做错啊，有愧也是有可能，因为他这里是有不稳定性的啊，有不稳定性的，他的参数变了呀。



![](img/dfd2d2e1df9bfea284eca2d958e37705_35.png)

啊就改这个就行了呀，没问题啊，我把那个拿出来看看。

![](img/dfd2d2e1df9bfea284eca2d958e37705_37.png)

拿过来吧。

![](img/dfd2d2e1df9bfea284eca2d958e37705_39.png)

让我再哭一次，让我死心，这个事情，应该是这样啊，这里，亏肯定是亏了，我们再运行试试看，运运行倒是很快的啊，运行倒是很快，我有点不敢相信，怎么会这样子会亏掉啊，所以调参有时候也没啥意义啊，没啥意义。

这个越越是简单的模型调整会好。

![](img/dfd2d2e1df9bfea284eca2d958e37705_41.png)

但是GBDT的话，它其实底层已经做了很多调整啊。

![](img/dfd2d2e1df9bfea284eca2d958e37705_43.png)

就是改变不了这个会亏钱的毛病，那就是没办法啊，同学们好。

![](img/dfd2d2e1df9bfea284eca2d958e37705_45.png)