# Python机器学习量化选择全流程 (XGBoost ／ SVM ／RF ／ DT) - P1 - 代码解析与论文精读 - BV1gT421U7eC

哈喽各位小伙伴们大家好，今天给大家分享的是Python版本的，嗯好话不多说，我们先给大家讲解一下整体的一个脉络框架，首先就是数据啊。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_1.png)

选取选取的是沪深三百三百只股票。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_3.png)

然后进行构建这个特征。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_5.png)

特征呢我们选择的是这么多个特征，就是热度的技术指标特征。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_7.png)

然后进行数据的标准化。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_9.png)

标准化完之后，进行数据的一个模型搭建。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_11.png)

和参数的一个调参工作，由于咱们这个是演示，所以我们没有对它进行调参，但是如果后续大家想要去A运行，这个调参代码的的话，我也写出来了，大家可以进行去调参，这个工作量比较大。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_13.png)

所以就没有进行调参工作，但是相关的调参代码已经列出来了。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_15.png)

然后接下来就是模型的评估，模型评估呢。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_17.png)

然后是预测涨跌嘛，就预测准确率，准确率就是准确率。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_19.png)

召回率F1得分和精确率，然后绘制ROC曲线。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_21.png)

最后我们有一个收益率的一个绘制，在测试集上面进行回测。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_23.png)

回收完之后我们还分析了一个特征重要性，那么最终我们进行了一个策略的性能评估，计算年化收益率，波动率，夏普比率所提的比率，最大回撤偏度峰度和5%的VR值。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_25.png)

好话不多说，今天我们来看一下啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_27.png)

从头带大家看一下整体代码，我把这个代码呢这个框呢放大很多。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_29.png)

之前小伙伴说呃这个呃代码的看不见。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_31.png)

所以我给它放大一下，嗯可能尽量的为他显显示清晰。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_33.png)

首先我们导入这个热度频率的这个数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_35.png)

热度频率的数据呢，我们有300只股票给大家打印一下。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_37.png)

300只股票就是收盘价，开盘价，还有这个什么涨跌幅啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_39.png)

总共是5万啊，五百五十五十二万多条数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_41.png)

有52万多条数据，是从2015年的沪深300，到2023年的6月份300只股票，那接下来呢我们就是要对这个呃personal change。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_43.png)

就是呃这个除以100诶，把它变成这个呃。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_45.png)

原来这个person change是呃乘以100，所以在这里我们我们对它进行了除以100。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_47.png)

然后我们计算一个shift return，原来是没有后面这几列的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_49.png)

没有后面这两列的，我们为了预测未来的那个TARTARGET，我们对它向前移动一个单位。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_51.png)

就是原来这个person change不是负的0。122吗，那么它那么往前移动一个单位。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_53.png)

就把这个负的0。12移动到这里了，移动的时候我们用的是一个group by呃，分组对这个呃，每一个代码的person change都向前移动一个单位。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_55.png)

注意哈注意哈，这里一嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_57.png)

第一个点需要注意的，是不是不是直接使用这个DF，不是直接使用这个df return person change shift，不是直接shift f1，不是直接使用这个啊，Shift f1。

而是使用这个股P函数对它进行了分组，就是在每一只股票上面，它的收益向前移动一个单位，如果直接这样搞的话，就导致别的股票的收益，第一天的收益赋值给了前一只股票。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_59.png)

最后一天的收益相当于会有会有一个误差，所以我们使用的是一个不说by函数。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_61.png)

那接下来就是嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_63.png)

股票数据的预处理和特征变量的一个构建，特征变量呢我们选择的是技术指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_65.png)

技术指标啊，可以一呃过去一天的收益率呃，过去一天五天，十天和30天的收益率。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_67.png)

然后我们选择标准差代表波动率，过去一个月的波动率，30个天的波动率。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_69.png)

然后选择偏度和峰度呃，这个呢是成交量的增长率，Percent volume，还有一个close减open，然后high减low也作为衍生指标呃。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_71.png)

那个PRINCLOSE就是前一天的这个价收盘价嗯，还有这个pro就是价格差，这个不是收益率啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_73.png)

这个是价格差，prince change这个，那那这个呢就是这个啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_75.png)

A personal change，personal change嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_77.png)

然后这个呢是移动平均线的构建，就是ma5ma10，还有啊这个也可以构建一个MA20都一样的，RSI动量，Ema ema26。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_79.png)

MACDKDG就是KDG这么多个那个指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_81.png)

这么多个指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_83.png)

KDG这么多个指标，然后大概是这么多个指标，技术指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_85.png)

什么M15MA10，RSI动量效应，EMA20等等这些指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_87.png)

那我们接下来就开始嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_89.png)

看一下到底有数据集到底有多少多少天，2015年到2023年嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_91.png)

为了加快，这里面只是给大家演示一下，为了加快我们的训练速度对吧，那么我们的训练时间范围呢，就是使用的是2022年6月，到2023年6月，就是使用的是最后一年的数据，如果数据量太长，我们的训练速度太慢。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_93.png)

由由你看，由于我们是五十五十多万条数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_95.png)

所以呃电脑本地的这个运行速度受限。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_97.png)

我们只选择了最后一年作为展示，作为案例展示嗯。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_99.png)

那这个设置好feature和label之后。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_101.png)

我们对它进行了一个标准化啊，点mean点STD就是这个减去均值除以标准差，减去均值除以标准差是z socz soccer。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_103.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_104.png)

the soc标准化，然后可以给大家看一下。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_106.png)

这个是训练数据，就是2022年6月到2023年6月，总共是四呃，4万8568条数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_108.png)

4万多条数据，这个是训练集的数据，然后那个太那个test呢。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_110.png)

就是2023年2月到2023年6月，就是使用的是四个月的数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_112.png)

然后训练集是使用的是八个月的数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_114.png)

八个月的数据，然后呃构构建特征变量和目标变量。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_116.png)

特征变量和目标变量呢，就是这个feature name和label name，然后我们查看一下这个维度。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_118.png)

就是20一个特征，然后是448万，不是4万8568条数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_120.png)

那个训练集呢是2万4600多条数据。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_122.png)

那接下来就进行这个模型构建和参数调参了啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_124.png)

这里我给大家列出来了，调参和不调参的两种代码，不调参呢就是直接使用固定参数进行训练，由于我们的数据量实在是太大了，所以我们仅仅是呃是不调参，作为那个训练的一个工作。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_126.png)

如果大家想要使用调参的代码也列出来了。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_128.png)

这个DT随机森林，还有这个SVM都列出来了，还有xgp boost这些参数都列出来。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_130.png)

大家也可以去进行调参工作，但是工作。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_132.png)

但是除非你电脑设置电脑设置比较好，那么这个时候你的运行速度会快。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_134.png)

所以嗯我大概运行的话需要10分钟，就是不调参的话也大概需要10分钟左右的时间。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_136.png)

就这一段这一段会迟迟的运行不出来。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_138.png)

那接下来就开始预测下一天的涨跌，预测下一天的涨跌呢。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_140.png)

为了绘制这个ROC曲线，这个ROC曲线是根据这个呃。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_142.png)

呃probe是根据这个概率。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_144.png)

是根据这个概率来计算的，就是这个啊预测的这个概率值来计算的，所以我们嗯呃，既输出了这个未来的这个零一分布，又输出了这个概率分布两种情况。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_146.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_147.png)

那我们嗯这个时候最终的这个test d，这个训练集就多了几列，看到没有，这个YDT就是它的预测值，YRF的预测值，YSVM的预测值和YDT这个呃这个预测的概率，problem就是这个预测的概率值。

预测的概率值，我们选择的是第二列，就是它预测为上涨的概率值，你看这个地方小于0。5，这个地方小于0。5，这个地方小于0。5，所以就是000，这个地方大于0。5，这个地方大于0。5，这个地方小于0。5。

就是110。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_149.png)

看到没有，就是110，所以哎，哎这这四列是根据后最后四列得到的一个结果。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_151.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_152.png)

那接下来就是模型准确性评估，模型准确性评估呢啊是计算的四个指标。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_154.png)

准确率。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_156.png)

召回率，精确率和F1得分，嗯嗯我们从这个结果里面我们可以发现呢，这个SVM这个准确率是最高的，SVM是0。55，0。16，0。470呃，呃这个F1得分比较小哈，F1得分比较小。

可能是我们没有调参的原因吧，嗯但是从准确率上看，SVM的效果是最好的，其实不是哦，随机森林的效果是最好的，达到了0。56。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_158.png)

然后这个ROC曲线呢，我们展示这个随机森林的ROC曲线。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_160.png)

AUC是等于0。52岁岁诶，诶如果是热度的涨跌概率预测。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_162.png)

在论现在当今的论文里面，顶多0。540。55都已经是最高的了，就是0。54和0。55。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_164.png)

就是0。54，0。55，0。556和0。55都已经是最高的了，但凡超过0。56的，就比如说某篇论文，它的准确率超过0。56了，那这个就是很高很高的一个非常夸张的数字了。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_166.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_167.png)

好那接下来就是这个收益曲线的绘制，收益曲线绘制呢我们选择的是什么呢，我们对这个啊概率值进行排序，就是预测为上涨和下跌的这个概率值排序，那么我们选择这个呃，我们选择这个，嗯我看一下哈，我们选择这个SDF。

我们排完序之后，我们对它进行了一个等权重name parade。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_169.png)

进行了一个等权重的一个好，这里呢这个name parade呢就是我们预测值唯一的，就是有我们有两种投资组合构建策略，第一种投资组合过滤固件策略呢，我们就是买入预测值唯一的所有的股票，那么第二种策略呢。

我们就是根据这个probe排序，我们预测涨跌概率最高的前五只股票，或者是前十只股票。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_171.png)

作为我们投资组合的一个呃标的投资标的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_173.png)

好那本文呢就是选择的是第一种方法。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_175.png)

买入所有预测上涨的股票。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_177.png)

求均值，就这个NPD等于一求均值。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_179.png)

只要预测会上涨，我们就买入，就等权重分分配。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_181.png)

然后接下来呢就是这个啊只为了回测。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_183.png)

为了进行回测嘛，我们导入这个沪深300指数，沪深300指数呢呃作为我们的一个基准备line。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_185.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_186.png)

那接下来就是呃把我们预测的这个，把我们这个投机器学习构建的这个投资组合啊。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_188.png)

和沪深300构建的这个呃基准进行合并。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_190.png)

![](img/bf95abcffd9a9c69a4827554fc5d44c8_191.png)

合并完之后大概是这样的一个结果，这个是沪深300，这个是决策树，这个是随机森林，这个是SVM它的累计收益率的情况。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_193.png)

可以看到，最终呢沪深300呢它的累计收益率是0。90。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_195.png)

就是说相当于是跌了10%，而这个这个随机森林和SVM呢，是0。11。018，就是涨了0。18和涨了0。006个点好。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_197.png)

那接下来我们对它进行一个绘制。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_199.png)

可以发现RF呢，这个随机森林的收益率是最高的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_201.png)

这也间接呼呼应了随机森林的准确率是最高的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_203.png)

其次是SVM。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_205.png)

然后最后是决策树0。509，所以从这个图里面看。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_207.png)

随机随机森林它的收益率最高的，其次是决策树。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_209.png)

最后是沪深300，那呃那这是第一种策略。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_211.png)

我给大家展示一下第二种策略。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_213.png)

第二种策略是什么呢，第二种策略是根据这个根据这个概率值，我们选择前五名，前五只股票，前十只股票我们来运行一下。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_215.png)

好这是选择了前五只股票，大家可以看一下，前五只股票的话，由于呃我们选择投资标的数量太少了，所以你可以发现他们的走势基本一致，这个SVMRF呃基本一致，但是反而这个DT取得了一个不错的效果。

在最后就是呃基本上前面都是差不多的，但是最后这个DT这个效果变好了，但但这不能证明DT的效果，那个投资组合就构建的是好的，是由于我们选择的这个呃数量是。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_217.png)

我们是取决于我们选择这个投资标的数量呢。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_219.png)

那我再把它改成十来看一下。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_221.png)

好改成十之后，这个呃SVM效果就变好，就是最好的了，SVM效果变好是最好的了。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_223.png)

好话不多说，那我们还是把它改回来。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_225.png)

改成第一种策略，就是买入所有预测为上涨的这个股票。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_227.png)

改回来。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_229.png)

然后接下来我们就开始分析这个特征的重要性。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_231.png)

嗯分析这个特征重要性呢，我们可以看一下这个一堆，就是过去一天的这个呃特殊重要性是最高的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_233.png)

看到没有，然后是close减open。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_235.png)

然后close1day，然后close减open，然后MACD，然后30天五天哇，这个这个绝对是符合我们的认知的，就是你过去一天的收益率一，绝对影响到明天的收益率，对不对，然后这个close减open。

MACD30天五天都是过去的收益的表现，影响着未来的这个趋势，所以这个结果是非常非常非常符合。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_237.png)

符合我们的认知的。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_239.png)

好这个是它的特征重要性的一个表现，那接下来我们就是对它的一个性能进行评估，我们展示了这么多个性能评估指标，首先是年化收益率，年化收益率呢沪深300是负的，那个这个啊DT呢决策树也是负的。

我们发现机器学习构建投资组合策略，均超过基准策略沪深300，然后他们的随机策略达到了0。5。65，1。94，然后这个是负的呃，这个呃基准收益率是负的25个点，而随机森林和SVM能达到五个点和一个点。

是正的，然后我们看一下这个最大回撤，我们发现随机森林的最大回撤也小于这个呃，沪深300的最大回撤，那下部比例也是后面两个都优于前面两个，后面两个这个呃，随机森林各项指标均是最优的，各项指标均是最优的。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_241.png)

好今天就讲到这里，我稍后会把代码放到视频的正下方。

![](img/bf95abcffd9a9c69a4827554fc5d44c8_243.png)

大家感兴趣的话可以自行去下载好，今天就讲到这里，祝大家生活愉快，工作顺利，成果多多，如果大家有什么疑问，可以在视频的正下方留言，欢迎大家进行批评指正，好祝大家生活愉快。



![](img/bf95abcffd9a9c69a4827554fc5d44c8_245.png)