# 基于alphalens的阿尔法因子分析的代码实现-量化金融与机器学习2024 - P1 - 背包2004 - BV1s1421m7iK

![](img/bd61ca3c5622593b04932e32fe8e6dbe_0.png)

好啊，接下来我们来来来来，具体的来来搞它啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_2.png)

具体的来实现一下，所谓的我们的阿尔法因子分析啊，我们的实现啊是基于这样一个包，刚才张同学们装过了啊，这样一个包的啊，实现起来其实很简单，因为虽然说这个因子分析里面有非常多的过程，但是因为这个包的存在。

使得我们只需要干嘛呢，只需要把我们的数据处理成，这个包所要求的形式，接下来产生结果，其实是完全不需要我们自己搞的啊，我们就是在基于这个包来进行，因子分析的过程里面，我们只只需要做两件事情，第一件事情呢。

就是我们把我们的数据处理成这个包，所要求的一个格式，第二件事情需要我们去理解理解这个包，通过它通过自动化的一个因子，分析给我们的结果的意义啊。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_4.png)

他会给我们很多很多结果，这些结果都不需要我们自己自己搞。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_6.png)

它会自动的给我们。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_8.png)

然后我们更大的一个难点，就是后面怎么去了解它，给了我们这么多张图。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_10.png)

它背后的意思是什么，好吧，我们先先来完成第一件事情就是数据的处理。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_12.png)

数据的处理啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_14.png)

我我们的数据的话，先把把先把前面的包倒一倒啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_16.png)

这个包。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_18.png)

啊这个包也导一下好，然后到这里来。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_20.png)

我们最关键是什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_22.png)

最关键的一步啊，就整个这个过程里面，对我们来说，最关键的一步就是把数据处理成这个函数，能够接收的一个形式啊，能够接受的形式就可以了啊，就可以了，啊那到底是什么样的形式它可以接受呢。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_24.png)

其实它的帮助文档里面讲的比较详细了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_26.png)

你看有它的输入量其实包含两个。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_28.png)

一个是因子，一个是价格。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_30.png)

它需要两个东西，我们来看一下啊，呃因此需要是什么什么样的形式呢，你看他他提到了它的音质啊，是需要这样的形式，这个是个什么形式呢，是这样的呃，他这个因子分析，它是对某一个因子来进行分析的。

所以说你看它的因子数据，它你拿到的是这样一列数据。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_32.png)

能理解吧，啊所以他需要你给给出这样一列因子啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_34.png)

啊这是它的因子数据，然后呢这个是什么呢哈这个S它是某种资产，但是这是什么，这是这是股票的那个id，同学们可能会想哎，这不会是这个id呢，那是因为这是美股啊，这是美股美股他的id是字母中。

我们中国的股票id是是那个是数字嘛是吧，这是美股的啊，所以这一列是股票id，然后这边是是时间啊，是时间，你从这个形式也能看到，你从这个形式也能看到我们的因子的值。

因子的值对于不同的股票因子值是不一样的啊，这和我们的beta的那个，因此对应的那个风险一筹是不一样的，风险一筹，所有股票都一样，但在这里阿尔法因子它对应的因子的这个词，不同的股票它是有不同的值的啊。

你要把这些词都给他。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_36.png)

而且呢注意点这个table啊，它必须是一个多层索引。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_38.png)

什么意思呢，这一列是值，这两列是索引index，它是有两层索引的，第一层索引是日期，第二层索引是股票，这是他对于音输入的因子，就单个输入的阿尔法因子的一个呃格式要求。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_40.png)

格式要求好吧，先了解了解了这个格式要求，我们再看另外一个格式要求就是价格啊，就是你得你给了，因此之后你得给它价格，这样的话他才能做做分析啊，价格是咋弄的呢。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_42.png)

价格是这样子这样一个形式，价格的形式更简单，它是一张二维的数据框，二维的数据框，这个二维的数据框呢啊这边大家应该也看到了，这应该是每每列标列标必须是股票的id啊，不同的股票。

而是每一列代表的是某个股票的股价啊，某个股票的股价，当然这个股价你可以是开盘价，也可以是收盘价呃，取决于你自己吧，我我也其实老师也不太清楚，到底开盘价好还是收盘价好，反正我看到老外那个老外。

他就是呃这个新版的这个老外他用的是开盘价，但是国内很多的人又用的是收盘价，我不清楚老师这里用的收盘价啊，就这边是价格，这边是股票，然后呢这边是交易日的日期啊，这是这是那个输入价格的一个形式啊。

输入价格的形式，当然这是最基础的两个输入量。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_44.png)

就是这个了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_46.png)

其他的都是参数，其他的都是一些参数，其实默认你不用不用动都没问题啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_48.png)

对于初学者来说，当然还有一些出输入量。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_50.png)

你如果有的话，给他是更好的，比如说这个这个是啥呢，这是当你想分析行业的时候，你需要把它给的就给什么呢，给每一个股票id属于哪个行业，属于哪个标签，这个你如果想分析不同行业的股票。

就是如果你想分析你这个因子，对于不同行业是不是有差异性，那么你需要需要给到呃每一个股票的行业信息，当然他这里没有讲，他讲的是一个是一个diction，就是一个字典，我们可以看一下呃。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_52.png)

具体是什么形式，应该这里有例子啊，这个这里面有例子哎。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_54.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_55.png)

这里应该是你看就这个啊，这就是股票的行业。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_57.png)

必须得以这样的形式，这样的一个支点，因为这个是他们美股的那个股票id吗。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_59.png)

这个它所属的行业的编码。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_61.png)

你得有这个，然后呢你得有。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_63.png)

有这个为什么是这个，你再看看之前告诉了，每个股票所属于哪个行业的标标标码，是不是，然后这里你得给它，每一个标签对应的是哪个行业，你得给给他。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_65.png)

把这两个值给了，给了之后附附到什么地方呢，你看放到这里，一个是给到这个这里，这个地方，一个是给到这个地方，那么它下面的分析里面，就可就会就会去对比，不同行业这个因子所产生的一个效果啊。

当然呃我们这节课没有，我们我们暂时没有，其实我们有啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_67.png)

但是老师还没处理好，还没处理，我们暂时没有行业数据，所以说暂时不做什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_69.png)

不做行业分析，只做这个因子和整整体的一个分析啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_71.png)

所以说我们暂时没有这这两个数据，我们暂时不搞。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_73.png)

我们现在只搞什么呢，只搞因子数据和价格数据，就暂时不搞这个数据。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_75.png)

而因此价格呢就就要搞成这个形式和这个形式。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_77.png)

就行了啊，好吧，有了这个我们把我们的数据导进去啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_79.png)

数据导进去嗯，就是我们的那个啊下啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_81.png)

这样同学们下载的数据大家还记得吧啊啊，然后呢我们把我们只搞一年的啊，搞一年的搞少一点，其实同学们电脑还行的话，搞个三两三年都没问题啊，因为老师的数据应该应该是5年，老师数据是5年，我们这里只搞一年的。

哪一年的。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_83.png)

这一年里面所有股票的价格把它拿过来好。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_85.png)

啊这个稍微等等哈就能拿到啊，就能拿到啊，而且注意一点啊，我们这个行情数据的话，不仅是有股票的价格。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_87.png)

而且还有股票的一些别的，你看不仅只有这些信息，而且还有一些什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_89.png)

还有一些这个信息是吧，那这个东西这些信息就可以做我们的因子了，能理解吗，这些我们就做因子啊，这节课老师我们分析这个因子，分析四词，同学们可以自己玩一玩啊，可以看一下市盈率啊。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_91.png)

还有其他的因子，但是我们这节课就搞一下市值吧。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_93.png)

啊搞一下诗词，所以这个我们拿到的这个表。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_95.png)

实际上是既有因子数据，又有价格数据的啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_97.png)

现在的问题是什么呢，我们需要处理这个数据，让这个数据变成刚才他里面要求的那个形式啊，变成他要求的形式。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_99.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_100.png)

呃我们拿到这个数据之后要变啊，要变的第一点是要干啥呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_102.png)

要变的低一点呀，是要把这个交易日期要变成什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_104.png)

要变成时间啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_106.png)

要变成时间，要把交易日期变成时间。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_108.png)

交易日期怎么变成时间呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_110.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_111.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_112.png)

啊这是我们的交易日期，但是这个时候交易日期注意点它是什么，它的data type是整数，这可不行，要变成实践的第一步是什么呢，要不要把它变成变成变成那个变成，要把它变成字符串啊，它不应该是整数。

它不应该是整数，得变成object，变成字符串，这是第一步啊，这个搞好了之后，然后，我们就可以怎么变呢，大家还记得吗，pandas里面pd点我们的上过的a two day ten，可以把这个变成时间啊。

这个时候他变成时间了，但是这个时间其实是不够的哈，其实是不够的，还要做什么事情呢，还要给他搞个搞个时区，这是他那个东西的要求哈，USUTSUT我忘了，不好意思。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_114.png)

同学们，我刚才我忘了是UTS还是UTCUTC啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_116.png)

UTCUTC老师忘了等于什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_118.png)

等于true，这个很重要，这个需要的需要的啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_120.png)

这样的话才是标准的标准的，这个时间有有那个他应该是有时区的啊，有时区的有了到了这个格式我们就可以干嘛呢，把它替代掉，替代掉原来的能理解吧，数一下，一旦替代掉之后，你这个这个代码就不要再运行了，懂吗。

因为你在运行的话，他就会出错的啊，这个运行一次就够了啊，因为他替代完了之后就不能再做刚才的事情了，我们一下好。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_122.png)

这样的话呢我们的这个代码啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_124.png)

啊这个这个应该就就变了就变了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_126.png)

你看交易日期就变了，好，然后呢我们拿股票价格，拿股票价格，股票价格的话呃，怎么拿呢，我们得这么拿。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_128.png)

为什么呢，大家看一下刚才的那个形式啊，股票价格得是这个形式，这个形式就意味着，我们实际上是要对对刚才那张表做一些，行和列的一个转换的，你看它这它的列标是股票的id，行航标是时间。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_130.png)

然后这样这个是价格，那么我们要做这个事情。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_132.png)

最简单的方法是什么呢，是pivot啊，透视啊，这个函数这个函数这个函数干嘛呢，我们跟这个函数讲，我们这个函数里面我们的index要要是什么呢，要是交易日期，要是交易日期。

我们的COLUMCOLLINS必须是什么呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_134.png)

是股票代码还是股票简称，我们其实可以用股票简称，是不是，那我们用股票简称吧，不过简单会看起来更亲切一点，反正他都是一对一的，是不是用股票简称，然后呢我们的values我们需要用什么呢。

我们这里用收盘价吧，老师也不知道哪个更优一点啊，开玩家是玩家啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_136.png)

我觉得其实都行都行啊，好我们运行一下，啊都是个st股，垃圾股啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_138.png)

好这些股票啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_140.png)

有了这些股票啊，有了这些股票，现在的问题是啥呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_142.png)

现在的问题是啥呢，这里有很多空的啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_144.png)

要么就是他可能停盘了，要么就是还刚上市或者是什么的。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_146.png)

为了简单起见，我们把这些空的都不要啊，都不要，所以说呢drop n a注意一下，我们是一列一列的，不就那一列只要有一个空值，我们就不要，所以说呢等于一是那一列都不要。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_148.png)

你看啊，现在应该是有2520只股票。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_150.png)

我们这样处理之后啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_152.png)

这样处理之后应该只有1870个股票了啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_154.png)

只有1870个股票了，就是所有有有有空值的，我们都把它去掉了啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_156.png)

都把它去掉了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_158.png)

就我们就就玩这1870个股票吧，就玩这个就是课堂上我们不需要那么严谨啊，不需要那么严谨。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_160.png)

就玩这几只股票呃，这样的话呢同学们可以看一下现在的形式。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_162.png)

是不是就是我们刚才这个形式了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_164.png)

你看这是这个，这是股票id，然后这是那个啊，这是索引。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_166.png)

应该就是。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_168.png)

哦还不还应该就是了，你看这个是日期。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_170.png)

看到没有是吧，这是股票id，那么这个东西我们可以可以了可以了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_172.png)

我看一下下面我是用用哪个哪个还用这个。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_174.png)

那我们就把这个得到这个结果付给这个词。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_176.png)

赋给这个词好。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_178.png)

那么价格我们就弄好了，价格弄好了之后呢，我们来来搞因子，好来搞因子，因此的话啊之前老师用的是股票代码啊。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_180.png)

但是这里老师用的是用的是那个用的是简称啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_182.png)

这是用的简称，有这么个差异啊，那无所谓啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_184.png)

我觉得都行，接下来我们来搞因子。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_186.png)

因子的数据呢实际上还是在这里。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_188.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_189.png)

是吧，因此数据实际上已经在这些位置呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_191.png)

啊我们我们需要干嘛呢，我们只需要把这张表啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_193.png)

把这张表嗯，把这张表的索引结构变成因子，数据所要求的索引结构其实就可以了啊，其实就可以了，在这个过程呢，我们还要做一件事情，什么事情呢，我们不是因为刚才drop n a把空值去掉，滤掉了很多股票吗。

那么这个时候我们最好也是还是还是什么呢，我们我们在这里也把那些股票给去掉啊，怎么去掉呢，我们就让什么呢，让这个东西，他的股票简称，点1in好像是这个函数，它要在什么地方呢。

他得在这个这个东西的colony啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_195.png)

要在这个里面点。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_197.png)

啊他得在这里面我才要啊，不带的我就不要了啊，啊这样这样的话能够对齐对齐了，所以说他得在这里面，他得在这里面。



![](img/bd61ca3c5622593b04932e32fe8e6dbe_199.png)

好这就是所有我们呃。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_201.png)

需要的股票的价格啊，不需要的股票的，因此因此接下来我们要干干什么呢，啊接下来我们就要设置多层索引啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_203.png)

设置多层索引，这个时候我们先那个一下吧，先先给个中间量吧，给到一个中间量。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_205.png)

这个时候我们要设置它的多层索引点set。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_207.png)

![](img/bd61ca3c5622593b04932e32fe8e6dbe_208.png)

啊第一个索引呢我们得是交易日期。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_210.png)

第二个索引呢得是股票简称。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_212.png)

我们来看一下是吧。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_214.png)

那么这个索引其实就弄好了啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_216.png)

但是还不够，为什么呢，大家可以看一下这边这个索引啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_218.png)

它应该是排过序的，我们要排序。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_220.png)

所以说呢我们搞完这个之后呢，点sort index。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_222.png)

你看这样是不是跟那个差不多了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_224.png)

就差不多了，那么这是我们的，我们就写什么呢，写成，写成它吧，写成他，然后下面还是输出一下。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_226.png)

让同学们可以看到点。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_228.png)

好，啊这样我们就有了，这样我们就有了有了这个我们刚才讲过。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_230.png)

我们是要拿什么呢，我们是要拿这里面的市值因子。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_232.png)

是要拿这里面的市值因子。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_234.png)

我们把总市值拿出来。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_236.png)

总市值在这里，啊不好意思啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_238.png)

你看这是不是就拿到了啊，就拿到了四只因子，这样的话呢。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_240.png)

我们这个东西和我们刚才的这个东西啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_242.png)

刚才的什么刚才的这个应该都准备好了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_244.png)

准备好了之后，我们怎么弄呢，我们把它给到。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_246.png)

这个里面去给到这里面去，好像名字是一样的吧。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_248.png)

那我们就直接运行了，你看到这个函数直接运行了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_250.png)

是不是他不就好了吗。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_252.png)

那你看运行之后我们运行一下，再运行一遍啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_254.png)

运行之后出了结果，说明我们的输入的东西是是对的啊，是对的，那么意味着我们啊，数据处理的这个事情就完成了啊，也意味着我们阿尔法认识一个因子，分析代码层次其实就game over了啊，就结束了。

接下来其实就是看图说话的一个层次了。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_256.png)

大家先先完成这个门。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_258.png)

做到这个地步啊，做到这里就是把它放进去，能够运行就行了啊。

![](img/bd61ca3c5622593b04932e32fe8e6dbe_260.png)