# 清华博士带你学习python金融量化投资分析与股票交易【附项目实战】 - P64：66上下文数据存储 - python大师姐 - BV1BYyDYbEmW

好，那我们接下来就这个带着大家开始写一下，我们简单的这个框架啊，首先啊导入一下需要的各种，包括number pi。



![](img/b420f5bb580025920a8fabee528a98e4_1.png)

Pandas。

![](img/b420f5bb580025920a8fabee528a98e4_3.png)

![](img/b420f5bb580025920a8fabee528a98e4_4.png)

哎包括我们还需要我们的这个财经数据包。

![](img/b420f5bb580025920a8fabee528a98e4_6.png)

To share to share，好啊，那首先我们说我们要这个啊，写什么这个上下文信息对吧，好，比如说我们可以把它类比到我们的之前，那个框上不就一样的嘛，那我们就类比到就是到一个context类里。

那这个类的初始函数要写它有哪些的呃，要要存储这个context类存在哪些的属性对吧，好它的参数需要哪些呢，一般我们说我们回测设置的刚开始的参数，一般有开始时间，结束时间和我们这个刚开始的现金好。

cash用来表示初始资金，start date和N的date，分别用来表示我们的回测开始时间和结束时间，嗯好那我们的属性，首先这三个参数要把它存起来，开始，Start at date。

和end date。

![](img/b420f5bb580025920a8fabee528a98e4_8.png)

![](img/b420f5bb580025920a8fabee528a98e4_9.png)

好除此之外，我们说这个context类在我们那个距宽上，它是context点，portfolio里记录了各种的我们的这个持仓信息，那我们这因为我们是简化版的啊。

所以我们就直接把它寄到我们的context。

![](img/b420f5bb580025920a8fabee528a98e4_11.png)

我们也不用portfolio了，我们的持仓信息，我就直接记录在一个positions字典里啊，刚开始的时候，因为我们没有任何没有任何时长，所以刚开始的时候肯定是一个空字点好。



![](img/b420f5bb580025920a8fabee528a98e4_13.png)

除此之外，还有我们想比如说我们的这个啊，参就是我们的那个参，参考那个参照，就是我们那个区块上那条红线基准啊。



![](img/b420f5bb580025920a8fabee528a98e4_15.png)

叫benchmark，要记一下，刚开始的时候没有的话，我们就比如说可以设置成空啊，除此之外还有啊，因为我们说我们这个context，相当于他是从开始这个开始时间，到结束时间之间，这个范围内的所有时间。

我们是不是都要考虑到对啊，所有交易日，那这些交易日比如说我的这个开始时间是啊，16年的1月1号，截止时间是18年的1月1号嗯，那这我们就要获取的是，这一段时间中的所有交易日，那怎么样获取所有交易日呢。

啊我们的to share包下。

![](img/b420f5bb580025920a8fabee528a98e4_17.png)

有一个叫做are get，Get trained。

![](img/b420f5bb580025920a8fabee528a98e4_19.png)

call是calendar啊，这个函数可以获取，我们所有的这个交易日的信息，好我们把它哎，我们把它，存到这样一个变量下好，我们可以直接运行一下。



![](img/b420f5bb580025920a8fabee528a98e4_21.png)

然后我们可以先忽略掉这个context啊，这个函数你们之前没有遇到过。

![](img/b420f5bb580025920a8fabee528a98e4_23.png)

我们可以打印一下，tron cnl对这个东西应该没有拼错。

![](img/b420f5bb580025920a8fabee528a98e4_25.png)

拼错了吗。

![](img/b420f5bb580025920a8fabee528a98e4_27.png)

![](img/b420f5bb580025920a8fabee528a98e4_28.png)

好叫trade cl，可能是他是不是改版过了，好我们可以看到这个trade ca l它是什么，它是把这个我们的所有的时间每一天是一行啊，有两列，第一列呃，第一列是我们的日期。

第二列是一个叫做is open属性，嗯啊is open是一表示这一天是交易日，is open是零表示这一天不是交易日，嗯啊就是这么简单，我们可以把它存到刚开始的时候，我们可以把它。

因为我们不想要每次都去网上获取数据。

![](img/b420f5bb580025920a8fabee528a98e4_30.png)

我们可以把它存到一个CSV里啊。

![](img/b420f5bb580025920a8fabee528a98e4_32.png)

To csv，文件名，比如说我们就叫trade cl，点CSV，好现在有了这个这个文件之后。

![](img/b420f5bb580025920a8fabee528a98e4_34.png)

我们就直接以后就不用再调取这个函数了，我们就直接可以设置CAR等于pandas。

![](img/b420f5bb580025920a8fabee528a98e4_36.png)

点read csv。

![](img/b420f5bb580025920a8fabee528a98e4_38.png)

名字trade c a l l csv好。

![](img/b420f5bb580025920a8fabee528a98e4_40.png)

那我们为什么要获取它，是因为我们说想要在context这个类里记录一下。

![](img/b420f5bb580025920a8fabee528a98e4_42.png)

就这个范围的所有交易日对吧，比如说我把它叫做data range好，它应该是一个列表或者是一个数组对吧，那就应该是把trade cl里，所有的交易日给他选出来。

而且这个交易日还要在start date和end date之间，这个用什么呢，我们用我们之前讲过的这个布尔型索引，就可以了，好其中第一个条件trade c a l点。



![](img/b420f5bb580025920a8fabee528a98e4_44.png)

第二列，它的第二列是这个is open啊，这个东西要等于一。

![](img/b420f5bb580025920a8fabee528a98e4_46.png)

他的is open没有下划线，is open这一列，要等于一啊。

![](img/b420f5bb580025920a8fabee528a98e4_48.png)

并且什么呢，并且它的第一列这个东西的时间。

![](img/b420f5bb580025920a8fabee528a98e4_50.png)

要在开始时间和结束时间之间嗯，好所以并且并且我们讲布尔型索引的时候说过，使用这个啊，而且注意要加括号啊，这有点长了，所以我们就画好，并且什么呢，并且trade的CAL。

的第一列叫做calendar date，这一列要什么，大于等于start date，并且，SA哎，并且，calendar date要小于等于n date，好，大概就是一个这个啊。

然后我们可以这个排版的话，因为它是换行了，所以要加一个这个表示他后边还有内容，这应该学过吧对吧对吧，就是转行换行的这个东西，那现现在我们的这个context，应该基本上就没有什么问题了。

我们可以看一下啊，创建一个对象，context等于context的一个实例化，比如说现金传1000开始时间，比如说我们传这个2016年1月1号好，结束时间，比如我们传2017年1月1号好。

我们可以打印一下context的各项值啊。

![](img/b420f5bb580025920a8fabee528a98e4_52.png)

比如说catch就不用打印了。

![](img/b420f5bb580025920a8fabee528a98e4_54.png)

我们就直接上，实际上只有这个date range写起来比较复杂，我们看一下这个值是不是OK，好我们可以看到它，这是它的索引，这是他的name，这是他的CALENDATE，这是is open的属性。

那其实我们只要这一列就可以了，可以看到这确实是从1月1号开始，应该是一号2号三号都可能放假了，元旦4号开始交易，然后5678呃，45678，然后一个周末过去，说明这交易日都OK。

然后最后是16年12月31号，就是这个范围是没有问题的啊，但是因为什么呢，我们的date range，我们只要这一列啊，所以我们在后边再加一个选出来，这一列。



![](img/b420f5bb580025920a8fabee528a98e4_56.png)

Calendar date，这一列，然后再把它变成我们的数组啊。

![](img/b420f5bb580025920a8fabee528a98e4_58.png)

唉这个时候我们可以看到这个它的date range。

![](img/b420f5bb580025920a8fabee528a98e4_60.png)

就是一个数组吧，那等到我们回测的时候，我们对这个数组里的所有人进行遍历就可以了，嗯好除此之外，我印象中我们还有一个什么呢，我们还有一个啊有用的对象，叫做就是在我们那个啊join框呢。

在距宽里叫做有一个小J对象，这个小J对象是一个全局对象，那所以这个其实好写。

![](img/b420f5bb580025920a8fabee528a98e4_62.png)

我们只要定义一个大这类，然后什么都不写，然后创建一个全局的小队对象。

![](img/b420f5bb580025920a8fabee528a98e4_64.png)

哎这样就可以了，如果我们想在小这里记录任何的信息。

![](img/b420f5bb580025920a8fabee528a98e4_66.png)

就直接可以小这点一些属性，然后等于什么就可以创建一个新的属性了。

![](img/b420f5bb580025920a8fabee528a98e4_68.png)

这是Python本身就支持的，对好，那这个关于我们的这个上下文的数据，其实就到这就涉及到这就可以了，当然啊因为我们是简易的，所以好多东西都省略了，其实我们可以按照距宽的它的一些构造。

比如它的context下的portfolio有各种各样的属性，它的positions，它的portfolio下有positions，然后positions的position类又有各种各样的学生。

其实还可以再丰富一下，那我们为了这个简单，为了上手容易啊，就先这样写好，那我们的这个上下文上，这个相关的代码就大概到这儿，然后接下来比如说我们可以写，我们怎么样获取历史数据啊。

那我们下一个时间给大家讲讲一下。

![](img/b420f5bb580025920a8fabee528a98e4_70.png)