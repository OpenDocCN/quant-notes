# Python多因子量化选择全流程 - P1：数据预处理 - 代码解析与论文精读 - BV1JfDLYjEdL

哈喽各位小伙伴们大家好，今天我们准备讲解一个合集，主要内容呢是以Python代码的形式讲解，如何进行量化多因子选股，如何基于因子数据进行机器学习收益的预测，这一部分的内容量非常多，非常复杂。

后面做什么内容还没有具体呃想清楚，但是今天第一步呢是讲解的是数据预处理，是一个抛砖引玉的一个步骤。

![](img/c2315df7b7420729fb303cd355b101d3_1.png)

这一步骤很关键，这部的好坏。

![](img/c2315df7b7420729fb303cd355b101d3_3.png)

决定着后面所有流程的，以及最后投资组合构建，收益的好坏的一个重要基础，嗯好我们话不多说，我们来讲解一下数据处理的一个Python代码，首先嗯第一步呢就是数据预处理，主要包含嗯我讲解一下废话嘛。

大家啊耐心听着一点啊，包含以下四个部分。

![](img/c2315df7b7420729fb303cd355b101d3_5.png)

第一部分呢就是缺失值填充，第二部分是异常值，第三部分是中性化。

![](img/c2315df7b7420729fb303cd355b101d3_7.png)

第四部分是标准化，那缺失值填充呢就是针对于那些难值，然后我们进行填充，一般填充的方式呢有零填充，中位式填充和均值填充啊，异常值处理呢就是当我们给数据设定一个上限，设定一个上下限。



![](img/c2315df7b7420729fb303cd355b101d3_9.png)

就是呃当我们的异常值大于这个上限时，我们就取这个上限，当我们这个异常值小于下限时，我们就取下限啊。

![](img/c2315df7b7420729fb303cd355b101d3_11.png)

第二部分，中性化呢是用我们的这个市值和行业指标，这个xi就是一个零一，行业指标与这个因子进行回归。

![](img/c2315df7b7420729fb303cd355b101d3_13.png)

取残差作为新的因因子值，这个就是中性化。

![](img/c2315df7b7420729fb303cd355b101d3_15.png)

那第三部分是标准化，大家应该都知道，就是因子值减去均值除以标准差，这个地方应该是z Sol标准化。

![](img/c2315df7b7420729fb303cd355b101d3_17.png)

非常流行的一个做法，好话不多说。

![](img/c2315df7b7420729fb303cd355b101d3_19.png)

我们来诶用Python代码的方式给大家进行演示。

![](img/c2315df7b7420729fb303cd355b101d3_21.png)

那第一步呢我们就是呃导入我们的因子数据。

![](img/c2315df7b7420729fb303cd355b101d3_23.png)

导入包导入因子数据，这个地方主要是显示中文进行设置的。

![](img/c2315df7b7420729fb303cd355b101d3_25.png)

那这个地方这个地方呢是我们使用那个PICO。

![](img/c2315df7b7420729fb303cd355b101d3_27.png)

PICO文件，PICO文件的主要好处呢，它在于它读取数据比较快速，如果我们存在excel里面，它的读取流程会非常的耗时间。



![](img/c2315df7b7420729fb303cd355b101d3_29.png)

但是如果保存为PO文件，它的读取速度就会快很多，这里我们选取的是2011年1月，到2022年1月28日，总共六六百多万，627万，2627就是六，不是啊，62万7228条。



![](img/c2315df7b7420729fb303cd355b101d3_31.png)

就是60多万条数据呃。

![](img/c2315df7b7420729fb303cd355b101d3_33.png)

大家可能会纳闷，为什么这里是都是空值，这个是北交所点BG的后缀是北交所数据，所以在2011年他们还没有上市。



![](img/c2315df7b7420729fb303cd355b101d3_35.png)

这里都是空值。

![](img/c2315df7b7420729fb303cd355b101d3_37.png)

我们选取的是我们选取的是二十二十多个因子。

![](img/c2315df7b7420729fb303cd355b101d3_39.png)

包含什么市净率，市现率，市盈率，还有这个销售净利率。

![](img/c2315df7b7420729fb303cd355b101d3_41.png)

这些因子全部是从万德里面进行下载的。

![](img/c2315df7b7420729fb303cd355b101d3_43.png)

当然这个因子数据量可能还是不够，它并没有那么庞大，我们仅仅是以一个演示，所以后续大家如果有在自己的数据上，可以尝试用更多的因子来进行操作。



![](img/c2315df7b7420729fb303cd355b101d3_45.png)

那啊接下来就开始导入这个收益率嗯。

![](img/c2315df7b7420729fb303cd355b101d3_47.png)

由于在万德里面这个因子值和收益率是分开的。

![](img/c2315df7b7420729fb303cd355b101d3_49.png)

所以我们要把这个因子值和收益率进行合并，合并完之后。

![](img/c2315df7b7420729fb303cd355b101d3_51.png)

合并完之后啊，啊要进行合并，这还没有合并呢。

![](img/c2315df7b7420729fb303cd355b101d3_53.png)

那先进行了这个异常值处理与数据填充，就是进行了第一步和第二步啊，这个异常值处理呢大家可以看一下，我们选择一个中位数。



![](img/c2315df7b7420729fb303cd355b101d3_55.png)

那么设定一个上限，设定一个下限，当我们的这个因子值，当我们这个因子值限定在下限和上限之间，如果超出上限取上限，小于下限取下限，这个就是这个中位数去极值的一个方法。



![](img/c2315df7b7420729fb303cd355b101d3_57.png)

![](img/c2315df7b7420729fb303cd355b101d3_58.png)

那额这里面呢主要是选择这个二额分号。

![](img/c2315df7b7420729fb303cd355b101d3_60.png)

就是说选取第二个因子之后。

![](img/c2315df7b7420729fb303cd355b101d3_62.png)

所有的因子的一个去极值方法。

![](img/c2315df7b7420729fb303cd355b101d3_64.png)

那这里我们来好去极值之后呢。

![](img/c2315df7b7420729fb303cd355b101d3_66.png)

然后接下来我们就要进行股票的一个筛选了，那这个筛选过程呢嗯可以选择剔除掉s st股票，那这里我们给它注释掉了，大家如果想要把s st股票进行剔除掉的话。



![](img/c2315df7b7420729fb303cd355b101d3_68.png)

那方式也很简单，就是判断就是判断这个股票名字里面带没带st，如果这个股票里名字里面带了s st，我们就给它添加到这里面。



![](img/c2315df7b7420729fb303cd355b101d3_70.png)

然后再给它进行删除。

![](img/c2315df7b7420729fb303cd355b101d3_72.png)

就是DP一下，就是我们把这个s st里面的股票选择出来，进行统一删除嗯。

![](img/c2315df7b7420729fb303cd355b101d3_74.png)

本文这里就没有挑选出s st，因为我们s st也作为了一个样本。

![](img/c2315df7b7420729fb303cd355b101d3_76.png)

那接下来额就是要导入行业数据。

![](img/c2315df7b7420729fb303cd355b101d3_78.png)

导入行业数据的目的呢是为了进行中性化。

![](img/c2315df7b7420729fb303cd355b101d3_80.png)

中性化里面有一个很重要的一个点，这个xi就是如果爱股票属于某一个行业，那么他这个地方就等于一。

![](img/c2315df7b7420729fb303cd355b101d3_82.png)

如果不属于某一个行业，这个地方就等于零，所以这个地方是一个完号的编码形式的。

![](img/c2315df7b7420729fb303cd355b101d3_84.png)

一个矩阵。

![](img/c2315df7b7420729fb303cd355b101d3_86.png)

接下来就是要把因子数据和行业数据进行合并。

![](img/c2315df7b7420729fb303cd355b101d3_88.png)

嗯合并完之后，它最后就会多出来一列行业名字，前面是因子值，后面一列是行业行业名称。

![](img/c2315df7b7420729fb303cd355b101d3_90.png)

那这部分是我们本次视频的重点，讲解了如何进行中性化和标准化。

![](img/c2315df7b7420729fb303cd355b101d3_92.png)

嗯中性化我我在大家进行复习一遍。

![](img/c2315df7b7420729fb303cd355b101d3_94.png)

就是把市值和行业作为自变量，与这个因子进行回归。

![](img/c2315df7b7420729fb303cd355b101d3_96.png)

回归完之后取残渣值作为新的因子值。

![](img/c2315df7b7420729fb303cd355b101d3_98.png)

然后然后那这里呢嗯有有一个这个normal函数。

![](img/c2315df7b7420729fb303cd355b101d3_100.png)

是这里面的一个核心，我们来看一下，在这里呢我们有一个这个if判断一下是不是额，想要是不是中性化，如果想要中性化的话，首先第一步，我们把这个一级行业呢变成一个完号的编码，往后的编编码呢。

那个编程的就是操作方式呢也很简单，就是点get这个这个是雅变量的方式，我们就可以生成一个行业完号的编码矩阵。



![](img/c2315df7b7420729fb303cd355b101d3_102.png)

那接下来这个A股流通市值呢，需要进行一个对数。

![](img/c2315df7b7420729fb303cd355b101d3_104.png)

这个M是一个对数，就是要取对数。

![](img/c2315df7b7420729fb303cd355b101d3_106.png)

对这个市值进行取对数，取对数完之后，我们把然后还有一个常常数项就是截距项，然后我们把啊这个流A股流通市值，还有行业矩阵，还有这个常数项这三部分嗯，行业变量，A股市值，还有常数项与因子值进行回归。

这个是点function进行回归，进行回归，看到没有，这个地方就是进行回归，回归完之后取参差，就是我们的那个，因子值大家可以看一下。



![](img/c2315df7b7420729fb303cd355b101d3_108.png)

在这里面我们嗯把这个Y变量，把这个因子值和这个X值进行回归。

![](img/c2315df7b7420729fb303cd355b101d3_110.png)

回归完之后取残差就得到了我们新的因子值了，这是中性化，中性化完之后再进行标准化，标准化的方式呢就是data点，data点min除以data塔点STD，这个地方就是呃标准化标准化完之后再放进去。

相当于这个normal函数呢这一部分执行了啊，因子的中性化，这一部分执行了这个因子的标准化，大家应该去看一下，应该挺简单的，主要核心就是在这一步，是对每一个因子都进行了一个回归，这个X就是因子值。

然后哦这个X是这个呃自变量，这个data里面的每一列呢就是因变量，就是那个Y值。

![](img/c2315df7b7420729fb303cd355b101d3_112.png)

那这个中性化中性化完之后呃。

![](img/c2315df7b7420729fb303cd355b101d3_114.png)

我们就可以查看一下我们这个数据在这里面。

![](img/c2315df7b7420729fb303cd355b101d3_116.png)

我们这个数据名数据中心完完之后，就是这样的一个啊，它的分布比较均匀。

![](img/c2315df7b7420729fb303cd355b101d3_118.png)

就是0。042负的0。023。

![](img/c2315df7b7420729fb303cd355b101d3_120.png)

你看大家就看可以看一下这个地方都是残差值。

![](img/c2315df7b7420729fb303cd355b101d3_122.png)

它的数据就比较均匀了，我们把我们把这个这个值呢。

![](img/c2315df7b7420729fb303cd355b101d3_124.png)

把这个啊中心化完后的值呢。

![](img/c2315df7b7420729fb303cd355b101d3_126.png)

啊这这部分是重复了。

![](img/c2315df7b7420729fb303cd355b101d3_128.png)

这一部分大家可以不用看，是重复的操作，这一部分可以不用看。

![](img/c2315df7b7420729fb303cd355b101d3_130.png)

因为这里已经有一个标准化了。

![](img/c2315df7b7420729fb303cd355b101d3_132.png)

所以这里就不需要了。

![](img/c2315df7b7420729fb303cd355b101d3_134.png)

然后接下来呢我们要对他啊，我们要获取到下一个季度的收益。

![](img/c2315df7b7420729fb303cd355b101d3_136.png)

所以最后添加了一列这个收益值。

![](img/c2315df7b7420729fb303cd355b101d3_138.png)

就是next rate和这些因子，因子值和next rate。

![](img/c2315df7b7420729fb303cd355b101d3_140.png)

next rate之后我们接下来开始呃导入这个收盘价。

![](img/c2315df7b7420729fb303cd355b101d3_142.png)

导入收盘价的目的呢主要是计算未来1月。

![](img/c2315df7b7420729fb303cd355b101d3_144.png)

一个月，三个月。

![](img/c2315df7b7420729fb303cd355b101d3_146.png)

五个月，十个月的这个收益，然后最后合并到一起。

![](img/c2315df7b7420729fb303cd355b101d3_148.png)

就是一个月，三个月，五个月，十个月的一个收益。

![](img/c2315df7b7420729fb303cd355b101d3_150.png)

计算这个收益呢的目的呢，是为了计算因子值和未来收益值的一个相关性，可能我们某一个股票的这个因子值比较大，未来一个月的这个收益值可能也大，主要是为了计算它们之间的一个相关性，要对股票进行分组验证。

因子分组的有效性，对因子进行检验好。

![](img/c2315df7b7420729fb303cd355b101d3_152.png)

这是第一部分，那个后面这个操作呢。

![](img/c2315df7b7420729fb303cd355b101d3_154.png)

其实是第二部分要做的内容，但今天我们讲一下第一部分嗯。

![](img/c2315df7b7420729fb303cd355b101d3_156.png)

是怎么样进行因子呃，中性化，异常值处理标准化。

![](img/c2315df7b7420729fb303cd355b101d3_158.png)

大家可以去操作一下，其实最核心的地方就是这个代码，我们要构建一个哑变量，做行业的亚变量，然后第二个是要构建A股流通市值，第三个呢是要构建这个残差，这个残剧就是那个呃呃差那个截距项。

然后把这个X呢和里面的每一个因子呢。

![](img/c2315df7b7420729fb303cd355b101d3_160.png)

进行回归，回归完之后去参差，就是点right点Rest side。

![](img/c2315df7b7420729fb303cd355b101d3_162.png)

这个取残差项就得到了我们新的因子值，然后再进行标准化，所以所以这个地方就是我们呃。

![](img/c2315df7b7420729fb303cd355b101d3_164.png)

数据预处理的一个核心代码，稍微写的有点乱，大家将就着看一下。

![](img/c2315df7b7420729fb303cd355b101d3_166.png)

但总总体来说代码的代码是没问题的。

![](img/c2315df7b7420729fb303cd355b101d3_168.png)

好今天今天就讲到这这里，后面我们来讲第二节好，今天就讲到这里，祝大家生活愉快。

![](img/c2315df7b7420729fb303cd355b101d3_170.png)