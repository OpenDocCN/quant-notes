# 第10节课 CtpEngine讲解(4) - P1 - 古辰诗提 - BV1Aq421A7YS

欢迎大家来到从零开始量化系列课程，VPI课程的第十节课，上一节课咱们说到了发送委托委托的发送。

![](img/29eac973bbb958b710be05dc9a782807_1.png)

其实最终他还是会发送这个limit order对吧，然后再去发送到这个send silver order。



![](img/29eac973bbb958b710be05dc9a782807_3.png)

然后就是就是the sher sent server。

![](img/29eac973bbb958b710be05dc9a782807_5.png)

就是往服务器发送委托，然后呢，他又给把这个就是呃一直给他到了这个self main engine，然后去SORDER其实就就去找那个gateway了。

咱们也去看了这个my engine里边那个代码了对吧，好SORDER有了之后，你还有一个就是说cancel order。



![](img/29eac973bbb958b710be05dc9a782807_7.png)

Cancel order，Cancel order，你从底层去调用的时候。

![](img/29eac973bbb958b710be05dc9a782807_9.png)

从这个template里边就是这个cancel order，那肯定是这个CCTA引擎里边cancel order对吧。



![](img/29eac973bbb958b710be05dc9a782807_11.png)

好咱们看一下这个cancel order，cancel order呢，他看这个vt order id呃，这个VTOID，如果说它是以这个stop这个前缀开始的，就说明它是它是这个停止的。

然后它就会cancel local这个stop order。

![](img/29eac973bbb958b710be05dc9a782807_13.png)

这个很容易理解，因为它本身这个stop d，它是在这个CT引擎里边去保存的，保存在了那个self stop orders这个里边是吧，然后他先去找找到这个stop order。

找到了这个stop order之后啊，就是然后再去找这个strange，就是就是在这个self distrange里面，找到这个strange，就是这个策略吗。

然后呢把它从这个self stop orders里边给pop出来，你给他pop出来之后，他是不是就不会在这个tick的这个事件里边。



![](img/29eac973bbb958b710be05dc9a782807_15.png)

去这个check stop order里边去触发了对吧啊。

![](img/29eac973bbb958b710be05dc9a782807_17.png)

去触发了，所以说它其实就是把它从字典里边给。

![](img/29eac973bbb958b710be05dc9a782807_19.png)

这不是把它从列表里边给摘出来对吧，这边啊这边是这个optional，其实他的意思呃，就是optional，是这个他这个中括号里边，这个类型或者一个NN类型，它其实就等价于什么呀，等价于这个。

等价于这个就是stop order或者是none值啊，因为他get的时候有可能获取获取的到，有可能获取不到对吧，这个optional你知道它是什么意思就可以了，它其实就是一个类型提示。

它跟这个代码纠错没有关系啊，就是你这写错了，他代码也不会报错，除非你是安装了一个插件，就是他严格遵循你这个代码的这个提示，这么来的，但是我觉得没有这个必要，这更多的是给你自己一个提示。

你在写代码的时候对吧，然后他还需要从哪把它给删了呢，就是c strange old id map里面去把它给删掉，这个cf点strange order id map啊。

这个是里边的这个存放的内容是v t order呃，就是就是每个策略的他后边都会有一个列表，这个列表里面存放的是你发送出去的委托单，这个委托单不光是限价单，停止单页会保存在这个里边。

你像我现在把它给选中了啊，咱们去发送委托的时候。

![](img/29eac973bbb958b710be05dc9a782807_21.png)

SORDER咱们先看这个S这个local stop order。

![](img/29eac973bbb958b710be05dc9a782807_23.png)

就是发送这个就是停止弹的这个啊新的local order。

![](img/29eac973bbb958b710be05dc9a782807_25.png)

你看啊是吧，他从这儿给他ADD进去了吧，对不对，咱们在之前还提过这个为什么这样去添加进去，因为他这个涉及到了一个深copy浅copy的问题，对不对啊。



![](img/29eac973bbb958b710be05dc9a782807_27.png)

这个没问题吧，然后你新的这个limit order。

![](img/29eac973bbb958b710be05dc9a782807_29.png)

User server。

![](img/29eac973bbb958b710be05dc9a782807_31.png)

Send limit order，就是你去发送委托单，Sa local stop order。

![](img/29eac973bbb958b710be05dc9a782807_33.png)

然后S咱们看一下啊，SORDER咱们找到这个send order吧。

![](img/29eac973bbb958b710be05dc9a782807_35.png)

![](img/29eac973bbb958b710be05dc9a782807_36.png)

SORDERSORDER在这呢一个是诶。

![](img/29eac973bbb958b710be05dc9a782807_38.png)

这个是SORDER，一个是slocal stop order。

![](img/29eac973bbb958b710be05dc9a782807_40.png)

一个是slimit order，slimit order里边咱们看一下他有没有添加啊。

![](img/29eac973bbb958b710be05dc9a782807_42.png)

就是啊send server al。

![](img/29eac973bbb958b710be05dc9a782807_44.png)

![](img/29eac973bbb958b710be05dc9a782807_45.png)

他从这你看啊self order id，strange map和self strange old id map，是不是就是尤其是这个通过策略找到这个order id，它是不是也添加进去了。

所以说咱们在cancel order的时候啊，这个有点乱啊，Cancel locust order，你看这个，它就是里边既存放了你限价单的那个委托单号，也存放了你的停止单的委托单号，然后他会去便利一下。

如果说这个stop bod在它这个里面的话，它会把它给删除掉，然后呢把他这个状态呢改成CANCELLED是吧，Canceled，然后再把这个stop order回调给这个这个strange。

就是调用它里面的on stop order这个方法是吧，这就是撤销这个本地的停止单委托，从这插一句话，其实你这么去考虑，如果这个停止的，比如说你发送了十首，然后有五首成交了，然后有五首没成交。

是不是他这个是他这个是撤销不了的对吧，你仔细想想，就是有十首十首委托单，有五首成交了，有五首没成交，它其实是通过这啊这个代码它是撤销不了的。



![](img/29eac973bbb958b710be05dc9a782807_47.png)

因为你这个委托单已经成交了，就是已经tracked了，咱们在讲这个check stop order的时候。



![](img/29eac973bbb958b710be05dc9a782807_49.png)

就是触发的时候。

![](img/29eac973bbb958b710be05dc9a782807_51.png)

这个process tick就是在这个check stop order的时候。

![](img/29eac973bbb958b710be05dc9a782807_53.png)

他会在最后把它给删掉，就是这个SORDERS里边会把这个给删掉，在哪，就是这个是吧，给这个把它给pop掉，你从这删是删不掉的，但是你想想啊。

这个stop that他最终还是会发到这个slimit order，也就是send server order这个里边去，然后你想想他发送过去的这个ORD，就是由stop单转换成就是限价单。

它给拆分了之后，他这个限价单发送过去了，发送到这个底层了，它也会在这个strange order id里面去添加，所以说如果说从stop order里边就是删不掉的话，他会去这个就是就是里边再去删对吧。

能理解这个意思吗啊然后这是cancel local order，然后还有cancel这个server or。



![](img/29eac973bbb958b710be05dc9a782807_55.png)

其实就是往这个底层去发一个申请，就是self engine点cancel order，其实还是去调用了cctp gateway，底层的那个cancel order，对吧啊。

这个呢它是没有直接的这个毁掉的，就是你看这cancel order，其实是调用了这个my engine的CONSODER，My engine consoder。



![](img/29eac973bbb958b710be05dc9a782807_57.png)

它其实还是调用了底层的这个cctp gateway，然后这个。

![](img/29eac973bbb958b710be05dc9a782807_59.png)

找一下。

![](img/29eac973bbb958b710be05dc9a782807_61.png)

这个偏瘦的这个cancel order，它其实是直接去这个TDAPI里边去。

![](img/29eac973bbb958b710be05dc9a782807_63.png)

cancel order去了，他只是给他发过去，如果委托撤销失败了。

![](img/29eac973bbb958b710be05dc9a782807_65.png)

咱们之前说过，就会他会给一个回调。

![](img/29eac973bbb958b710be05dc9a782807_67.png)

但是回调里边只有一个错误信息，对吧啊，这个on order啊。

![](img/29eac973bbb958b710be05dc9a782807_69.png)

这个是就是委托更新的时候嗯，Return order，这是委托更新的推送，然后还有这个嗯呃不是这个这个action，就是如果撤销失败了，他会从这给你回调一下，就是只会告诉你这个交易撤单失败。

但是没有详细的这个一些内容，其实你可以去翻一看，就是翻一下它的底层啊，这个dict里面究竟是，就是就是这个data里面究竟是个什么东西啊，这个data里面究竟是个什么东西，其实也没有太大的必要。

因为什么呀，就是你委托呃这个撤单失败的话，呃他这个就是这个状态。

![](img/29eac973bbb958b710be05dc9a782807_71.png)

他肯定会给你改变掉，就是这个下单失败的话。

![](img/29eac973bbb958b710be05dc9a782807_73.png)

就是他会给你reject，撤单失败一般就是正在撮合嘛对吧，但是你也可以去深入的去研究一下啊，这个是CANCELDER。



![](img/29eac973bbb958b710be05dc9a782807_75.png)

需要说一下的呢，就是这个cancel or cancel or，先去这个strange order id map里面去找，就是跟这个strange相关的所有委托单，然后这个所有委托单如果没有的话。

他就return，如果有的话，你看他copy了一下，就是这个他为什么要copy一下呢。

![](img/29eac973bbb958b710be05dc9a782807_77.png)

这个咱们需要说一下啊，为什么要copy一下，我还是去给大家做一下演示吧。

![](img/29eac973bbb958b710be05dc9a782807_79.png)

哦哦新建一个代码一零点PY，这个为什么要复制一下啊，这个必须得复制一下，就比如说我这有一个字典，比如DIC啊，哎DC等于这个里边你不能这么去存放，比如说135这么去存放，你是就是起不到实验的效果的。

比如说我这存放了列表，比如说我这个起个名字，它叫呃list1，然后这个里边呢存放的是123啊，然后这边我存放一个list2，好然后这个里面存放的是A啊，这是一个字典吧，对吧好，然后我找到这个list1。

等于dict点git，然后这个里边我找这个LST1啊一我找到它，其实这个list就是list1，就是这个嘛是吧，你找出来是这个嘛，如果说这个时候我LST1，然后那个呃点呃，我用这个end吧。

当然这个没有这个类型提示，LOST啊，我给他写一个list，它就有利有这个类型提示了，比如说我往里边添加一个100，我这个时候我添加进去，你会发现什么呢，就是print这个DIC。

你会发现它这里边就DIC，里面就自动去添加了对吧，但是如果说我给就是copy一下，就是我这个list1等于我获取这个就是dict，然后我进行一下copy，然后这个时候我再进行啊。

Has no tribute，这个好，这样是吧，这个它是不是原本的他就没有去改变，对不对，所以说嗯就是这个就是，如果说你就是对这个字典，你去获取它里边的值，但是这个值呢它又是一个可变数据类型的话。

你对它的这个值进行改变，原本的这个dict它也会进行改变。

![](img/29eac973bbb958b710be05dc9a782807_81.png)

所以说从这添加了一个这个copy，它就是为了在撤销的时候啊，撤销的时候就是不让他产生一些别的意外，比如说我这个VTO的ID里边，本身就是说可能有的在等待啊，等待出发。

有的在就是说在你这个执行这个代码的时候，它触发了它会就是有变化的，所以说有变化就产生了一些不确定性，所以说为了避免这种不确定性，这添加了一个copy这个东西啊，就是一般的错误。

有可能你通过自己的逻辑啊去找，能找出来，但是很多隐性的错误，尤其是这种就是说数据类型套数据类型的，就是字典里边有集合，有列表，这样的就是有些时候会有一些隐形的错误，你是不知道的呃，你像这样。

你像这样的话，就是你必须得注意啊，你像尤其是有copy的时候，肯定就是说它里边的状态的改变，就是说这个VTOID，它里边状态的改变可能会影响很多东西，所以说这边必须得要一个copy。



![](img/29eac973bbb958b710be05dc9a782807_83.png)

包括咱们这个template里边，它也有地方用到了这个copy，就是在一开始的时候，在初始化的时候，他这也用到了一个copy啊，咱们后边讲这个的时候，会着重讲一下为什么会copy。



![](img/29eac973bbb958b710be05dc9a782807_85.png)

其实这些都是Python基础啊，好cancel就属于是说完了。

![](img/29eac973bbb958b710be05dc9a782807_87.png)

那就是既然就是发送委托单和撤销委托单，都说完了。

![](img/29eac973bbb958b710be05dc9a782807_89.png)

那咱们再说一说，就是说委托单的反馈，委托单的反馈肯定是从你们engine里边去接收。

![](img/29eac973bbb958b710be05dc9a782807_91.png)

这个order m是吧，就是process这个order in it。

![](img/29eac973bbb958b710be05dc9a782807_93.png)

它在register里面肯定是因为order，然后process ordering in。

![](img/29eac973bbb958b710be05dc9a782807_95.png)

然后到这他第一步呢是把这个order获取过来，就是old data给获取过来，然后呢他去进行一下转换，就是用转换器，这个咱们先略过啊，你知道转换器是什么意思就可以了。

然后下来有时间咱们去讲一下这个转换器，然后呢去找到这个strange，你像这个self alid string map，就是为了找到这个策略，然后呢cf点strange order id map。

它是为了找到这个策略里面对应着的，就是所有的委托单的这个order id对吧，这个你要分清楚了啊，好就是哪个在前面，哪个就是key，你想通过这个就很快的能找到这个strange。

如果没有strange的话，就return有strange在接着往下走，它首先呢是通过strange ord map，就是来找到这个VTOID，就是就是这个策略，它总共的就是里面存放着的委托单。

这个单号都在这个里边，咱们刚才说过了，这个里边可能有限价单的委托单号，也有这个停止单的委托单号对吧，都在这个微调的ID里边好，然后if order点VTORD。

如果说这个委托的old id在这个VTORD，and这个order is active啊，And not order is active，这个order is active，它是什么意思啊。

就是你像这个是order data，它里边会有一个is active，就是它返回的是个布尔值，它是看你的状态啊，是不是在这个active studies，就是你的状态是不是还是活跃的状态。

什么叫活跃的状态，那肯定就是说你在等待成交是吧，已经申请了，但是啊就是还没成交，就是在等待，然后部分成交，对不对，咱们可以看一下啊，他这就是申请没有成交呢，然后部分成交就是这三个类型。

说明就是说你这个判断，它是不是就是还是活跃状态，如果说不是活跃状态了，我就把它从这个VTOLD里边给删掉了啊，这是做了这么一个工作对吧。



![](img/29eac973bbb958b710be05dc9a782807_97.png)

然后呢下面这个if order点tap等于order tap点stop，咱们要注意这段代码啊，这一段代码咱们想一想，从就是去发送委托单的时候，去发送维多弹的时候。

你不管是stop done还是limit，你最终会转换成这个limit到底层。

![](img/29eac973bbb958b710be05dc9a782807_99.png)

咱们在讲gateway的时候，咱们也在反复在说这个问题，就是说你最终发送的委托单，因为它这个上面有一个，就是old type的这么一个映射啊，多空方向B嗯，就是委托类型的映映射。

你像它的映射有什么limit market fake folk，但是咱们在CTA里边不谈这个fact和folk，CT里面并没有提供market委托，咱们那个CT引擎里面没有提到market吧。

就是market这个单词都没看到，所以说发过来的肯定是LIMBED维多的。

![](img/29eac973bbb958b710be05dc9a782807_101.png)

你想想limit委托单就是到底层了，到这它是limit维度的。

![](img/29eac973bbb958b710be05dc9a782807_103.png)

那它返回去也就是咱们刚才看的这个呃on return order。

![](img/29eac973bbb958b710be05dc9a782807_105.png)

这就是这他委托更新推送，他会有order委托单给发送出去吗，你像他都是order data吧，对不对，你像这个order咱不用看别的，他这个order data它放到了这个on order里边。

它就不可能有stop单，就是会出现这个就是这个type等于哎这样啊。

![](img/29eac973bbb958b710be05dc9a782807_107.png)

咱们还是看看这个，就是他就是你看他这个tape，是从刚才这个映射转过来的。

![](img/29eac973bbb958b710be05dc9a782807_109.png)

out tape呃，这是吧，是从这个映射里边给转过来的，所以说他返回觉得这个tab根本就不可能是stop d，它只有可能是什么，是什么委托单的，只有可能是限价委托单，能理解这个意思吗。

就是你从cctp gateway里边看这个代码，他返回去的就不可能是stop down。

![](img/29eac973bbb958b710be05dc9a782807_111.png)

所以说啊咱们刚才看的这个这其实这段代码啊，就是你可以你可以直接把它删了，就是针对于这个咱们这个期货啊，就商品期货来说的话，你就可以把它给删了，因为你像这for server stop order。

就是呃为了这个服务器端，就是咱们服务器根本就不支持单对吧。

![](img/29eac973bbb958b710be05dc9a782807_113.png)

这个代码你可以直接把它给删掉啊，然后呢他去self cost function就是回调这个on order，那什么时候是回调onstop order，咱们之前说过。

就是在触发stop order这个委托单的时候。

![](img/29eac973bbb958b710be05dc9a782807_115.png)

他会去毁掉这个on stop order，对啊是吧。

![](img/29eac973bbb958b710be05dc9a782807_117.png)

就是在check stop order的时候，他完成了这个long track，或者说是这个short track。



![](img/29eac973bbb958b710be05dc9a782807_119.png)

它最终会呃会去毁掉这个on order，On on order，咱们也说了，发送出去的都是涨跌停价。

![](img/29eac973bbb958b710be05dc9a782807_121.png)

用涨跌停价发呃，发出去一般情况下都能立即成交对吧。

![](img/29eac973bbb958b710be05dc9a782807_123.png)

但是有没有这种偶然性，就是它成交不了，有吧就是掌心顶板，就是掌心顶板的时候，它发动机就可能成交不了嗯。



![](img/29eac973bbb958b710be05dc9a782807_125.png)

就是那这个就得等待嘛，而且他后边就是触发了会回调一次，On stop order，但是呃它转成限价单去成交了，他还会去调用这个OO的这个逻辑。



![](img/29eac973bbb958b710be05dc9a782807_127.png)

你一定要捋清楚了，好，其实这个order这个方面呢，就已经就是委托单这一块就已经讲完了，但是肯定会比较绕，因为这个不是很好理解，那咱们再捋一下捋一下，首先这个是服务器，然后这个是你的这个策略。

然后这个是CCTA引擎啊，CT引擎，这个是你的策略strange，然后这个是服务器t template，当你去发送委托单的时候，你会通过这个template，就是咱们之前说这个template。

把它转换成这个order data，就是说all就all data啊，也不是order data啊，它没有进行转换啊，没有进行转换，就是他直接回调这个CT引擎里边SOR。

然后SORDER呢就是到这来会回调SORDER，然后SORDER呢会根据你的委托类型，然后去区分，如果说你是stop单的话，它会呢就是说把它放到那个叫cf点stop orders是吧。

stop orders里边等待触发对吧，就是放到这个里边去等待出发，如果说你是限价单的，他会直接呃发送limit order，然后由limit order转到了这个server order里边。

就是服务器order，然后再转去这个CDP里边，当然在这个转换的过程中呢，它可能会被拆分掉在底层，它也会被拆分，有有那个咱们那个转换器去拆分呃，就是他始终会变成一个，就是说可能就是说会变成两个啊。

也有可能会拆分的更多，他会给你进行拆分的，去发送委托单对吧，然后呢发送委托单就是这个停止单，在这等的时候呢，他会接收tick，然后每次有tick来，他都会去检测一下，如果说触发了触发了啊。

因为他的这个stop order只有三个状态，就是说一个是触发，一个是去就是CANCELLED的，就是撤呃，就是撤单，还有一个就是wedding，就是等待嘛是吧，一个等待一个触发一个cancel的。

当这个stop单有变化的时候，他会去毁掉你这儿的on stop order，只有这个就是它有变化的时候，在T引擎这它有变化的时候会掉这个on stop order，对吧好呃，转换成这个限价单之后。

它会发送给这个就是底层，就是说这个呃cdp gateway，CD p gateway呢会反馈给什么呢，就是说这个VTOID啊，就是这个order das会给你一个列表呃，但是从底层这个CP来说。

它不会给你就说一个列表，因为从底层你这不管是你怎么拆分，都是一一个一个的给他去发送委托对吧，但是呢从这儿呢，你一个列表发送出去的这个委托，所有的OLEDD它会给你归为一个VTOD，就是一个列表里边是吧。

然后再给你返回去，然后返回到这个顶层，对不对好，这是就这么一个流程啊，当然这个里边stop order停止单，你从这委托了，他也会给你返回一个，这个就是这就是这种形式的。

然后里面写上stop order是吧，stop点一这样的一种形式，咱们也讲过对吧好，这是一个发送的，其实都是不断的去回调，从底层，然后呃到这个t tablet这边去毁掉SORDER。

然后从这个CTA里边，然后进行转换等待，或者说是等待触发，然后给你最终转换成，就是说去这个cctp gateway里边去SORDER，然后cdp gateway里边去SORDER。

再去转换到这个TDAPI，或者哎那就就是在TDAPI里边去这个co order，然后去发送给服务器底层，这个是发送的一个过程，对不对，发送的时候你注意了，他这里边肯定会涉及到一个什么呀。

就是说以策略为key，然后呢后边是一个列表，这里边都是它的这个V呃，old i d这个里边有可能有stop单，也有可能有限价单是吧，然后还有以这个哦，ORD就是VTOID，然后v key。

然后后边是strange，然后这个时候就是方便很快的找到这个strange，是吧，同时呢这里边还有这个stop order，stop orders啊，这样的一个字典是吧，等待触发嘛对吧。

所以说这些又有什么用呢，虽然看着好像很绕，但是它其实每一个都有它每个的作用，从这儿你要注意一点，就是当你有成交的时候，当你触发了之后，你一定要注意它，这个里边儿是每次都完成了，这个里边数据的更迭迭代。

就是说比如说当你的这个停止单触发之后，他就直接从这里边把这个stop order给删掉了，因为你出发之后，你就会转成现价单，它会从这里边给添加进来对吧好，当你取消委托的时候。

它就会根据你是stop单还是你是限价单，然后去这里边来取消，或者说是去这里边来取消是吧，在这里边取消，同时呢，你也需要把它这个这个这块给删除掉对吧，这个逻辑没有问题吧是吧，这是一个数据的，就是增和删。

这一点你一定要记清楚了，这个很重要的，对不对啊，不复杂，但是呢比较绕一些，所以说你从这你就能明白你像这些字典，它是来做什么用的，对不对啊，好在这个发送的时候，你要注意一个点了。

有一个点我觉得你得引起注意，就是这个stop单呢它始终是一个什么呀，就是说咱们在分析这个这个stop order的时候，咱们反复在说他是去判断这就是这个tick点，Last price。

也就是说tick的上一笔成交价，成交价它如果高于这条线了，比如说这个是一个stop键，如果高于这个线了，当然咱们就拿这个举例子啊，就是说它停止弹吗，如果如果说咱们是空单的话，它高于这个线了。

然后它就会触发，那就是会会把这个委托给发出去啊，委托啊，不是啊，就是等待去触发对吧，你要注意这边是有个等待的过程的，明白吗，就是他在这等待等待着，就是说他再次比他高或者等于它的时候，它才会触发。

你想想如果你的代码里面写的是什么呢，我当我超过一个价格的时候，我就去给他发送停止单，肯定有这样的逻辑对吧，就是因为停止单用的更多的是止损嘛，啊当我超过这个价格的时候，我就给他发一个停止单。

但是有可能你这个停止单，你看着他超过这个价格了，你停止单发送出去了，但是他没有成交，为什么呢，就是可能价格就出现了一下上去，你停止单发送出去，在这个CTA引擎里边去等待，再没有就是再没有到过这个价格。

有些时候你回车的时候有可能就是说没有问题，但是你实盘的时候产生这样的问题，就是因为回测和实盘不一样的，它是有撮合的，而是有等待的对吧，其实同样的你limit单你发到你发到底啊，发到底层之后。

他也会有这个撮合嘛对吧，就是说可能就是说发过去之后，他是有这个报价的，但是你一发过去，它报它那个价格就下来了，或者上去了，他就不再有这个价格了，所以这一点你要注意了，就是你本身在你的策略里边。

你进行一下判断，比如说我这个价格超过某个价格，我就怎么怎么样，然后呢你发送的是委托单，然后你就把这个价格挂上去了，但是他没有成交，是有这个可能性的，好吧，这个是从顶层往底层去一步步的去回调，去发送委托。

好委托发送完了之后，他肯定得有回馈，当然有一部分回馈，你像stop order，它已经从这个CCTA引擎里边去完成了，对不对，还有一部分回馈是什么呢，你的这个限价单发到底层或者停止单，转成了限价单。

就是所有的限额，限价单发到就是发送到底层之后，在底层，比如说他撮合成交了或者被拒单了，他也会反馈回来，通过什么呀，因为engine是不是放到了这个limit engine里边，反馈给CTA引擎里边。

CT引擎里边它会这个process order event，对不对，但是在你的呃顶层，就是你的策略里边是没有的，这个是通过invent engine，就是这一点，你注意了，这边呢是通过调用。

就是你可以把它理解为COLLAB啊，去调用去完成的，从invent engine里边接过来之后呢，他会对这个order进行处理，其实最主要的处理是什么呀，第一个就是转换器里边的处理。

这个咱们之后再说转换器，第二个呢就是把该删的删掉是吧，你这个几个这个呃字典里边啊，以及你的这个列表里边，你该删的把它给删掉对吧，你拒单了也好，成交了也好，你该删的把它给删掉是吧，然后呢他再去调用。

就是再去回调到这个，这个咱们的这个顶层的策略是去调用OO的，对吧啊，所以说你的stop order，只是在CCTA引擎里边去完成回调，你stop order转换成了你的这个limit order。

成交了之后，或者有状态变化之后，它还是最终会调用到你，你的这个顶层的这个on order里边啊，一个own order，一个on stop order，这一点你一定要注意了，你的这个发送出去了。

stop单呃，会调到调用到onstop order，但是它真正的成交在底层成交，它会调用到own order，能明白这个意思吧，啊这一点你一定要清楚好吧，因为这个涉及到跟你策略相关，你写策略的时候。

你不知道这些东西，你肯定就没法写，什么时候会调用on order，什么时候会调用on stop order，或者说你想很精细的去控制委托单的发送，撤销啊什么的，你必须得考虑到就是这些问题对吧。

你什么样的委托单去接什么样的委托单，我可以不接啊，因为你发送委托单的时候，你肯定有stop order，肯定有own呃，有这个limit order，你像stop order一般用于什么呀。

一般用于是这个止损挂个大止损是吧，你像你这个限限价单一般适用于什么呀，就是说你去挂止盈，但是这个止盈不要太大，或者说是你在这个tick里边去触发止盈啊，这些咱们讲这个这个template的时候。

会给大家提及到，其实呢这一点很重要，但是很多人好像就不太重视这些代码，写到最后啊，他还是写逻辑的，你说Python基础能有多少东西吗，没有多少东西，你就算不会那些什么生成器啊，迭代器啊，比较复杂的呀。

同步异步啊什么的，你不懂，你就会一些Python基础，然后知道一些类会会用这个多线程，其实你就可以去进行编程了，但是很多老板们就是就是捋不清，这个该怎么去操作，怎么去写，怎么去下笔。

你只有把这这一步步理清了，你才能具有思呃，你你你才能有思路。

![](img/29eac973bbb958b710be05dc9a782807_129.png)

对吧啊，其实它这个里边每一个方法，就是就是他就做了一件很小的事情。

![](img/29eac973bbb958b710be05dc9a782807_131.png)

然后结合起来有这么多方法，然后他就完成了你所需要的工作。

![](img/29eac973bbb958b710be05dc9a782807_133.png)

好吧好，那咱们再看一下啊，这个里边咱们还没有还有什么没讲的。

![](img/29eac973bbb958b710be05dc9a782807_135.png)

INIT讲过了吧，初始化，这个时候你再看啊，这个strange setting，它其实就是呃参数设置啊，string data其实就是你的变量数值的设置，这个classes其实里面存放的是所有的。



![](img/29eac973bbb958b710be05dc9a782807_137.png)

就是说继承自c t template那个类，然后self distrangers，其实就是存放着你所有的实例化的策略对吧，然后这个cf点symbol strange map，它其实放着的是什么呀。

通过symbol为key，然后这个strange map后边是一个列表，列表里面存放着是你这个品种需呃，它实例化的策略对吧，这样方便在提克来的时候好调用，然后这个order id string map。

它其实是通过这个微调的id，然后去对应着这个策略，方便就是在这个order回调的时候，很快的找到这个策略对吧，然后这个strange old id map是通过strange name，就是你的策略名。

然后后边有一个列表是存放着的，你的这个order id啊，或者说是VTO的id，你可以自己去看一下是O的id还是VTL的id，这个是就是说在你找到了这个策略之后呢，你再找到这个策略。

对应的就是他在等待着或者在活跃着的那个order，就是那个委托单，然后你进行这个委托单的删除啊。

![](img/29eac973bbb958b710be05dc9a782807_139.png)

或者增加呀什么的，来干这个事情的，对不对啊，然后这个sp stop all count，他是来做什么的呢，他就是来一个技术，当你发送了停止单，然后就加一个再发一个停止单，他再加一个是吧。

然后结合那个stop order那个字符串类型，然后拼凑成他的这个呃O的I，就是这个O的AD，然后呢再由O的ID变成V跳的ID，然后在后面再加一个，就是说这个列表把它封装到一个列表里边。

反馈就是返回给你对吧，然后self stop orders主要是来干什么的呢，他是来保存这个stop order放在这个CTA引擎里边，然后tick过来之后等待出发的对吧，然后这个是来干什么的。

是就是它是一个线程池，是在初始化的时候，然后进行就是说下载数据啊，然后初始化用的这个也跟大家讲过，就是说如果说你不想那个sleep60，你应该怎么去做是吧，你可以去改啊，没有任何的问题。

这个三点ARQSIMPLES，这个咱们还没看到，它其实跟阿Q有关，其实就是跟数据库有关的嘛，对吧，哎呀不是不是数据库啊。



![](img/29eac973bbb958b710be05dc9a782807_141.png)

跟数据服务有关系的，阿Q嘛需要点VT这个try的id呢，它其实就是来保存你的这个已交月的，已交易的那个单号的，已交易的那个成交单号呃，防止又重复它，可能你在每次连接如果中间断开了之后。

他会再给你发一次那个成交的这个单号啊。

![](img/29eac973bbb958b710be05dc9a782807_143.png)

他是为了防止重复的，这个咱们后边会讲它是个转换器。

![](img/29eac973bbb958b710be05dc9a782807_145.png)

然后这两个就是吧，一个是database数据库。

![](img/29eac973bbb958b710be05dc9a782807_147.png)

一个是DATABFEED，就是数据服务啊，你看这个是不是就很清楚了对吧，一定要捋清楚啊。

![](img/29eac973bbb958b710be05dc9a782807_149.png)

如果说你在这个order方面啊，或者说在你这个载入数。

![](img/29eac973bbb958b710be05dc9a782807_151.png)

就是说你的这个策略的时候还没有太懂，你要反复看这个视频好吧，In it engine，咱们讲过了，这里边其实就是为了做这个而初始化使用的，就是去下载呃，去呃导入你的类，然后初始化你的累是吧啊。

这还没有还没有初始化类呢啊，就是把你的类加载进来对吧。

![](img/29eac973bbb958b710be05dc9a782807_153.png)

然后去下载好，你的这个参数和这个就是变量变量的数值，这边呢有个stop，它是就是不是这边有个close。



![](img/29eac973bbb958b710be05dc9a782807_155.png)

它是stop all stranges，咱们这看一下啊，Stop all stranges，它其实就是挨个的去关闭这个strange啊。



![](img/29eac973bbb958b710be05dc9a782807_157.png)

挨个去关闭全解。

![](img/29eac973bbb958b710be05dc9a782807_159.png)

咱们都能想到它其实就是调用这个on stop是吧，然后把你的委托全部给撤销掉，同步一下你的数据啊，然后再把这个状态放到这个UI界面里边去，让他接受一下对吧。



![](img/29eac973bbb958b710be05dc9a782807_161.png)

没什么别的东西吧是吧好，那咱们。

![](img/29eac973bbb958b710be05dc9a782807_163.png)

就是这个它会在什么时候调用这个close呢，咱们可以看一下那个my engine啊，my engine magine是在这个七啊。



![](img/29eac973bbb958b710be05dc9a782807_165.png)

这MAGINE是吧，my engine里边，close看啊它是four engine，In engines，然后engine their clothes就是他在关闭的时候。

他会去便利那个self engines，就是你那个city engine肯定是在这里边的。

![](img/29eac973bbb958b710be05dc9a782807_167.png)

他这个时候就会掉用闹啊，是这个时候会调用到的好吧，Reject invent。

![](img/29eac973bbb958b710be05dc9a782807_169.png)

这个这个不说了，这个是invent engine里边去注册的啊，Process account。

![](img/29eac973bbb958b710be05dc9a782807_171.png)

这是我后来添加的，但是我没写啊，然后in init data，这个data feed就是去初始化这个数数据服务啊。



![](img/29eac973bbb958b710be05dc9a782807_173.png)

这个其实咱们也不要过多的去关注。

![](img/29eac973bbb958b710be05dc9a782807_175.png)

然后query Buff from data feed。

![](img/29eac973bbb958b710be05dc9a782807_177.png)

就是从这个数据服务，那就比如像你像米框数据服务啊，去下载数据，这个咱们呃后边就是讲数据库的时候，会给大家提一下，讲数据库不会讲的太细啊，因为数据库它本身就是单独的一个一个东西。

咱们其实最主要的是讲PPEWE，就是那个P就是它的一个呃，就是就是一个三方库吧。

![](img/29eac973bbb958b710be05dc9a782807_179.png)

啊啊这个就不说了啊，persistent event里边主要的是做了一个check stop order。



![](img/29eac973bbb958b710be05dc9a782807_181.png)

然后就是之前会把这个tick放到，就是说这个每一个这个呃啊。

![](img/29eac973bbb958b710be05dc9a782807_183.png)

之后会放到每一个里面的OTC里边。

![](img/29eac973bbb958b710be05dc9a782807_185.png)

对吧哈，order event就是当你的order来了之后，他做了哪些工作啊，最主要的是这个它会把它放到这个转换器里面，去进行转换啊，然后process trade invent，这个咱们看一下。

其实也没什么，这个里边你看啊，tread等于M就是这个try data先获取先获取掉啊，先获取到，然后如果说这个这个交易的编号已经在这个呃，就是这个v try的id了，就return说明是重复发的。

如果说没有的话，把它给添加进去，然后去这个转换器器里边去update一下这个tread去，其实就是呃呃去改一下那个什么呀，就是说这个你的这个持仓的信息啊，然后去获取到这个strange啊。

通过这个old id啊，try就是strange map，这个china data里边是它是有这个呃OD的啊，有这个有这个OD的，不知道大家还记不记得那个OD。



![](img/29eac973bbb958b710be05dc9a782807_187.png)

就是咱们在看这个底层的时候，就是说这个在看这个底层的时候，咱们当时讲到了这个东西是吧，cf点呃，这个system id，这个old id map当时说了是两边去转换的啊。

你想它一个是on return trade，一个是on return order，你想on return trader里边是用到这个OLED的啊，他去他会就是当你有成交的时候。

他首先其实会调用的公return order，就告诉你这个order有变化了啊，然后再给你发这个trade data就是高啊，告诉你有成交了啊。



![](img/29eac973bbb958b710be05dc9a782807_189.png)

嗯记住这个流程啊，然后这个里边就是如果说没有这个策略的话。

![](img/29eac973bbb958b710be05dc9a782807_191.png)

他就给蹭了啊，如果说有这个策略的话，如果是多方向的，他这个间接点pose就是你的这个策略的这个pose啊，它会就是加等于这个自增这个数量啊，如果说是shirt的话，它就是自检啊。



![](img/29eac973bbb958b710be05dc9a782807_193.png)

这个pose它是这个呃template里边，它就是肯定会有的C点。

![](img/29eac973bbb958b710be05dc9a782807_195.png)

pose其实是代表持仓的意思啊，你这就是你的持仓量嘛。

![](img/29eac973bbb958b710be05dc9a782807_197.png)

然后它会回调一下on trade，然后呢再同步一下数据。

![](img/29eac973bbb958b710be05dc9a782807_199.png)

同步数据其实没什么东西啊，不要觉得它很复杂，它其实就是这个策略，就是这个咱们看template里边有get variables。



![](img/29eac973bbb958b710be05dc9a782807_201.png)

就是获取它的这个get variables，就是这个获取它的这个变量的这个字典啊，然后把这个字典里面一些东西去进行一下。



![](img/29eac973bbb958b710be05dc9a782807_203.png)

就是变化，就是因为你成交了吗，你成交了之后，那你的这个仓位肯定有变化，这个时候就需要去保存一下。

![](img/29eac973bbb958b710be05dc9a782807_205.png)

其实最主要的就是仓位的变化啊。

![](img/29eac973bbb958b710be05dc9a782807_207.png)

好这是traveling it，然后position it它没什么，它最主要的就是放到转换器里面去进行校准，就是你转换器你像刚才踹的也好，old也好，它是就是自己进行调整的。

你像这个position是你真正的最后的，就是实际的持仓啊，他会去这个啊，offset就是command，就是转换器里面去进行校正啊，就是矫正用的啊，这个咱们后面会说到这个stop order。

咱不说了，send sword limit order啊。

![](img/29eac973bbb958b710be05dc9a782807_209.png)

就是这个咱没讲到，因为根本就就闻不到是吧，就是去向底层发送这个stop order，然后这个SLOCALSTP咱们重点讲了，Cancel cancel，Local osorcancel cancel。



![](img/29eac973bbb958b710be05dc9a782807_211.png)

咱们都讲过了，这个是get engine type啊，这个get engine tab就是这个时实盘。



![](img/29eac973bbb958b710be05dc9a782807_213.png)

它会给一个LIVE就是这个lab是吧。

![](img/29eac973bbb958b710be05dc9a782807_215.png)

然后如果说是回测的话，他会告诉你它是回撤，这个没什么啊，然后get price stick。

![](img/29eac973bbb958b710be05dc9a782807_217.png)

这个price stick是什么东西啊，啊他是在这个contract data里面的。

![](img/29eac973bbb958b710be05dc9a782807_219.png)

这个price sta和这个size size，咱们之前说过是代表的，比如说你教他一手是100吨，它其实是代表的就是一个点100块钱，然后plastic是什么呢，焦炭最小的波波动它是0。5啊，你像这个。

可可能你像呃有色金属里面有五个一条的橡胶，是不是就是五个一条，还有一些就是化工品是两个一条的，就这个就这个你像那个股指期货或者是什么，就是国债那个是0。005是吧，这个就是代表这个的啊。

就是呃这个price tag啊，price tag不是这个呃volume啊，这个是代表的你最小的这个就是下单量吧，应该是啊，就应该是这个price tag是代表这个啊。



![](img/29eac973bbb958b710be05dc9a782807_221.png)

这个有什么用，其实挺有用的，就是当你自己想去写一些东西的时候，或或者你调你调整你的这个数值的精度的时候，你需要用到嗯，就是你你像如果说你只做大宗商品，一般情况下只是到这个小数点后一位或后两位，就行了。

但是你要做股指期货的话，你你是不是得保留到后边的后三位或者后四位，对吧啊，或者说是你在就是接收，你像上期所的一些数据的时候，它会后边由于这个计算机本身的问题，会有好多好多个零。

那你怎么去把它就就是矫正过来，其实这个也是有啊，也是有用的啊。

![](img/29eac973bbb958b710be05dc9a782807_223.png)

嗯好那这个就是get price tag。

![](img/29eac973bbb958b710be05dc9a782807_225.png)

Load bar，这个就是去下载啊，咱们就先不说了。

![](img/29eac973bbb958b710be05dc9a782807_227.png)

这个到ccta tablet的时候会给大家讲一下，load tick也不说了，cost string function也不说了。



![](img/29eac973bbb958b710be05dc9a782807_229.png)

ADSTRACT就是添加策略嘛，这个最最主要的是用到这个呃界面里边，就是界面里面会添加一个策略是吧，at jj啊。



![](img/29eac973bbb958b710be05dc9a782807_231.png)

嗯然后这个也不说了，Integer strange，这个也不说了，Stars strange，Stop strange。



![](img/29eac973bbb958b710be05dc9a782807_233.png)

这个说说一下，这个是edit，edit是编辑的意思是吧，这个其实是什么呀，在你在界面上去调整它的参数的时候啊，它会进行一个保存啊，它会进行一个保存，就是你把参数调整了，你把20日均线调成30均。

30日均线了，他会给你一个保存对吧，remote专辑就是删删除一个策略嘛。

![](img/29eac973bbb958b710be05dc9a782807_235.png)

啊这个也没啥，其实就是数据的保存与与删除嘛，后边这个lotus strange，Class，lotus strange啊，load这个这个都说了啊。



![](img/29eac973bbb958b710be05dc9a782807_237.png)

然后这个是同步一下数据，同步一下数据，他必须把这个和training给删掉，这个也是这个CD template里面，咱们再具体说为什么会把这个删了呀，就是初始化和是否能够交易嘛，你这个肯定得删掉。



![](img/29eac973bbb958b710be05dc9a782807_239.png)

你保存下来没有任何的意义对吧啊，然后get all strange class name，这个也就是返回cf点classes，这个这个也没什么说的好吧。



![](img/29eac973bbb958b710be05dc9a782807_241.png)

后边基本上就没什么东西了啊，update讲解啊，setting就是更新一下他的这个参数嘛对吧，然后remove string setting就是把这个参数给删掉啊。

然后put a stop order event，Put string event，你像一般这个put就是把它放到那个engine里边啊。



![](img/29eac973bbb958b710be05dc9a782807_243.png)

这个red log它也是放到了这个engine里边去，让这个lock engine去去接收的啊。

![](img/29eac973bbb958b710be05dc9a782807_245.png)

新的email咱们就不说了，好基本上这个咱们这个CT引擎就说完了好吧。

![](img/29eac973bbb958b710be05dc9a782807_247.png)

下下一节课。

![](img/29eac973bbb958b710be05dc9a782807_249.png)