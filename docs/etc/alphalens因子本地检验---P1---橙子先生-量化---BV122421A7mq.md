# alphalens因子本地检验 - P1 - 橙子先生-量化 - BV122421A7mq

各位朋友大家上午好，今天我们来分享一个因子检验，这个相对于来说是更加偏重于实战的，然后也是目前主流的量化机构，所采用的一个策略，其实不仅仅是量化机构，一些大型的国外的一些这种公募基金。

也是通过这种方式来配置资产，因此其实要想理解其实并不容易，尤其是对于没有接触过量化投资的，这种主观投资人来说并不容易，所以我们今天的分享分成两部分，第一部分是呃，通过经济学原理。

或者通通过经济学的直觉来分析什么是，因此因此它能够产生超额收益的逻辑，这是第一部分，就是我们先讲原理，经济学原理或者他的数学原理，统计学原理，第二部分我们再来说代码啊，以后可能以后我的这种公开的课分享。

可能都会包括两部分，先讲原理再讲代码，我觉得如果单独讲哪一部分都不合适，因为如果你单独讲代码，可能对于不了解经济学这个原理的朋友，他会觉得非常难以理解，那就就变成了学计算机了，那如果仅讲这个原理。

那学技术的人会觉得很没有意思，就喜欢看代码对吧，学计算机都在看代码，那么这两部分结合起来，我觉得会更有力量，也更更务实吧，可以落地好啊，第一部分如何通俗理解因子呢，呃这个因子和我们之前那个因子不一样。

我们这个大学统计学的时候有因子，有因子，这个这两个是不同的概念，我们量化投资的因子呢，它是有特定的含义，A professor andrew an，他认为因此就像对于就像对于食物来说。

我们吃的其实并不是各个食物，而是它背后的一些营养元素，比方说我们需要水，需要碳水化合物，需要蛋白质等等吧，还有需要维生素等等，这些东西，其实才是真正我们摄取食物的原因，我们身体需要营养。

有营养可以看成是因子，那么对于投资来说呃，传统的投资机构就是从大类资产配置来来说啊，会经常会有什么6040原则，什么5050原则，就是说大机构，国外大机构投资，会会觉得固定收益相对比较稳定吧。

固定收益拿的就是拿的是利差嘛，就是风险比较小啊，金融机构的朋友都会知道，利差就是我我我我我这个资金来的成本，比方说是是两个点，那我出的成本，比方说五个点，中间这三个点的收益像银行啊。

还有一些类银行的金融机构，它的它的这个授业这个商业逻辑就就这么简单，但他还做风控啊，它的优势在于风控比较好，包括那些互联网金融机构，他们做的一个利差业务为主吧，这是一类金融机构做的业务有利差。

还有一类呢，比方说什么PVC，还有一些投行他们的业务，他们可能就权益类投资，它就不仅仅是阵地差了，它是需要一些更复杂的，这个我们就不展开说了，因为我们今天讲的不是金融啊，啊讲的是这个量化因子。

那么我们回过来就说什么因子呢，因子可以理解为你在投资一个资产，它获得超额收益背后的原因，就像发生了一个事情，我们要找他的原因，通俗来说就找这个我们获得我们挣到更多的钱，比基准是更多的钱的原因是什么。

当然如果你跑输了基准，你就阿尔法是负的，所以我们在评价一个投资人或者一个机构，它的收益的时候，我们一般是要用他的超额，他的他的那个收益率和基准收益benchmark做比较。

而不是说我你不能听他的那个自我的描述，说我今天或者说我这段时间收益率多少，你要和基准比，如果没有基准是没有意义的，这是第一个，那相对于基准的超额收益的背后原因，我们就分解它是一种。

因此那如果通过跟学术的角度来看呢，那因此其实是一种风险，说资产，就是，为什么某些机构在08年金融危机之后，获得很高的收益，他很多机构啊，就比方说有一些量化机构都不点名了哈，就是西方的。

他在08年甚至在09年都能获得很高的收益，就是因为它承担了风险，这种是一种风险溢价的补偿，不知道大家理解没有理解的意思，它其实因此其实很多人可能不太明白，他觉得因此就是收益。

其实收益跟风险是一枚硬币的两面，你获得这个收益，超额收益，实际上你承担了超额风险，可以这么理解，就这是不是那么科学准确的，但是是一个，我停顿几秒，大家来思考思考，因此它到底是什么啊，我们看第二部分。

我们做这些因子组合啊，包括因此这些阿尔法策略的目的是什么，目的是为了获得超额收益啊，之前讲了很多很多，我分享了好多次各种策略，但是我没有办法展开讲，这次就借着机会展开吧，我做了一个图。

做了一个简单的这种逻辑图，未必准确啊，未必那么严谨，是一个比较形象的图，就是我们获得因子数据或者因子之后呢，我们通过各种组合的方式，构成一个通过模型回去阿尔法模型吧。

量化模型通过这个模型来找到阿尔法来找操作，所以是这么一个基本逻辑，那么大家如果读过那本书啊，号称是量化投资的圣经呢的业界一本书，要主动投资管理吧，叫主动投资管理，还主动资产管理，我不记得了。

也是我大概2020年的时候读过的一本书，非常好，推荐给大家，那这本书上有一个公式，就是说你这个信息比率就等于C乘以，B2的这个开开根号，然后再乘以CI2就是信息比率，它是指的超额收益的均值。

除以它的那个分差是吧，风险嘛叫标准差，就像对外在标准化之后的这种超额收益，等于什么，就是你我说通俗点A是什么，A就是你衡量一个主动投资基金经理，他的有多少能力获取阿尔法，有多少能力跑赢市场。

就它到底有多厉害，是由什么决定的呢，是由C乘以这个宽度取得，取得根号也是宽度吗，这个宽度我们对这个信息系数，我们所谓理解宽度，它不仅仅指的是，哦不好意思，他这个B2啊，在这宽度。

它宽度不仅指的是你投资股股票啊，或者其他资产，它的多样性，它往往也指的是策略多样性，就是用各种各样的策略组合在一块，有两种可能知道吧，一个是资产的多样性或者行业必须做多样性，第二类有策略多样性。

通过不同的分散能获得这个超额收益，呃举个更通俗的例子吧，我们常常说主观投资的代表人物是谁，巴菲特是吧，巴菲特芒格他们其实几十年来看啊，回回过头来看也是很高的收益，他们典型的特点是什么。

他如果来衡量巴菲特，他是有什么决定的脑袋，他IC高还是还是BR高的宽度高，还是IC值高啊，我们思考一个，很显然我们知道巴菲特，他和一些量化基金最大的区别是什么，他选的股比较少，那可能就是有那十几只。

几十只或者几只股票长期持有，就看准了这个赛道，看准了这个公司，比如可口可乐只有几十年是吧，包括他投资过比亚迪对吧，这都是长期投资，他很少快速快进快出，很少有那种高频交易，它都是非常长期的交易。

甚至是三十三五十年，那么所以它它的超额收益靠的主要是IC高，IC它低的是它B2比较低，宽度比较低，广度啊，抱歉啊，这个应该叫广度，不应该叫宽度，广度，他是主动投资。

像这种主动投资大师一般都是高ICD地广度，那对于量化投资显然来说，尤其是这种高频的量化投资基金经理，他的超额收益来自于什么，主要来自于比较大的这种宽度广度吧，广度宽度都可以，那他IC相对比较低。

就让他一秒交易好多次，那每一次IC都很少，他积少成多嘛，大数定律嘛，积少成多呃，大概就是这么个意思，大家明白吧，那当然了，除了高频之外，你也可以通过什么方式，就是量化不仅仅是高频，大家就是一定要明白。

高频是量化的一种，但是大多数量化不是高频，可能中中低频，知道吗，这个意思，那对他们来说，可能他的IC可能要就是对于一般的比方，基本面量化的话，它的IC值可能是要低低于巴菲特。

但他一定是高于这个高频的IC，它的广度宽度呢，它也能做到和高频一样的广度和宽度，往往我们都是全市场选股吧，接下来我们就来这，到到目前为止，我们把这个理论讲清楚了，就不再讲了，以后也不会再讲了。



![](img/2cb54d85333743834d5e131b7600b60b_1.png)

就一次课讲清楚，那么我们第二部分，就今天分享的第二部分，就是如何来实现单因子检验，我在我大概去年年底吧，在我的频道也分享了，就怎么通过巨宽的函数啊，通过它来调用的IC，IC一直检验。

但是我想很多人可能会有疑虑，或者说会想我能不能通过本地来检验呢，因为我有我有一个合集，就是讲本地建立自己的量化系统来量化系统，你在其实后面的跑策略都是非常容易的，其实后面都比较容易，说句实话。

不管你用什么机器学习模型，深度学习模型也好，你还是用普通的线性模型也好，其实都都不都不复杂，最关键的是你要找到因子，或者说你找到这种方向，方向对了，努力就会加倍，但你方向错了，努力就白费了。

所以方向是什么，方向就是因子找到正确的因子，然后对它进行配比，那与平台的回测相比呢，就是本地回测相对来说它更灵活啊，大家别看到我用的是这个聚宽的研究平台，但是我这个我我现在用的这个库是阿尔法。

Length，就是你在你的编辑器里都可以编辑的，不需要用这个原因是因为它的数据比较好，能直接拿过来，我的万能数据好像已经超标了，他问的数据他每天是有容量的，我我就是用了太多的容量就就没法下载了。

所以我就转到这，其实我昨天晚上已经通过那个万德已经跑跑，基本跑出来了，就差差最后一步，所以还要回到这个这个他的这个平台，但我没有用它平台的API函数，我用的都是可以在本地实现的，这一点是需要讲清楚的。

好我们直接来上代码吧，第一部分就是引入pandas库，它是用来处理这种二维数据的吧，那咱们今天这个数据还不止二维，还有三维的panda data，所以pandas的就来自于panda dt。

简称叫pandas，就是面板数据吗，如果学过经济学的都知道，就像经济学都知道面板分析是吧，那么第一步我们要获得A股所有股票的列表，代码列表，you get all securities的，不漂亮吗。

这是获得数据方式，如果你是通过万能的话，它函数做一点改变，本质上一样的，第二个是把这些全市场A股，全市场5000多只股票的收盘价给大家切出来，记住这个这个表呢是一个三维表，这三个轴或三阶啊，三个维度。

第一个维度是时间嗯，看到没，开始到结束，第二个维度呢是股票名称，第三个维度它包括什么，开盘收盘最高最低，那我把这个收盘贴出来了，他这个表实际上是一个二维表，但是他在API调用的时候。

它会先生生先生成这种三维的PANDATE。

![](img/2cb54d85333743834d5e131b7600b60b_3.png)

所以他这里就有一个有一个警告吧，说我们以后不会用了，现在可以用之后呢，我们就是老生常谈的，要调整它的data time格式，显示前五行我就不再运行。



![](img/2cb54d85333743834d5e131b7600b60b_5.png)

因为它时间比较长嘛，几10万行数据，所以我就先跑了，给大家看一下他是不是展开就两个啊，如果如果是用别的方式获得的话，可以用那个函数，可以用pandas的PIVT这个函数把它展开，直接展开就行了。



![](img/2cb54d85333743834d5e131b7600b60b_7.png)

好我们获得了，这是玩家的数据，第二步呢就叫获得因子数据呃。

![](img/2cb54d85333743834d5e131b7600b60b_9.png)

通过聚宽data来引入这段时间时间要要要一样啊。

![](img/2cb54d85333743834d5e131b7600b60b_11.png)

这个这两个时间也要完全一样。

![](img/2cb54d85333743834d5e131b7600b60b_13.png)

就price和factor这两个数据表的时间范围，区间要完全一样对吧。

![](img/2cb54d85333743834d5e131b7600b60b_15.png)

我们取了四个月，实际上你要是做的话，做更严谨，要取长一点10年。

![](img/2cb54d85333743834d5e131b7600b60b_17.png)

但我们不想花那么久嘛，我们就可以展示一下，我们就把这个从6月10号到10月30号的A股，5000多只股票日期先给他弄出来，然后我们写个循环，循环是什么样的逻辑呢，就是我们对每一只股票取它的什么，两个列。

一个是五个代码，一个是P值，我们我们这个就是随便选了一个PE作为单音子，假设它是个因子，然后filter filter cirarmy这个数据操作原理吧，Code in stop stop list。

就是我们要对整个A股，全A股的股票来做一个取财务指标，就P就P值做这么一个筛选，就Q对象，然后传到这个get fundamentals unity，就是连续的来取他的，这个值是吧，actor的值取出来。

那panda force取出来之后呢，我们还要把这个因为它是一个一个取嘛，所以我们要用come on cat这个函数来把它连起来，我们不能只要一个对吧，我们要所有的A股，所有股票来连连成一只大一个大表。



![](img/2cb54d85333743834d5e131b7600b60b_19.png)

source force就是逆序来排，OK然后我们再对这个表这个表出来了吗，OTA出来以后呢，我们还要把它的索引改成这种daytime格式，然后重新设置，然后出来打印出来。



![](img/2cb54d85333743834d5e131b7600b60b_21.png)

就是这个样子，大家发现这个表什么问题啊，就是索引重复了，所以我们要删code code1啊，我们代码也重复，索引重复这个这个这个有点瑕疵。



![](img/2cb54d85333743834d5e131b7600b60b_23.png)

大家可以改一改，擦完以后呢，就这种模式这个模式，但是这种模式的上面的，所以名字和affluence的要求的那个名字，有点区别，所以为了避免造成不必要的麻烦，我们就改成他官方需要那个索引的名字吧。

DASSET和P官方这叫factor，我们没改，我们就用这个皮。

![](img/2cb54d85333743834d5e131b7600b60b_25.png)

然后记住就是这个第五行代码很重要，他这all data set index这个两索引，这两种索引双索引是affluence要求必须的格式，所以你看设置了双索引之后呢。

他就会有date和asset两个索引，然后这个就是它的一个列一列，这个值是吧，就可以了，到目前来看，我们已经做成了第一件事，就是获得了阿尔法，LZ在因子分析需要的两张表。



![](img/2cb54d85333743834d5e131b7600b60b_27.png)

第一张表是price price表，就这种格式看到没，横轴是时间序列，the time时间的这个时间序列，纵轴是股票代码的序列。



![](img/2cb54d85333743834d5e131b7600b60b_29.png)

有5000多个，你看这么多全市场了，那这两个表出来。

![](img/2cb54d85333743834d5e131b7600b60b_31.png)

我们就完成了承诺，第一步那还远远没有结束，还有第二步，第二步就是对因子数据进行规范化处理啊，大家如果学过机器学习，就知道很多数据啊，你不规范化处理，它是很难以比较的，你比方说市值那么大是吧，五位数。

六位数，六七位数，你这P值又那么小，还有更小的值呢是吧，你的财务比率都是很小的，你这放一块儿到底怎么算呢，所以一般来说在做机器学习的时候，都会对数据进行一个规范化或者说预处理吧，清洗你用叫什么都行。



![](img/2cb54d85333743834d5e131b7600b60b_33.png)

反正一般就这几步去极值标准化，一般是去极值标准化。

![](img/2cb54d85333743834d5e131b7600b60b_35.png)

还有行业中心化，咱们这就跟不上我们对这P的值，我们定义两个函数，一个是3米西格玛方法来取极值标准化，我们是用这种均值方均值取均值方差，然后再除以这个好像叫z z z score，叫z score方法吧。

我不记得了，反正大概意思就是这样呃，确实好几种方法都没用，你用这个把三维方向差以外的，全部都都调整为三个方向差的边界大于三倍方，三倍方差的就设置为三倍方差，小于三倍方差一左的也是。

这属于min减去三倍这个标准差，好吧，这个意思啊，懂这个MMPV2的意思，我之前在标准课基础课都讲了，大家可以不懂的话，再去复习复习和南派的一些知识。



![](img/2cb54d85333743834d5e131b7600b60b_37.png)

对它标准化处理之后呢，我们再看这个factor。

![](img/2cb54d85333743834d5e131b7600b60b_39.png)

它就是比较哎看这个值有大有小啊，非常分散。

![](img/2cb54d85333743834d5e131b7600b60b_41.png)

你看它这就基本就聚拢起来了，在这个值啊，我没画图，大家一画图就看出来就比较锯的，比较懂，就不会那么分散好。



![](img/2cb54d85333743834d5e131b7600b60b_43.png)

这是第二步，就是数据标准化或者数据处理。

![](img/2cb54d85333743834d5e131b7600b60b_45.png)

数据清洗，那第三步嗯，我忘了讲一个，就是我对数据一定要是一个series格式，DFM传进去会报错，所以把它怎么怎么让一个DFM成为SIRI，最方便的就是取个切片，你列的这个名字取个切片就可以了。

你看打印出来它是不是一个series格式。

![](img/2cb54d85333743834d5e131b7600b60b_47.png)

所以到这第二步做完，第三步就是调库和包模块，调用这个法兰斯的模块，这个模块直接把我们刚才处理好的。

![](img/2cb54d85333743834d5e131b7600b60b_49.png)

这是什么，这factor数据就DF我们应该叫price嗯。

![](img/2cb54d85333743834d5e131b7600b60b_51.png)

应该命名price，就看直观一些，他既然我们之前写的DFDF吧，就是这个收盘价的数据放进去，这什么呀，这分五组我们不是叫什么分位数分组吗，第一第二第三第四第五，分位数为什么要分分位数回归。

分位数是不是要回归分分组呢，就这样我们能看出因子的单调性对吧，这个是时间窗口，三个三个时间窗口，一天五天20天，你也可以作为十天输进去，然后运行跑出来以后就这么一个情况，就是这么一个，这是第一步。

就叫收益率分析，就看它这个因子收益率哎，一天五天20天。

![](img/2cb54d85333743834d5e131b7600b60b_53.png)

然后这是什么，他这是对每一只股票都算了一下啊。

![](img/2cb54d85333743834d5e131b7600b60b_55.png)

然后他这个股票它属于第几个中啊，第几分位数他都会有有一个基本的。

![](img/2cb54d85333743834d5e131b7600b60b_57.png)

我们就可以说是一个统计啊。

![](img/2cb54d85333743834d5e131b7600b60b_59.png)

基本的基本面统计，基本统计分析吧，统计分析好不展开啊，呃可能很多人说哎，你上来就给我一个单独的分析，我想看所有的结果可不可以可以AALCS，然后create for。

然后把factory return就是factory。

![](img/2cb54d85333743834d5e131b7600b60b_61.png)

就因子的那个表，我不认字，表述错了，不好意思，factory return就是这个这个就是你factory return。



![](img/2cb54d85333743834d5e131b7600b60b_63.png)

你现在价进行收益率分析，这个对象这个实例化的这个这个表啊。

![](img/2cb54d85333743834d5e131b7600b60b_65.png)

就这个表传到这个press or thc这个函数里面。

![](img/2cb54d85333743834d5e131b7600b60b_67.png)

![](img/2cb54d85333743834d5e131b7600b60b_68.png)

它就会生成所有因单因子检验所需要的表格，嗯特别多，我们说三点吧，就关于这个单词检验的三三个需要看的指标，好吧，我们如果大家想要去看文档，文档是最全的，因为今天课程时间有限，不想让大家分散注意力。

我讲三点，这三点也是最重要的，就是我们的投资机构啊，不是我们的市场的一些机构，或者主要指的是一些西方啊，那些机构会用的比较多的一些评判的方法吧，首先是不是要看这个IC值对吧。



![](img/2cb54d85333743834d5e131b7600b60b_70.png)

IC分析我们看IC分析在哪找一找啊。

![](img/2cb54d85333743834d5e131b7600b60b_72.png)

哦这个ICIC好。

![](img/2cb54d85333743834d5e131b7600b60b_74.png)

表有点有点大哈，我给他放下来好IC。

![](img/2cb54d85333743834d5e131b7600b60b_76.png)

你看这个IC就说句实话不太好，但是这个因为这个因子我们随便选的嘛，它它就不好，你看他怎么看出它不好呢，他这个上蹿下跳是吧，来一一天，那个时间窗口之内的这个对于未来收益的预测，IC啊，上蹿下跳不稳定。

我们常常说因子包括可以分类成两个，一个风险因子，一个阿尔法因子，其实这种分分类也不严谨，就是比较通俗，风险因子好像是说你承担了它，你说或者你用这个因子挣的钱，你是因为承担风险。

而阿尔法因子好像是他的意思是说我就是挣钱，就是稳定，比方比方巴菲特，他说我这个我有一些因子，假设某个人说我有些因子，我我30年不变样，我年年少的收益，这种因子可能就是更好的因子。

从经济学角度来说是更好的因子，它比较稳定，它是均值来看啊，长期来看它只有稳定的C序列，然后均值高方差小，T统计量大，然后P值比较小就比较显著，然后就就一直是处在大家看一下，就一直处在这个零以上。

这是一类比较好的因子，那如果大家想，如果另一类因子它一直处在零以下行不行，就像就像某个某某个人啊，他预测他这个人总是预测错误，那这种也可以负面的叫负载原子，最怕某些，比方说就怕某些人他一会对一会错。

那你就就像这个因子一样上蹿下跳，是是是最可怕的，OK好，这是第一个，第二个，第二个I就是ID分析的是什么，是收益率分析，那收益率是所有投资人，包括我们这个，所有人啊，不管是机构还是还是散户，都一样。

他是最关心的，就是你这因子能不能带来实际的价值，有没有实战意义，那怎么那怎么来衡量呢，怎么衡量，其实很简单。



![](img/2cb54d85333743834d5e131b7600b60b_78.png)

就是你看这个因子，它它会统计一个阿尔法，阿尔法值和这个贝塔属性。

![](img/2cb54d85333743834d5e131b7600b60b_80.png)

贝塔值就要找阿尔法较高的，好吧我就不在这里找，这图太多了，我就给你讲这个规则，找阿尔法值高的，你好的，因子应该比较高的，阿尔法值，你分别在一天五天，20天，20天，这几个20天的几个调控周期要找。

这是第二个，第三个更重要的就是大家不要忽略换手率，换手率放在这不是没有用，非常有用，就刚才说的turn over，换手率就是我们一开始介绍的公式里面的。



![](img/2cb54d85333743834d5e131b7600b60b_82.png)

这个东西PC就成本就是你的一个好的，你好的IC值可能会就你产生了一丁点的收益，可能会被这个TC给它吸收了，所以所以大家第一个是要是要关注。



![](img/2cb54d85333743834d5e131b7600b60b_84.png)

重视这个turnover的分析，会有这个表格吗。

![](img/2cb54d85333743834d5e131b7600b60b_86.png)

找到turn over的分析，分析完了之后呢，我们要干一件什么事，就类似于我上一节课讲的，马克维茨的组合优化啊，通过权重配比优化来找到更好的，对各个股票的一个权重的配比，权重的比例是吧。

那实际上我们可以类比那个思想，来把因子的这种IC值和因子的什么换手率，做成两个，做成一个目标和一个什么约束，然后我们结合这个结合，他的相当于IC是什么收益率，而换手率呢相当于是风险。

因为换手率它是它成本嘛，交易费很高，相对来说不能太高，把这两集合在一起再做，这作为一个经过叫什么，是换手率调整之后的C值来进行这三选择，这样才是最优的啊，相对更优的优化以后的选择。



![](img/2cb54d85333743834d5e131b7600b60b_88.png)

但是我看好像现在很多看其他人，好像很多人讲这些东西都没讲过，这个这个我觉得是一个遗漏吧，这肯定是需要关注的啊。



![](img/2cb54d85333743834d5e131b7600b60b_90.png)

OK这节课讲的东西挺多的，大家可能需要去消化消化。

![](img/2cb54d85333743834d5e131b7600b60b_92.png)

这个图图也是要一步一步去理解，我就不想全部都想，就是这个图叫QQ图，表示它与正态分布的区别啊，别别靠这条对角线是越好的。



![](img/2cb54d85333743834d5e131b7600b60b_94.png)

好啊，先讲到这吧。

![](img/2cb54d85333743834d5e131b7600b60b_96.png)