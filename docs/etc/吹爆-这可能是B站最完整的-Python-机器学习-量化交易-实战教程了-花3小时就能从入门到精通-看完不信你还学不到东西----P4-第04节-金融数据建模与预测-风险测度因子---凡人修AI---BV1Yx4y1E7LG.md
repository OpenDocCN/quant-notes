# 吹爆！这可能是B站最完整的（Python＋机器学习＋量化交易）实战教程了，花3小时就能从入门到精通，看完不信你还学不到东西！ - P4：第04节-金融数据建模与预测-风险测度因子 - 凡人修AI - BV1Yx4y1E7LG

大家好，今天让我们来上Python，机器学习和量化分析的第四节课，那么今天第四节课主要分为这四块，主要内容，第一块内容，让我们简要的介绍一下我们统计学习的技术嗯，第二块儿我们来介绍一下金融时间序列分析。

当然这个不啊，这个与我们后面开的两节，金融时间序列分析的专题不一样，在这里我们是主要讨论的是交易，交易序列的特性，不需要用更深入的时间序列的模型，却可以达到我们想要的交易的效果。

嗯第三块呢是预测措施和计数的概述，那么第四块呢是我们performance的评估，和一些风险度量，那么关于第一块嗯，其实我们关于统计学习，主要分为以下这几个主要内容，那么第一块是回归分析。

回归分析主要分为预测和分类，那么什么是预测呢，其实主要是跟因子模型相关，比如说我们要做标普500的明天的价格的预测，那么我们认为它跟比如说标普500，今天和明天的序呃，今天跟昨天的序列，包括道琼斯序列。

包括WWTI，包括nature gas，包括goat等等等等的很多的因子，那么我们想找到他们跟s m p five hundred，决明天价格之间的关系，那么我们有历史数据，我们对它进行一个学习。

那么最简单的是线性回归，那么其次呢，如果我们比如说我们有成百上千个因子，那我们想找到主要因子，我们会使用领回归，就是ridge regression，或者是the sole regression。

拉索回归，那么这两个回归主要是在呃最小二乘的target function，后面加一个惩罚项，那么领回归呢加的是平方向，那么拉索回归呢加的是绝对值向，那么他们的想法都是嗯达到一定收敛的情况下。

把很多因子前面的系数给shrink到呃，Exactly zero，这样就帮助我们做一个因子选股的过程，那么还有另外一种降维方式呢，就是PCA跟factor model，那么他们的想法呃。

是与领回归跟拉索回归不同的，因为前面两个回归，主要是通过对每一个系数的绝对值或者是平方，进行乘法，把它加在我们需要最小二乘误差项的边上，那么PCA就是主成分分析跟因子分析。

他们的想法是对原有的feature，就是X，也就是我们这边提到的不同的市场，市场参数进行线性组合，把它们构造成新的一个因子，那么我们有比如说一开始有100个，因此那么我们后面进行线性组合组合成了十个。

那么这十个呢就是我们的新的因子，可以给它们不同的维度进行取名，对他们来，根据我们的标普500的明天的价格，进行历史的regression，那么这个是主要的是预测值的。

就是predict next step value，那么另外一块呢是分类，就是我并不在乎，明天标普500到底能够到多少的值，我们在乎的是明天它到底是上涨了还是下跌了，还是keep flat。

那么这个就涉及到分类问题，那么分类问题比较常用的模型呢，第一个是logistic回归，它虽然叫logistic回归，但它是一个分类器，那么第二个呢是discriminate分析，那么有啊线性的跟二次的。

那么第三个是SVM就支持向量机，那么logistic跟discriminate，他们都是通过一个叫做逻辑function，它们是一个它是一个转换的一个mapping，那么把我们的线性模型转换到一个呃。

指数模型上进行分类嗯，那SBM呢是通过我们找到一个叫做decision，boundary的东西，那么希望我们的这个分类点，尽可能的远离我们的decision boundary。

但是呢又要允许一定的错分嗯，就这样对于日后的这个OVERFITTING，包括我们方差，希望方差减小，那么都是有一定的帮助的，那么这三种主要的分类器，在后面会有详细的介绍，那么这是一块，就是我需要预测。

明天市场到底是上还是下的一个呃分类问题，那么接下来统计一块很重要的是贝叶斯模型，那么贝叶斯模型跟我们前面提到的分类，不同的是，分类我们得到的数据是完全来自于市场的，来自于历史的。

但是贝叶斯呢有有一块是需要加入，我们个人的主观因素，叫做先验先验，就是我人为认为这个参数，它会符合一个怎么样的分布，或者是他大概率取一个什么样的值，那么这个是我自己的主观判断。

所以这个市场值作为一个后期的后验辅助，进入我的模型，与我前面我人为的先验进行某种结合，那么达到一个贝叶斯古迹，那么贝叶斯古迹，我们会在第六堂课的时候具体介绍，接下来一块是时间序列分析。

那么与前面不同的是，时间序列是根据自己本身的滞后项，对某序列的未来值进行一步，两步甚至K步的预测，那么时间序列分为三块，主要内容第一块是这个平稳的时间序列，因为平稳时间序列具有很多嗯。

非常优秀的一些特征，比如说他的比如说他的均值呀，比如说他的呃滞后项的相关系数啊，包括他的方差呀，都是可估的，那么如果不可估呢，那就是一方差模型，甚至是别的类型，比如说要引入一些协变量等等等等。

那么以后也会有详细的介绍呃，那卡尔曼滤波呢，是一种新型的时间序序列的一种预测，那么之前的不管是平稳模型还是一方差，模型也好，预测出来的coefficient，也就是每一个滞后项。

前面的系数都不会随时间变化，那么这个在市场上肯定是不现实的，那么卡尔曼滤波呢，也就是一个动态的std model的过程，它的所有的预测参数，都会随着每日新进来的样本进行，进行一个自动的更新。

那么最后一块内容是嗯，近几年信息的也是用树形模型，tree和神经网renewal network进行分析，那么主要还是运用于分类问题，也就是我们前面回归分析提到的这个预测。

明天的指数到底是上还是平还是下，那么树形跟神经网络呢，由于它们的模型更为复杂，所以它大概属于一种半黑箱的呃，一种learning的模型，它的好处就在于，它能够，它能够适应于更复杂的内内涵的一个机制。

那么它的坏处呢也显而易见，由于他态度的变量和太多的层次，所以很多的参数是很难以调整，甚至说可以是不可控的，我们并不知道，比如说有一些惩罚项，比如说begging，我们到底要取多少才能达到一个最优的条件。

嗯那么第二块呢关于这个时间序列分析，此处的时间序列，我们主要介绍的是一些交易序列的市场特征，比如说平稳啊，比如说呃均值回复呀，比如说它这个配对交易的时候，又应该体现一个什么样的特征。

包括各个特征之间的检验，因为当我们把也想把它套到某种模型之前，我们先要知道它大概是属于一个什么样，模型的区间，比如说它到底是否平稳，它到底是否一反差，这样更有利于我们下一步的建模。

那我们会有一些小程序进行一些辅助支撑，那么第三块和第四块其实是嗯，一起讲的一个内容，主要是讲我们预测之后，我们到底用什么来评价我们的这个预测，或者说我们的模型嗯效果是否好，那么有像hit rate啊。

像这个混沌矩阵confusion matrix，那么判断我们的模型好坏是一方面，有时候呢我们不并不仅仅关注于我们的收益率，可能我们还要还要关注于我们的风险，尤其是在08年金融危机之后。

会有越来越多的risk major出现，那么我们这里先介绍一个最常用的叫做var，当然它有很多不足之处，那么嗯也陆续的开发一些，比如说CVV，比如说as far。

比如说expected tell your loss，那么这三个advanced的一些risk manager，包括一些rainbow measure，我们也会在之后的课进行一个详尽的介绍。

那么这里先介绍最常用最普遍的这个value，At risk，就是V，那现在让我们来结合Python的程序来看一下。



![](img/a612e3528c465cdf4e432319f8fe8f66_1.png)

首先跟之前的课一样，我们先导入我们要常用的一些包，包括这个时间前面介绍过的关于数组的number one派，包括画图，包括我们的数据结构pandas，包括我们这里要用的时间序列的stats model。

包括stats model的这个APISM，那它包括像回归啊等等等等。

![](img/a612e3528c465cdf4e432319f8fe8f66_3.png)

那我们第一个要介绍的序列特性呢，叫做均值回复，那么均值回复是一个非常重要的，定价交易的一个概念，它的意思呢是指在某一段时间内，我们的price或者说我们的return，会显示出一个回归历史平均值的趋势。

那么这样的好处呢是，当这个序列的价格currently很低的时候，我们认为他们终它终将上涨，并且回复到一个平均值，那我们就有必要进入市场，并且利用它的这个特性来得到一个收益，那么相反当这个时候价格很高。

关于我们认为的这个均值回复的bar的时候，那么我们就有理由及时的accent market嗯，这个时候我们应该short11导致啊，已形成获利，所以呢均值回复的这个策略。

构成了统计套利一个很重要的一个组成部分，也是我们比如说build一个很复杂的model，我们最后希望它的残差，它的误差下嗯，达到一个均值回复。



![](img/a612e3528c465cdf4e432319f8fe8f66_5.png)

那么在讨论均值回复之前，我们先讨论一个最简单的最难衣服的一个过程，叫随机游走，随机游走，当然它不不会出现在我们的股票的序列中，因为并不会有一个序列，它满足随机游走，但是它是所有序列的一个理论基础。

随机游走的意思是是一个时间序列，向上或者向下一个定向运动，但是这个时候呢，它的运动完全独立于之前的运动过程，所以它是一个没有记忆性的一个啊游走，所以顾名思义叫random walk。

那它的表达式呢是它的啊，差分项呢等于DWTDWT这个东西在我们后面，包括衍生品定价，包括时间序列中，都是一个非常非常常见的一个表达方式，那么DWT呢是满足一个均值为零物呃。

方差呢为DT的一个高斯过程后叫做正态分布，那么大家要注意DWT它的方差是DT，也就是说它的它的标准差其实是时间的根号，那么这个在我们后面做衍生品定价，包括伊藤过程的时候是一个很重要的一个概念。

因为这个时候呃，正常情况下，我们还记得我们这个本科的时候，学过高等高等数学对吧，那我们关于所有的积分，包括我们的这个求导，包括我们的泰勒展开，我们都说啊，我们当泰勒展开到二次项的时候，比如说是T方。

就是时间的方，那么再往后展开就没有任何意义了，那这个时候如果你关于DWT做一个展开，或者是平方向的话，你会发现它的平方其实是T的，跟T是一个同阶的，那么也就意味着它的平方向，并不是T方的一个高阶无穷小。

也所以它比我们长，我们我们知识上的泰勒展开要低了一个阶，所以当我们想要舍弃二次项的时候，DWT方不能舍弃，当然这个是后话，我们这里先提一下，同学们不要忘记这个点，那么这个是我们上面说的随机游走过程。

那么当然呃跟均值回复不一样的是，随机游走，它并没有一个回复到一个均值的一个趋势，所以均值回复顾名思义，我们的漂移项，也就是DT前面的这个这个地方应该是什么呢，theta其实是一个均值回复的速率。

C塔越高，说明我军我拉回到均值的速度越快，那么mu呢其实也就是我们的一个长期均值，也是我们希望回复到的这个历史水平，那么西格玛呢也就是我均值回复的一个呃，标准差，也就是我会在均值回复的附近。

震荡的这个频率到底有多高额，那这个均值回复的这个过程呢。

![](img/a612e3528c465cdf4e432319f8fe8f66_7.png)

又被称为那个OU过程，是我们经常读书，在wiki vidia3，你可能受君子回复，不让傻，你打一个OU就是onsten alen back过程，那么就是我们很呃我们所谓的均值回复。

那么鉴于均值回复非常好的这个交易特性，我们经常希望我们获得的长沙序列或者是序列，本身就是具有均值回复这样的性质，那么我们应该如何检验它呢，最常见的一个方法是这个啊，也就是单位根检验。



![](img/a612e3528c465cdf4e432319f8fe8f66_9.png)

那么单位根检验呢利用的是一个这样的事实，我们看下面这个表达式，如果这个序列呢具有均值回复，那么我的这个序列的这个差分，它跟我这个序列的一阶滞后的关系，应该是什么呢，这个伽马就应该是，如果这个干嘛。

如果这个伽马是零的话，那么我们把这个WYT拆成YT减去Y呃，T减一，那么移到边上这个项你就会发现嗯，你就会。



![](img/a612e3528c465cdf4e432319f8fe8f66_11.png)

那么让我们看来看一下下面的这个表达式，我们认为呢Y的差分等于阿尔法加上时间项，加上了伽马成阴间滞后，加上后面的一些剩余下，那么这个时候如果干嘛等于零，那我们把DOTAYT拆成YT减去Y减一。

移到等式右边，就会发现这个时候呢YT7是满足一个integral，也就是类似于随机游走的过程，嗯那么如果伽马小于零呢，那也就是说YT是等于一个在啊，比音小的一些呃，一项乘以一个Y的一阶之后。



![](img/a612e3528c465cdf4e432319f8fe8f66_13.png)

那么这个就跟我们前面的这个均值恢复。

![](img/a612e3528c465cdf4e432319f8fe8f66_15.png)

平均回复是一样的表达过程，所以当如果我们希望我们检验结果。

![](img/a612e3528c465cdf4e432319f8fe8f66_17.png)

是一个平均回复，那我们就希望我们接受呢是我们拒绝原假设。

![](img/a612e3528c465cdf4e432319f8fe8f66_19.png)

接受这个alternative hypothesis，那么下面让我们来看一下一个Python的具体例子，那我们要用到的呢是嗯，time series这个ts s tools里面的ADFOER这个函数。

那么我们从宽度上破amazon的嗯，10年内的一个数据，那这个是我们对它的调整的close，价格进行A的负责检验。



![](img/a612e3528c465cdf4e432319f8fe8f66_21.png)

那么这个第一行呢是我们的statistics，就是edit flor的统计量，那么第二个呢就是我们的p value，那我们主要就看P值就够了，这个时候P值呢比0。05来的大，并且大很多。

那么我们就不能拒绝原假设。

![](img/a612e3528c465cdf4e432319f8fe8f66_23.png)

我们就得接受now hypothesis，也就是伽马等于零，也就意味着我们这个amazon的这个close序列，并不满足均值回复，当然这个跟我们的市场的啊intuition。



![](img/a612e3528c465cdf4e432319f8fe8f66_25.png)

我们的直观想嗯想象是一样的。

![](img/a612e3528c465cdf4e432319f8fe8f66_27.png)

几乎呢所有的金融序列都不会满足均值回复，基本上是几何布朗运动，甚至比几何布朗运动更aggressive的一些过程。



![](img/a612e3528c465cdf4e432319f8fe8f66_29.png)

但是我们在这里讨论这个均值回复有什么用呢，我们说过了，不管是我们的配对交易，还是我们后面基于自身自回归的，时间序列的交易，我们都希望我们的长差是均值回复的。



![](img/a612e3528c465cdf4e432319f8fe8f66_31.png)

我们利用长差来进行一个这个回复套利。

![](img/a612e3528c465cdf4e432319f8fe8f66_33.png)

那么我们第二个要介绍的是一个嗯，很重要的概念是平稳性，那么平稳性的概念呢有以下这三条，第一条是它的均值是一个常数，那么方差呢也是一个常数，第三点就是它跟它的滞后项本身的这个COVERANCE协。

方差呢与初始的时间点无关，只跟它们之间的这个gap差量是有关的，那么这样的一个平稳性序列有，我们知道这些有什么好处呢，首先当我们对一个序列进行建模的时候，我们不可能把它一整段的历史序列都拿出来。

一定是基于某一段，并且对未来我们感兴趣的一段进行预测，那么这个时候如果我们的预测序列不平稳，会有什么样的结果呢，比如说我们是我们预测预测了标普500，我们认为啊他的这个均值可能差不多。

比如说他的return可能是在5%左右，那么如果你这个return序列本身不是平稳的，那么你预测出来的这个5%的均值，就没有任何意义了，因为它的均值本身就不满足等于constant。

就等于常数的这样一个假设，对于方差和协方差也是一样的，因为方差呢会影响到我们的，包括我们后面会提到的sh普利率，包括嗯我们的腕，如果它的方差不是一个均值的，那么我们预测出来的这些风险。

我们的风险评估的这一些measure都失去了意义，所以我们希望我们的过程是，或者是我们调整过的过程具有平稳性，那么嗯就因为它具有平稳性，那么我们后面识别出来的序列的性质呀，我们我们序列做出来的任何回归。

才具有一个长期的意义。

![](img/a612e3528c465cdf4e432319f8fe8f66_35.png)

那么接下来我们将要引入一个比呃单位检验根，更为普遍常用的一个统计量，叫做hearst exponent，那么这个可以帮助我们来检验血的平稳性，并且检验它是属于哪一种类型的序列。



![](img/a612e3528c465cdf4e432319f8fe8f66_37.png)

那么他的想法呢是提供了一个标量，是对于对于价格对数的方差额进行一个评估，我们认为它这个价格对数的方差，跟这个中间这个时间差，就是difference之间的关系呢，是2H次方成正比的。

那么这个时候H如果小于0。5，那我们这个序列呢就是均值回复，如果等于0。5呢，就是一个几何布朗运动，也就是我们现在指望上我们的每一个price。



![](img/a612e3528c465cdf4e432319f8fe8f66_39.png)

差不多都该满足的一个序列，那么大于0。5呢就具有趋势，就是比几何布朗运动更为aggressive的一种呃，一种时间序列。



![](img/a612e3528c465cdf4e432319f8fe8f66_41.png)

那呃这个统计量呢，有助于我们判断我们的序列。

![](img/a612e3528c465cdf4e432319f8fe8f66_43.png)

到底是呈现哪一种的特性，那么呃它的它的嗯具体的想法呢。

![](img/a612e3528c465cdf4e432319f8fe8f66_45.png)

就是对我们的对数价格方差，和我们的这个时间差进行一个回归，那么回归之后乘以两倍，看一下我们这个H统计量的啊大小。



![](img/a612e3528c465cdf4e432319f8fe8f66_47.png)

那么我们这里呢构造了一个几何布朗运动，构造了一个均值回复，那还构造了一个呃trend。

![](img/a612e3528c465cdf4e432319f8fe8f66_49.png)

就是有趋势的这样的一个时间训练。

![](img/a612e3528c465cdf4e432319f8fe8f66_51.png)

并对它们三者进行检验，那我们可以很清楚地看到，集合布朗运动呢几乎是0。5，那么均值回复呢是几乎是零，那么趋势的呢带趋势的呢就比0。5大，那么一呢就是一个啊random walk随机游走。



![](img/a612e3528c465cdf4e432319f8fe8f66_53.png)

那我们这个时候来看一看我们市场上的数据，比如说AARON的这个调整的价格，那么这个时候可以看到呢，他的荷尔系数呢是几乎接近于0。5，也就是满足我们对它的一个市场假设，就几乎是满足几何布朗运动的。

那么它会比几何布朗运动来的更保守一些。

![](img/a612e3528c465cdf4e432319f8fe8f66_55.png)

因为它比0。5来的小，那么接下来再讨论一个很重要的，关于配对交易的一个概念，那么嗯通过上面的例子，大家也看到，我们实际上是很难找到一个，具有均值回复行为的可交易资产，因为呢在广义上。

股票几乎都跟几何布朗运动这样的过程相似，那么有时候呢会比他来的更severe，那有时候呢来的更弱一些，那么主要控制它跟几何布朗运动的关系，就是它的误差项嗯，就是几何布朗运动的啊，DWT也就是随机项的。

前面是西格玛和当前的股价，那么如果比几何布朗运动来的week，可能是开根号，那么比它strong呢，可能也就是在比一次方来的高嗯。



![](img/a612e3528c465cdf4e432319f8fe8f66_57.png)

当然一般不会到平方嗯，所以呢平均回复的这个交易策略，在对于我们单只股票的建模上来说呢，几乎是失效的，但是我们说过，这个均值回复具有非常好的交易特性，所以我们依旧希望可以，创建一个价格的一个组合。

那么呢它的长差如果能够达到均值回复，那我们可以通过构建这样的一个动态组合，就多个资产的组合来达到这个均值回复交易，所以呢它最经典的简单方案就是双交易，那么如果你是做多资产。

做一个package也是可以的，但是我们不希望无缘无故的增加，我们的组合的复杂度，因为我们需要take care更多的参变量，所以我们就做双交易，那么双交易呢要选谁呢，理论上呢就是比如说两一家。

两家业务相同的公司，比如说苹果跟这个微软，比如说呢google跟FACEBOOK，或者是比如说gold，就是黄金的现货跟黄金期货，或者是不同的同一种BD的不同的tender啊。



![](img/a612e3528c465cdf4e432319f8fe8f66_59.png)

都可以嗯，所以呢他们的行为呢是可能会面临呃，类似的市场因素，那么呢有时候它们相对的股价会通，会因为某一件事件或者是一些时间差，而导致轻微的分歧，那么渐渐的呢又会恢复到原来的状态。

那么这个就满足我们对均值回复的一个假想的，一个这个市场前提，所以我们认为当我们做适当的回归。

![](img/a612e3528c465cdf4e432319f8fe8f66_61.png)

那么它们的长差大概率是一个均值回复的，那么可以用这个max跟will。

![](img/a612e3528c465cdf4e432319f8fe8f66_63.png)

也就是同样是两家这个做原油的，或者也是可以用google跟MICROSOFT，或者是google跟FACEBOOK都可以。



![](img/a612e3528c465cdf4e432319f8fe8f66_65.png)

那么他的想法呢主要是一个简单的线性回归，那么长差呢，我们要检验它是否满足平稳的均值回复，或者是hers的指数，但是他们的问题是他们的结果会告诉你，他是否满足均值回复，OK但是呢他不会告诉我们。



![](img/a612e3528c465cdf4e432319f8fe8f66_67.png)

我们需要的这个对冲比例，因为我们在做嗯这个pair trading的时候。

![](img/a612e3528c465cdf4e432319f8fe8f66_69.png)

最重要的就是求求出这个对冲比率贝塔。

![](img/a612e3528c465cdf4e432319f8fe8f66_71.png)

所以这个时候要引入一个叫做增强的DK follow，设置，就是CADFCADF呢。

![](img/a612e3528c465cdf4e432319f8fe8f66_73.png)

嗯它会自动的对两个时间序列进行回归，并且确确定这个最优的这个贝塔，也就是最优的这个线性回归正交投影，并且呢在这个线性组合下，自动的对我们的这个长差，IMMESNOONT做一个平稳性的测试。

当然我们需要呃强调的一点是，这个是由于市场是动态的，还有很多的一些外力因素存在，所以我们的这个均值回复的这个伊普斯隆，替这个呃得到这个长差的时候啊，这个贝塔其实是会随随时间变化的。

所以我们做的这个均值回复的这个呃资产组合，我们要做一个rolling window，比如说一个月做一次rolling嗯，来提及时调整我们的这个对冲比率。



![](img/a612e3528c465cdf4e432319f8fe8f66_75.png)

要不然会有一个很大的gap的损失。

![](img/a612e3528c465cdf4e432319f8fe8f66_77.png)

那么让我们来看一下我们的这个例子，那其实很简单。

![](img/a612e3528c465cdf4e432319f8fe8f66_79.png)

首先呢我们先定义一下如何画价格序列，如何呢画序列长差的散点图嗯。

![](img/a612e3528c465cdf4e432319f8fe8f66_81.png)

包括如何画，就直接把长差本身plot出来。

![](img/a612e3528c465cdf4e432319f8fe8f66_83.png)

就是时间序列不画散点一个连续过程。

![](img/a612e3528c465cdf4e432319f8fe8f66_85.png)

那么这些画图的方法我们在第二节课，第三节课的时候已经交代过了。

![](img/a612e3528c465cdf4e432319f8fe8f66_87.png)

那么大家回去可以简要的复习一下，那么这个main函数呢，就是主要调我们啊，从这个框do上破两组时间序列，然后调我们上面提到的这几个画图的函数嗯。



![](img/a612e3528c465cdf4e432319f8fe8f66_89.png)

那么用增强的DK fl检验。

![](img/a612e3528c465cdf4e432319f8fe8f66_91.png)

并且呢根据我们这个hedge的这个贝塔嗯，来求得我们的长差，那么我们得到这个贝塔的方法呢，是用我们一整片序列的线性回归。



![](img/a612e3528c465cdf4e432319f8fe8f66_93.png)

当然我们前面说到，我们最好要缩短我们这个time window，比如说这个一个月做一次，然后进行一个这个动态的这个moving。



![](img/a612e3528c465cdf4e432319f8fe8f66_95.png)

过程是最好的，那么这个是我们长沙的plot，那我们对产差呢，要做一个我们之前提到的这个均值回复，包括平稳性的检验，那么这个是我们检验的这个报表啊，发现我们这个PP值是0。08，那比0。05来的大。

但是比0。1来的小，也就是说我有这个92%的信心，我的这个我的这个长差呢是具有均值回复的，也就是我们大概率是可以接受。



![](img/a612e3528c465cdf4e432319f8fe8f66_97.png)

我们的这个配对交易是符合我们的市场猜想的。

![](img/a612e3528c465cdf4e432319f8fe8f66_99.png)

那接下来我们要再简要的介绍一下第三块，第四块内容也就是基本的一些预测手法，包括我们如何manor我们的，我们的预测就是是优于市场的嗯。



![](img/a612e3528c465cdf4e432319f8fe8f66_101.png)

包括我们的这个策略的风险大概有多少。

![](img/a612e3528c465cdf4e432319f8fe8f66_103.png)

那接下来让我们介绍一下基本的预测的手法。

![](img/a612e3528c465cdf4e432319f8fe8f66_105.png)

那么我们有我们的算法呢，是来帮助我们预测金融时间序列的市场走向的，那么在Python中呢有一个已经开发好的报价，SK啊，Sk learn，那么呢这个包是统计学习，机器学习的Python的库。

那么它有很多我们常用的现成技术，比如说logistic啊，discriminate analysis啊，然后包括这个SVM支持向量机，包括决策树，包括random forest。

包括各种boosting的树，那么像基本的神经元，它也有包括，但是如果像啊卷积神经系统，包括advanced的嗯，revolution neural network的话，那么用KERAS会比较好一些。

那么后面也会有深入的介绍，那么他的这个sk learn的包呢是使用，其实base是C加加写的，那么它与R呢跟C加加，包括java呢也有很好的嗯connection的interface。

那我们先介绍基本的预测，预测方法的评估，然后介绍一下一些机器学习常用的一些函数，那么我们用标普500的价格走向，进行一个简单的小应用，那么首先呢先介绍一个hit read。

he read是最常见的一个错判率，包括正确率的一个啊统计量，那么顾名思义，它就是把我们的预测值跟真实值相等的，这些相加起来，并且呢对这个样本量做一个平均，那么越接近于一。

说明我们的啊training的效果呢就越好。

![](img/a612e3528c465cdf4e432319f8fe8f66_107.png)

那么第二个呢是混沌矩阵，混沌矩阵是一个2×2的矩阵，那么它的对角圆UT跟DT分别代表了，就U假设是一，那么D是零的话，那也就是嗯真实情况是一，那么我们的预测也是一，也就是关于一的正确和这个真实情况是零。

我们预计也是零的一个正确，那么UF跟DF呢就是零一错错开了，也就是错判，那么两个错盘的量，那么我们当然希望这个主对角圆越大越好，那么嗯另外的这个UF跟DF的话。



![](img/a612e3528c465cdf4e432319f8fe8f66_109.png)

当然是越接近于零是越好的，那么再提一句，这个UF呢也就是我们的称为的第一类错误，在我们做假设检验的时候，其实也有接触过这个名词，那么第一类错误是什么呢，就是说嗯真实情况呢是是真的。

就比如说这个关于这个信用卡，default的一个啊判别，那么他这个人本身呢其实不会default，但是我们把它预测为default了，那么这个称为第一类错误，那么第一类错误。

其实第一类错误我们在做假设检验的时候，是希望把第一类错误控制在某个值以下，Mini messa，但是呢如果他很大会有什么问题呢，其实也不是非常的重要，也就是说我们要尽量控制第一类错误嗯。

当把第一类错误控制到某个值一下就好了，因为这个UF跟DF两者之间是不可以兼得的，如果如果UF低了，那么DF一定会变高，那么相比较的话，UF不会那么的可怕，因为我们宁可错杀一个，也不能放过1万。

我们宁愿把这个客户从不default，predict到default，我们也不希望它本身是一个信用很差的，会default，但是我们预测嗯。



![](img/a612e3528c465cdf4e432319f8fe8f66_111.png)

他是一个信用很好的人来的损失来得高，那么这个是这个混沌矩阵的定义。

![](img/a612e3528c465cdf4e432319f8fe8f66_113.png)

那么接下来我们简简单介绍一下，这几个分类器嗯，后相关的知识，我们理论知识，我们后面的机器学习的章节会有深入的了解。



![](img/a612e3528c465cdf4e432319f8fe8f66_115.png)

那么第一个是logistic回归，有建设回归的最重要的中心思想是，我们假设了这个后验分布，也就是当X取某个固定的值的时候，我这个Y这个分类分为一类，它满足一个这个指数的一个这个logistic函数。

那么这是我们的单个的条件概率分布，我们利用最大自然古迹这个最大化的联合条件，概率分布，也就是把所有的观测值的这个P乘连乘起来，然后取个log，并且把这个log函数最大化，来解除我们的分布参数。



![](img/a612e3528c465cdf4e432319f8fe8f66_117.png)

这个是logistic regression，那么另呃discriminate analysis呢，跟上述不同的是上述的，这个是我们的一个模型假设，那么discriminate呢。

是我们通过贝叶斯定理得到的，首先我们先假设啊，这个分布呢是一个叫做嗯变量，就L1L2，其实就是上面这个X变量呢关于每一个类别，它都有一个特定的分布，那么还要乘以一个每一个类别的概率。

那么这两个P呢都是我们事先对它的分布，预定好的，我们基本上是预定前面的这个分布，为一个高多元的高斯分布，那么根据贝叶斯定理，我们是对后面的这个乘积，就是呃联合的一个叫join distribution。



![](img/a612e3528c465cdf4e432319f8fe8f66_119.png)

做一个MLE就是最大自然古迹，那么求嗯求出参数之后呢，当我们得到一个新的新的L1L2，把它plug in到后面这个式子中，嗯当这个P值达到最高的时候，也就是我们预测的这个Y，应该属于某哪一个类型。

那么LLDA的一个重要的数学假设呢，是嗯这个P的这个分布，我们提过是一个多元高斯，那么呢它每对于每一个UG，就是不同的Y的类别，它有相同的斜方差正，那么在做就在做中间这个理论推导的时候，由于这个假设。

那么嗯X方的这个二次项是会被消除的，那么如果没有此假设，也就是拥有更普遍的协方差阵的话，那么呢X2次项就不会被消除，所以是QDA也就是quadratic就是二次的意思，那么关于这个差别分析。



![](img/a612e3528c465cdf4e432319f8fe8f66_121.png)

我们在后面也会深入的介绍，那么下一类是支持向量机，支持向量机，首先首先的问题是基于一个线性二分类，就是我们对于两个类别的点，我们想要找到一个最佳的分类的boundary，那么这个帮助有什么特点呢。

就是最大化margin，就是使所有的点尽量的远离这个分类平面，当然这种理想化是几乎是不存在的，那么有时候呢是本身就是无法可分的。



![](img/a612e3528c465cdf4e432319f8fe8f66_123.png)

那么我们采取支持向量机，采取的一个方法叫做软边缘分类器，就是soft margin，那他的idea是对于我们的这一条decision boundary，两边各取两个等距平行的一个EPSENT管。

那么在这个EPSENT管中，我们有很多我们的错分的，包括是离边缘非常近的这些点，那么这些点就构成了一个知识向量，由这些点提供的information，我们来找到这条decision boundary。

这是一个主要的最简单的这样的一个idea，那么这个做完二分类之后呢，嗯还有一些问题是多分类，还有线性不可分问题，那么就需要扩展到SVM的呃，Kernel function，那么内核呢有这个多项式内核。

那么就是比如多项式是N，那么就可以扩展到N维，那么还有高斯内核，其实高斯是一个无穷维的，那么还有SIGMOID就是tan函数的和，那么呢嗯通过这个不同内核的选取。

我们可以达到很多非线性的decision boundary，那么就对我们的模型引入更大的灵活性，那么还有一块很大的类呢是决策树和随机数，决策树呢是一种树形分类，是一个最为直观并且最好做嗯。

实际解释的一种分类器，他的想法呢是一开始大家都属于同一个类别，比如呃然后每一层每一层数呢找到一个feature，找到一个特性，根据这个特性把它们的点分为两类，一直这样二分类，二分类拆分下去。

直到我们满足了某个条件，或者是它已经不可分为止，那么这是决策树的一个想法，那么每一层的feature如何找呢，是通过这个最大熵值理论，那嗯决策树的不足之处呢。

是每一层找这个feature的时候都过于的贪婪，过于的greedy了，那么当这些树的feature，本身的相关性非常高的时候，其实很难做决断，哪一层用哪一个feature来分类是比较好的。

那么就引入了一种begging的想法，就是呢我构造非常非常多的，基于同一组data的这个分类数，那么每一层呢是从我的这个feature中，随机的选出一个啊，sub class就是一个一个它的小子集。

那么再从小子集中利用这个最大熵值理论，选出我的feature，所以每次的这个不同的数啊，它每一层的feature最优feature都不一样，那么把这么多的数呢都aggregate起来，取一个平均值啊。



![](img/a612e3528c465cdf4e432319f8fe8f66_125.png)

就是我这个分类器的结果，那么它主要呢，其实是应用于一些噪音比较多的data，并且它的feature之间的相关性很高，那么通过这个呢可以拆分，就是feature之间的相关性。



![](img/a612e3528c465cdf4e432319f8fe8f66_127.png)

来导致这个减少误差的这样的一个结果，那还有更多的高级的方法，比如说像boosting呃，也是基于术的一种，还有这个神经网络系统，还NOP，也就是自然语言学习，就一个非常最近很火热的一个话题。



![](img/a612e3528c465cdf4e432319f8fe8f66_129.png)

那么我们的课程是不会涉及到NLP的，那NLP的一个很有意思的例子呢，其实是这样的，就是我们大概在几年前也做过一个应用，简单的介绍一下，就是比如说这个大家知道这个马伊俐跟文章的。

这个这个当时的这个出轨事件呃，发生之后呢，过了几天之后，这个伊利牛奶的股票就暴涨了呃，虽然听起来非常的奇怪，但是这个是有人做过一个learning，他们存在一个呃潜在的相关性。

也就是马伊利与伊利牛奶之间的关系，那么怎么learning呢，嗯国外呢就是twitter或者是FACEBOOK，那么国内呢就是微博了，或者是一些微信的公众号，那么首先我们先learning这个文章。

出轨马伊俐出轨这样的一个新闻呃，和大家的朋友圈，那么通过大家发的每一条状态呢，我们来读出这条状态，关于这个新闻的评价，到底是negative还是positive的，那么我们learning到之后呢。

把它转化为一种类型的feature，那么它的回归呢就是这个伊利股票的价格了，到底是up或者是down，那么通过通过这个互联网，大家发的这个朋友圈，包括大家发的所有的这个在各大媒体上的comment。

进行这种啊心情之间的learning，然后我们来判断大家对于马伊俐其实是同情的，那么同情之后呢，会导致伊利股票的暴涨，就是说这个NLP啊本身可能是很无厘头的。

你很难distinguish这两个东西之间居然有关系，但是它是一个O就是total里，由数据说话的一种东西，可能它存在着the chin或者是一些伪相关。



![](img/a612e3528c465cdf4e432319f8fe8f66_131.png)

但是somehow他就能很好的predict嗯。

![](img/a612e3528c465cdf4e432319f8fe8f66_133.png)

那么我们回归正题，接下来我们来解释一下，上述我们提到的这些基本的machine learning的方法，对于s m p five hundred。

就是第二天tomorrow的走势大概是up and down的预测。

![](img/a612e3528c465cdf4e432319f8fe8f66_135.png)

那么我们的ACTIVARIABLE呢，是利用它标普500本身自己的滞后项，那我们先define一个函数是create lack series。



![](img/a612e3528c465cdf4e432319f8fe8f66_137.png)

那么就是我们从这个宽度下获取SMP的数据。

![](img/a612e3528c465cdf4e432319f8fe8f66_139.png)

并且呢，嗯把他的字字后项排成这个column的形式。

![](img/a612e3528c465cdf4e432319f8fe8f66_141.png)

嗯主要是完成一个这样的任务。

![](img/a612e3528c465cdf4e432319f8fe8f66_143.png)

那么接下来呢我们要调用我们的。

![](img/a612e3528c465cdf4e432319f8fe8f66_145.png)

我们我们上面提到的这个reno forest啊，logistic regression啊，然后LDAQDA包括我们的这个SVM。



![](img/a612e3528c465cdf4e432319f8fe8f66_147.png)

SAM可以用线性的，也可以用上面提到的非线性。

![](img/a612e3528c465cdf4e432319f8fe8f66_149.png)

比如说高斯核，比如说啊ten整合，那么我们要调用的function呢。

![](img/a612e3528c465cdf4e432319f8fe8f66_151.png)

都放在放在这个models里面。

![](img/a612e3528c465cdf4e432319f8fe8f66_153.png)

那么关于这个SBC也就是非线性的，我们需要做一些参数的设置。

![](img/a612e3528c465cdf4e432319f8fe8f66_155.png)

包括random forest，那么接下来把这个hit rate跟那个confusion matric，就是混沌矩阵打印出来，那我们可以看到不同的模型的performance的好坏。

那么在这里呢表现最好的是这个二次的，Discriminate analysis。

![](img/a612e3528c465cdf4e432319f8fe8f66_157.png)

和这个呃带着高斯核的这个支持向量机。

![](img/a612e3528c465cdf4e432319f8fe8f66_159.png)

那么下面我们先简单的看一下这个每一个呃，函数是怎么调用的，包括一些参数怎么设置，像logistic regression里面的penalty呢，嗯如果是主要一般是舍the词penalty。

如果没有一些特殊的原因的话，deal的话是做最优化的时候，是否要用这个对偶函数，那么TORREN呢就是做最优化，我们我们的B就是，当这个误差小于0。001的时候，我们就结束我们的迭代。

那么C呢是是否要用shrinkage，像logistic regression也可以使用像了，so跟vage regression，就是对于每一个参变量，我们我们希望它的coefficient不要太大。

因为太大，它的variance会比较高，那么把它们的和加起来，前面带一个乘法项，那么我我认为乘法项是1。0，或者也可以写二，或者也可以写0。01，那是否要fit这个洁具项，包括SKILLING啊。

Weight，后面这些就后面这些设置就不是太常用了。

![](img/a612e3528c465cdf4e432319f8fe8f66_161.png)

然后discriminate analysis的话。

![](img/a612e3528c465cdf4e432319f8fe8f66_163.png)

linear跟呃跟那个嗯CONTROLT是一样的。

![](img/a612e3528c465cdf4e432319f8fe8f66_165.png)

就是关于这个sofa的设置，那SYKAGE呢跟上面的这个C其实是一样的，就是是否要做一个就是对于参数的这个。



![](img/a612e3528c465cdf4e432319f8fe8f66_167.png)

shrinkage to zero的这样的一个设置，那一般你选NN就好了，那sofa呢有下面这几个，还有一个是aggon value的分解，还有一个是用那个LISQUARE。

那么default的话一般就是用single value求解。

![](img/a612e3528c465cdf4e432319f8fe8f66_169.png)

那关于分类的话，SVC是嗯知识量量机关于分类的函数，那SBR呢是支持向量机关于回归的一个函数，那么支持向量机的C的penalty呢，就是我的这个em sno管，就我上面说过的错分类。

错分类到底能够容忍多少错分类，那么C越高呢，就是能够容忍的就越多，嗯然后还有是这个kernel，就是像这个线性的就不用选kernel了，那如果不是线性的话，kernel的RFB也就是高斯。

那么还有sigma，也就是T，那么伽马呢是就是这个呃正态分布，不是有一个西格玛方嘛，除以西格玛方，那么这个伽马呢就是西格玛方的导数，那么越大的话呢。



![](img/a612e3528c465cdf4e432319f8fe8f66_171.png)

这个高斯和本身就在高维中，它就越胖，可以这么理解。

![](img/a612e3528c465cdf4e432319f8fe8f66_173.png)

那这个就是主要的设置的一些参数，那别的设置成default就好了。

![](img/a612e3528c465cdf4e432319f8fe8f66_175.png)

![](img/a612e3528c465cdf4e432319f8fe8f66_176.png)

我们接下来介绍一下performance和risk的评估，那么一开始的时候，可能大家会认为嗯，如果我一只策略那么的年化收益率，比如说10%甚至20%，那么就说明我的这条策略非常的好。

那么确实在08年之前，我们来分析我们的一条策略的表现是否优秀，基本是通过年化收益率来进行判别的，那么它有一个很大的不足呢，就是没有考虑到波动率的风险，因为其实是在06~08之间的时候。

其实那个时候虽然嗯其实不仅仅是equity，就是关于MMBS，abs这些mortgage basecurity，他们的生育率都很高，但是同样的他们的volatility，也就是他们的风险很高。

所以我们在考虑我们一个一支策略的呃，表现如何的时候，我们不仅仅是要看收益率，我们还要考虑到它的波动率风险，所以有一个指标叫sharp ratio，那么shop ratio呢。

就很好的将收益率与波动率风险进行结合，来进行判断，那么sharp ratio主要的思想呢是嗯，当我们投资者选择某种投资组合，那么呢即那些就是在给定的风险水平下，使期望回到回报最大化的这样的一个组合呢。

如果它越高，那么就说明我这个投资组合越少。

![](img/a612e3528c465cdf4e432319f8fe8f66_178.png)

它的表达式呢是这个A就是我这个资产组合，那B呢是benchmark，就是标的资产，那有时候可以用RF就是无风险收益率，那么这两个差值的期望呢，除以我这个资产的volatility，也就是波动率。

那么字面上解释呢就是投资人多承担一分风险，可以多拿到呢几分报酬，但这个回正直的时候，就说明我的额回报的收收，收收益率高于波动风险，那如果是负的呢，这就反之，那么在我们经验上来看。

一个比较好的策略的SUPERRATIO，一般要在意义上，如果你的刷PARATION能达到三。

![](img/a612e3528c465cdf4e432319f8fe8f66_180.png)

那么就是一个相当好的一个投资策略。

![](img/a612e3528c465cdf4e432319f8fe8f66_182.png)

那额其实SHERRATIO的表达式给出来了，那么计算SHRATIO嗯的这个程序非常的好写，就是scan here n n的话呢，这个其实是一个年画。



![](img/a612e3528c465cdf4e432319f8fe8f66_184.png)

就是我们要把它给通过年来scale，这样的话，不同的时间长度的投资组合。

![](img/a612e3528c465cdf4e432319f8fe8f66_186.png)

之间才可以进行比较，那么把我们这两个写好之后呢。

![](img/a612e3528c465cdf4e432319f8fe8f66_188.png)

之后我们都会调用我们这两个super ratio的函数，那么我们可以简单的就是，假设我们就是购买这个apple，那么就是从11年一直买到13年，我们不做任何的action。

那么这个SHERRATIO有多高呢，我们就扣这个echo d点sharp。

![](img/a612e3528c465cdf4e432319f8fe8f66_190.png)

它的年化杀PARRATIO呢是0。8，其实还可以是正的，那么其实有的时候separation你扣出来，如果什么事情都不干，就直接把它买了搁，那像我记得apple如果是嗯，应该是取10年到12年的话。



![](img/a612e3528c465cdf4e432319f8fe8f66_192.png)

那么shap ratio应该就是负的了。

![](img/a612e3528c465cdf4e432319f8fe8f66_194.png)

那还有一种分析呢是这个回撤分析，就是draw down跟maximum，draw down和draw down duration也是我们很常用的几个呃，这个risk measure，那么回撤呢。

其实是当一种这个投资价格下降的时候啊，它的最高点跟最低点之间的距离称为回撤，那么呢这是一个纵向距离，那么横向距离就是时间跨度，那么时间跨度呢就是我的dradown duration。



![](img/a612e3528c465cdf4e432319f8fe8f66_196.png)

这是duration的一个定义，那还有一个呢，要银行特别常用的是这个风险债值，叫做value at risk，那么value at risk它的官方定义呢，其实是在某个给定的概率水平。

也就是我们的执行度下，就某一个资产，那么在未的未来的特定时间内，最大的可能损失，比如说这个置信度是95%，那么variant risk比如说是5万块钱，那意思就是说我有95%的信心。

我在这个未来的一年内，我的最大损失是不会超过5万块钱的。

![](img/a612e3528c465cdf4e432319f8fe8f66_198.png)

那么根据这样的一个定义呢，具有这个word不同的算法。

![](img/a612e3528c465cdf4e432319f8fe8f66_200.png)

那么第一种是variance covariance，也叫做model fitting。

![](img/a612e3528c465cdf4e432319f8fe8f66_202.png)

也就是假设我的这个收益率是服从正态分布的。

![](img/a612e3528c465cdf4e432319f8fe8f66_204.png)

那么通过上述的这个VARIRISK定义的表达式呢，通过这个置信区间跟输入量。

![](img/a612e3528c465cdf4e432319f8fe8f66_206.png)

是可以计算出95%的。

![](img/a612e3528c465cdf4e432319f8fe8f66_208.png)

这个置信的这个var其实就是均值，加上这个你自信的这个框套量，就是如果是95%，就是1。96，那乘以呢这个呃standard deviation，也就是volatility。



![](img/a612e3528c465cdf4e432319f8fe8f66_210.png)

所以为什么我们前面其实有提过，就是这个均值回复，包括这个stationary平稳性的过程很重要，当这个mu跟西格玛如果会变的话。



![](img/a612e3528c465cdf4e432319f8fe8f66_212.png)

你这个values risk，你这个估计出来本身就其实是失去意义的，因为你不知道你之前算的这个mu跟这个西格玛。



![](img/a612e3528c465cdf4e432319f8fe8f66_214.png)

在当前的时候还是否可用，那么接下来是这个VARIRISK的这个，这种方法的调用函数就很简单，调用这个正态PPPF就是求你的就好了。



![](img/a612e3528c465cdf4e432319f8fe8f66_216.png)

那么我们可以看一下，我们就是框斗上，如果调这个city group或者调M早期也可以嗯，你可以算它在10年到14年。



![](img/a612e3528c465cdf4e432319f8fe8f66_218.png)

他这个年化的白RI的risk有多高。

![](img/a612e3528c465cdf4e432319f8fe8f66_220.png)

那么是啊5万7嗯，那它还有一种方法呢，是其实银行系统现在用的这种基本方法，不是太常用了。

![](img/a612e3528c465cdf4e432319f8fe8f66_222.png)

因为我们会发现大部分的return其实不是正态。

![](img/a612e3528c465cdf4e432319f8fe8f66_224.png)

并且它是比正态纬度要来得厚的，那么你估计出来，用正态模型假设下的YY的risk。

![](img/a612e3528c465cdf4e432319f8fe8f66_226.png)

其实是估计过于保守了，是我们不希望看到的，就我的loss其实是有可能比这个还要来得高的，那么有一种方法叫这个历史模拟法。



![](img/a612e3528c465cdf4e432319f8fe8f66_228.png)

那么历史模拟法的想法呢其实非常的简单，就是比如说在未来的两年内啊，就是500种变化情况，就假设一年是250个trading day的话，那么就有就能构造出500种的scenario。

那每一个scenario呢，其实就是其今天的这个value除以昨天的value，你就排成这个500个scenario，那么呃假设呢这个第N天的市场只是VN，那么第这个DN天在第I种情形下的市场变量。

在明天的值呢，就是VN乘以这个VI除以VI减一，那么你把这个市场的这个vi除以vi减一，不是500种吗，啊你随机排列排列好之后呢，每一天的这个VN都迭代的去乘，你排列好的这些SCARARIO。

嗯乘好之后呢，你再plot一个distribution，然后截低5%的位置。

![](img/a612e3528c465cdf4e432319f8fe8f66_230.png)

就是你95%的value at risk的值，那么这个呢是一个啊中后上的例子的一个，具体操作啊，上面的这个呢就是历史的SCARL，总共500种，有道琼斯啊，100啦日经啊等等。

那么嗯这些情形呢就是通过上面的抽样得到的，就是假设从今天是这个9月25号，那么道琼斯呢是这个1万多点，那么在呃第一条情形，就是8月7号到8月8号呢，其实1117÷11111219。

那么你用今天的值乘以这第一个CNL的比率，就得到他，第二天你用value re算出来，这个道琼斯平均指数在第二天进行下，应该是多少只，那么嗯第三天的值呢，就是第二天去乘以第二个情形的这个比值。

那么so far，So forth，迭代，迭代后呢，你把这些情形的这个亏损嗯进行排列，排列之后呢，就可以画出像右图这样的一个亏损的直方图，那么你获得最最就如果是500种吧，如果是九十九十九%的八的话呢。

那就是第五个最坏的结果哎，那你通过查这个风度图，发现第五个坏的结果的值呢是2万，是25万，20万3，那这个呢就是我这两年的这个value at risk，在第99%的执行区间下的值。

那么我们这一节课的作业呢，是我们前面提到的这个VARI的risk，我们并没有用啊Python进行实现，那么我们要求呢用历史模拟法实现VA计算嗯，那么我们用的呢就是用上面的例子。

是这个va variance and converance一样的，based on这个city group这个价格啊，来用历史模拟法算法，并与呢variance和variance方法进行比较。



![](img/a612e3528c465cdf4e432319f8fe8f66_232.png)