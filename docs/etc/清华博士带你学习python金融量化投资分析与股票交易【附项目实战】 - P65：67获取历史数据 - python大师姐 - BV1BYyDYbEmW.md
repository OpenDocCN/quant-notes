# 清华博士带你学习python金融量化投资分析与股票交易【附项目实战】 - P65：67获取历史数据 - python大师姐 - BV1BYyDYbEmW

OK啊OK好，同学们，那我们接下来给大家写怎么样获取啊，这个股票的历史行情数据啊，主要是行情数据，其实什么对应财务数据啊，这些东西都有，只要你有这些数据哎，你就能写啊，那行情数据呢怎么样呢。

我们可以比如说把它存到我们的这个模块的，这个目录下，这个用CSV文件啊，用我们的之前讲过了，用这个to share，这个包下的get k data可以直接存下来啊，那我们要实现什么呢，我们要实现的是啊。

和这个距宽也相似，叫attribute，attribute属性，History history，什么拼吧，嗯好参数，第一个参数security股票代码，第二个参数count。

就是我们要从现在开始往前取多少天的，第三个参数叫field啊，它有好多参数，files就是我可以选择哪些列，默认的情况下，应该是比如说我全选open close，啊high lo啊，什么VUE啊。



![](img/15746812af95aa6901ea32fa6e536643_1.png)

这些列什么呢，是就其实就是我们下载的这个cs v的。

![](img/15746812af95aa6901ea32fa6e536643_3.png)

这几列的名字，这几类的题目。

![](img/15746812af95aa6901ea32fa6e536643_5.png)

因为他这个数据就给了这么几个，就这个数据就给了这么几个这个额属性。

![](img/15746812af95aa6901ea32fa6e536643_7.png)

所以就我们就默认的话，field是这几个代码用户，你可以如果你传一个field，传一个列表，只有open close，那应该我们给他返回出来的就只有open close。



![](img/15746812af95aa6901ea32fa6e536643_9.png)

这两列好，那么问题来了，我们现在要什么呢，要获取这个从今天开始往前数count天的时间，从今天开始往前数抗天的时间，那这个东西怎么搞，首先今天是哪一天，哪一次他点daytime，点now。

Date time，点now，那是说现在系统的时间，但是我们是回测，我们回测不是说就是今天运行，就是今天我们回测的意思是，我回测从16年1月1号到17年1月1号，那今天就是116年1月1号回测循环吧。

一天一循环吧，嗯那这个时候哎我们就得还需要维护一个，就是它模拟回测的时候今天的属性，那我们加在哪，比如说我们可以加在context啊，点DT来存什么呢，来存，我现在模拟是模拟这个执行是模拟到哪一天了。

OK吧，开始的时候这个啊context点DT可以是什么呢，可以说是start date啊，那当然这个东西这个self点DT应该是一个啊。



![](img/15746812af95aa6901ea32fa6e536643_11.png)

date time对象了啊，所以我们这import一下date time，S点TD点d t sorry。



![](img/15746812af95aa6901ea32fa6e536643_13.png)

DT等于date time，点date time，点s str p time。

![](img/15746812af95aa6901ea32fa6e536643_15.png)

把刚开始的时候就是开始时间嘛，对不对，好，start date这个时间啊，不是这个这个格式，大家可以自己传，当然也可以，我交给之前在讲我们的这个啊时间序列的时候，说过了，可以不用date time。

可以用date u t i l啊，那在这个包下的，点pass函数可以直接把这个start date。

![](img/15746812af95aa6901ea32fa6e536643_17.png)

转换成我们的这个时间对象啊，之前给大家讲过了好。

![](img/15746812af95aa6901ea32fa6e536643_19.png)

那我们有了当前的时间，那这个DT在运行的过程中，它刚开始是第一天嘛，只要你循环一次，我的DT就直接下一天就可以了，那在运行的过程中。



![](img/15746812af95aa6901ea32fa6e536643_21.png)

这个时候attribute history，我们想获取最后一天就好说了啊。

![](img/15746812af95aa6901ea32fa6e536643_23.png)

最后一天就是什么呢，就是context点DT减去一天，对不对，相当于是因为今天这还不是历史了，今天你要说今天就是1月1号拿attribute history，你是拿不到1月1号的。

你上最新的那天只能是12月31号，这条要减一天，怎么减一天呢，Date time，点啊time啊，Time delta，然后哎sorry days等于一啊，这个是标准库里的。

就是相当于是这个tim delta就是一个时间范围，它时间范围就是一天减一天，就是之前那一天，OK吧好，那比如说我们可以把它这个啊，我们可以把它变换成我们的什么，我们的这个啊，字符串当然不变，也可以。

还没有引入上下文的实例，我写的对吧，上下文的实力，什么上下文的实例，Context。

![](img/15746812af95aa6901ea32fa6e536643_25.png)

context哦，context没有是吗，所以context我应该做一个全局的啊对象出来嗯，那这个全局对象的时候就需要catch start和end date了。



![](img/15746812af95aa6901ea32fa6e536643_27.png)

所以这些其实应该是在用户，应该是就是啊。

![](img/15746812af95aa6901ea32fa6e536643_29.png)

用户就得就是他在这个进入回测的时候。

![](img/15746812af95aa6901ea32fa6e536643_31.png)

就设定好了对吧，所以我们这写一个什么呢，cash等于比号10万。

![](img/15746812af95aa6901ea32fa6e536643_33.png)

Start date，比如说等于2017年对17年的16年，1月1号，嗯都大写的还是都大写的，因为是用户输入嘛，所以我们区分一下，end date等于比如说是2017年12月31号。



![](img/15746812af95aa6901ea32fa6e536643_35.png)

好这个context，我们把这个三个参数传进去。

![](img/15746812af95aa6901ea32fa6e536643_37.png)

好这个时候其实把它设置成全局的啊，也不是不行，那你不是大家不想让成全局的话，可以把这个context相当于传到这个参数里，传到这个函数也一样啊，这个是啊，这end star是什么鬼，End date。

你都不提醒我，这是date time，也没有引daytime。

![](img/15746812af95aa6901ea32fa6e536643_39.png)

老师给删了啊，之前也过嗯。

![](img/15746812af95aa6901ea32fa6e536643_41.png)

这是算出了，就是我要更新，我我要拿到历史的最后一天，那拿到历史的开始时间怎么算呢，因为什么呢，因为我们要相当于是获取历史，这传了一个count，我们要按照这个开始的时间和结束的时间，把这一个把这一段的。

把这一段时间上的所有数据切出来对吧，那所以开始时间怎么搞，开始有看看减呗，往回往回减，但是不是说不是一定不能是end date减去time daytime，Time delta，这样来算。

应该是从什么呢，从哪算呢，从交易日开始算，就是因为你相当于是你要保证整个啊，整个它的这个data frame的啊，长度是抗的。

所以说这个start date和end date中间的交易日也是count的，所以你要找的时候，就要从c street cl这个data frame没找好，那又来了，它首先进行这个布尔型啊。

布尔型索引的过滤，trade cl的is，open线没有下划线，等于一样式交易日对吧，并且，trade c a l到，Calendar，date要什么，要小于等于n late，因为相当于是在它前面嘛。

相当于是把它前面的所有时间都切出来对吧，然后是不是切出来，相当于是这把N的那个前面的，并且交易日这个属性是一的，所有行都切出来了对吧，那因为我们要取后，我们要取count个。

所以相当于是从这些应该分比取后，倒数count不count，所以应该啊从负count切到最后，对对吧，好这个时候记得取时间，所以怎么着呢，去第零行的calendar。

calendar date这一列对吧好点，i lock逗号隔开行零列CALENDATE嘛。

![](img/15746812af95aa6901ea32fa6e536643_43.png)

所以这个地方写啊，因为我们这个行上是行。

![](img/15746812af95aa6901ea32fa6e536643_45.png)

知道的是这个下标列，知道的是名字，所以这是。

![](img/15746812af95aa6901ea32fa6e536643_47.png)

trade c a l点哎。

![](img/15746812af95aa6901ea32fa6e536643_49.png)

columns不能这么写。

![](img/15746812af95aa6901ea32fa6e536643_51.png)

行知道，那我这个时候略前切吧，列全切之后，然后我再选出来calendar。

![](img/15746812af95aa6901ea32fa6e536643_53.png)

e n d a r date这个这一列的一些这个属性好。

![](img/15746812af95aa6901ea32fa6e536643_55.png)

那这个时候我们的study就选出来了，然后接下来什么呢，接下来就是相当于是我要把start date和end date，之间的所有数据切出来，对不对对好，我们来先来看一下这个study和N。

start date和N类的算的，对不对啊，比如说我们来打印一下啊，不要写了半天，结果不对对啊，你说的这个对呀，是对还是不对，是嘶在讽刺你好啊，还HQ还是V的history security。

其实这传什么都无所谓了，因为没有用到的嘛，还各位嗯count比如说选个十。

![](img/15746812af95aa6901ea32fa6e536643_57.png)

那现在context就是end date，一定是什么，一定是啊。

![](img/15746812af95aa6901ea32fa6e536643_59.png)

1月1号对不对嗯，让我们来看一下啊。

![](img/15746812af95aa6901ea32fa6e536643_61.png)

答对看一下，哎果然报错了，S t r p tl，S t r p time，这是F，我怎么打成P了，你都不提醒我，哎呀，你说的太快了好，我们可以看到有没有我说的太快可以看到啊。



![](img/15746812af95aa6901ea32fa6e536643_63.png)

这个因为什么，因为end date，因为我们设定的context的DT是什么。

![](img/15746812af95aa6901ea32fa6e536643_65.png)

是开始的时间对吧对，开始的时间是是不是这个116年1月1号。

![](img/15746812af95aa6901ea32fa6e536643_67.png)

所以attribute history从12月31号开始获取。

![](img/15746812af95aa6901ea32fa6e536643_69.png)

往前获取十天，我们可以对着这个ca2来看啊。

![](img/15746812af95aa6901ea32fa6e536643_71.png)

复制粘贴，找一下好对应的这一行往前数，123456789十十一十二。

![](img/15746812af95aa6901ea32fa6e536643_73.png)

不对啊，哦因为啊不能这样直接数十，要要把零的过滤掉，哎我都懵了，1234跳过跳过五，6789跳过跳过十，哎，你看正好是嗯对吧，也就是说我到时候把18年一八啊，不是18年18号到31号。

这些的数据都取出来。

![](img/15746812af95aa6901ea32fa6e536643_75.png)

是不是可以了对啊，所以证明我们的这个started和INIT写的没有错，是的，然后接下来我们就是要什么呢，把它切出来啊，切出来这一块，其实我想的是，就是我们把它封到另一个函数里啊，在这写其实也行啊。

我们还是分到另一个函数里，因为这个东西可能其他函数还会用到这个时候，比如说啊这先标记一下啊，一会回来再写to do这个什么切这个取取值，就把这2started和NINIT之间的取出来对吧。

那我们这样的话再封装一个函数叫做什么呢，ACTRE叫做啊ATTRI，Data range history t o r y，因为我觉得因为这个函数，一会儿后边还会还会用，所以我们直接这样弄好。

他传的参数不是count了，他通过什么呢，它通过start date和end date来传，然后field等于这应该都一样，参数跟上面的唯一差别就是我把count换成对。



![](img/15746812af95aa6901ea32fa6e536643_77.png)

换成study和NT，那其实这个to do，到时候我怎么样把这我把两个值，我把这个函数的返回值返回就可以了，就不是不是这个RETUR不把对。



![](img/15746812af95aa6901ea32fa6e536643_79.png)

我是把它的返回值返回就可以了，security不变还是传进去。

![](img/15746812af95aa6901ea32fa6e536643_81.png)

然后start date和end date我们是不是也算出来了，然后field哎把它到时候return就可以了，嗯对吧，然后我就保证这个函数。



![](img/15746812af95aa6901ea32fa6e536643_83.png)

让它返回一个data frame就可以了，嗯好那这个函数啊，我们直接打开一这个啊CSV的文件。

![](img/15746812af95aa6901ea32fa6e536643_85.png)

叫做这个DF点，Read csv，参数啊，函数这个文件名应该是security的代码，加上C点CSA，然后用读方式我们来看一下这个东西啊。



![](img/15746812af95aa6901ea32fa6e536643_87.png)

要选择谁当索引，选择date这类的索引。

![](img/15746812af95aa6901ea32fa6e536643_89.png)

我们之前讲过的时间序列用起来比较好啊，index c o l等于date，pass date啊，date还是这次，应该是这次我记得等于data，把它变成时间对象，然后选完了之后就可以了。

当然哎这什么情况啊，这不应该加空格，这提示没事好，那当然我们有的时候其实可以考虑到，我们如果说用户他查了这个security，我这有我是直接能查到的吧，如果我这个里边没有啊，其实我们可以这样做。

就是说啊本地数据会存一些，如果说用户取到你本地数据，那你就在本地，如果说用户没有取到你本地数据，你可以去，你可以去什么玩，就如果说万一他传了一个601317，你完了你就报错了，是因为你没有这个文件对吧。

所以你可以这样对吧，这个ray csv第一个参数也可以是一个文件对象，可以这样这么搞啊，再给大家写一下，DF现在还是未定义啊，Sorry，写错了，Pd，你看你就是给我在线挤bug的。

欢迎开启debug模式。

![](img/15746812af95aa6901ea32fa6e536643_91.png)

try好，我try，然后except一下。

![](img/15746812af95aa6901ea32fa6e536643_93.png)

一个是慢慢这个异常就可以了是吧，如果说他没有这个open。

![](img/15746812af95aa6901ea32fa6e536643_95.png)

会给你报一个异常，嗯对对，那报一个异常，那个这个时候我怎么办。

![](img/15746812af95aa6901ea32fa6e536643_97.png)

我的DF我到时候应该是把它存到DF，如果有，我就把它存到D里，如果没有我的DF就怎么样，就用to share2。2get hdi，get这个KA哈，这个函数大了嗯，不是H吗，啊什么HKA它吧，H是哎。

get h d r是之前的那个这个这个API嗯，好那它的话我们只需要把security，start date和end date传进去就可以了啊，那如果说本地有，我们就直接读文件，当然注意读文件之后。

你要该切的要切出来，你要把什么呢，你要把start date到end date这段切出来啊，列上全切，ALLIA是神仙吗，应该是全切对，要全切，这个如果说你在列上，这切已经把fields选出来的话。

那他也得把FD选出来，所以我们在后边啊。

![](img/15746812af95aa6901ea32fa6e536643_99.png)

try except这个块完事之后，DF肯定拿到了，不管是说本地拿到还是远程拿到对吧，一般来说我们都拿到了，拿到之后啊，我们要注意这个什么呢，把它的啊，我们传的这个fields相应的列给你拿出来啊。

所以这个时候我们还要在里边传一个FILD，进去啊，应该是原组可能是不行，默认的话原组传的不行，应该是要把它转换成这个列表，好这是把这个写就是用户要的这些列都拿出来，如果是FS是默认的话。

就是所有的也拿出来了，然后注意要啊这个，应该没啥了。

![](img/15746812af95aa6901ea32fa6e536643_101.png)

好直接返回看一下，我看一下，这个时候我们测试下，比如说attribute date rain history吧，601318，嗯开始时间你选一个，2015年1月1号就会选1月1号。

那就是2016年2月20号fuse，我不传，我们可以看一下，打印一下这个呃无所谓无所谓，应该无所谓吧，好看一下他最后诶到了2月19号，我觉得有戏，开始的时候是1月5号，因为1234号放了四天啊。

赶上应该是赶上，有可能是赶上对，有可能是赶上周末，我们试下别的别的1月1号了，来个3月1号，3月1号不放假吧，哎你看这就3月2号开始了，就没有问题，刚才那个是放假，谁知道为啥那年放了四天好。

这是呃data rain history，那如果没有data rain，就是attribute history的话，你这比如说传的就不是日期了啊，我们就是在模拟的时候传一个count，比如说传十。

那别传十，刚才就传了十，传20，常常是因为我们这儿这个它的返回值，到时候被它也返回出来了。

![](img/15746812af95aa6901ea32fa6e536643_103.png)

所以应该是从开始，日期是15年12月31号。

![](img/15746812af95aa6901ea32fa6e536643_105.png)

因为我们这设的是16年1月1号啊，那往前数一共是二。

![](img/15746812af95aa6901ea32fa6e536643_107.png)

这是多少，20还是30，反正就是这些行20行啊。

![](img/15746812af95aa6901ea32fa6e536643_109.png)

那这些行拿出来我们的attribute history，就应该是算写完了嗯。

![](img/15746812af95aa6901ea32fa6e536643_111.png)

那我们的这个获取历史数据的这个函数，就写完了，对啊，那接下来可能有一些这个下单函数啊，我们要需要那下单的时候我又需要什么，那就相应的一些函数都有，就可能要写，比如说下单的时候。

我要知道今天的价格对我就需要什么，写一些或怎么样获取，不是历史数据了，获取今天的实时数据好，那我们这个历史数据这块讲到这儿，然后下一个视频就给大家讲下单。

