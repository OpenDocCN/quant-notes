# 第25节课 交易信号及委托3 - P1 - 古辰诗提 - BV1ajsQenE5Y

欢迎大家来到从零开始量化系列课程，MC课程的第25节课，这节课咱们接着往下说，咱们看一看这个课件上的这些关键字，关键字呢基本上咱们已经讲的差不多了，你像by是吧。

by这边呢这个intro labor labor呢，它是就是一个标签的意思，就是ENTROLEBEL，它其实就是咱们那个起那个名字，然后track size就是这个你的这个手术嘛。

后边是entroid type，就是你的进场的类型是吧，这个咱们之前都讲过，这个你起名字要在这个手术前面啊，你看中括号内他是呃，这个可以写也可以不写的是吧呀，把它复制一下，放到前面来啊。

好然后下一个是SRSR咱们也讲过了，好再下一个是sell shot，这个也说过了，再下一个是by to cover，都是一样的，再下一个是all all，讲过就是你在平仓的时候你可以使用哦。

千万不要在开仓的时候使用or啊，然后秃头啊，这个秃头咱们是需要讲一下的，直接给大家演示吧，新建这个型号怎么说，把之前的这个策略咱们给它复制过来，呃咱们写个什么策略呢，就是可以就是开多个仓位。

就是分批进场，分批进场呢，咱们这，bile就不要写这个名字了啊，然后if fast a cross over slow ma，and就是这个market position，就是你的持仓啊。

这个market position嗯，咱们看一下啊，Market position，Market position，咱们看一下啊，它只有三个，就是一零和一，然后你如果想获取持仓的话。

是用current shares a r e s是用这个，这个是就是和这个contracts是一样的，它返回的是你持仓的数量，它没有正负号，它没有正负号好吧。

and market就是这个country shers小于十，Them by next by at market，什么意思呢，就是如果说呃我这个上穿了快线，上穿慢线，然后我的持仓小于十手，我就接着买。

我一直买到十手才开始，我这儿呢设一个开关control42，然后零这个control是干嘛的呢，if c o RT count shares等于十，And，CNTR应该是OL吧。

c n t r a and control等于嗯0Z，control等于一，什么意思呢，我这儿呢算是一个开关，如果说我的持仓有十手了，然后呢我这个control还等于零，因为它初始是零嘛。

我就把它变成一，我把cell shot也给他给删掉啊，然后如果说close under slow ma，然后and就是control等于一，Then sell short，我几手呢，我卖出三首十。

THESHIRT是three shares，我把这啊就是SHARES啊，就是我先是只买只买进是吧，只开仓，然后开十首，然后一笔一笔的开进去，然后我等他开满了之后呢，我再往外卖，然后一次性呢卖三首一呃。

一次性卖三手，我是这么个逻辑啊，一次性卖十卖三手，他应该卖几回啊，卖四回，最后一次卖一手对吧好，然后我进行一下编译。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_1.png)

设置信号，我把这个信号给删掉。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_3.png)

然后增加这个25close。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_5.png)

看一下策略绩效报告，你会发现就是它只有一笔交易啊，它只有一笔交易，而且合约是一手啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_7.png)

从这儿呢咱们需要设置一下信号在属性，虽然咱们代码里边写了写了。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_9.png)

就是你需要就是说一直买。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_11.png)

但是呢你如果说你不给他从这设，咱们可以找到那个开仓的这个位置啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_13.png)

点一下点一下，咱们把它缩一下啊是吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_15.png)

就是从这买进去的啊，从这买进去的，然后他平仓。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_17.png)

他平仓就一直没有平仓，因为他这个咱们看一下啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_19.png)

他这个还是open着呢，open着就是一直拿到了现在一直拿到现在。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_21.png)

你让他亏损了1万8000多块钱，因为什么咱们这个代码里边他始终没有满足他。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_23.png)

持仓持仓达到了十首。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_25.png)

然后去平仓，你control它始终没有变为一对吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_27.png)

这个时候呢我需要设置一下，如果说你想分批进场的话，你需要把这个属性这儿呢，这不为限制，最多允许多少笔与目前仓位同向的进场，咱们最多开十首，我就啊就这个十就不用改了。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_29.png)

这个时候我再确定一下，然后你就发现这又败了，这又败了是吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_31.png)

这又败了啊，呃我这个时间是不是太短了。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_33.png)

设置一下商品设置啊，然后一日了是吧，我从这个。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_35.png)

10分钟吧，10分钟，然后。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_37.png)

好，哦试图策略绩效报告。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_39.png)

你就会发现它跟咱们想的不一样。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_41.png)

他会一直买，你看900笔是吧，咱们再看看这个代码啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_43.png)

就是control等于1then，需要是这个three shores，这你应该改改一下什么，因为他会反复的就是就是开仓，然后平仓，然后进场，这个代码逻辑是这样的，就是我评完了之后，我这又上穿了。

然后又小于十了，因为咱们是做演示嘛对吧，我只让他开一次就可以了，就是开完十首后边就不开了，我这个后边再加一个control啊，再加一个control and control等于零。

你想想这个他满足十首开完了之后，这CTRL就变成一了，所以说这他就不会再开仓了，对吧啊，逻辑捋顺了啊。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_45.png)

这个时候咱们再看啊，策略绩效报告。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_47.png)

你有没有发现哎他成交是要少得多了。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_49.png)

但是他也成交了40，比咱们看一下啊，咱们找到它的成交的位置。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_51.png)

点一下这个吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_53.png)

哎成交的价格是多少来着，价格是3150。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_55.png)

是在下面的对吧，3150诶。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_57.png)

找一下这个价格啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_59.png)

好价格是5080啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_61.png)

5080再上，5080是在这儿，咱们再把它缩一下看一下啊，这个哎，是吧，就是说这儿你会发现它，它会有个什么情况呢，就是说你从这儿就从这都给平了，对不对，一次性你像这个是几笔，一次性全部都从这给平掉了。

然后你这儿呢我再给他说一说啊，你后边还有反复的，有这个是设置三，设置三去平这个三首，但是没有线跟它连，你发现没有，就是后边这个share3其实是嗯没什么用对吧，就是只有前面的是有这个实际的这个交易的啊。

咱们看一下这个后边，你想他都是这个还是持着仓呢，那是因为啥呢，因为为什么会持仓呢，他这个一直持仓呢，持仓它是空单空单，这咱们是sell short是吧，咱们把它改成cell，就是我不就我就不开空仓了。

我只开多仓，然后把多仓平掉啊，应该是这样的一个逻辑对吧，好，你过来之后发现后边没有了，现在只有几笔交易呢，咱们看一下只有十笔交易，只有十笔交易是吧，但是啊，你会发现这个十笔交易跟咱们想象的不一样。

咱们想象的是什么，就是我一次性只凭三首，我应该按三次四次平完，最后一次平一手，但是从这儿呢他可以一次性都给平完了，这个是为什么呢，这个啊就涉及到他这个设计的这个逻辑问题了，就是你这个是分十次进的。

分十次进，你每一次进一进一首，然后你从这SL的时候，没有指定评哪一个的时候，他就把你静的每一首都按照可以评的数量给你，评完了，你这评一手他也是一次性全给你，评完了看一下啊，他也是一次性全给你拼完了。

咱们看一下图，他也是一次性全给拼完了，这一样都拼了十首对吧，所以说这个逻辑他是什么呢，就是你分十次进的，分十次进，我这平的时候你没有指定，就是为什么咱们当时就是说在买的时候，这需要加名字呢。

你这儿没有指定啊，当然怎么指定，咱们后边说啊，你这儿没有指定，没有指定的话，我就把每一笔进场我都评一手，然后就把十笔全部给平完了，如果说你想就是咱们之前那个逻辑，就是我每次评三首，你这个应该怎么写呢。

在后边加一个total，就是什么意思，我sell我评三首，总共啊一共评三首next，but the market好，进行一下编译，然后你会发现啊，这个可就可能有点乱啊。

你看这三首这三首这三首这平了一首对吧啊，这是total的作用啊，这个一定要知道，但是咱们一般不这么去写啊，后边儿咱们会说如何指定它的名字，而且一般你一般进场你不会这么粗糙的对吧。

你可能有好几个条件来进场，那个时候进场，你就可以根据条件的类型，然后去确定他的名字，然后再你平仓的时候，你评哪个仓位呃，你评哪个名字的仓位，应该按照这样的逻辑去写你的策略好吧，你看这他也有解释。

就是落三笔多头进场仓位就是依序为一首，一首一首呃，一首一首三首，如果说你total next bat market就是四，就是总共评三首的话，他会把前面两首平了，然后再把后进场的那个三首平两首。

他就会就剩两首，但是如果说你这个一首一首，三首语句没有total的话，他就会把你这四这个这个都平调三次，里边都评三首，好吧啊，当然不够三首了，他就凭一手啊，你要够三手了，他就把三首全部给平了啊。

后边这个intro就是使用在策略中出场语句中，指定进场信号名称为intro labor啊，Intro labor，你像这样就是说就是它的这个语法格式是什么，就是co from entry。

然后后边跟上你的这个名字，从这从这个咱们写的这个测试案例，咱们应该怎么去写呢，首先给它起名字，对不对，首先给它起名字，名字怎么起呢，当然你可以起成一样的，但是起成一样，你平的时候你就都平了对吧。

这我先把total给删掉啊，起名字呢我这写一个这个number string，然后这个里边写上这个啊，然后number string就是后边写上这个字符串格式的，然后我从这儿then begin。

然后从这再写一个number，初始值是零啊，初始值是零啊，当然这个number string就先放着吧，初始值是零，然后我先给他什么呢，begin把这end先给它加上，别忘了这个啊，and然后从这儿呢。

我这个name就是这个number string s t r等于啊number two string，然后这个里边写上这个呃，这个value这个咱们一直在用的啊，就是里边写上这个。

第一个是写上你的这个字符，就是number后边保留几位数字，我就是小数，我就写上个零啊，就是不保留小数，然后呢我把这个number，等于number加一啊，它就变成一了吧，然后它就变成字符串了吧。

字符串，然后我取名字的时候，我这加上这个名字是什么呢，就是这个number string，就等于这个我应该是在前面加上这个，啊这样，后加上这个，然后我把名字直接写到这儿。

number string s t r啊，我进行编译，看看能不能编译过去啊，编译没有问题，这个时候我起名字是不是你看C21啊，就是是不是cl2，Cl1，C22C23是吧，然后我再平仓啊，你看我平仓。

Then sell from entry in t r y entry entry，括号里边我给它放什么呢，比如说我把这个，这个这个这个C26from entrance，416。

这个entrance它的这个语法就是说from entrin，然后后边是名字对吧，我是from entrc26嗯，All shares next bat market，然后进行一下编译，编译成功了。

然后这个时候你会发现别的都没平掉，只有这个C26被平掉了对吧，只有这个C16被平掉了，这个就是可以单独起名，然后这个里边的逻辑这个number string呢，这就是这样说，可能不是特别标准。

你应该直接把它改成name是吧，它的名字呢就是这个cell后边加上他的这个编号，当然编号你得把它转换为字符串类型的，然后起名字的时候就用这个编号啊，就是这个CR加上编号，然后他就有名字了。

这个时候你就可以去指定哪个仓位给平掉啊，这个就是它的用法好吧，并不是多么复杂啊，记住它的这个from entr，当然你看这个from这个它也是个关键字，所以说你可以把你可以把它删掉。

然后再进行一下这个编译啊，这个都是一样的是吧，好了啊，这个是其实是比较重要的这个ENTR啊，然后this but today，咱们讲过了这个ENTR啊，给它，This but today，不建议去用。

下一个limit限价单，就是也不建议大家直接去用，这样容易去乱啊，就是你开仓的时候，你用它呃都无所谓，但是你平仓的时候建议不要去用它，然后用那个or high或者all lola是吧，那是比较级啊。

stop也讲了，higher也讲了，这一点我觉得设置的特别的人性化，像这个我在做这个开源平台的时候，那个上面只有一个呃限价单和一个停止弹，其实很多老板们都不是特别清楚，这个他的这个逻辑。

一定要把这个逻辑捋清楚了，这对于你以后就是说这个做这个开源的平台时，候也非常有帮助呃，因为开源平台它毕竟不是三方平台，它设计的没有这么完善，所以说难免就是说嗯就是说你如果不太懂。

这个会出现一些问题的好吧，intro bar order generation是咱们一直讲过的。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_63.png)

就是其实就是打开班内交易，咱们之前这个例子，你会发现大部分的成交要么是收盘价，要么是一个最高价。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_65.png)

最低价看一下啊，你看这个它的位置，这个是开盘价是吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_67.png)

然后这个是开盘价啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_69.png)

这个也是开盘价是吧，因为是next bat market嘛，然后这也是开盘价，next bat market它就应该是在下一根K线，他的这个开盘的时候嘛，你看这个也是开盘价都是在这个位置的。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_71.png)

如果说我把它打开，就是把这个可以八内进行交易，TIANRO8generation等于true，这个就算是给他打开了，然后为了看的清楚一点呢，比如说我把这个买的时候啊，这儿写成了SL了啊。

因为你你应该买的时候写成by，当然这无所谓了，是取个名字by next bat，比如说我用clothes，然后减去一个十，然后O我买买的越便宜越好吧，low了是吧，我就是其实这是一个限价单。

只不过我发的这个委托价格呢还要低十块钱啊，十块钱也就是十个点，然后这个时候我进行编译一下。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_73.png)

然后咱们可以再看看，就是咱们这个啊图啊，你会发现嗯，你看这个他就到这儿来了吧是吧。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_75.png)

他不是这个开盘价了吧，你包括这个他在中间了，对不对。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_77.png)

你看这个是在这了吧对吧，这个也是在这儿了吧，啊包括这个也是在中间了，不跟刚才试的都是要么是这个开盘价是吧，要么反正就是高开低收里边一个点位，但是这个你看他在中间了吧，啊这个起的名字应该起败的啊。

这个就是打开这个int bar order generation，可能会有一些老板问。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_79.png)

因为我并没有设置信号，就是说这个回测的时候，就是使用精细资料进行回测，我并没有打开它，因为什么呢，因为我这个就是我回测的时候。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_81.png)

我还是按照这个一根K线，一根K线来的嘛是吧，它只不过价格会出现在这个中间啊，价格会出现在这个中间，这个回测有一些不太好的地方，如果说你想细致的回测，你最好还是把那个tick打开，这儿呢。

它只能给你就说把这个箭头画在中间，如果说你的止盈止损比较小的话，它可能这根K线里边会来来回回好几遍，咱们之咱们之前不是讲过吗，就是说他可能你一根K线看似好，好像就是说是这样很饱满的一根K线。

它可能就是来来回回来来回回这样好几遍，如果说你止盈止损小的话，你可能就会出问题，但是我没有打开精细回测，我没有打开精细回测，你没发现就是咱们之前讲的那个内容，同样的根K线。

我没法就是去判定它的走势的时候，MC会有那个假设吗，忘了那三个假设了吗，里边其中有一个假设，就是用这个开盘价和最高价比，如果说这个开盘价，当然它这个开盘价是在这啊，开盘价和最高价比，然后这个开盘价呃。

就是最高价减去开盘价，如果说大于等于开盘价减去最低价，他的就是这个开盘肯定是第一个的，然后第二个是低是吧，然后高然后去收盘，是不是，所以说他给你默认的就是说呃开盘是在这啊，然后低这样走是吧。

然后高走到最上面哎，然后收盘，所以说这个时候呢中间它只会出现一个，就是说点位，如果说你的止盈止损设的比较小，可能一根K线里边，尤其是周期再大一点，一根K线里边可能会有好几个这个买开买开啊。

当然我这个其实是没有必要，我给大家做演示，就是告诉你它可以把这个箭头画到中间来啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_83.png)

这个就是intro bar order generation，这个后边咱们挑一个就是有实时行情的时候，给大家做一个详细的演示，它有什么区别，包括咱们之前一直说的那个intro8呃，不是INTR。

but persist啊，那个会给大家做一个详细的这个演示的好吧，下一个呢是这个place market order，这个是用来干什么的呢，这个是用来干嘛的，干什么的呢，咱们把它复制到这个里边。

这个给大家回测不了啊，这个就是它是什么意思呢，就是不改变图表上的部位，图表上不会有信号产生，发试价单到经纪商，这个经纪商是什么意思，经济商你可以理解为就是就是就是交易所啊，发十假单交到这个交易所。

然后呢他呢跟它相对应的呢，还有个本地企本地洗，其实就是放在咱们这个电脑里边等待触发，本地喜是什么呢。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_85.png)

给大家，比如我这个信号，然后属性，然后在这个自动交易这儿呢有一个这个设置，你看本地息触发以本地息，你看现价，咱本地洗啊。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_87.png)

就是说这个本地系，就是其实是把你的这个价格放在你本地。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_89.png)

等待出发啊，然后发市价到经纪商哎呀，这个有什么作用啊，就是这个的作用是什么呀，就是当你的这个就是图表的这个走势图。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_91.png)

跟你的实际的成交不一致的时候，呃什么时候出现不一致的情况呢，就是咱们就是之前一直说这个什么呀，就是比如说我从这我用这个限价单，比如说他一直是往上涨的，用限价单，我这我用一个限价单，我发出去委托。

at close limit或者at close or lola发出去委托，这再没有出现这种价格，它就是成交不了了对吧，他成交不了之后呢，但是你这个图上啊，它会给你显示有有这笔成交。

当然这个你也得设置啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_93.png)

这个是从哪儿呢，就是这个信号这属性，这然后自动交易这儿，这儿呢有一个就是这个同步和异步，一般呢选择异步，一般选择异步，为什么一般选择异步同步啊。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_95.png)

先说同步，如果说你没成交的了的话，它呢也不会在这个图上显示，可能有的老板就说这样不是挺好的吗。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_97.png)

但是比如说你一般是这个CCTA策略吗，长期策略你会拿个几天是吧，你从这没有显示到周末的时候，然后呢我把这个就是量化交易给关掉了，我周一早上我再开开，到周一早上一开开的时候呢，这又显示又有了。

因为你这个在当时是实盘，但是你走到后来你周一早上再打开的时候。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_99.png)

它就成历史数据了，他这会有这个就是说这个成交的记录。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_101.png)

但是呢你实际上这个没有成交。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_103.png)

你实际上没有成交是吧，这就产生差异了对吧，另外一个为什么推荐大家用异步，因为异步就是其实你的回测是依照不，你的实盘是依照你的这个回测来的，很多时候咱们做这个CCTA策略的时候，一年可能就交易个大几十笔。

错过一笔就可能错过一波行情，对不对，你肯定是不希望就是说去错过一笔，所以说你还是希望他按照你的这个策略，这个显示上的来，但是这个策略在回测的时候，他只要有那个价格它就会成交，但是有那个价格你在实盘里边。

你撮合不一定能够撮合成功对吧，你不管就是说你是用现价发的，还是当然一般都用现价发才会，就是发生这种情况，你限价是为了减少滑点，但是呢你又不想错过这个行情，其实你还可以后边去补对吧。

所以说这个补就是用这个就是place market order啊。

![](img/fca4ec54640df03d6c339ff3f4dea5cb_105.png)

这个他的这个解释就是为什么不给这个呃，图表上不会有信号产生，因为它是用来补齐你的这个仓位的啊，来补齐你的这个仓位的，你像这个他后边这个is by就是用来指定委托，是买或卖true。

就是买force为卖啊，然后那个is enter就是指定，就是呃就是开仓还是平仓啊，第一个指定买还是卖，第二个指定开仓还是平仓啊，然后这个后边就是这个参数就是少数，你看他给的这个例子。

当然这个给的例子不太对啊，咱们给他复制过来看啊，复制他给的例子是什么意思，就is if market position等于二，market position没法等于二，因为它的返回值是呃。

你要是持有多头的话是一呃，没有持仓是零，空投的话是一，所以说这个时候你应该乘以一个什么呀，current shares吧，就是这个相当于是正负号，这个是相当于你的持仓量等于二。

然后呢你market position at boker这个是什么呀，就是返回当前交易的账号持仓啊，对应策略部位的经纪商部位栏数值，其实就是你的持仓嘛，你这个策就是你这个策略的实际持持仓。

你策略实际持仓是这个四手，就是你获取的实际持仓是四手，但是呢你现在的啊，不是这个你账户的实际持仓是四手对吧，然后你的这个呃现在的这个持仓呢是两手啊。

你把market position加上你图表上的持仓是两手，你是不是需要把再平掉两手是吧，所以说它是place markeorder，第一个就是这个呃买卖false就是卖嘛是吧。

第二个是你的开屏false是平是吧，就是卖平两首啊，他是做这个工作的，当然这个写的不是很严谨啊，那个写写的不是很严谨，为什么呢，因为呃也有可能就是你这个实际持仓里边，还有别的策略呢。

对吧啊啊这个后边咱们再说，就讲到这个时候再说，好吧好，这个是place marked order，好咱们再看下面啊，下面就没有了，就是内建出场函数了。



![](img/fca4ec54640df03d6c339ff3f4dea5cb_107.png)