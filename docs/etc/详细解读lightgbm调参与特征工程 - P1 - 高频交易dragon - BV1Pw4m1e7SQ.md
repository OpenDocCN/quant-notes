# 详细解读lightgbm调参与特征工程 - P1 - 高频交易dragon - BV1Pw4m1e7SQ

哈喽前几天我们呃做了一下来的GBM，这样的一个机器学习库，然后呢，今天呢详细的把这几个东西呢撮合在一起，讲一下这个理论和一些普通的代码以后的话，就是说把这个东西如何用在我们自己的。

这种就是高频交易里面去做，这种就是auto book的因子挖掘，以及就是trees，就是刚刚成交的这种东西的这种就是特征挖掘，可以用到这样的一个工具来做回归，或者来做分类。

OK那我们来看到这个light g b m的官方文档，那么我们来看到它就是一个这个叫stable的，这个版本，如果说你看你们最新的是V4。4啊，4。3，还有最新的叫RTTEST。

那么有很多是可能已经是三点几的老的版本，所以说可能呢会有点那个，那么它还可以在GITHUB上有他的这种库啊。



![](img/c554579f1a84eb537d7d362105bd2794_1.png)

那么我们看到，这是在MICROSOFT的一个家族下的一个东西。

![](img/c554579f1a84eb537d7d362105bd2794_3.png)

所以说呃肯定肯定是OK的啊，没有问题，那我们首先来看看他的这种呃。

![](img/c554579f1a84eb537d7d362105bd2794_5.png)

就是Python的这个quick start，那么首先它会给到如何people in store这样的light gbm，然后就可以用了啊，就是最新的一个版本，那么肯定的他是需要你有烂派的啊。

那么这个里面呢他就会告诉你怎么样去装，然后呢他的数据啊，包括有一些这种就是这个五折验证对吧，这个就是五折交叉验证，然后还有一个就是alice stopping，那么alice stopping是早停。

早停的话，你可以看到l g b d l stopping，那么stopping lungs等于五啊，那么就是说如果训练五次再也不下降，你可以进行早停，不能傻傻的一次让他训练1万次。

然后其实你在1000次的时候，可能就已经过拟合了，或者说这个训练就没有效果了啊，那么你就可以提前节省时间，那么他给了一个sing store，还有data的这种interface。

data的这个什么样的数据接口，然后呢如何去设置这样的一些参数，那么它重要的几个参数就是objective，objective的话就是你训练的目标是banner的，一般是一分类，还有就是这样的啊。

回归啊，类似的还有一个magic，那么这个是AUC这样的一个曲线啊，还有就是它的每棵树下的，因为它是一个树模型，就是长多少颗叶子，那么如果说leave是太大了，就是会产生过拟合。

那么这个数呢他推荐的是31啊，这默认的参数对吧，那么它的magic的评价，他就AUC和班列的lock lock loss，也就是说这样的一个就是log这样的损失啊，那么看他的chain的话，就是做十次。

然后怎么样去传进去，然后呢这个valid set，那么就是对它的交叉验证的那个那个，它的那个就是这个validation data data，那么还可以对模型进行存储，可以存成text文档。

还有picker pk l这样的文档等等，你可以在这里面呢就是很快的，那么就是在这里看到，因为我们这里就是不会太详细去讲这一块。



![](img/c554579f1a84eb537d7d362105bd2794_7.png)

那么OK那么可以看到它呃，简单的就过一下这个里面，Python这个里面呢有它的data的这个structure API，那么就是怎么样把这个这个数据给给给掉。



![](img/c554579f1a84eb537d7d362105bd2794_9.png)

丢进去啊，那么他给到了，就是有这么多的一些各种各样的参数，还有各种各样的方法啊，呃等等，那个get data，还有future nm bean对吧，生成的这个数据的这种啊，有多少多少特future啊。

多少future的这样的数据等等，这个里面呢可以自己去看每一个参，有参有什么样的参数，那基本上我们呃比较多用的，我其实是在light GB and mascr line下面的东西。

你看light在DATASET，那么data set boost，还有这个SIQUENS，还有CV boost各种的这种东西啊，这是原声的，用他的，那么他跟SKLEAR有一个这样的接口对吧。

那么你可以看看有dusk的接口，Call bs，这个是call bs的话就是反馈啊，那么就是说跟你可就是有回调函数一样的东西，那么alice stopping，那么还有这个log的evolution。

还有record的这样的evolution，还有这张其他的这种这个这个reset对吧，重新这个这个这个parameters，那么这样的就是各种的参数call bx，还有这个里面呢还有画图的一些东西啊。

就是最重要的就是这个pilot importance对吧，就是最重要的排序等等，还有还有其他的画这种这种直方图等等的，还有画的竖图对吧，这样的一个应用，那基本上我们的很多都是用这个skin。

它跟skin一个绑定的东西，那么跟斯skin绑定的东西有重要的，有这个CLASSIFICCLASSIFIRE，classify的话就是做分类的啊，基本上你在金融里面的话就是上涨下跌，还有不涨不跌。

怎么样去做一个分类对吧，那么这个里面呢这个classify的话，那么它的boosting的type也是用GBDT等等啊，那么这个里面的学习力啊，还有n estimators的100次的这种训练呐。

这个训练的时间就训练的轮轮询的次数，那么还有就是这个还有各个模型，直线模子模型的一些权重之类的东西啊，你可以看看这里面的，还有这个ENJOBS的话，就是应该是建立多少CPU的线程，进行多线程的一些训练。

可以看到它的蛮多的，这种这种东西，那么我们重点的可能呢，就是可能就讲这个就是这个LGBM的。

![](img/c554579f1a84eb537d7d362105bd2794_11.png)

它的回归的这样的模型。

![](img/c554579f1a84eb537d7d362105bd2794_13.png)

那么我们一会去看一下其他的东西，这个里面呢可以看到它的有一些参数。

![](img/c554579f1a84eb537d7d362105bd2794_15.png)

那么我们找到了有有几个博主写的一些博客。

![](img/c554579f1a84eb537d7d362105bd2794_17.png)

我们一会去看一下，那么这个里面的只是一个文档的一个解读。

![](img/c554579f1a84eb537d7d362105bd2794_19.png)

那么文档解读的话，那么它还给会给一些案例，案例的话是在这个MICROSOFT的下的这个GITHUB的这个库，可以看到这个Python guide，那么这个里面呢他给了一些案例。

1example是讲的Python guide，那么这个里面呢有个有个高级点的案例，那么就是如何去诶拿到什么样的数据，去划分训练集和测试集对吧，然后呢再在里面呢进行了一些这样的。

就是呃这个生成这个特征的一些特征工程，然后呢塞到这个data set里面，然后就可以开始利用一些参数，G b d t binary，the binary lock loss之类的啊。

这些学习力啊之类的啊，那这个学习力是比较精确的，它比较小啊，他这个值是0。05，还有的人用0。03，那么这个里面的比较小的话，学习力的话他梯度下降就比较小了，就精细学习。

如果说呃这样耽误的时间就会比较多一点啊，那么这几个人是关于过拟合的一些参数啊，你们可以去看看这个里面的，这个里面的就可以进行劝了，劝了之后可以save mode，Save mode。

就是把它改成成text，然后呢有新的数据来进行重复训练的时候，有把它可以把它给给给重新的，把它给捞的进来之后又可以去做了啊，那么这里面呢都会有有这个open，这个你看见没有model p k l对吧。

那么可以把它重新漏的漏的出来，大家全身进行预测啊等等，你可以看到他这个给到的这个，这个这个各种不同的这种这种训练的参数，包括还有这种luckly like holder，Likely holder。

那么这个是最大释然对数对吧，好像是这样的一些自定义的，这种，就是metric自定义的这样的评价的一个东西，它可能呢给了一个这个很多的这样的自定义的，这个参数，这个是高级训练嘛。

所以说这个里面呢你可以看到他的这个里面呢，就是你看见没有这个这个FEVEL，就是BINNER的L，那么这个这个里面的它就会给到一些，你看这个自定义的一些参数损失，类似这个东西，还有一些正确率对吧。

你可以看到啊，就等等啊，这个里面呢你可以看到他用的这个评，评价的这个东西，就是它的正确率，还有这个binary elo类似的这个东西啊，这个里面呢就是做了一些自定义的东西。

那么这个call back x cbs的话，刚才讲的，他的有的东西就是关于他的这个呃这个call back x，就是他这个里面的call back x，也自定义了一个叫list set metric。

这个是重新设置的，这样的一个评估的一个一个方式啊，那么他的评估方式就是呃自定义一个函数，那么很多的自呃call back，比如说这个是早停啊，干嘛的呢，那是差的call back的一种方式。

那么这个是在这个这个叫什么，这个文档里面所说呃，可以的，那么呢这里面呢我们捞到了几篇文档啊，我也看看，给大家瞄一下吧，这个这个呃从这个开始吧，这个比如讲透一个大模型，这个哥们是在北京6月4号。

应该来讲是比较新的，那么最近的他应该是6月21号写的这个啊，就light gbm，那么能看到他是从数模型讲到X级boost的，差几boost的，然后再讲到light gbm，那么这个里面呢它都是数模型。

都是GPDT的，这样的一些这种这种决策树的提升，那么这个里面的可以看他首先呢讲的这个是呃，拉力GBT的显著特点，速度快，内存效率高，高精度支持支持并行计算，自动处理缺失值，支持分类和回归啊。

这样的问题啊，那么它的理论基础一样的目标函数是什么样啊，那么它是一样的，就是预测值跟它的这种真实值之间的，这平方的这个这个均值应该最小，那么其实就是in boost这样的东西的话。

他们最最重要的一个是要得到JI，这样的一些争议的东西啊，那么他的这个这个里面的，怎么样提升迭代的过程啊，大家有兴趣可以去看看啊对吧，这个这个你看那个BM的步长学习力。

所以说这个里面呢你可以简单的看一下之后，就会对他的这种呃后面调参的话，就是你理解它的原理，对调参可能会更更那个啊，就是他可能有哪些就是权重，去决定它过拟合或者精细精度，精细学习。

这个里面呢这个这个他的light gbm的改进是什么，这个直方图的什么算法，基于叶子的最佳分割的这种方法，那么叶子的数据越多，当然够能更好的你和你的样本，但呢它就是可能会太多的话。

就是OVERFITTING的这样的东西，其实这个数模型的话，也就是说这个无论是用boost的这样的模型的话，它其实就会就是按照他的这种收益啊，就是经济的收益的话进行，这个这个做的这个这个啊。

就是上一次的分类跟下一次的分类对吧，就是根据这个收益的东西来来进行，这种梯度提升的，那么他数学推导那大家都是一个套路，你看见没有计算分割争议节点增益公式，对于每个桶啊就寻求最佳的分割点对吧。

因为你一堆的样本分进去之后，对于每个桶对吧，8KET的分类的话，那么他其实就是这样，有这样的一个公式进行指导，那么进行梯度怎么样进行正则化，进行这个惩罚项，然后呢得到的这样这样一个电。

OK更如何去更新模型对吧，找到最佳分类点更新模型，OK那么这个算法流程我就不再讲了。

![](img/c554579f1a84eb537d7d362105bd2794_21.png)

这个里面都有，那么会给了一个完整的一个案例啊，那么这个完整的案例里面呢也很简单，就是啊这个是打包打包的话，他这个这个斯cur令可以看到没有，它斯cur令还是跟这个gt啊，来的GPN进行结合的。

所以说你看的就是为什么叫skin这样的一个东西。

![](img/c554579f1a84eb537d7d362105bd2794_23.png)

那么它可能呢导入了这个这个的声音，这个grader search CV啊，类似这样的一些东西啊，我们看到他就是一个就是这个train text的，一个spread，就是把数据进行分割。

第二个就是做了一个就是超参数搜索的，就是啊叫叫叫做网格搜索吧，就参数搜索grade cs CV，那么后面的就像你看就是这样的均方差的啊，这个这个这个这个这个错误。

还有一个叫r r score的一个这样的评分，那么还有一个就是standard的scare的这样的规划啊，还有one hot encoder这样的独乐编码呃，其他的people line啊，画图呃。

这后面的也是画图啊，这个我没没没看他的是什么一个东西。

![](img/c554579f1a84eb537d7d362105bd2794_25.png)

那么它把数据加载进来之后，进行这个数据分离和特征，那么就是把其中的job掉了，这样的这个这个什么就是YY的话，因为是cell price，那么把它id和cell price给JOP掉了之后。

那么就是让这个训练集和目标分离，分离之后的话，那么你可以看见没有，这x text再把id啊，这个这个这个这个这个id给drop掉了，然后进行这个诶你可以看到啊，就是他选择什么样的。

这种这种这种这种类型数据进行COLLINS进行，然然后呢把这个特征值啊处理一下之后啊，把缺失缺失的拿下来进行一些填充，那么其实呃还把这个p line里面的一些数据啊。

就是把这个呃就是进行归一化和读了编码，然后呢再跑去进行这个这个。

![](img/c554579f1a84eb537d7d362105bd2794_27.png)

把这个是这个将预处理步骤和模型结合起来，然后呢开始就做这种拆分，训练集和这个验证集了，拆了之后立马就做这种fit fit之后进行predict。



![](img/c554579f1a84eb537d7d362105bd2794_29.png)

然后呢给到就是IMSE和R2。

![](img/c554579f1a84eb537d7d362105bd2794_31.png)

这样的就是均方差的这个平方，然后来看看会怎么样，最后做一个超参数的优化，最重要的就这几个参数啊，因为后台后面会讲就是关于叶子树啊，learning late呃，学习力还有这种迭代的次数嗯。

后面还有一个文章会讲哪些最重要啊，那么进行网格搜索，可以看到，会得到一个比较比较好的最佳参数是什么，然后用的这个最佳参数，可以进行这个多轮次的这个训练对吧，然后呢预测测试机并导出结果啊。



![](img/c554579f1a84eb537d7d362105bd2794_33.png)

然后呢最后就画一个图进行可视化分析。

![](img/c554579f1a84eb537d7d362105bd2794_35.png)

他那个好像是，我不知道它应用的是是不是卖房子的。

![](img/c554579f1a84eb537d7d362105bd2794_37.png)

那个cl的价格啊，就是说房子有几个什么样的特征啊，干干嘛干嘛的。

![](img/c554579f1a84eb537d7d362105bd2794_39.png)

那么它会形成了这样的一个，一个这样的一个东西啊，形成了这种就是predict，是围绕着这个东西的这个这个predict，然后他有个action，真实值的话是个红点点，你看见没有。

他好像这个这个这个东西好像从你会画图之后，它就是一个这种这种倾斜向45度。

![](img/c554579f1a84eb537d7d362105bd2794_41.png)

这样的一个东西，那么重要特性对吧，他也给了你一个有呃，就是这种在最佳参数下面的时候，他的这种就是future importance嗯。



![](img/c554579f1a84eb537d7d362105bd2794_43.png)

还有feature的链是什么样的东西，然后他把他的这个前十名的这样的东西，也可以用画出来了啊，他这个里面你这样gage area啊，哦这个还有车库的区域什么什么的吧，还有lot arely什么什么的。

好像这个就是那个房卖房子的那个啊。

![](img/c554579f1a84eb537d7d362105bd2794_45.png)

好预测房产的一个一个一个一个重要的东西，然后把特征分布进行可视化。

![](img/c554579f1a84eb537d7d362105bd2794_47.png)

可以知道它大概是不是符合这种这种呃，均态分布，正态分布，如果不是的话，这个我们在处理数据的时候，最好是把它能做成这个，你们看很多的东西是没有正态分布的，可以看到只有只有这种有点偏态的啊。

你看这个很多的是是是不具备这个正太的，这样的一些条件。

![](img/c554579f1a84eb537d7d362105bd2794_49.png)

如果不具备的话，正态分布的话，你去预测是比较比较麻烦的。

![](img/c554579f1a84eb537d7d362105bd2794_51.png)

嗯大概是这样的，他最后说了一下，这个最后的话他的这个这个就是看到没有，就涉及几个问题，参数调优，模型训练和模型评估呃，这样的一些东西，那么参数调优的话，有人去跟他问了，他最主要的点看见没有。

就是这个一个下面的树有多少多少个叶子，还有生成叶子的深度，还有learning laid，还有一个就是an estimate or这样的一些东西啊，就是增加这个计算的时间的那个数的构建，然后呢他也说了。

就是这个mean data in leaf啊，然后呢方知一个叶子数列最小数据，还有一个是min3hassing leaf，就最少的这个黑线和这个黑心的矩阵，是目标函数的R阶导数矩阵呢。

也是为了防止过拟合的东西，还有原来看到这个begging这个东西，也是这个就是多少次，取多少比例的数据来训练啊，就是为了防真防止特征过拟合的这个东西。



![](img/c554579f1a84eb537d7d362105bd2794_53.png)

还有呃这个LAMBDL1兰姆达L2等等，还有个包啊，objective就是是回归还是分类问题，还是多分类的问题，以及最后评估的指标，Metric，这个是m RM c a u c等等。



![](img/c554579f1a84eb537d7d362105bd2794_55.png)

然后呢就给了一个，也给了一个这个比较全面的一个例子。

![](img/c554579f1a84eb537d7d362105bd2794_57.png)

你可以看到他现在就给多了，这样给的更多的一些这样的play meters。

![](img/c554579f1a84eb537d7d362105bd2794_59.png)

拿了放进去进行那个什么，其实大部分的时间啊，其实要么就是在特征工程上去花了很大时间，要么到最后训练的时候对吧，你确定参数之后。



![](img/c554579f1a84eb537d7d362105bd2794_61.png)

最后的话就去fit的时候，就劝fit在评估的时候花比较多的时间。

![](img/c554579f1a84eb537d7d362105bd2794_63.png)

其实真正用的模型的时候是比较简单的，用海盗还还还好不顺那么难。

![](img/c554579f1a84eb537d7d362105bd2794_65.png)

那参数调优他就给了几十，关键的问题啊，就是这个这个学习力是什么样的东西，然后最大深度叶子树啊。

![](img/c554579f1a84eb537d7d362105bd2794_67.png)

但是关键的这几个是这个还有一个模型评估。

![](img/c554579f1a84eb537d7d362105bd2794_69.png)

然后呢交叉验证去泛化，去去去做交叉验证的基本的概念，他这个就是一般来讲我们五折啊，七折啊，这K折交叉验证啊，就是这个重复K值每次用不同的子集作为验证，你最后计算K值验证的平均结果。

进行一个平均的一个东西来的，这边交叉验证函数的话，提供了这样的，这样的一些就是LGBN的点CV这个东西啊，进行自动处理分割，还有包括超参数调用。



![](img/c554579f1a84eb537d7d362105bd2794_71.png)

把这个这个grader啊，就是你看这样的弄了之后。

![](img/c554579f1a84eb537d7d362105bd2794_73.png)

它有一个啊，这是参数。

![](img/c554579f1a84eb537d7d362105bd2794_75.png)

然后呢他用那个叫叫做light gm，点CV这样的函数可以去调用啊，五折进行验证啊，然后进是否进行这个分叉，然后呢这个我提醒大家注意一点啊，这个这个非常关键的就是shuffle这个东西啊。

如果你是一个时间序列的东西，如果你下后等于ch的话，你就会犯了非常严重的错误，那基本上训练出来的模型是用不了的，你下F等于CHE的话会有个问题，就是说时间系列的问题是有严格的先后顺序。

你把它严格的先后顺序进行shuffle，打乱的时候会出现，就是就就就很傻，知道吧，本身时间序列是不可能去进行shuffle的。



![](img/c554579f1a84eb537d7d362105bd2794_77.png)

下破之后，他就呃打乱了这种前后顺序，所以说这个千万要记住。

![](img/c554579f1a84eb537d7d362105bd2794_79.png)

这个这个里面就是照葫芦画瓢的时候，一定要知道这个东西啊，不能去打乱啊，大量数据啊，这个这个如果说嗯如果说你分割后了去去打乱，就不要再填这个吧对吧。



![](img/c554579f1a84eb537d7d362105bd2794_81.png)

数据预处理早停随机种子模型训练，减少数据挑几参数并行化，数据格式化，硬件优化。

![](img/c554579f1a84eb537d7d362105bd2794_83.png)

100万条数据倒还好，我去年500万条数据做了2100次，大概花了四五个小时，就是笔记本上搞的啊。

![](img/c554579f1a84eb537d7d362105bd2794_85.png)

然后呢这个里面所以说这个速度还是比较快的，可以看到它这个里面。

![](img/c554579f1a84eb537d7d362105bd2794_87.png)

我觉得这个这个基本上是把这个讲，讲的非常那个了，讲的非常那个那么好看，好像还有一个啊，就是还有一个也大差不差呃，light gp m就这么多东西啊，这个这个也是另外一个也差不大差不差。

你看都是抄来抄去的，因为整个只要你出过一章，有人翻译过，他一定会去进行更多规模的搜索啊，大概是这样的，light g b m其实就是这么点东西，一个就是官方文档去看看，第二个是官方给的案例。

再到这个找到一些相应的这种这种这种博客，然后呢最后一个可能就是cargo的竞赛，你可以去看一下对吧，cargo的竞赛原来我们也看过，大概就是你把这个这么多的资料一看，你就应该来讲再摸索一下。

就应该懂得这个东西，但如何去工程上去实现一个东西，把它搞成盈利的这种赚钱机器。

![](img/c554579f1a84eb537d7d362105bd2794_89.png)

到时候我们请一个这个高手对吧，已经这个做高频交易的高手，然后呢用这种分类去，一秒钟大概能做一次交易的呃，应该是两秒钟能做一次啊，一天能交易3万5000次，那么这样的一个高手来看看。

有机会人家愿不愿意帮我们来讲讲课哦，出点钱或者是花个一两万块钱对吧，就是整个学习一下它的特征，工程到训练到这个评估模型，报评估模型是否稳定，那么我觉得花一两万块钱。



![](img/c554579f1a84eb537d7d362105bd2794_91.png)

还是值得去去去找一个高手来帮我们试一下，去做一下这样的工作行。

![](img/c554579f1a84eb537d7d362105bd2794_93.png)

那么今天的这个就到此为止。