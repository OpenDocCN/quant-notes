# 多变量时间序列股价预测｜Darts｜时间序列预测｜深度学习-量化金融与机器学习2024 - P1 - 背包2004 - BV1XM4m1z7Pn

好我们这里来实现一个更加呃高级的功能啊，可能同学们之前没用过，所谓的多变量的时间序列预测，什么是多变量的实验序列预测呢，我们我们之前学的实验序列预测，都是对某一某一根时间序列，是不是，但是有些时候呢。

你可能不仅仅是想预测一根时间训练，你可能想预测什么呢，预预测多个时间序列，多个时间训练，当然这个多变量的一个时间序列预测额，他通常什么情况下用呢，就我们之前用到的通常都是单变量的嘛啊。

通常都是单变量时间预测啊，但是在某些时候涉及到预测多个相关的时间，与时间相关变量的未来值的时候，预测模型会考虑需要预测模型，需要考虑多个变量之间，相互依赖的关系和交互作用。

这个时候有可能会用到多变量的一个时间，预测呃，这里其实是有一个问题，什么问题呢，我们的股票预测其实是通常要预测多个股票的，是不是我们预测一个股票没意义哈，我们肯定是要预测多个股票。

然后看哪个股票好进行择进行选股的哈，进行选股的，那是不是多个股票的预测，是把每个股票单独分开来进行预测好呢，还是把多个股票弄成一个多变量，时间预测来进行，那好呢，这个其实也不知道啊，老师不确定呃。

其实老师试过下面试过，我之前试过，我把两个股票一起作为，作为一个两个变量的时间序列预测，其实效果并不并不好啊，效果其实是并不好，那么另外一个问题就是，当你要预测某一个股票的时候。

你除了这个股票的时间序列以外，还有这个股票的其他特征的时间训练，那么把这个其他特征的时间训练，作为一个多变量时间序列，和这个股票一起来做预测，是不是能提高呢，老师其实下面也试了。

我并没有得到一个确定的答案啊，我感觉好像也没没特别提高，但是不管怎么样呃，我们这里实现一下，基于dust的这个多变量时间序列，预测的这样一个流程，我们把它实现一下，至于它的效果到底好不好。

这是一个未知数，可能是需要同学们探索啊，我们我们呃学习一下他怎么来做啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_1.png)

他的方法是什么样子，额因为涉及到我们要提取多个时间变量，因此呢我们最好是先干嘛呢，先把我们的原始数据啊，我们这个数据，就是我们最近最开始读的那个数据。



![](img/53f93c718a34b2003e314f0e86b21c7d_3.png)

给给转换一下，因为他这里这个是他的时间链，是不是，然后呢我们通从我们一般都是从这里来抽取啊，来抽取我们要预测的序列的。



![](img/53f93c718a34b2003e314f0e86b21c7d_5.png)

所以说呢我们先干嘛呢，我们先根据这个这个代码。

![](img/53f93c718a34b2003e314f0e86b21c7d_7.png)

这个代码其实我们以前用过，它，无非就是因为什么呢，因为这个一开始是一个整数，他先要把它转换成字符串，然后再转换成时间序列啊，先做这么一个变换。



![](img/53f93c718a34b2003e314f0e86b21c7d_9.png)

啊之前是没变换的。

![](img/53f93c718a34b2003e314f0e86b21c7d_11.png)

之前的转换大家看一下，之前是取出来之后再转换。

![](img/53f93c718a34b2003e314f0e86b21c7d_13.png)

就我们一开始那个比亚迪这个是先取出来之后，然后再进行转换，而因为这里我们涉及到多个的话，我们就先转换再取出来，这样会更合理一点啊，所以我们先把原始数据啊。



![](img/53f93c718a34b2003e314f0e86b21c7d_15.png)

把原始数据的这个时间序列。

![](img/53f93c718a34b2003e314f0e86b21c7d_17.png)

转换成标准的时间格式啊，转换成标准的时间格式。

![](img/53f93c718a34b2003e314f0e86b21c7d_19.png)

转换好了之后呢，我们在在做抽取工作啊，抽取工作的话。

![](img/53f93c718a34b2003e314f0e86b21c7d_21.png)

我怎么拖不动这个啊，我们接下来把上面的代码，我们最好是拷贝一下拷下拷贝下来就这个代码。

![](img/53f93c718a34b2003e314f0e86b21c7d_23.png)

我们把它放到一起，然后拷贝下来吧。

![](img/53f93c718a34b2003e314f0e86b21c7d_25.png)

一个是这个代码要要用哈，还有呢这个代码需要用，我们把它拷放到一起，然后拷贝下来。

![](img/53f93c718a34b2003e314f0e86b21c7d_27.png)

还有什么代码呢，还有这个代码。

![](img/53f93c718a34b2003e314f0e86b21c7d_29.png)

我们把它做成一个函数，这样的话我们要哪。

![](img/53f93c718a34b2003e314f0e86b21c7d_31.png)

把这一这一串代码做成一个函数，这样我们要要额需要抽取任意一个时间序列。

![](img/53f93c718a34b2003e314f0e86b21c7d_33.png)

就直接通过这个函数来抽抽。

![](img/53f93c718a34b2003e314f0e86b21c7d_35.png)

就更方便一点啊，更方便一点，所以好就是这些代码我们把它拷贝过来。

![](img/53f93c718a34b2003e314f0e86b21c7d_37.png)

![](img/53f93c718a34b2003e314f0e86b21c7d_38.png)

啊这里我们就复原一下吧，省得搞搞混淆了。

![](img/53f93c718a34b2003e314f0e86b21c7d_40.png)

然后把这些刚才那些代码拷贝到下面。

![](img/53f93c718a34b2003e314f0e86b21c7d_42.png)

然后把它做成一个函数。

![](img/53f93c718a34b2003e314f0e86b21c7d_44.png)

啊这个函数的框架我们已经放到这里了。

![](img/53f93c718a34b2003e314f0e86b21c7d_46.png)

好是要做成这样一个函数啊，做成这样一个函数，做成这样一个函数的话，我们先要怎么弄呢，我们肯定是要干嘛呢，我们就用这个BYD吧，啊或者用换一个名字，换一个so close，按这个吧，换price吧。

其实无所谓啊，这个名字换个名字，我们这个先先从那里面抽啊，抽什么呢，抽，抽取对应的，他的，股票代码是不是啊，股票代码要等于什么呢，等于我们输入的这个东西，给的这个东西是吧，这是一个一个要求。

还有一个什么要求呢，然后呢and and什么呢，呃需要取哪一列，需要取哪一列，哪一列的话无所谓啊，那我们直接直直接用这个了，然后取他的什么呢，取他的，取他的其中几列哪几列呢，肯定是要取他的date。

date要取的，然后呢它对应的特征是要取的，也就这个输入的这个量啊，我们通常取价格的话就是close嘛是吧，取价格就是closed，但是如果你取别的，那就换一个就是了啊，换一个就是了，这是，这个东西啊。

这是这个东西，这样的话我们应该就能够把额，我们想要的股票的哪个特征给获取到啊，获取到之后干嘛呢，呃我们要因为我们这个都这个部分做，是做什么事情呢，我们现在已经内一列已经是一个时间序列了。

那这个部分是为了让呃他的时间序列没有空值，就是每一个每一个时间都有值，他要填补那些呃假日的一些词啊，他们当然是通过这个前项进行填补，呃这里的话是要拿什么呢，假设你看我们可以把这个拿出来看看。

比如说我们的股票代码是什么啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_48.png)

我们的股票代码看看股票代码是比亚迪那个吧。

![](img/53f93c718a34b2003e314f0e86b21c7d_50.png)

![](img/53f93c718a34b2003e314f0e86b21c7d_51.png)

对不要加码，是不是这个是不是哦。

![](img/53f93c718a34b2003e314f0e86b21c7d_53.png)

我们还有一个很关键的要要搞一下。

![](img/53f93c718a34b2003e314f0e86b21c7d_55.png)

这里要加个点COOPY，啊为什么呢，因为我们这里希望做参考对，为什么要做深拷贝呢，因为我们要改变它的，我我们应该会改变它的索引结构的，所以说这里要加个copy啊，就让他重新那个。

然后我们的股票代码用这个，date和什么呢，我们假设我们还是用什么呢，用closed。

![](img/53f93c718a34b2003e314f0e86b21c7d_57.png)

啊你看我们拿到的是这个，是不是拿到的是这个，然后呢我们肯定是要获取这个东西是什么呢，这个东西的时间的最大值和最小值。



![](img/53f93c718a34b2003e314f0e86b21c7d_59.png)

![](img/53f93c718a34b2003e314f0e86b21c7d_60.png)

啊时间的最大值和最小值要以这个格式，要以data格式啊，要以这个格式获取，这是star，这个是and是max，有了时间的最大值最小值，就能通过这个最大值最小值来构建一个呃，每一天都不缺的一个日期序列啊。

然后把这个日期序列呢啊，做成一个日期的一个数据框啊，做成一个日期的数据框，然后呢，通过这个东西，把这个日期的数据框的列的类型变成时间，这个类型变成时间这个类型之后。

然后和我们这个拿到这个只做一个match，他是在对这一列做一个match合并啊，合并的时候呢，他说了是要基于左边的，也就是这个东西的索引来进行合并，所以它会保留所有多出来的这个多出来的时间。

而没有值的话，它就把它变成空值，然后在这里呢对空值进行做了一个填补啊，做了一个填补，这些应该都是差不多的啊，就没有什么啊，没有什么要改的，然后呢啧额这里有个性小改，我们要变让让它变成TZ。

因为有时候啊我们并不是每次都用的是close，我们有时候会取别的东西，所以说这里要改一改啊，这里要改一改。



![](img/53f93c718a34b2003e314f0e86b21c7d_62.png)

然后接下来然后做一个标准化，其实就是除一个那个什么值嘛，然后再把这个结果返回出来啊，返回出来。

![](img/53f93c718a34b2003e314f0e86b21c7d_64.png)

那么这个东西我们就弄好了啊，就弄好了，就是就改改前面那些地方就行了。

![](img/53f93c718a34b2003e314f0e86b21c7d_66.png)

那么这个函数应该就好了，这个函数好了之后呢，我们来，来用这个函数做一个事情，啊啊，这个就是调用上面这个函数，取它的closed调出来。



![](img/53f93c718a34b2003e314f0e86b21c7d_68.png)

然后作图啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_70.png)

是吧，然后呢这里呢我们取什么呢，取它的交易量作为他的第二个作为第二个额度，其作为这个多变量时间序列。

![](img/53f93c718a34b2003e314f0e86b21c7d_72.png)

预测里面的第二个序，第二个点啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_74.png)

交易量就这样，当然最终也是做了一个做了一个标准化嘛，啊做了一个标准化，然后同时对这两个时间序列来进行预测。



![](img/53f93c718a34b2003e314f0e86b21c7d_76.png)

我们看一下写效果啊，代码其实就在这里，代码就在这里，都是取得前面的650个时间，作为我们的训练集，后面的就作为一个啊，后面的作为我们的预测题啊，这个测试集啊，测试集依然用用的我们这个模型啊。



![](img/53f93c718a34b2003e314f0e86b21c7d_78.png)

这个这个我我也不知道是什么模型模型，然后参数还是这些东西啊，还是这些东西，这里我把它弄小了，弄少了。

![](img/53f93c718a34b2003e314f0e86b21c7d_80.png)

注意下，这里这个时候你预测的时候就要输入两个序列，就不再是输入一个序列了，能理解吗。

![](img/53f93c718a34b2003e314f0e86b21c7d_82.png)

就输入要输入两个序列啊，输入两个序列，我们运行一下吧。

![](img/53f93c718a34b2003e314f0e86b21c7d_84.png)

![](img/53f93c718a34b2003e314f0e86b21c7d_85.png)

这有点慢啊，40个迭代我们只能慢慢等了。

![](img/53f93c718a34b2003e314f0e86b21c7d_87.png)

好了好，应该是好啦。

![](img/53f93c718a34b2003e314f0e86b21c7d_89.png)

这个模型，但是我们可以看一下这个模型的一个效果啊，当然整本身这个模型我们是预测的，后面12个啊，理论上来我们N等于12是不是靠谱的。



![](img/53f93c718a34b2003e314f0e86b21c7d_91.png)

后面再之后就是自回归了哈，但是我们看一看吧，我们看一看啊，这个作图还是跟上面一样啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_93.png)

还是跟上面一样，他会而且这里也做了一个评价，我们可以看一下。

![](img/53f93c718a34b2003e314f0e86b21c7d_95.png)

是吧，就是这个部分呢应该是他真正靠谱的一个预测，到了这里的话，他其实基本上就属于自回归了啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_97.png)

就自回归了，肯定是不好的是吧。

![](img/53f93c718a34b2003e314f0e86b21c7d_99.png)

我们如果把这个改成12，改成12。

![](img/53f93c718a34b2003e314f0e86b21c7d_101.png)

看看，改成12效果好吗。

![](img/53f93c718a34b2003e314f0e86b21c7d_103.png)

11 11%也不知道。

![](img/53f93c718a34b2003e314f0e86b21c7d_105.png)

也没说多好，坦率来说啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_107.png)

而且这里还有一个情况，它不仅能够预测这个了，还能够预测什么呢。

![](img/53f93c718a34b2003e314f0e86b21c7d_109.png)

还能预测我们的，那个，交易量能预测交易量啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_111.png)

但是预测交易量似乎效果更不好啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_113.png)

看到没有哦，这不不他要那个啊，他要用这个。

![](img/53f93c718a34b2003e314f0e86b21c7d_115.png)

是吧，这就他预测的交易量是不是也也挺也不知道啊，就他能够这样的话，这个模型就能同时预测两个序列，所以说这两个序列效果就老师也不清楚。



![](img/53f93c718a34b2003e314f0e86b21c7d_117.png)

好像如果是给的，是不是不是这个股票的收盘价和它的交易量。

![](img/53f93c718a34b2003e314f0e86b21c7d_119.png)

而是用另外另外两个不同的股票给进去，作为多变量进行预测，效果其实也也不好啊，我感觉这样是不是效果会好一点，为什么呢，虽然说在呃股票市场，两只不同的股票，它是存在关联性的，但是关联性其实是弱很弱的。

大家能理解吗，关联性是比较弱的，反而是这个股票的那个收盘价。

![](img/53f93c718a34b2003e314f0e86b21c7d_121.png)

以及这个股票的交易量，它们两者的关联性反而强一点，是不是更好的。

![](img/53f93c718a34b2003e314f0e86b21c7d_123.png)

是不是作为两个多变量的，你们两个序列来进行预测好呢。

![](img/53f93c718a34b2003e314f0e86b21c7d_125.png)

这个老师也也不知道啊，因为这都是老师的常识啊，常识我并没有找到相关的资料来讨论这一点啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_127.png)

来讨论这个东西。

![](img/53f93c718a34b2003e314f0e86b21c7d_129.png)

好吧，同学们自己实现一下这个事儿啊。

![](img/53f93c718a34b2003e314f0e86b21c7d_131.png)

不管是用老师这个比亚迪。

![](img/53f93c718a34b2003e314f0e86b21c7d_133.png)